"use strict";function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach((function(e){_defineProperty(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function _regeneratorRuntime(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function(){return e};var t,e={},a=Object.prototype,n=a.hasOwnProperty,r=Object.defineProperty||function(t,e,a){t[e]=a.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function h(t,e,a){return Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{h({},"")}catch(t){h=function(t,e,a){return t[e]=a}}function l(t,e,a,n){var i=e&&e.prototype instanceof m?e:m,o=Object.create(i.prototype),c=new D(n||[]);return r(o,"_invoke",{value:C(t,a,c)}),o}function g(t,e,a){try{return{type:"normal",arg:t.call(e,a)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var u="suspendedStart",d="suspendedYield",p="executing",f="completed",v={};function m(){}function _(){}function y(){}var b={};h(b,o,(function(){return this}));var x=Object.getPrototypeOf,w=x&&x(x(O([])));w&&w!==a&&n.call(w,o)&&(b=w);var k=y.prototype=m.prototype=Object.create(b);function $(t){["next","throw","return"].forEach((function(e){h(t,e,(function(t){return this._invoke(e,t)}))}))}function I(t,e){function a(r,i,o,c){var s=g(t[r],t,i);if("throw"!==s.type){var h=s.arg,l=h.value;return l&&"object"==_typeof(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){a("next",t,o,c)}),(function(t){a("throw",t,o,c)})):e.resolve(l).then((function(t){h.value=t,o(h)}),(function(t){return a("throw",t,o,c)}))}c(s.arg)}var i;r(this,"_invoke",{value:function(t,n){function r(){return new e((function(e,r){a(t,n,e,r)}))}return i=i?i.then(r,r):r()}})}function C(e,a,n){var r=u;return function(i,o){if(r===p)throw Error("Generator is already running");if(r===f){if("throw"===i)throw o;return{value:t,done:!0}}for(n.method=i,n.arg=o;;){var c=n.delegate;if(c){var s=P(c,n);if(s){if(s===v)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===u)throw r=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=p;var h=g(e,a,n);if("normal"===h.type){if(r=n.done?f:d,h.arg===v)continue;return{value:h.arg,done:n.done}}"throw"===h.type&&(r=f,n.method="throw",n.arg=h.arg)}}}function P(e,a){var n=a.method,r=e.iterator[n];if(r===t)return a.delegate=null,"throw"===n&&e.iterator.return&&(a.method="return",a.arg=t,P(e,a),"throw"===a.method)||"return"!==n&&(a.method="throw",a.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=g(r,e.iterator,a.arg);if("throw"===i.type)return a.method="throw",a.arg=i.arg,a.delegate=null,v;var o=i.arg;return o?o.done?(a[e.resultName]=o.value,a.next=e.nextLoc,"return"!==a.method&&(a.method="next",a.arg=t),a.delegate=null,v):o:(a.method="throw",a.arg=new TypeError("iterator result is not an object"),a.delegate=null,v)}function S(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function B(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function D(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(S,this),this.reset(!0)}function O(e){if(e||""===e){var a=e[o];if(a)return a.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,i=function a(){for(;++r<e.length;)if(n.call(e,r))return a.value=e[r],a.done=!1,a;return a.value=t,a.done=!0,a};return i.next=i}}throw new TypeError(_typeof(e)+" is not iterable")}return _.prototype=y,r(k,"constructor",{value:y,configurable:!0}),r(y,"constructor",{value:_,configurable:!0}),_.displayName=h(y,s,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===_||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,y):(t.__proto__=y,h(t,s,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},$(I.prototype),h(I.prototype,c,(function(){return this})),e.AsyncIterator=I,e.async=function(t,a,n,r,i){void 0===i&&(i=Promise);var o=new I(l(t,a,n,r),i);return e.isGeneratorFunction(a)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},$(k),h(k,s,"Generator"),h(k,o,(function(){return this})),h(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),a=[];for(var n in e)a.push(n);return a.reverse(),function t(){for(;a.length;){var n=a.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=O,D.prototype={constructor:D,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(B),!e)for(var a in this)"t"===a.charAt(0)&&n.call(this,a)&&!isNaN(+a.slice(1))&&(this[a]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var a=this;function r(n,r){return c.type="throw",c.arg=e,a.next=n,r&&(a.method="next",a.arg=t),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],c=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var s=n.call(o,"catchLoc"),h=n.call(o,"finallyLoc");if(s&&h){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!h)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(t,e){for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var a=this.tryEntries[e];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),B(a),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var a=this.tryEntries[e];if(a.tryLoc===t){var n=a.completion;if("throw"===n.type){var r=n.arg;B(a)}return r}}throw Error("illegal catch attempt")},delegateYield:function(e,a,n){return this.delegate={iterator:O(e),resultName:a,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function _createForOfIteratorHelper(t,e){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){a&&(t=a);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,c=!1;return{s:function(){a=a.call(t)},n:function(){var t=a.next();return o=t.done,t},e:function(t){c=!0,i=t},f:function(){try{o||null==a.return||a.return()}finally{if(c)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var a={}.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}function asyncGeneratorStep(t,e,a,n,r,i,o){try{var c=t[i](o),s=c.value}catch(t){return void a(t)}c.done?e(s):Promise.resolve(s).then(n,r)}function _asyncToGenerator(t){return function(){var e=this,a=arguments;return new Promise((function(n,r){var i=t.apply(e,a);function o(t){asyncGeneratorStep(i,n,r,o,c,"next",t)}function c(t){asyncGeneratorStep(i,n,r,o,c,"throw",t)}o(void 0)}))}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,a){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var n=a.call(t,e||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}var SOCKET,defaultUserAvatar="/dist/img/ai-chatting/icon_avatar.png",gfChattingLan=jsonData.aiGirlFriendChat.javascript,AiGirlfriendTalking=function(){return _createClass((function t(){_classCallCheck(this,t),_defineProperty(this,"unChangeKeyList",["chat_id"]),_defineProperty(this,"lastMessage",null),_defineProperty(this,"loginPopup",null),this.boxPosition={changeBtnLeft:{chattingContainer:{height:"64vh"},chattingBox:{left:".8rem",right:"auto"},chatBgImg:{right:"0px",left:"auto"},changePhotoBtn:{right:".8rem",left:"auto"}},changeBtnMiddle:{chattingContainer:{height:"320px"},chattingBox:{left:"calc(50% - 38.54vw / 2)",right:"auto"},chatBgImg:{right:"auto",left:"calc(50% - 661px / 2)"},changePhotoBtn:{right:"auto",left:".8rem"}},changeBtnRight:{chattingContainer:{height:"64vh"},chattingBox:{left:"auto",right:".8rem"},chatBgImg:{right:"auto",left:"0"},changePhotoBtn:{right:"auto",left:".8rem"}}},this.isChat=!1}),[{key:"data",value:function(){return{modelDOM:$("#AiChat"),userMessage:$("#userInputMsg").value}}},{key:"getChatHistory",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a,n=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.isSyncingHistroy&&this.chatPage){t.next=2;break}return t.abrupt("return");case 2:return this.isSyncingHistroy=!0,(e=new URLSearchParams).append("chat_id",this.connectMsg.chat_id),this.chatPage&&this.chatPage>0&&e.append("page",this.chatPage+""),a=e.toString(),t.next=9,fetchGet("chat/user/get-message-info?".concat(a)).then((function(t){if(200===t.code&&t.data){n.isChat=!0,n.chatPage=t.data.page;var e=t.data.list.filter((function(t){return!!t.chat_content.content}));if(e.length<5&&n.chatPage&&(n.isSyncingHistroy=!1,n.getChatHistory(),0===e.length))return;var a=$(".chatting-container"),r=a.scrollTop(),i=a[0].scrollHeight;a.css("overflow-y","hidden");var o,c=_createForOfIteratorHelper(e);try{for(c.s();!(o=c.n()).done;){var s=o.value;if("user"===s.chat_content.role){var h=$("#myMessageBox");n.showMessage(h,s.chat_content.content,".my-message-container",!1,!0)}else{var l=$("#aiMessageBox");n.showMessage(l,s.chat_content.content,".ai-message-container",!0,!0)}}}catch(t){c.e(t)}finally{c.f()}if(a.css("overflow-y","auto"),n.initHistory)a.scrollTop(a.prop("scrollHeight"));else{var g=a[0].scrollHeight-i;a.scrollTop(r+g)}n.initHistory=!1}})).finally((function(){n.isSyncingHistroy=!1}));case 9:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"getChatData",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",a=this;return new Promise((function(n){var r={chat_id:t.aiData.chat_id,role_id:t.connectMsg.role_id,is_my_characters:t.aiData.is_my_characters,last_server_url:e};1===t.aiData.is_my_characters&&(r.my_characters_id=t.aiData.my_characters_id),fetchPost("chat/user/get-chat-server",r).then((function(e){if(401===e.code)return a.closeChat(),!1;1===e.data.is_old_server_url&&(a.isOldSeverUrl=!0),t.socketUrl=e.data.server_url,t.connectMsg.chat_id=e.data.chat_id,t.aiData.chat_id=e.data.chat_id,t.connectMsg.chat_id_name=e.data.chat_id_name,200===e.code?n(e.data):($Popup({type:"error",errorType:"normal"}),n())}))}))}},{key:"AiHello",value:function(){var t=this;if(!this.sendHello)return!1;try{clearInterval(this.helloTimer)}catch(t){}var e=_objectSpread(_objectSpread({},this.connectMsg),{},{request_type:50,chat_last_sep:3234});this.helloTimer=setInterval((function(){SOCKET.send(JSON.stringify(e)),t.sendHello=!1,clearInterval(t.helloTimer)}),24e4)}},{key:"changeAvatarFn",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a,n,r,i,o,c,s,h,l,g,u,d;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=getUrlVal("form"),a=this,!(n=getUrlVal("headAvatar"))){t.next=27;break}if(s=atob(getUrlVal("avatarKey")),h=atob(n),l={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:this.aiData.name,is_draft:2,tag:null!==(r=this.aiData.json.tag)&&void 0!==r?r:"",persona:null!==(i=this.aiData.persona)&&void 0!==i?i:"",gender:null!==(o=this.aiData.json.gender)&&void 0!==o?o:"",description:null!==(c=this.aiData.json.Character_des)&&void 0!==c?c:"",scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait:JSON.stringify([{key:"head_portrait",value:s,is_temp:1}]),head_portrait_background:JSON.stringify(this.aiData.head_portrait_background)},this.aiData.head_portrait=[{key:"head_portrait",value:h,url:h}],a.aiAvatarImg=h,this.aiData.status=2,this.updateCharacter(),$(".chatting-share").hide(),a.aiData.is_my_characters=1,a.bgImg="",this.changeBgAvatar(),e){t.next=17;break}return t.abrupt("return",!1);case 17:return t.next=19,fetchPost("chat/user/role-edit",l);case 19:return 200===(g=t.sent).code&&(aiGirlFriend.GetRecentChatting(),this.aiData.toMyCharacter=!0,history.pushState(null,null,"/ai-girlfriend.html?openShare=".concat(getUrlVal("openShare"),"&headAvatar=").concat(n,"&avatarKey=").concat(btoa(s))),this.aiData.my_characters_id=g.data.my_characters_id,this.aiData.role_id=g.data.role_id,this.aiData.is_my_characters=1),401===g.code&&a.closeChat(),t.next=24,this.getAiDetails(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id);case 24:for(d in u=t.sent)!u.hasOwnProperty(d)||this.aiData[d]&&this.unChangeKeyList.includes(d)||(this.aiData[d]=u[d]);this.updateCharacter();case 27:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"mobileInit",value:function(){var t;window.innerWidth<1200&&($("#changePhotoBtn").text("Change Photo"),t=1===this.aiData.is_my_characters?"1.4rem":"1.92rem",$(".change-photo-btn").css({left:"auto",right:t}))}},{key:"init",value:(n=_asyncToGenerator(_regeneratorRuntime().mark((function t(e){var a,n,r,i,o,c,s,h,l,g,u,d,p,f=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return gtag("event","chat_aigirlfriend_".concat(e.role_id)),this.errorPopup=$Popup({type:"error",errorType:"network"}),this.errorPopup.close(),this.isChat=!1,h=this,this.socketClose=!1,this.chatPage=-1,this.initHistory=!0,this.isSyncingHistroy=!1,gtag("event","enter_aigirlfriend_chatting"),this.aiData=e,this.aiAvatarImg=null==e||null===(a=e.head_portrait[0])||void 0===a?void 0:a.url,this.bgImg=e.head_portrait_background.length>0?null===(n=e.head_portrait_background[0])||void 0===n?void 0:n.url:null===(r=e.head_portrait[0])||void 0===r?void 0:r.url,this.backImg='url("'.concat((null===(i=e.head_portrait_background[0])||void 0===i?void 0:i.url)||this.bgImg,'")'),this.uploadAvatarChange=!0,this.uploadbg=(null===(o=e.head_portrait_background[0])||void 0===o?void 0:o.url)||!1,getCookie("user_info")&&(this.userData=JSON.parse(getCookie("user_info"))),this.userAvatarImg=(null===(c=this.userData)||void 0===c?void 0:c.head_portrait)||defaultUserAvatar,this.connectMsg={user_id:"0"|(null===(s=this.userData)||void 0===s?void 0:s.id),role_id:e.role_id+"",role_name:e.name,chat_id_name:"",chat_id:"",token:getCookie("SsToken")},this.connectMsg.user_id=this.connectMsg.user_id+"",this.uploadBlob={changeAvatar:{},changeBg:{}},this.sendHello=!0,this.uploadStatus=!1,$(".chatting-container").empty(),l="changeBtnMiddle",localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(l=localStorage.getItem("chattingPosition")),this.changePosition(l),this.mobileInit(),this.data().modelDOM.fadeIn(),$("body").css({overflow:"hidden",position:"fixed"}),this.loginTimer=setInterval((function(){f.showLoginPopup()}),3e5),$(".hidden-box #aiAvatarImg").attr("src",this.aiAvatarImg),$("#myAvatarImg").attr("src",this.userAvatarImg),$(".chat-bg-img, .ai-chat-box").css("background-image",this.backImg),(g=new Image).onload=function(){h.ratio=this.width/this.height,h.ratio.toFixed(2)>1?h.boxPosition.changeBtnMiddle.chatBgImg.left=0:h.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";var t="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(t=localStorage.getItem("chattingPosition"));var e=$("#chatBgImg");h.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:h.boxPosition[t].chatBgImg.left})},g.src=this.bgImg,this.updateCharacter(),t.next=40,this.getAiDetails(e.role_id,e.is_my_characters,e.my_characters_id);case 40:for(d in u=t.sent)!u.hasOwnProperty(d)||this.aiData[d]&&this.unChangeKeyList.includes(d)||(this.aiData[d]=u[d]);return this.updateCharacter(),1===u.is_like?($(".no-like-icon").hide(),$(".like-icon").show()):($(".no-like-icon").show(),$(".like-icon").hide()),t.next=46,this.getChatData();case 46:return p=t.sent,t.next=49,this.changeAvatarFn();case 49:this.getChatHistory(),this.isMyCharacterStatus=this.aiData.is_my_characters,this.aiData.toMyCharacter=!1,this.connectChatting(p.server_url),this.AiHello();case 54:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"updateCharacter",value:function(){$(".chatting-count").text(formatNumber(this.aiData.msg_num)),$(".ai-chat-gf-avatar, .ai-gf-info-dialog-avatar").attr("src",this.aiAvatarImg),$(".ai-gf-info-dialog-birthday").text(this.aiData.json.Created),$(".ai-gf-info-dialog-desc").text(this.aiData.json.Character_des),$(".ai-chat-gf-name, .ai-gf-info-dialog-name").text(this.aiData.name),this.toggleShareBtn(1===this.aiData.status&&1===this.aiData.type);var t=this.aiData.json.tag.split(",").filter((function(t){return""!==t})).map((function(t){return'<div class="ai-gf-info-dialog-tag">'.concat(t,"</div>")}));$(".ai-gf-info-dialog-tags").html(t.join(""))}},{key:"bindEvent",value:function(){var t=this,e=this;$("#userInputMsg").off("input").on("input",(function(){var t=$(this).val().length;window.innerWidth>1200?this.style.height=this.scrollHeight+"px":this.style.height=this.scrollHeight/100+.5+"rem",(0===t||t<37)&&(window.innerWidth>1200?this.style.height="46px":this.style.height=".88rem");var e=$(".send-btn");0===t||/^\s*$/.test($(this).val())?e.addClass("disable"):e.removeClass("disable")})),$("#backIcon, #closeIcon").off("click").on("click",(function(){"backIcon"===$(this).attr("id")?gtag("event","back_aigirlfriend_chatting"):gtag("event","close_aigirlfriend_chatting"),e.closeChat("click")})),$("#sendMsg").off("click").on("click",(function(){t.sendMessage(),$("#userInputMsg").trigger("focus")})),$(".ai-chat-box textarea").off("keydown").on("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),t.sendMessage())})),$("#editIcon").off("click").on("click",(function(){$(".change-position-box").toggle()})),$(document).on("click",(function(t){var a=$(t.target);a.closest("#editIcon").length||a.closest(".change-position-box").length||$(".change-position-box").hide(),a.closest(".right-button-box-m-dropdown").length||a.closest(".right-button-box-m-dropdown-menu").length||e.toggleGFDropdown(!1)})),$(".change-btns-box .change-btn").off("click").on("click",(function(){var t=$(this).attr("id");gtag("event",{changeBtnLeft:"left_aigirlfriend_pos",changeBtnMiddle:"mid_aigirlfriend_pos",changeBtnRight:"right_aigirlfriend_pos"}[t]),e.changePosition(t),$(".change-position-box").hide()})),$("#changePhotoBtn").off("click").on("click",(function(){gtag("event","click_aigirlfriend_changephoto"),t.openChangeHandle()})),$(".chatting-like").off("click").on("click",(function(){aiGirlFriend.changeLike(e.aiData.role_id),$(".no-like-icon").toggle(),$(".like-icon").toggle(),$(this).closest(".ai-gf-info-dialog").length>0?gtag("event","like_aigirlfriend_view"):"like-icon"===$(this).find('img[style="display: block;"]').attr("class")&&gtag("event","like_aigirlfriend_chatting"),1===e.aiData.is_like?e.aiData.is_like=2:e.aiData.is_like=1})),$(".discord-box").off("click").on("click",(function(){gtag("event","discord_aigirlfriend_chatting")})),$(".chatting-share").off("click").on("click",(function(e){$(e.target).closest(".ai-gf-info-dialog").length>0?gtag("event","share_aigirlfriend_view"):gtag("event","share_aigirlfriend_chatting"),aiGirlFriend.showShare(t.aiData.role_id,t.aiData.head_portrait[0].value)})),$(".ai-chat-gf-view").off("click").on("click",(function(){t.toggleGFInfoDialog(!0)})),$(".ai-gf-info-dialog-close, .ai-gf-info-dialog-bg").off("click").on("click",(function(){t.toggleGFInfoDialog(!1)})),$(".right-button-box-m-dropdown").off("click").on("click",(function(){var e=$(".right-button-box-m-dropdown-menu").is(":visible");t.toggleGFDropdown(!e)})),$("#chattingContainer").off("scroll").on("scroll",(function(){0===$(this).scrollTop()&&e.getChatHistory()}))}},{key:"changePosition",value:function(t){this.currentPosition=t,getCookie("user_info")?localStorage.setItem("chattingPosition",t):localStorage.removeItem("chattingPosition"),$("#"+t).addClass("change-active").siblings().removeClass("change-active");var e=this.boxPosition;for(var a in e[t]){var n="#".concat(a);for(var r in e[t][a])$(n).css(r,e[t][a][r])}var i=$(".chatting-container");i.scrollTop(i.prop("scrollHeight"))}},{key:"isMobile",value:function(){return window.innerWidth<1200}},{key:"toggleGFInfoDialog",value:function(t){var e=$(".ai-gf-info-dialog-wrap");this.isMobile()?t?e.show(0,(function(){return e.addClass("active")})):e.removeClass("active").hide():t?e.fadeIn(160):e.fadeOut(160),t&&gtag("event","show_aigirlfriend_view")}},{key:"toggleGFDropdown",value:function(t){var e=$(".right-button-box-m-dropdown-menu");this.isMobile()?t?e.slideDown(160):e.slideUp(160):t?e.fadeIn(160):e.fadeOut(160)}},{key:"toggleShareBtn",value:function(t){var e=$(".chatting-share");t?e.show():e.hide()}},{key:"closeChat",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function t(e){var a,n=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.toggleGFInfoDialog(!1),$(".change-position-box").hide(),$("body").css({"overflow-y":"auto",position:"static"}),history.pushState(null,null,"/ai-girlfriend.html"),clearInterval(n.loginTimer),clearInterval(n.heartTimer),clearInterval(n.helloTimer),clearInterval(n.disconnectTimer),(a=$("#userInputMsg")).val(""),window.innerWidth>1200?a.css("height","46px"):a.css("height",".88rem"),$(".chatting-container").empty(),$("div.modal").remove(),n.data().modelDOM.fadeOut(),n.socketClose=!0,null===(e=SOCKET)||void 0===e||e.close(),n.isChat&&aiGirlFriend.addRecentChatting(n.aiData),t.next=19,aiGirlFriend.initCharacters();case 19:aiGirlFriend.GetMyCharacters();case 20:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),e?this.showLoginPopup(_asyncToGenerator(_regeneratorRuntime().mark((function t(){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a();case 1:case"end":return t.stop()}}),t)})))):a();case 2:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"connectChatting",value:function(t){var e=this;if(this.socketClose)return!1;var a=this;SOCKET=new WebSocket(t);var n=_objectSpread(_objectSpread({},this.connectMsg),{},{chat_last_sep:3234,request_type:this.isOldSeverUrl?11:10,chat_action:""});this.isOldSeverUrl=!1;var r=_objectSpread(_objectSpread({},this.connectMsg),{},{request_type:40});this.heartTimer=setInterval((function(){SOCKET.readyState===WebSocket.OPEN&&SOCKET.send(JSON.stringify(r))}),4e4),SOCKET.onopen=function(){e.disconnectTimer=setTimeout((function(){SOCKET.close()}),3e5),SOCKET.send(JSON.stringify(n)),e.disconnectMessage&&setTimeout((function(){SOCKET.send(e.disconnectMessage),e.disconnectMessage=""}),1e3)},SOCKET.onmessage=function(){var n=_asyncToGenerator(_regeneratorRuntime().mark((function n(r){var i,o,c,s;return _regeneratorRuntime().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.wssResponse=JSON.parse(r.data),e.wssResponse.next_time||(clearTimeout(e.disconnectTimer),e.disconnectTimer=setTimeout((function(){SOCKET.close()}),3e5)),300!==e.wssResponse.status){n.next=10;break}return SOCKET.close(),e.disconnectMessage=e.lastMessage,n.next=7,a.getChatData(t);case 7:return o=n.sent,a.connectChatting(null==o?void 0:o.server_url),n.abrupt("return",!1);case 10:if(6001!==e.wssResponse.status){n.next=14;break}return gtag("event","already_aigirlfriend_win"),a.closeChat(),n.abrupt("return",!1);case 14:c=null===(i=JSON.parse(r.data))||void 0===i?void 0:i.chat_content,s=$("#aiMessageBox"),e.showMessage(s,c,".ai-message-container");case 17:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}(),SOCKET.onerror=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function t(e){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:console.error(e,"error");case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),SOCKET.onclose=function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.wasClean){e.next=5;break}return e.next=3,a.getChatData(t);case 3:r=e.sent,a.connectChatting(null==r?void 0:r.server_url);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}},{key:"showMessage",value:function(t,e,a,n,r){if(e){var i=t.clone().removeAttr("id");e=/^\*[^*]+\*$/.test(e)?e.replace(/\*(.*?)\*/g,'<p style="margin:0">($1)</p>'):e.replace(/\*(.*?)\*/g,"<p>($1)</p>"),".ai-message-container"===a&&(e='<div class="ai-name">'.concat(this.aiData.name,"</div>")+e),i.find(a).html(e);var o=$(".chatting-container");if(r?o.prepend(i):(o.append(i),o.scrollTop(o.prop("scrollHeight"))),".ai-message-container"===a&&!n){i.find(a).html('<div class="chatting-loading"></div>');var c=0,s=setInterval((function(){$(".chatting-loading").css("background-position-x",c+"px"),c+=8}),200);setTimeout((function(){i.find(a).html(e),o.scrollTop(o.prop("scrollHeight")),clearInterval(s),c=0}),800)}}}},{key:"sendMessage",value:function(){gtag("event","click_aigirlfriend_send"),this.AiHello();var t=$("#userInputMsg"),e=t.val();if(!e||/^\s*$/.test(e))return!1;e=e.replace(/[(（](.*?)[)）]/g,"*$1*");var a,n=_objectSpread(_objectSpread({},this.connectMsg),{},{chat_content:e,request_type:20,chat_action:""});try{var r=$("#myMessageBox");this.showMessage(r,e,".my-message-container"),SOCKET.readyState===WebSocket.OPEN?SOCKET.send(JSON.stringify(n)):SOCKET.readyState===WebSocket.CLOSED?(this.disconnectMessage=JSON.stringify(n),this.connectChatting(this.socketUrl)):this.disconnectMessage=JSON.stringify(n)}catch(t){console.warn(t),this.disconnectMessage=JSON.stringify(n)}a=window.innerWidth<1200?".88rem":"46px",t.css("height",a),this.lastMessage=JSON.stringify(n),t.val(""),$(".send-btn").addClass("disable")}},{key:"saveCharacter",value:(e=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a,n,r,i,o,c,s,h,l,g,u,d,p,f,v,m,_,y,b,x,w=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=function(t){return t instanceof Blob},gtag("event","save_aigirlfriend_changephoto"),(r=$("#characterNameInput")).prop("disabled",!0),o={changeAvatar:"aiAvatarImg",changeBg:"bgImg"},c={changeAvatar:"head_portrait",changeBg:"head_portrait_background"},h=r.val()+"",l={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:h.trim(),is_draft:2,tag:null!==(e=this.aiData.json.tag)&&void 0!==e?e:"",persona:null!==(a=this.aiData.persona)&&void 0!==a?a:"",gender:null!==(n=this.aiData.json.gender)&&void 0!==n?n:"",description:this.aiData.json.Character_des,scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait_background:this.uploadbg?JSON.stringify(this.aiData.head_portrait_background):"[]"},t.prev=8,this.changePopup.loading.start(),d=_regeneratorRuntime().mark((function t(e){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!i(w.uploadBlob[e])){t.next=5;break}return t.next=3,fetchPost("ai/source/get-upload-url",{file_name:"".concat(e,".png")}).then((function(t){s=t.data.upload_url,u=t.data.key,w[o[e]]=t.data.access_url,"bgImg"===o[e]?(w.aiData.head_portrait_background=[],w.aiData.head_portrait_background.push({key:"head_portrait_background",url:t.data.access_url,value:u})):w.aiData.changeAvatarUrl=t.data.access_url})).catch((function(t){$Popup({type:"error",errorType:"network"})}));case 3:return t.next=5,fetchPut(s,w.uploadBlob[e]).then((function(t){200===t&&(l[c[e]]=JSON.stringify([{key:c[e],value:u}]))}));case 5:case"end":return t.stop()}}),t)})),t.t0=_regeneratorRuntime().keys(this.uploadBlob);case 12:if((t.t1=t.t0()).done){t.next=17;break}return p=t.t1.value,t.delegateYield(d(p),"t2",15);case 15:t.next=12;break;case 17:return void 0!==l.head_portrait_background||null!==(g=this.aiData.head_portrait_background[0])&&void 0!==g&&g.url||(l.head_portrait_background="[]"),void 0===l.head_portrait&&(l.head_portrait=JSON.stringify(this.aiData.head_portrait)),getUrlVal("avatarKey")&&(f=atob(getUrlVal("headAvatar")),v=atob(getUrlVal("avatarKey")),(m=JSON.parse(l.head_portrait))[0].value===f&&(m[0].value=v,m[0].is_temp=1,delete m[0].url,l.head_portrait=JSON.stringify(m))),t.next=22,fetchPost("chat/user/role-edit",l);case 22:if(401!==(_=t.sent).code){t.next=26;break}return this.closeChat(),t.abrupt("return");case 26:if(200===_.code){t.next=32;break}return $Popup({type:"error",errorType:"normal"}),setTimeout((function(){$(".error").find("button").text("OK")}),10),$("#characterNameInput").prop("disabled",!1),this.changePopup.loading.end(),t.abrupt("return");case 32:return this.aiData.name=l.name,this.aiData.head_portrait=JSON.parse(l.head_portrait),this.aiData.head_portrait[0].url=this.aiData.changeAvatarUrl,this.aiData.is_my_characters=1,2===this.isMyCharacterStatus&&(this.aiData.toMyCharacter=!0),this.aiData.my_characters_id=_.data.my_characters_id,this.aiData.role_id=_.data.role_id,this.aiData.status=2,"[]"===l.head_portrait_background&&(this.bgImg="",this.aiData.head_portrait_background=[]),(y=$(".chatting-container")).scrollTop(y.prop("scrollHeight")-y.height()-10),this.changePopup.close(),this.aiData.head_portrait[0].url||(this.aiData.head_portrait[0].url=this.aiAvatarImg),this.updateCharacter(),$("#characterNameInput").prop("disabled",!1),this.changePopup.loading.end(),this.aiData.name=l.name,this.changeBgAvatar(),t.next=52,this.getAiDetails(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id);case 52:for(x in b=t.sent)!b.hasOwnProperty(x)||this.aiData[x]&&this.unChangeKeyList.includes(x)||(this.aiData[x]=b[x]);this.updateCharacter(),t.next=64;break;case 57:t.prev=57,t.t3=t.catch(8),this.errorPopup.show(),setTimeout((function(){$(".error .closeModal").text("OK")}),10),$(".error .closeModal").off("click").on("click",(function(){w.errorPopup.close()})),$(".error .title-right").off("click").on("click",(function(){w.errorPopup.close()})),this.changePopup.loading.end();case 64:case"end":return t.stop()}}),t,this,[[8,57]])}))),function(){return e.apply(this,arguments)})},{key:"showLoginPopup",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};if(this.loginPopup)return!1;if($("#userInputMsg").trigger("blur"),getCookie("access_token"))e();else{gtag("event","alert_aigirlfriend_loginwin"),this.loginPopup=$Popup({title:gfChattingLan.loginTitle,content:gfChattingLan.loginContent,closeBtn:gfChattingLan.loginBtn,otherBtns:gfChattingLan.loginOtherBtn,exist:gfChattingLan.loginExist,addBorderRadius:!0,onClose:function(){t.loginPopup=null,gtag("evet","login_aigirlfriend_loginwin"),showLoginWindow({fn:function(){gtag("evet","succ_aigirlfriend_loginwin"),chatLogin()}})}});var a=this;$(".login-popup-close-btn,.title-right").off("click").on("click",(function(){"title-right"===$(this).attr("class")?gtag("evet","close_aigirlfriend_loginwin"):gtag("evet","notnow_aigirlfriend_loginwin"),a.loginPopup.close(),a.loginPopup=null,"login-popup-close-btn"===$(this).attr("class")&&e()}))}}},{key:"changeBgAvatar",value:function(){var t=this;$(".aiAvatarImg").each((function(){$(this).attr("src",t.aiAvatarImg)})),$(".ai-name").each((function(){$(this).text(t.aiData.name)}));var e=new Image;e.onload=function(){var e=t.bgImg||t.aiAvatarImg;t.ratio=this.width/this.height,t.ratio.toFixed(2)>1?t.boxPosition.changeBtnMiddle.chatBgImg.left=0:t.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";var a=$("#chatBgImg");t.ratio.toFixed(2)>1?a.css({width:"100vw",left:"0px"}):a.css({width:"661px",left:t.boxPosition[t.currentPosition||"changeBtnMiddle"].chatBgImg.left}),$(".chat-bg-img, .ai-chat-box").css("background-image",'url("'.concat(e,'")'))},e.src=this.bgImg||t.aiAvatarImg}},{key:"hideShowImgBox",value:function(t,e){var a=this,n={avatarImgBox:{id:"#avatarText",iconId:"#avatarIcon",imgUrlObj:"uploadAvatar",blob:"changeAvatar",showFn:function(){gtag("event","upload_aigirlfriend_avatar"),a.uploadAvatarChange=!0,$("#characterNameInput").val().length>0&&a.changePopup.enableCloseBtn()},hideFn:function(){a.uploadAvatarChange=!1,a.changePopup.disableCloseBtn(),gtag("event","del_aigirlfriend_avatar")}},bgImgBox:{id:"#bgText",iconId:"#bgIcon",imgUrlObj:"uploadBg",blob:"changeBg",showFn:function(){gtag("event","upload_aigirlfriend_bg"),a.uploadbg=!0},hideFn:function(){a.uploadbg=!1}}},r="#"+t;({hide:function(){$(r).hide(),$(n[t].id).text(gfChattingLan.changePopBtnSpanSet),$(n[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_small.png"),a[n[t].imgUrlObj]=!1,a.uploadBlob[n[t].blob]={},n[t].hideFn()},show:function(){$(r).show(),$(n[t].id).text(gfChattingLan.changePopBtnSpanAddNew),a[n[t].imgUrlObj]=!0,$(n[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_normal.png"),n[t].showFn()}})[e]()}},{key:"openChangeHandle",value:function(){var t,e=this,a=this;this.uploadStatus=!1,this.changePopup=$Popup({title:gfChattingLan.changePopTitle,content:'<div class="change-photo-box">\n          <div class="change-avatar-box">\n             <div>'.concat(gfChattingLan.changePopName,'</div>\n             <div class="name-input-box">\n             <input type="text" id="characterNameInput" maxlength="100">\n           </div>\n            <div>').concat(gfChattingLan.changePopAvatar,'</div>\n            <div class="avatar-box">\n              <div class="avatar-img changeAvatarImg" id="avatarImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeAvatarIcon" class="close-icon" bindId="avatarImgBox"/>\n\n                <img src="" alt="" id="changeAvatarImg" class="changeAvatarImg" />\n              </div>\n              <div class="replace-img-btn" id="changeAvatarId" fn="changeAvatar">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="avatarIcon" class="img-icon" />\n                  <div class="change-btn-text" id="avatarTextBox">').concat(gfChattingLan.changePopBtn,'</div>\n                </div>\n              </div>             \n            </div>\n            \n              <div class="avatar-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png">\n                <span class="tip-text" id="avatarTip">').concat(gfChattingLan.changePopSupport,'</span>\n              </div>\n\n            <div class="change-bg-title">').concat(gfChattingLan.changePopBgDesc,'</div>\n            <div class="change-bg-sub">').concat(gfChattingLan.changePopRecommend,'</div>\n            <div class="avatar-box">\n              <div class="avatar-img" id="bgImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeBgIcon" class="close-icon" bindId="bgImgBox"/>\n                <img src="" alt="" id="changeBgImg" class="changeBgImg" />\n              </div>\n              <div class="replace-img-btn" id="changeBgId" fn="changeBg">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="bgIcon" class="img-icon" />\n                  <div  class="change-btn-text" id="bgTextBox">').concat(gfChattingLan.changePopBgBtn,'</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="bg-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png">\n                <span class="tip-text" id="bgTip">').concat(gfChattingLan.changePopBgSupport,'</span>\n           </div>\n\n            <input type="file" name="file" id="fileInput" style="display: none"   accept="image/jpeg, image/png, image/webp">\n          </div>\n        </div>'),closeBtn:gfChattingLan.changePopCloseBtn,otherBtns:gfChattingLan.changePopOtherBtn,autoClose:!1,topCloseFn:function(){this.uploadBlob={changeAvatar:{},changeBg:{}},a.uploadStatus=!1,gtag("event","close_aigirlfriend_changephoto")},onClose:function(){e.uploadStatus?e.saveCharacter():e.changePopup.close()},exist:"change"}),$("#changeOtherBtn").off("click").on("click",(function(){e.uploadBlob={changeAvatar:{},changeBg:{}},gtag("event","discard_aigirlfriend_changephoto"),a.uploadStatus=!1,e.changePopup.close()})),$("#characterNameInput").val(this.aiData.name),$("#characterNameInput").off("input").on("input",(function(){var t=$(this).val(),e=/[/*&\\%$#@]/g;e.test(t)&&$(this).val(t.replace(e,""));var n=(t=$(this).val()).length;n>50&&($(this).val(t.substring(0,50)),n=50),a.uploadStatus=!0,0===n?a.changePopup.closeButton.disable():a.uploadAvatarChange&&a.changePopup.closeButton.enable()})),this.aiAvatarImg?$("#changeAvatarImg").attr("src",this.aiAvatarImg):a.hideShowImgBox("avatarImgBox","hide");var n=$("#changeBgImg");this.aiData.head_portrait_background.length&&this.bgImg?n.attr("src",this.bgImg):a.hideShowImgBox("bgImgBox","hide"),n.attr("src",this.bgImg),$("#closeAvatarIcon,#closeBgIcon").off("click").on("click",(function(){a.uploadStatus=!0;var t=$(this).attr("bindId");"bgImgBox"===t&&gtag("event","del_aigirlfriend_bg"),a.hideShowImgBox(t,"hide")})),$(".replace-img-btn").off("click").on("click",(function(){t=$(this).attr("fn"),$("#fileInput").trigger("click")})),$("#fileInput").off("change").on("change",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var n,r,i,o,c,s,h,l,g,u,d,p,f,v,m,_;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r={changeAvatar:{text:"#avatarTip",box:".avatar-tip-box"},changeBg:{text:"#bgTip",box:".bg-tip-box"}},o=(i={changeAvatar:{icon:"#avatarIcon",text:"#avatarTextBox"},changeBg:{icon:"#bgIcon",text:"#bgTextBox"}})[t].icon,c=i[t].text,s=r[t].box,h=r[t].text,l=function(){$(o).attr("src","/dist/img/ai-chatting/icon_loading.svg"),$(o).addClass("popup-loading"),$(c).html(gfChattingLan.changePopUploading)},g=function(){$(o).removeClass("popup-loading"),$(o).attr("src","dist/img/ai-chatting/btn_add_normal.png");var e={changeAvatar:gfChattingLan.changePopBtn,changeBg:gfChattingLan.changePopBgBtn};$(c).html(e[t])},u={changeAvatar:function(e){var r=new Image;r.onload=function(){var n=this.naturalHeight,r=this.naturalWidth;n<32||r<32?($("#avatarTip").text(gfChattingLan.changePopAvatarError),$(".avatar-tip-box").css("visibility","visible")):(a.uploadStatus=!0,$(".changeAvatarImg").attr("src",e),a.hideShowImgBox(d[t],"show"))},r.src=URL.createObjectURL(n),$(s).css("visibility","hidden")},changeBg:function(e){var r=new Image;r.onload=function(){var n=this.naturalHeight,r=this.naturalWidth;n<128||r<128?($("#bgTip").text(gfChattingLan.changePopBgError),$(".bg-tip-box").css("visibility","visible")):(a.uploadStatus=!0,a.bgImg=e,$(".changeBgImg").attr("src",a.bgImg),a.hideShowImgBox(d[t],"show"))},r.src=URL.createObjectURL(n),$(s).css("visibility","hidden")}},d={changeAvatar:"avatarImgBox",changeBg:"bgImgBox"},p=this.files[0],f=p.name.split(".").pop().toLowerCase(),/^(image\/(jpg|jpeg|png|webp))$/.test(p.type)&&/^jpg|jpeg|png|webp$/.test(f)){e.next=17;break}return $(h).text(gfChattingLan.changePopSupport),$(s).css("visibility","visible"),$(this).val(null),e.abrupt("return",!1);case 17:if(!((null==p?void 0:p.size)>104857600)){e.next=22;break}return $(h).text(gfChattingLan.changePopMaxError),$(s).css("visibility","visible"),$(this).val(null),e.abrupt("return",!1);case 22:return l(),e.next=25,resizeImageByFile(p);case 25:v=e.sent,(m=v.blog)?(_=URL.createObjectURL(m),a.uploadBlob[t]=m,n=m,u[t](_)):($(h).text(gfChattingLan.changePopSupport),$(s).css("visibility","visible")),$(this).val(null),g();case 30:case"end":return e.stop()}}),e,this)}))))}},{key:"getAiInfo",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a,n){var r=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function t(i,o){var c;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return c="chat/user/get-role-info?id=".concat(e,"&is_my_characters=").concat(a),1===a&&(c+="&my_characters_id=".concat(n)),t.next=4,fetchGet(c).then((function(t){200===t.code?r.init(t.data):$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),200!==t.code&&console.error(t.data.message,"get-role-info"),i()}));case 4:case"end":return t.stop()}}),t)})));return function(e,a){return t.apply(this,arguments)}}()));case 1:case"end":return t.stop()}}),t)}))),function(e,a,n){return t.apply(this,arguments)})},{key:"getAiDetails",value:function(t,e,a){return new Promise(function(){var n=_asyncToGenerator(_regeneratorRuntime().mark((function n(r,i){var o;return _regeneratorRuntime().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o="chat/user/get-role-info?id=".concat(t,"&is_my_characters=").concat(e),1===e&&(o+="&my_characters_id=".concat(a)),n.next=4,fetchGet(o).then((function(t){200===t.code?r(t.data):$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),200!==t.code&&console.error(t.data.message,"get-role-info")}));case 4:case"end":return n.stop()}}),n)})));return function(t,e){return n.apply(this,arguments)}}())}}]);var t,e,a,n,r,i}();function formatTimestamp(t){var e=new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});return"Created ".concat(e)}function getUrlVal(t){var e=window.location.href;if(!e.includes("?"))return!1;var a=e.split("?")[1].split("&"),n={};return a.forEach((function(t){var e=t.split("="),a=decodeURIComponent(e[0]);n[a]=decodeURIComponent(e[1])})),n[t]}"placeholder"in document.createElement("input")||$("input[placeholder],textarea[placeholder]").each((function(){var t=$(this),e=t.attr("placeholder");""===t.val()&&t.val(e).addClass("placeholder"),t.focus((function(){t.val()===e&&t.val("").removeClass("placeholder")})).blur((function(){""===t.val()&&t.val(e).addClass("placeholder")})).closest("form").submit((function(){t.val()===e&&t.val("")}))})),$((function(){}));