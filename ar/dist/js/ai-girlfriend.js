var winRef=null,tryTimes=0,evt=document.createEvent("HTMLEvents");evt.initEvent("input",!0,!0);class AiGirlFriend{constructor(){var e=this;if(this.proxy=new Proxy(this.data(),{set:(t,i,a)=>("editMcType"===i&&(e.oldEditType=e.editMcType),setTimeout((async()=>{if("mc_Avatar"===i&&(t.mc_Avatar?($(".createMc_container .avatar").addClass("has"),$(".avatar .addImage span").text(jsonAiGirlFriend.createMc.avatar_btnAdd)):($(".createMc_container .avatar").removeClass("has"),$(".avatar .addImage span").text(jsonAiGirlFriend.createMc.avatar_btnSet))),"mc_Background"===i)t.mc_Background?($(".createMc_container .background").addClass("has"),$(".background .addImage span").text(jsonAiGirlFriend.createMc.background_btnAdd)):($(".createMc_container .background").removeClass("has"),$(".background .addImage span").text(jsonAiGirlFriend.createMc.background_btnSet));else if("mc_Desc"===i)$(".whiteMeOut").val(a);else if("mc_Name"===i)$(".createMC_name").val(a);else if("mc_Gender"===i)$(".createMC_gender").val(a);else if("mc_Persona"===i)$(".createMC_persona").val(a);else if("mc_Greeting"===i)$(".createMC_Greeting").val(a);else if("mc_Scenario"===i)$(".createMC_Scenario").val(a);else if("mc_Dialogue"===i)$(".createMC_Dialogue").val(a);else if("mc_visibility"===i)$(".createMc_select .select_content").text(a),$(".createMc_select .select_list_item").removeClass("active"),$(`.createMc_select .select_list_item[data-type='${a}']`).addClass("active");else if("mc_Categories"===i){let e="";e=(a.length>1?jsonAiGirlFriend.createMc.Categories_tips:jsonAiGirlFriend.createMc.Categories_tip).replace("%ss",a.length),$(".checkNum").text(e),$(".createMc_radio").prop("checked",!1),$(".createMc_radio").each((function(){const e=$(this).attr("value");a.forEach((t=>{t==e&&$(this).prop("checked",!0)}))}))}else"editMcType"===i?a?($("#myCharacters").click(),$(".myCharacters_Box,.noFoundMc,.Mycharacters_loading").hide(),$(".createMyCharacter_Box").show(),$(".createBtn").addClass("active"),$(".myCharactersBox .classify").hide(),"create"===a?(gtag("event","show_aigirlfriend_create"),$(".createMc_container").removeClass("editStart")):(gtag("event","show_aigirlfriend_edit"),$(".createMc_container").addClass("editStart"))):($(".myCharactersBox .classify").show(),e.composeClassify($(".myCharactersBox"))):"homeTag"===i?e.initCharacters():"mcTag"!==i&&"primary"!==i||e.GetMyCharacters();"tab"!=i&&"CharactersCount"!=i&&"MyCharactersCount"!=i||e.pageProcess()}),10),t[i]=a,!0),get:(e,t)=>e[t]}),Object.setPrototypeOf(AiGirlFriend.prototype,this.proxy),this.access_token=getCookie("access_token")?getCookie("access_token"):"",getCookie("aiGirlSort")&&this.access_token){const e=getCookie("aiGirlSort");this.sort=e;const t=$(`.character_select .select_list_item[data-sort='${e}']`);$(".character_select .select_list_item[data-sort]").removeClass("active"),t.addClass("active"),t.parents(".select_list").siblings(".select_content").text(t.text()),"top"==this.sort&&$(".select_time").css("display","flex")}$(window).bind("beforeunload",(function(){this.access_token=getCookie("access_token")?getCookie("access_token"):"",this.access_token||setCookie("aiGirlSort","")}))}data(){return{access_token:"",charactersList:[],mycharactersList:[],recentCharacters:[],sort:"",sort_time:"",tab:"all",isLoading:!1,isMyLoading:!1,isLike:!1,num:0,numMy:0,CharactersPage:0,MyCharactersPage:0,CharactersCount:0,MyCharactersCount:0,editMcType:"",classifys:[],homeTag:[],mcTag:[],primary:"",mc_Avatar:"",mc_Name:"",mc_Desc:"",mc_Gender:"",mc_Background:"",mc_Persona:"",mc_visibility:jsonAiGirlFriend.classifySelect.Public,mc_Categories:[],mc_Greeting:"",mc_Scenario:"",mc_Dialogue:"",my_characters_id:0,head_portrait:[],head_portrait_background:[],mc_roleId:"",is_draft:!1,oldRoleInfo:{},isUploadAvatar:!1,isUploadBackground:!1}}async init(){await this.initCharacters(),this.pageProcess(),this.GetMyCharacters(),this.GetRecentChatting(),this.GetClassify(),this.clickFn(),this.eventLoginsuccess(),this.composeBrief()}async initCharacters(e=!0){this.num++,this.isShowCharacterLoading(!0,!e);let t=this.sort?this.sort:"hot";e?this.CharactersPage=0:this.CharactersPage++;try{const i=await fetchGet(`chat/user/get-role-list?sort=${t}&sort_time=${this.sort_time}&is_like=${this.isLike?1:2}&page=${this.CharactersPage}&tag=${this.homeTag.join(",")}`);if(200===i.code){let t=i.data.list;this.CharactersCount=i.data.page_count;let a="",s=0;t.forEach(((e,t)=>{s>=6?s=1:s++;let i=e.json?.tag.split(",");a+=`<div class="characters_item" data-indexId="${e.id}" data-id="${e.role_id}">\n          <div class="headPortrait">\n            <img src="${e.head_portrait[0]?.url}" alt="" class="avatar">\n            <div class="share_icon">\n              <img src="/dist/img/aiGirlFriend/btn_more_normal.svg" />\n            </div>\n            <div class="head_shareBox">\n            ${1==e.is_self?`<div class="editInbox" >\n                <div class="icon"></div>${jsonAiGirlFriend.edit}\n              </div>`:""}\n              <div class="shareInbox">\n                <div class="icon"></div>${jsonAiGirlFriend.Share}\n              </div>\n            </div>\n            <div class="chat_info">\n              <img src="/dist/img/aiGirlFriend/icon_chat.svg" alt="">\n              <span>${formatNumber(e.msg_num)}</span>\n            </div>\n          </div>\n          <div class="character_info">\n            <div class="character_name">${e.name}</div>\n            <div class="infoBox">\n              <div class="info_l">\n                <div class="like_icon ${1===e.is_like?"active":""}" data-likes="${e.like_num}"></div>\n                <span class="num">${formatNumber(e.like_num)}</span>\n                <div class="like_num">${e.like_num>1?jsonAiGirlFriend.likes:jsonAiGirlFriend.like}</div>\n               </div>\n              <div class="info_r">\n                <button class="chatNow">${jsonAiGirlFriend.chatNow}</button>\n              </div>\n            </div>\n          </div>\n          <div class="brief_hover"></div>\n          <div class="brief">\n            <div class="brief_top">\n              <img class="brief_avatar" src="${e.head_portrait[0]?.url}"/>\n              <div class="tagBox">\n                <div class="brief_tag" style="display:${i.length>1&&i[i.length-2]?"block":"none"}">${i[i.length-2]}</div>\n                <div class="brief_tag" style="display:${i.length>0&&i[i.length-1]?"block":"none"}">${i[i.length-1]}</div>\n              </div>\n            </div>\n            <div class="brief_name">${e.json.Character_name}</div>\n            <div class="brief_created">${e.json.Created}</div>\n            <div class="brief_des">${e.json.Character_des}</div>\n          </div>\n        </div>`})),e?(this.charactersList=t,$(".characters").html(a)):(this.charactersList=[...this.charactersList,...t],$(".characters").append(a))}this.num--,this.isShowCharacterLoading(!1)}catch(e){this.num--,this.isShowCharacterLoading(!1),console.log(e,"error Failed to initialize all characters")}}async GetMyCharacters(e=!0){try{this.numMy++,this.isShowMyCharacterLoading(!0,!e),e?this.MyCharactersPage=0:this.MyCharactersPage++;const t=await fetchGet(`chat/user/get-role-list?type=my_characters&page=${this.MyCharactersPage}&tag=${this.mcTag.join(",")}&role_type=${this.primary.toLowerCase()}`);if(200===t.code){let i=t.data.list;this.MyCharactersCount=t.data.page_count;let a="",s=0;const r=$(".edit:not(.recent)").hasClass("active");i.forEach(((e,t)=>{s>=6?s=1:s++;let i=e.json?.tag.split(",");a+=`<div class="myCharacters_item" data-indexId="${e.id}" data-id="${e.role_id}" data-status="${e.status}">\n                        <div class="headPortrait">\n                          <img src="${e.head_portrait[0]?.url}" alt="" class="avatar" />\n                          <div class="share_icon" style="display: ${r?"none":"flex"};">\n                            <img src="/dist/img/aiGirlFriend/btn_more_normal.svg" />\n                          </div> \n                          <div class="lock_icon" style="display:${2==e.type?"block":"none"}"></div>\n                          <div class="head_shareBox">\n                            <div class="editInbox">\n                              <div class="icon"></div>${jsonAiGirlFriend.edit}\n                            </div>\n                            ${1==e.status&&2!=e.type?`<div class="shareInbox" style="display:">\n                              <div class="icon"></div>${jsonAiGirlFriend.Share}\n                            </div>`:""}\n                          </div>\n                          <div class="deleteChat ${r?"active":""}">\n                            <img src="/dist/img/aiGirlFriend/btn_close_big_normal.svg" alt="" class="" />\n                          </div>\n                        </div>\n                        \n                        <div class="character_info">\n                          <div class="character_name">${e.name}</div>\n                          <div class="infoBox">\n                            <div class="info_l">\n                              <div class="like_icon ${1===e.is_like?"active":""}"" data-likes="${e.like_num}" style="display:${4!=e.status?"block":"none"}"></div>\n                                    </div>\n                            <div class="info_r">\n                            ${4!=e.status?`<button class="chatNow">${jsonAiGirlFriend.chatNow}</button>`:`<button class="editDraft"><div class="icon"></div>${jsonAiGirlFriend.edit}</button>`}\n                            </div>\n                          </div>\n                        </div>\n                        <div class="brief_hover"></div>\n                        <div class="brief">\n                          <div class="brief_top">\n                            <img class="brief_avatar" src="${e.head_portrait[0]?.url}"/>\n                            <div class="tagBox">\n                              <div class="brief_tag" style="display:${i.length>1&&i[i.length-2]?"block":"none"}">${i[i.length-2]}</div>\n                                    <div class="brief_tag" style="display:${i.length>0&&i[i.length-1]?"block":"none"}">${i[i.length-1]}</div>\n                          </div>\n                        </div>\n                        <div class="brief_name">${e.json.Character_name}</div>\n                        <div class="brief_created">${e.json.Created}</div>\n                        <div class="brief_des">${e.json.Character_des}</div>\n                      </div>\n                      </div>`})),e?(this.mycharactersList=i,$(".myCharacters").html(a)):(this.mycharactersList=[...this.mycharactersList,...i],$(".myCharacters").append(a)),this.numMy--,this.isShowMyCharacterLoading(!1)}}catch(e){this.numMy--,this.isShowMyCharacterLoading(!1),console.log(e,"error Failed to initialize my chat partner")}}async GetRecentChatting(){try{const e=await fetchGet("chat/user/get-role-list?type=recent_chatting");if(200===e.code){let t=e.data.list;if(t.length>0){const e=$(".edit.recent").hasClass("active");$(".Recent_hr").css("display","flex"),$(".RecentChatting").css("display","flex"),this.recentCharacters=t;let i="";t.forEach(((t,a)=>{i+=`<div class="Recent_item" data-index="${a}" data-id="${t.chat_id}">\n                          <img src="${t.head_portrait[0]?.url}" alt="" class="recent_head_port"/>\n                          <div class="name">${t.name}</div>\n                          <div class="deleteChat recent ${e?"active":""}" style="display: ${e?"flex":"none"};">\n                            <img src="/dist/img/aiGirlFriend/btn_close_normal.svg" alt="" class="" />\n                          </div>\n                        </div>`})),$(".RecentChattingBox").html(i),setTimeout((()=>{this.composeRecent()}),200)}else $(".Recent_hr").hide(),$(".RecentChatting").hide(),$(".RecentChattingBox").html(""),$(".edit.recent").removeClass("active").text(jsonAiGirlFriend.edit)}}catch(e){console.log(e,"error Failed to initialize recentCharacters")}}async GetClassify(){try{const e=await fetchGet("chat/user/get-setting?type=tag");if(200===e.code){let t=e.data;if(t.length>0){this.classifys=t;let e=`<div class="classify_item active" data-tag=''>${jsonAiGirlFriend.AllCharacters}</div>`,i="";t.forEach((t=>{e+=`<div class="classify_item" data-tag='${t}'>${t}</div>`,i+=`<div class="check_item">\n                                <input type="checkbox" value="${t}" class="createMc_radio" />\n                                <label for="${t}">${t}</label>\n                              </div>`})),$(".classify_box_container").append(e),$(".createMc_checkbox").html(i),setTimeout((()=>{this.composeClassify($(".SegmentBox")),this.composeClassify($(".myCharactersBox"))}),200)}}}catch(e){console.log(e,"error Failed to initialize classify")}}async GetSettingInfo(e){for(;;){try{let t=await fetchPost("ai/tool/get-task",{id:e});if(200!==t.code)return tryTimes<=3?(console.log("try repeat1 -",tryTimes),tryTimes++,void setTimeout((()=>{this.GetSettingInfo(e)}),3e3)):void $Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"});if(0===t.data.status){const e=t.data.additional_data;return this.mc_Dialogue=e.example_chat,this.mc_Greeting=e.greeting,this.mc_Persona=e.persona,this.mc_Scenario=e.scenario,$(".createMC_persona").val(this.mc_Persona).get(0).dispatchEvent(evt),$(".createMC_Greeting").val(this.mc_Greeting).get(0).dispatchEvent(evt),$(".createMC_Scenario").val(this.mc_Scenario).get(0).dispatchEvent(evt),$(".createMC_Dialogue").val(this.mc_Dialogue).get(0).dispatchEvent(evt),void(this.editMcType="edit")}}catch(t){return console.log(t,"error"),tryTimes<=3?(console.log("try repeat2 -",tryTimes),tryTimes++,void setTimeout((()=>{this.GetSettingInfo(e)}),3e3)):void $Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"})}await new Promise((e=>setTimeout(e,2e3)))}}async addTaskGetSettingInfo(){try{const e=await fetchPost("ai/ai-tool/add-task",{action:"aichat_role_generate",param:{type:2,name:this.mc_Name,description:this.mc_Desc}});if(tryTimes=0,200!=e.code)return void $Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"});await this.GetSettingInfo(e.data.task_id)}catch(e){$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"}),console.log(e,"error get-task")}}async GetRoleInfo(e,t=2,i=0){try{const a=await fetchGet(`chat/user/get-role-info?id=${e}&is_my_characters=${t}&my_characters_id=${i}`);if(200===a.code){let e=a.data;this.my_characters_id=e.my_characters_id,this.mc_Avatar=e.head_portrait[0].url,this.mc_Name=e.name,this.mc_Desc=e.json.Character_des,this.mc_Background=e.head_portrait_background[0]?.url,this.mc_Persona=e.persona,this.mc_Gender=e.json.gender,this.is_draft=4==e.status,this.mc_visibility=1==e.type?jsonAiGirlFriend.classifySelect.Public:jsonAiGirlFriend.classifySelect.Private,this.mc_Categories=e.json.tag.length>0?e.json.tag.split(","):[],this.mc_Greeting=e.role_content.greeting.toString(),this.mc_Scenario=e.role_content["scene description"],this.mc_Dialogue=e.role_content.context,this.head_portrait=e.head_portrait,this.head_portrait_background=e.head_portrait_background,this.mc_roleId=e.role_id,$("#createMC_background_img").attr("src",e.head_portrait_background[0]?.url),$("#createMC_avatar_img").attr("src",e.head_portrait[0]?.url),$(".whiteMeOut").val(this.mc_Desc).get(0).dispatchEvent(evt),$(".createMC_name").val(this.mc_Name).get(0).dispatchEvent(evt),$(".createMC_gender").val(this.mc_Gender).get(0).dispatchEvent(evt),$(".createMC_persona").val(this.mc_Persona).get(0).dispatchEvent(evt),$(".createMC_Greeting").val(this.mc_Greeting).get(0).dispatchEvent(evt),$(".createMC_Scenario").val(this.mc_Scenario).get(0).dispatchEvent(evt),$(".createMC_Dialogue").val(this.mc_Dialogue).get(0).dispatchEvent(evt),this.oldRoleInfo={role_id:this.mc_roleId,name:this.mc_Name,type:this.mc_visibility,is_draft:this.is_draft,tag:this.mc_Categories.join(","),description:this.mc_Desc,persona:this.mc_Persona,scene:this.mc_Scenario,greeting:this.mc_Greeting,context:this.mc_Dialogue,head_portrait:JSON.stringify(this.head_portrait),head_portrait_background:JSON.stringify(this.head_portrait_background)}}}catch(e){console.log(e,"error get role info")}}async GetAiDesc(e=(()=>{})){try{const t=await fetchGet("chat/user/get-setting?type=role");if(200===t.code){let i=t.data;const a=randomchoice(i);$(".whiteMe").val(a().description),e?.()}}catch(e){console.log(e,"error get role info")}}async roleEdit(e=(()=>{}),t=(()=>{})){try{let i;this.mc_visibility==jsonAiGirlFriend.classifySelect.Public?(i=1,gtag("event","public_aigirlfriend_edit")):(i=2,gtag("event","private_aigirlfriend_edit"));let a=this.is_draft?1:2,s=this.head_portrait,r=this.head_portrait_background;delete s.url,delete r.url;const n={role_id:this.mc_roleId,my_characters_id:this.my_characters_id,name:this.mc_Name.trim(),type:i,is_draft:a,persona:this.mc_Persona.trim(),gender:this.mc_Gender.trim(),tag:this.mc_Categories.join(","),description:this.mc_Desc.trim(),scene:this.mc_Scenario.trim(),greeting:this.mc_Greeting.trim(),context:this.mc_Dialogue.trim(),head_portrait:JSON.stringify(s),head_portrait_background:JSON.stringify(r)},c=await fetchPost("chat/user/role-edit",n,{},!1);if(401==c.code){gtag("event","alert_aigirlfriend_loginwinedit");let e=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),e.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:()=>{gtag("event","notnow_aigirlfriend_loginwindit"),e.close(),this.closeCD(),this.clearInput(),this.editMcType=""},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}});t?.()}else 200===c.code?e?.():(this.is_draft?$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.draftSaveError,type:"error"}):$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.publishError,type:"error"}),t?.())}catch(e){console.log(t,"error"),this.is_draft?$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.draftSaveError,type:"error"}):$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.publishError,type:"error"}),t?.(),console.log(e," create or edit role error")}}addRecentChatting(e){console.log(e,"addRecentChatting");const t=e.chat_id,i=this.recentCharacters.findIndex((e=>e.chat_id==t)),a=$(".edit.recent").hasClass("active");let s="";-1!=i?($(".RecentChattingBox").children().eq(i).insertBefore($(".RecentChattingBox").children().eq(0)),$(".Recent_item").eq(0).find(".recent_head_port").attr("src",e.head_portrait[0]?.url),$(".Recent_item").eq(0).find(".name").text(e.name),this.recentCharacters.splice(i,1),this.recentCharacters.unshift(e)):(s=`<div class="Recent_item" data-id="${e.chat_id}">\n        <img src="${e.head_portrait[0]?.url}" alt="" class='recent_head_port'/>\n        <div class="name">${e.name}</div>\n        <div class="deleteChat recent ${a?"active":""}" style="display: ${a?"flex":"none"};">\n          <img src="/dist/img/aiGirlFriend/btn_close_normal.svg" alt="" class="" />\n        </div>\n      </div>`,$(".RecentChattingBox").prepend(s),this.recentCharacters.unshift(e)),$(".Recent_hr").css("display","flex"),$(".RecentChatting").css("display","flex"),setTimeout((()=>{this.composeRecent()}),500)}clickFn(){let e=this;$(".chatSelect").click((function(){$(this).hasClass("active")?($(this).children(".select_list").slideUp(),$(this).removeClass("active")):($(this).children(".select_list").slideDown(),$(this).addClass("active"),$(this).siblings(".chatSelect").children(".select_list").slideUp())})),$(".select_list_item").click((function(){const t=$(this).data("sort_time"),i=$(this).data("sort"),a=$(this).data("type"),s=$(this).data("primary");if(0!=$(this).parents("#select_sort_time").length&&(e.sort_time=t),0!=$(this).parents("#select_sort").length&&(e.sort=i,"top"==i?$(".select_time").css("display","flex"):$(".select_time").hide()),ttsBlank(a)||(e.mc_visibility=a),0!=$(this).parents(".classify").length)switch(e.composeClassify($(".myCharactersBox")),e.primary=s,s){case"":gtag("event","all_aigirlfriend_filter");break;case jsonAiGirlFriend.classifySelect.Public:gtag("event","public_aigirlfriend_filter");break;case jsonAiGirlFriend.classifySelect.Private:gtag("event","private_aigirlfriend_filter");break;case jsonAiGirlFriend.classifySelect.Draft:gtag("event","draft_aigirlfriend_filter")}if("sort"===Object.keys($(this).data())[0]&&0!=$(this).parents(".character_select").length)switch(getCookie("access_token")?setCookie("aiGirlSort",i):setCookie("aiGirlSort",""),!0){case"top"==i:gtag("event","top_aigirlfriend_hfilter");break;case"hot"==i:gtag("event","hot_aigirlfriend_hfilter")}else switch(!0){case"day"==t:gtag("event","top_aigirlfriend_hdayfilter");break;case"week"==t:gtag("event","top_aigirlfriend_hweekfilter");break;case"month"==t:gtag("event","top_aigirlfriend_hmonthfilter");break;case"year"==t:gtag("event","top_aigirlfriend_hyearfilter");break;case""==t:gtag("event","top_aigirlfriend_halltimefilter")}$(this).addClass("active"),$(this).siblings(".select_list_item").removeClass("active"),$(this).parents(".select_list").siblings(".select_content").text($(this).text()),0==$(this).parents(".createMyCharacter_Box ").length&&$(".description")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"end"}),e.initCharacters()})),$(".heart").click((function(){$(".Characters_hr")[0].scrollIntoView({behavior:"instant",block:"start",inline:"end"}),$(this).hasClass("active")?e.isLike=!1:(e.isLike=!0,gtag("event","like_aigirlfriend_hfilter")),$(this).toggleClass("active"),e.initCharacters()})),$(".Segment_item").click((function(){$(".Segment_item").removeClass("active"),$("body")[0].scrollIntoView({behavior:"instant",inline:"nearest"}),$(this).addClass("active"),"myCharacters"===$(this).attr("id")?(gtag("event","click_aigirlfriend_mytab"),e.tab="my",$(".myCharactersBox").show(),$(".SegmentBox").hide(),e.composeClassify($(".myCharactersBox"))):(gtag("event","click_aigirlfriend_htab"),e.tab="all",$(".SegmentBox").show(),$(".myCharactersBox").hide(),e.composeRecent(),e.composeClassify($(".SegmentBox")))})),$(".edit").click((function(){$(this).hasClass("active")?($(this).removeClass("active"),$(this).text(jsonAiGirlFriend.edit),$(this).hasClass("recent")?($(".Recent_item .deleteChat").removeClass("active").hide(),gtag("event","click_aigirlfriend_hrctedit")):($(".myCharacters_item .deleteChat").removeClass("active").hide(),gtag("event","click_aigirlfriend_mycedit"),$(".myCharacters_item .share_icon").css("display","flex"))):($(this).addClass("active"),$(this).text(jsonAiGirlFriend.Done),$(this).hasClass("recent")?($(".Recent_item .deleteChat").addClass("active").css("display","flex"),gtag("event","click_aigirlfriend_hrctedit")):($(".myCharacters_item .deleteChat").addClass("active").show(),gtag("event","click_aigirlfriend_mycedit"),$(".myCharacters_item .share_icon").hide()))})),$(".createMc").click((function(){e.editMcType="create",$(this).hasClass("createBtn")?gtag("event","click_aigirlfriend_create"):gtag("event","click_aigirlfriend_nodatacreate")})),$(".create_back_box,.mc_btn.discard").click((function(){if("edit"==e.editMcType)if($(this).hasClass("discard")?gtag("event","discard_aigirlfriend_edit"):gtag("event","back_aigirlfriend_edit"),getCookie("access_token")){let t={role_id:e.mc_roleId,name:e.mc_Name,type:e.mc_visibility,is_draft:e.is_draft,tag:e.mc_Categories.join(","),description:e.mc_Desc,scene:e.mc_Scenario,persona:e.mc_Persona,greeting:e.mc_Greeting,context:e.mc_Dialogue,head_portrait:JSON.stringify(e.head_portrait),head_portrait_background:JSON.stringify(e.head_portrait_background)};if(areObjectsEqual(t,e.oldRoleInfo))e.closeCD(),e.clearInput(),e.editMcType="";else{const t=$Popup({title:jsonAiGirlFriend.toSaveTitle,content:jsonAiGirlFriend.toSaveDesc,closeBtn:jsonAiGirlFriend.save,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{t.loading.start(),e.is_draft=!0,e.editDraftUpload((()=>{t.close(),e.editMcType=""}),(()=>{t.close()}))},onApply:()=>{t.close(),e.closeCD(),e.clearInput(),e.editMcType=""}})}}else{gtag("event","alert_aigirlfriend_loginwinedit");const t=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),t.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:async()=>{gtag("event","notnow_aigirlfriend_loginwindit"),t.close(),await e.closeCD(),e.clearInput(),e.editMcType=""},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}})}else e.closeCD(),e.clearInput(),e.editMcType=""})),$("#createMc").click((async function(){let t=!0;e.mc_Avatar?$(".erorrTip[data-type='avatar']").css("visibility","hidden"):($(".erorrTip[data-type='avatar']").find(".image_error").text(jsonAiGirlFriend.createMc.avatar_not),$(".erorrTip[data-type='avatar']").css("visibility","visible"),t=!1),e.mc_Name&&0!=$(".maxLength[data-input='name'] span").text()?$(".erorrTip[data-type='name']").css("visibility","hidden"):($(".erorrTip[data-type='name']").css("visibility","visible"),t=!1),e.mc_Desc&&0!=$(".maxLength[data-input='description'] span").text()?$(".erorrTip[data-type='description']").css("visibility","hidden"):($(".erorrTip[data-type='description']").css("visibility","visible"),t=!1),t&&(gtag("event","click_aigirlfriend_aicreate"),e.oldRoleInfo={role_id:e.mc_roleId,name:e.mc_Name,type:e.mc_visibility,is_draft:e.is_draft,tag:e.mc_Categories.join(","),description:e.mc_Desc,scene:e.mc_Scenario,greeting:e.mc_Greeting,persona:e.persona,context:e.mc_Dialogue,head_portrait:JSON.stringify(e.head_portrait),head_portrait_background:JSON.stringify(e.head_portrait_background)},$(this).addClass("loading"),$(".createMc_item,.create_back_box").addClass("loading"),await e.addTaskGetSettingInfo(),$(this).removeClass("loading"),$(".createMc_item,.create_back_box").removeClass("loading"))})),$("#editMc").click((async function(){gtag("event","publish_aigirlfriend_edit");let t=!0;if(e.mc_Avatar?$(".erorrTip[data-type='avatar']").css("visibility","hidden"):($(".erorrTip[data-type='avatar']").find(".image_error").text(jsonAiGirlFriend.createMc.avatar_not),$(".erorrTip[data-type='avatar']").css("visibility","visible"),t=!1),e.mc_Name&&0!=$(".maxLength[data-input='name'] span").text()?$(".erorrTip[data-type='name']").css("visibility","hidden"):($(".erorrTip[data-type='name']").css("visibility","visible"),t=!1),e.mc_Persona&&0!=$(".maxLength[data-input='persona'] span").text()?$(".erorrTip[data-type='persona']").css("visibility","hidden"):($(".erorrTip[data-type='persona']").css("visibility","visible"),t=!1),e.mc_Desc&&0!=$(".maxLength[data-input='description'] span").text()?$(".erorrTip[data-type='description']").css("visibility","hidden"):($(".erorrTip[data-type='description']").css("visibility","visible"),t=!1),0==e.mc_Categories.length?($(".erorrTip[data-type='Categories']").css("visibility","visible"),t=!1):$(".erorrTip[data-type='Categories']").css("visibility","hidden"),e.mc_Greeting&&0!=$(".maxLength[data-input='Greeting'] span").text()?$(".erorrTip[data-type='Greeting']").css("visibility","hidden"):($(".erorrTip[data-type='Greeting']").css("visibility","visible"),t=!1),e.mc_Scenario&&0!=$(".maxLength[data-input='Scenario'] span").text()?$(".erorrTip[data-type='Scenario']").css("visibility","hidden"):($(".erorrTip[data-type='Scenario']").css("visibility","visible"),t=!1),!t)return;if(!getCookie("access_token")){gtag("event","alert_aigirlfriend_loginwinedit");const t=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),t.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:()=>{gtag("event","notnow_aigirlfriend_loginwindit"),e.editMcType="",t.close(),e.closeCD()},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}});return}e.is_draft=!1,$(this).addClass("loading");const i=()=>$(this).removeClass("loading");await e.editDraftUpload(i,i,"all")})),$("#draftMc").click((async function(){if(gtag("event","draft_aigirlfriend_edit"),!getCookie("access_token")){gtag("event","alert_aigirlfriend_loginwinedit");const t=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),t.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:()=>{gtag("event","notnow_aigirlfriend_loginwindit"),t.close(),e.closeCD()},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}});return}e.is_draft=!0,$(this).addClass("loading");const t=()=>$(this).removeClass("loading");await e.editDraftUpload(t,t,"draft")})),$(".addImage").click((function(){0!=$(this).parents(".avatar").length?$("#createMC_avatar").click():$("#createMC_background").click()})),$("#createMC_avatar").on("change",(async function(t){e.isUploadAvatar=!0,e.uploadImage($(".avatar"),t,this,"avatar",(()=>{$(this).val("")}))})),$("#createMC_background").on("change",(async function(t){e.isUploadBackground=!0,e.uploadImage($("#background"),t,this,"background",(()=>{$(this).val("")}))})),$(".delete_image").click((function(){0!=$(this).parents(".avatar").length?e.mc_Avatar="":e.mc_Background=""})),$(".writeMe").click((function(){gtag("event","show_aigirlfriend_aiwrite");let t=$Popup({type:"createMC",title:jsonAiGirlFriend.createMc.writeMe_title,content:$(".whiteMeContent").html(),closeBtn:jsonAiGirlFriend.createMc.Generate,applyBtn:jsonAiGirlFriend.createMc.Apply,autoClose:!1,exist:"exist",onClose:()=>{gtag("event","generate_aigirlfriend_aiwrite"),t.loading.start(),e.GetAiDesc((()=>{t.loading.end()}))},onApply:()=>{gtag("event","apply_aigirlfriend_aiwrite");const i=$(".createMC .whiteMe").val();i.length>0&&(e.mc_Desc=i,t.close())}})})),$(".whiteMe,.whiteMeOut").on("input",(function(){const t=e.inputCharacter($(this),500,"description");$(this).hasClass("whiteMeOut")&&(e.mc_Desc=t)})),$(".createMC_name").on("input",(function(){const t=e.inputCharacter($(this),30,"name");e.mc_Name=t})),$(".createMC_gender").on("input",(function(){const t=e.inputCharacter($(this),30,"gender");e.mc_Gender=t})),$(".createMC_persona").on("input",(function(){const t=e.inputCharacter($(this),500,"persona");e.mc_Persona=t})),$(".createMC_Greeting").on("input",(function(){const t=e.inputCharacter($(this),330,"Greeting");e.mc_Greeting=t})),$(".createMC_Scenario").on("input",(function(){const t=e.inputCharacter($(this),500,"Scenario");e.mc_Scenario=t})),$(".createMC_Dialogue").on("input",(function(){const t=e.inputCharacter($(this),700,"Dialogue");e.mc_Dialogue=t})),$("body").on("mouseup",(async function(t){const i=$(t.target),a=0!=i.parents(".characters_item").length||i.hasClass("characters_item"),s=0!=i.parents(".myCharacters_item").length||i.hasClass("myCharacters_item");let r;if(a){let t=i.parents(".characters_item").attr("data-indexid");r=e.charactersList.findIndex((e=>parseInt(e.id)==parseInt(t)))}if(s){let t=i.parents(".myCharacters_item").attr("data-indexid"),a=e.mycharactersList.findIndex((e=>parseInt(e.id)==parseInt(t)));r=a>=0?a:r}if(0!=i.parents(".chatSelect").length||i.hasClass("chatSelect")||$(".chatSelect").removeClass("active").children(".select_list").slideUp(),0==i.parents(".head_shareBox").length&&$(".head_shareBox").hide(),i.hasClass("like_icon")){const t=i.parents(".characters_item").data("id")||i.parents(".myCharacters_item").data("id"),a=i.parents(".myCharacters_item").find(".deleteChat");if(0!=a.length&&a.hasClass("active"))return;if(0!=i.parents(".characters_item").length){let t=i.data("likes");i.hasClass("active")?(t>0?t--:t=0,i.siblings(".num").text(formatNumber(t)),i.siblings(".like_num").text(t>1?jsonAiGirlFriend.likes:jsonAiGirlFriend.like),i.data("likes",t),e.charactersList[r].is_like=2):(t++,i.siblings(".num").text(formatNumber(t)),i.siblings(".like_num").text(t>1?jsonAiGirlFriend.likes:jsonAiGirlFriend.like),i.data("likes",t),gtag("event","click_aigirlfriend_hlikebtn"),e.charactersList[r].is_like=1)}else i.hasClass("active")?e.mycharactersList[r].is_like=2:(gtag("event","click_aigirlfriend_myclikebtn"),e.mycharactersList[r].is_like=1);return i.toggleClass("active"),void e.changeLike(t)}if(0==i.parents(".share_icon").length)if(i.hasClass("shareInbox")){if(a){gtag("event","click_aigirlfriend_hshare");const t=e.charactersList[r];e.showShare(t.role_id,t.head_portrait[0].value)}else{gtag("event","click_aigirlfriend_mycshare");const t=e.mycharactersList[r];e.showShare(t.role_id,t.head_portrait[0].value)}$(".head_shareBox").hide()}else if(i.hasClass("editInbox"))if(e.editMcType="edit",$("body")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),0!=i.parents(".characters_item").length){gtag("event","click_aigirlfriend_hedit");const t=e.charactersList[r];await e.GetRoleInfo(t.role_id,1,t.my_chat_id)}else{gtag("event","click_aigirlfriend_mycchatedit");const t=e.mycharactersList[r];await e.GetRoleInfo(t.role_id,1,t.my_characters_id)}else if(i.hasClass("classify_item")){$(".description")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"end"});const t=0!=i.parents(".SegmentBox").length,a=i.data("tag");if(ttsBlank(a))t?(e.homeTag=[],gtag("event","htag_aigirlfriend_allcharacters"),$(".SegmentBox .classify_item").removeClass("active"),$(".SegmentBox .classify_item").eq(0).addClass("active")):(e.mcTag=[],gtag("event","mytag_aigirlfriend_allcharacters"),$(".myCharactersBox .classify_item").removeClass("active"),$(".myCharactersBox .classify_item").eq(0).addClass("active"));else{if(t){$(".SegmentBox .classify_item").eq(0).removeClass("active");let t=e.homeTag.findIndex((e=>e===a));if(-1!==t)e.homeTag.splice(t,1);else{e.homeTag.push(a);let t=i.attr("data-tag");t=t.replace(/\s+/g,"").toLowerCase(),gtag("event",`htag_aigirlfriend_${t}`)}const s=e.homeTag;e.homeTag=s,0==e.homeTag.length&&$(".SegmentBox .classify_item").eq(0).addClass("active")}else{$(".myCharactersBox .classify_item").eq(0).removeClass("active");let t=e.mcTag.findIndex((e=>e===a));if(-1!==t)e.mcTag.splice(t,1);else{e.mcTag.push(a);let t=i.attr("data-tag");t=t.replace(/\s+/g,"").toLowerCase(),gtag("event",`mytag_aigirlfriend_${t}`)}const s=e.mcTag;e.mcTag=s,0==e.mcTag.length&&$(".myCharactersBox .classify_item").eq(0).addClass("active")}i.toggleClass("active")}}else if(i.hasClass("createMc_radio"))setTimeout((()=>{if(i.is(":checked"))e.mc_Categories.push(i.attr("value"));else{const t=i.attr("value"),a=e.mc_Categories.findIndex((e=>e==t));e.mc_Categories.splice(a,1)}const t=e.mc_Categories;e.mc_Categories=t;let a="";a=(e.mc_Categories.length>1?jsonAiGirlFriend.createMc.Categories_tips:jsonAiGirlFriend.createMc.Categories_tip).replace("%ss",e.mc_Categories.length),$(".checkNum").text(a)}),5);else if(0!=i.parents(".deleteChat").length){let t;if(i.parents(".deleteChat").hasClass("recent")){gtag("event","click_aigirlfriend_hrctdelete");const a=i.parents(".Recent_item").attr("data-id");t=$Popup({title:jsonAiGirlFriend.deleteRecentTitle,content:jsonAiGirlFriend.deleteRecentText,closeBtn:jsonAiGirlFriend.Delete,otherBtns:`<button class="cannel">${jsonAiGirlFriend.Cancel}</button>`,autoClose:!1,exist:"deletePop",onClose:()=>{gtag("event","del_aigirlfriend_hrctdelete"),t.loading.start(),e.deleteChat(a,(async()=>{await e.GetRecentChatting(),t.close()}))}}),$(".modal .cannel").click((()=>{gtag("event","cancel_aigirlfriend_hrctdelete"),t.close()}))}else{gtag("event","click_aigirlfriend_mycdelete");const i=e.mycharactersList[r].my_characters_id;t=$Popup({title:jsonAiGirlFriend.deleteMyChatTitle,content:jsonAiGirlFriend.deleteMyChatText,closeBtn:jsonAiGirlFriend.Delete,otherBtns:`<button class="cannel">${jsonAiGirlFriend.Cancel}</button>`,autoClose:!1,exist:"deletePop",onClose:()=>{gtag("event","del_aigirlfriend_mycdelete"),t.loading.start(),e.deleteMyChat(i,(async()=>{await e.GetMyCharacters(),await e.GetRecentChatting(),t.close()}))}}),$(".modal .cannel").click((()=>{gtag("event","cancel_aigirlfriend_mycdelete"),t.close()}))}}else{if(0!=i.parents(".characters_item").length)return i.hasClass("chatNow")?gtag("event","click_aigirlfriend_hchatbtn"):gtag("event","click_aigirlfriend_hcard"),void aiChatting.init(e.charactersList[r]);if(0!=i.parents(".myCharacters_item").length){if(i.hasClass("chatNow")?gtag("event","click_aigirlfriend_mycchatbtn"):gtag("event","click_aigirlfriend_myccard"),i.parents(".myCharacters_item").find(".deleteChat").hasClass("active"))return;if(4!=i.parents(".myCharacters_item").attr("data-status"))aiChatting.init(e.mycharactersList[r]);else{gtag("event","click_aigirlfriend_myccardedit"),e.editMcType="edit";let t=e.mycharactersList[r];await e.GetRoleInfo(t.role_id,1,t.my_characters_id)}return}if(0!=i.parents(".Recent_item").length){if(i.parents(".Recent_item").find(".deleteChat").hasClass("active"))return;gtag("event","click_aigirlfriend_hrctcard");const t=i.parents(".Recent_item").attr("data-id"),a=e.recentCharacters.findIndex((e=>e.chat_id==t));return console.log(e.recentCharacters[a],"that.recentCharacters[index]"),void aiChatting.init(e.recentCharacters[a])}}else{const e=i.parents(".share_icon").siblings(".head_shareBox");e.hasClass("active")?e.removeClass("active").hide():e.addClass("active").show()}})),$(".view,.viewMore,.back").click((function(){$(".Recent_item,.RecentChattingBox").css("transform","translateX(0px)"),$(this).hasClass("active")?($(".view").text(jsonAiGirlFriend.view),$(this).removeClass("active"),$(".RecentChatting").removeClass("viewAll"),e.composeRecent(),$(".viewMore").removeClass("active")):($(".view").text(jsonAiGirlFriend.viewLess),$(this).addClass("active"),$(".btn_left,.btn_right").hide(),$(".RecentChatting").addClass("viewAll"),$(".back").addClass("active"))}))}async editDraftUpload(e,t,i){$(".createMc_item,.create_back_box").addClass("loading");try{if(this.isUploadAvatar){const e=await uploadImagePromise(this.mc_Avatar);this.head_portrait=[{key:"head_portrait",url:e.res.data.access_url,value:e.res.data.key}]}if(this.isUploadBackground){const e=await uploadImagePromise(this.mc_Background);this.head_portrait_background=[{key:"head_portrait_background",url:e.res.data.access_url,value:e.res.data.key}]}}catch(e){t?.(),$(".createMc_item,.create_back_box").removeClass("loading")}await this.roleEdit((()=>{e?.(),$(".createMc_item,.create_back_box").removeClass("loading"),"all"==i?($(".myCharactersBox .classify_select .select_list_item").removeClass("active"),$(".myCharactersBox .classify_select .select_list_item").eq(0).addClass("active"),$(".myCharactersBox .classify_select .select_content").text(jsonAiGirlFriend.classifySelect.All),this.primary=""):"draft"==i&&($(".myCharactersBox .classify_select .select_list_item").removeClass("active"),$(".myCharactersBox .classify_select .select_list_item").eq(3).addClass("active"),$(".myCharactersBox .classify_select .select_content").text(jsonAiGirlFriend.classifySelect.Draft),this.primary=jsonAiGirlFriend.classifySelect.Draft),$(".classify_box_container .classify_item").removeClass("active"),$(".SegmentBox .classify_item").eq(0).addClass("active"),$(".myCharactersBox .classify_item").eq(0).addClass("active"),this.homeTag=[],this.mcTag=[],this.clearInput(),this.closeCD(),this.editMcType=""}),(()=>{t?.(),$(".createMc_item,.create_back_box").removeClass("loading")}))}isShowCharacterLoading(e,t=!1){e&&t?$(".characters_loading").show():e||0!=this.num?($(".noFound").hide(),$(".characters").hide(),$(".characters_loading").show()):(this.isLoading=e,0==this.charactersList.length?$(".noFound").show():$(".characters").show(),$(".characters_loading").hide())}isShowMyCharacterLoading(e,t=!1){console.log("isShowMyCharacterLoading",e,t,""==this.editMcType,this.editMcType),""==this.editMcType?e&&t?$(".Mycharacters_loading").show():e||0!=this.numMy?($(".noFoundMc").hide(),$(".myCharacters_Box").hide(),$(".Mycharacters_loading").show()):(this.isMyLoading=e,0==this.mycharactersList.length?$(".noFoundMc").show():$(".myCharacters_Box").show(),$(".createBtn").hasClass("active")&&$(".myCharacters_Box,.noFoundMc").hide(),$(".Mycharacters_loading").hide()):$(".Mycharacters_loading").hide()}changeLike(e){fetchPost("chat/user/role-like",{role_id:e}).catch((function(e){console.log("role-like",e)}))}deleteChat(e,t){fetchPost("chat/user/del-recent-chatting",{chat_id:e}).then((()=>{t?.()})).catch((function(e){console.log("del-recent-chatting",e)}))}deleteMyChat(e,t){fetchPost("chat/user/del-my-characters",{my_characters_id:e}).then((()=>{t?.()})).catch((function(e){console.log("del-my-characters",e)}))}composeRecent(){const e=$(".RecentChatting").width(),t=$(".Recent_item").width(),i=$(".Recent_item").css("margin-right"),a=$(".RecentChatting"),s=$(".RecentChattingBox");s.css("transform","translateX(0px)");let r=(t+parseFloat(i))*$(".Recent_item").length,n=0,c=3*(t+16);isShowBtnLR(n,-(r-e)),$(".btn_right").click((function(){Math.abs(n-c)>=r-e?n=-(r-e):n-=c,s.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-e))})),$(".btn_left").click((function(){n+c>0?n=0:n+=c,s.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-e))})),r>e&&"pc"!=userModel?($(".viewMore").css("visibility","visible"),$(".back").css("display","")):($(".viewMore").css("visibility","hidden"),$(".back").hide(),a.off())}composeClassify(e){const t=e.find(".classify_item"),i=e.find(".classify_box_container").width(),a=e.find(".classify_btn_left"),s=e.find(".classify_btn_right");t.css("transform","translateX(0px)");let r=0;e.find(".classify_item").each((function(){let e=0;e+=$(this).width(),e+=parseFloat($(this).css("margin-right")),e+=parseFloat($(this).css("padding-right")),e+=parseFloat($(this).css("padding-left")),e+=2*parseFloat($(this).css("border-width")),r+=e}));let n=0,c=300;r>i&&"pc"==userModel&&transformBtn(n,-(r-i),a,s),s.click((function(){Math.abs(n-c)>=r-i?n=-(r-i):n-=c,t.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-i),a,s)})),a.click((function(){n+c>0?n=0:n+=c,t.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-i),a,s)}))}composeBrief(){const e=this;$("body").on("mouseover",(function(t){const i=$(t.target);if("pc"==userModel&&(0!=i.parents(".characters_item").length||i.hasClass("characters_item")||0!=i.parents(".myCharacters_item").length||i.hasClass("myCharacters_item"))){let t,a,s;0!=i.parents(".characters_item").length?(t=i.parents(".characters_item").find(".brief"),a=i.parents(".characters_item"),s=e.charactersList.findIndex((e=>parseInt(e.id)==parseInt(a.attr("data-indexid"))))):0!=i.parents(".myCharacters_item").length?(t=i.parents(".myCharacters_item").find(".brief"),a=i.parents(".myCharacters_item"),s=e.mycharactersList.findIndex((e=>parseInt(e.id)==parseInt(a.attr("data-indexid"))))):(t=i.find(".brief"),a=i),t.removeClass("brief_left");const r=$(".aiGirlFriend").width(),n=a.width();s++;const c=Math.floor(r/n);(Number.isInteger(s/c)?1:s/c%1)>.5&&t.addClass("brief_left")}}))}showShare(e,t){gtag("event","share_aigirlfriend_winshow"),$Popup({title:$(".sharePop .shareTitle").html(),content:$(".sharePop .shareBox").html(),type:"share"});let i=TOOL_API+"chat/user/share?s="+btoa(t+","+window.location.origin+window.location.pathname+"?openShare="+e+",en");$('meta[name="twitter:image"]').attr("content",t),$("meta[property='og:image']").attr("content",t),$(".shareIco.x").click((()=>{gtag("event","share_aigirlfriend_tw"),openWindow(`https://twitter.com/intent/tweet?url=${i}?play_source=Twitter&text=${encodeURIComponent(jsonAiGirlFriend.shareText)}`)})),$(".shareIco.facebook").click((()=>{gtag("event","share_aigirlfriend_fb"),openWindow(`https://www.facebook.com/sharer.php?u=${i}?play_source=Facebook&text=${encodeURIComponent(jsonAiGirlFriend.shareText)}`),$("meta[property='og:url']").attr("content",i)})),$(".shareIco.Link").click((()=>{gtag("event","share_aigirlfriend_link"),copyText(window.location.origin+window.location.pathname+"?openShare="+e);try{ToolTip({text:"Copied successfully"})}catch(e){ToolTip({text:"Copied failed"})}}))}eventLoginsuccess(){const e=this;document.querySelector("my-component").addEventListener("loginsuccess",(async function(t){isLogin(!0),await e.initCharacters(),e.GetMyCharacters(),e.GetRecentChatting()})),$(".signout").on("click",(async function(){await e.initCharacters(),e.GetMyCharacters(),e.GetRecentChatting()}))}inputCharacter(e,t,i){const a=t-1;let s=e.val(),r=0,n=0;"name"==i&&(s=s.replace(/[/*&\\%$#@]/g,""));let c="";for(const e of s)if(c+=e,n++,r=c.trim().length,r>a)break;return r>=t?$(`.maxLength[data-input='${i}']`).addClass("error"):$(`.maxLength[data-input='${i}']`).removeClass("error"),r>a&&(r=t),$(`.maxLength[data-input='${i}'] span`).text(r),e.val(s.substring(0,n)),s.substring(0,n)}async uploadImage(e,t,i,a,s){const r=this;if(!t.target.files||!t.target.files[0])return console.log("there is no file"),void s?.();let n=i.files[0];if(!checkFileType(n))return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.imageNoSupported),e.siblings(".erorrTip").css("visibility","visible"),$(i).val(null),s?.(),!1;if(n?.size>104857600)return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.imageSizeError),e.siblings(".erorrTip").css("visibility","visible"),$(i).val(null),s?.(),!1;let{blog:c}=await resizeImageByFile(n),o=URL.createObjectURL(c);var l=new Image;l.src=o,l.onload=function(){var t=this.naturalHeight,i=this.naturalWidth;if("background"===a){if(t<128||i<128)return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.backGround_Error),e.siblings(".erorrTip").css("visibility","visible"),!1;r.mc_Background=n,$("#createMC_background_img").attr("src",o)}else{if(t<32||i<32)return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.avatar_error),e.siblings(".erorrTip").css("visibility","visible"),!1;r.mc_Avatar=n,$("#createMC_avatar_img").attr("src",o)}e.siblings(".erorrTip").css("visibility","hidden")},l.error=function(){console.log("Error image loading")},s?.()}clearInput(){this.mc_Avatar="",this.mc_Name="",this.mc_Desc="",this.mc_Gender="",this.mc_Background="",this.mc_Persona="",this.mc_visibility=jsonAiGirlFriend.classifySelect.Public,this.mc_Categories=[],this.mc_Greeting="",this.mc_Scenario="",this.mc_Dialogue="",this.head_portrait=[],this.head_portrait_background=[],this.isUploadAvatar=!1,this.isUploadBackground=!1,this.oldRoleInfo={},this.my_characters_id=0,this.is_draft=!1,this.mc_roleId="",$(".maxLength span").text(0),$(".erorrTip").css("visibility","hidden")}async closeCD(){$(".createBtn").removeClass("active"),$(".createMyCharacter_Box").hide(),$("#myCharacters").click(),$("body")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),setTimeout((async()=>{await this.GetMyCharacters(),this.initCharacters(),this.GetRecentChatting()}),10)}pageProcess(){const e=this;$(window).off("scroll");const t="all"==this.tab;let i,a;t?(i=this.CharactersPage+1,a=this.CharactersCount):(i=this.MyCharactersPage+1,a=this.MyCharactersCount),i>=a||""!=this.editMcType||(console.log("pageProcess"),$(window).on("scroll",(function(i){let a=$(".hr_pagePorgress").offset().top+parseFloat($(".hr_pagePorgress").css("padding-bottom"));window.scrollY+$(window).height()>=a&&($(".hr_pagePorgress")[0].scrollIntoView({behavior:"instant",inline:"end",block:"end"}),t?(!e.isLoading&&e.initCharacters(!1),e.isLoading=!0):(!e.isMyLoading&&e.GetMyCharacters(!1),e.isMyLoading=!0))})))}}function ToolTip(e){const{text:t="",type:i="",showtime:a=""}=e;$("body").append(`\n    <bottom-message\n      text="${t}"\n      type="${i}"\n      showtime="${a}"\n      >\n    </bottom-message>`)}function isShowBtnLR(e,t){const i=$(".RecentChatting").width(),a=$(".Recent_item").width(),s=$(".Recent_item").css("margin-right");(a+parseFloat(s))*$(".Recent_item").length>i&&"pc"==userModel?($(".view").show(),$(".view").hasClass("active")?$(".btn_left,.btn_right").hide():transformBtn(e,t)):$(".btn_left,.btn_right,.view").hide()}function transformBtn(e,t,i=$(".btn_left"),a=$(".btn_right")){0==e?i.hide():i.css("display","flex"),e==t?a.hide():a.css("display","flex")}function copyText(e){const t=e,i=document.createElement("input");i.value=t,document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i)}function openWindow(e){winRef&&!winRef.closed?winRef.location.href=e:window.open(e)}function formatNumber(e){if(e<1e3)return`${e}`;if(e<1e6){const t=e/1e3;if(Number.isInteger(t))return`${t.toFixed(0)}K`;{const e=t.toFixed(1);return e.endsWith(".0")?`${t.toFixed(0)}K`:`${e}K`}}{const t=e/1e6;if(Number.isInteger(t))return`${t.toFixed(0)}M`;{const e=t.toFixed(1);return e.endsWith(".0")?`${t.toFixed(0)}M`:`${e}M`}}}checkFileType=(e,t)=>{var i=e.type;let a=e.name.split(".");var s=a[a.length-1].toLowerCase();return!(!["image/jpeg","image/png","image/webp","application/octet-stream"].includes(i)||!["jpeg","png","webp","jpg"].includes(s))},$(document).ready((function(){console.log(`%cCurrent version: V${currentVersion}`,"color: red;font-size: 24px;font-weight: bold;text-decoration: underline;"),window.aiChatting=new AiGirlfriendTalking,window.aiGirlFriend=new AiGirlFriend,aiChatting.bindEvent();let e=getUrlVal("openShare");(async()=>{await aiGirlFriend.init(),e&&aiChatting.getAiInfo(e,2,""),(getCookie("access_token")?getCookie("access_token"):"")||gtag("event","open_aigirlfriend_page"),window.addEventListener("resize",(function(){aiGirlFriend.composeRecent()}))})()}));