var winRef=null,tryTimes=0,evt=document.createEvent("HTMLEvents");evt.initEvent("input",!0,!0);var informTimer=null;class AiGirlFriend{constructor(){var e=this;if(this.proxy=new Proxy(this.data(),{set:(t,i,a)=>(setTimeout((async()=>{if("mc_Avatar"===i)t.mc_Avatar?($(".createMc_container .avatar").addClass("has"),$(".createMc_container .avatar .addImage span").text(jsonAiGirlFriend.createMc.avatar_btnAdd)):($(".createMc_container .avatar").removeClass("has"),$(".createMc_container .avatar .addImage span").text(jsonAiGirlFriend.createMc.avatar_btnSet));else if("mc_Background"===i)t.mc_Background?($(".createMc_container .background").addClass("has"),$(".background .addImage span").text(jsonAiGirlFriend.createMc.background_btnAdd)):($(".createMc_container .background").removeClass("has"),$(".background .addImage span").text(jsonAiGirlFriend.createMc.background_btnSet));else if("mc_Desc"===i)$(".whiteMeOut").val(a);else if("mc_Name"===i)$(".createMC_name").val(a);else if("mc_Gender"===i)$(".createMC_gender").val(a);else if("mc_Persona"===i)$(".createMC_persona").val(a);else if("mc_Greeting"===i)$(".createMC_Greeting").val(a);else if("mc_Scenario"===i)$(".createMC_Scenario").val(a);else if("mc_Dialogue"===i)$(".createMC_Dialogue").val(a);else if("mc_visibility"===i)$(".createMc_select .select_content").text(a),$(".createMc_select .select_list_item").removeClass("active"),$(`.createMc_select .select_list_item[data-type='${a}']`).addClass("active");else if("mc_Categories"===i){let e="";e=(a.length>1?jsonAiGirlFriend.createMc.Categories_tips:jsonAiGirlFriend.createMc.Categories_tip).replace("%ss",a.length),$(".checkNum").text(e),$(".createMc_radio").prop("checked",!1),$(".createMc_radio").each((function(){const e=$(this).attr("value");a.forEach((t=>{t==e&&$(this).prop("checked",!0)}))}))}else if("editMcType"===i)a?($("#myCharacters").click(),$(".myCharacters_Box,.noFoundMc,.Mycharacters_loading").hide(),$(".createMyCharacter_Box").show(),$(".createBtn").addClass("active"),$(".myCharactersBox .classify").hide(),"create"===a?(gtag("event","show_aigirlfriend_create"),$(".createMc_container").removeClass("editStart")):(gtag("event","show_aigirlfriend_edit"),$(".createMc_container").addClass("editStart"))):($(".createMyCharacter_Box").hide(),$(".classify").show(),e.isMyLoading?$(".Mycharacters_loading").show():0==e.mycharactersList.length?$(".noFoundMc").show():$(".myCharacters_Box").show());else if("homeTag"===i)e.initCharacters();else if("mcTag"===i||"primary"===i)e.GetMyCharacters();else if("voice_json"===i){const t=$("#voice_type")[0],i=e.voiceArr.findIndex((e=>e.name==a.name)),s=$(`.voice_box .voice_item[data-name='${a.name}']`),r=e.voiceArr[i].url;$(".voice_box .voice_item").removeClass("active"),$(".voice_item .icon").removeClass("active"),s.addClass("active"),t.pause(),t.setAttribute("src",r),t.currentTime=0}else"editUser_Avatar"===i?t.editUser_Avatar?($(".editUser .avatar").addClass("has"),$(".editUser .avatar .addImage span").text(jsonAiGirlFriend.createMc.avatar_btnAdd)):($(".editUser .avatar").removeClass("has"),$(".editUser .avatar .addImage span").text(jsonAiGirlFriend.createMc.avatar_btnSet)):"editUserAge"===i?0!=Number(a)?$(".editUserAge .select_content").text(a).attr("data-age",a):$(".editUserAge .select_content").text(jsonAiGirlFriend.editUser.age_tip).attr("data-age",0):"isLoadingInform"===i&&(a?($(".inform_notMore").hide(),$(".inform_loading").show()):($(".inform_notMore").show(),$(".inform_loading").hide()));"tab"!=i&&"CharactersCount"!=i&&"MyCharactersCount"!=i||e.pageProcess()}),10),t[i]=a,!0),get:(e,t)=>e[t]}),Object.setPrototypeOf(AiGirlFriend.prototype,this.proxy),this.access_token=getCookie("access_token")?getCookie("access_token"):"",getCookie("aiGirlSort")&&this.access_token){const e=getCookie("aiGirlSort");this.sort=e;const t=$(`.character_select .select_list_item[data-sort='${e}']`);$(".character_select .select_list_item[data-sort]").removeClass("active"),t.addClass("active"),t.parents(".select_list").siblings(".select_content").text(t.text()),"top"==this.sort&&$(".select_time").css("display","flex")}$(window).bind("beforeunload",(function(){this.access_token=getCookie("access_token")?getCookie("access_token"):"",this.access_token||setCookie("aiGirlSort","")}))}data(){return{access_token:"",charactersList:[],mycharactersList:[],recentCharacters:[],sort:"",sort_time:"",tab:"all",isLoading:!1,isLoadingTimer:null,isMyLoading:!1,isMyLoadingTimer:null,isLike:!1,num:0,numMy:0,CharactersPage:0,MyCharactersPage:0,CharactersCount:0,MyCharactersCount:0,editMcType:"",classifys:[],homeTag:[],mcTag:[],primary:"",mc_Avatar:"",mc_Name:"",mc_Desc:"",mc_Gender:"",mc_Background:"",mc_Persona:"",mc_visibility:jsonAiGirlFriend.classifySelect.Public,mc_Categories:[],mc_Greeting:"",mc_Scenario:"",mc_Dialogue:"",my_characters_id:0,head_portrait:[],head_portrait_background:[],mc_roleId:"",is_draft:!1,oldRoleInfo:{},isUploadAvatar:!1,isUploadBackground:!1,voiceArr:[],voice_json:{},isUploadUserAvatar:!1,editUser_Avatar:"",editUserAge:0,editUser_firstName:"",editUser_lastName:"",informaPage:0,isLoadingInform:!1,unlook:!1,resetMy:!0,resetAll:!0,voiceOpen:"pool_voice",voicePool_json:{},lastTab:"all"}}async init(){this.reSetAllCharacters=refreshData(6e5),await this.initCharacters(),this.reSetMyCharacters=refreshData(6e5),this.GetMyCharacters(),this.pageProcess(),this.GetRecentChatting(),this.GetSetting(),this.GetIfications(),this.clickFn(),this.eventLoginsuccess(),this.composeBrief(),this.isShowNewTag()}async initCharacters(e=!0){if(!this.reSetAllCharacters(this.resetAll))return void(this.resetAll=!0);this.resetAll=!0,this.num++;const t=await this.isShowCharacterLoading(!0,!e);if(console.log(t,"isRun"),!t)return;let i=this.sort?this.sort:"hot";e?this.CharactersPage=0:this.CharactersPage++;try{const t=await fetchGet(`chat/user/get-role-list?sort=${i}&sort_time=${this.sort_time}&is_like=${this.isLike?1:2}&page=${this.CharactersPage}&tag=${this.homeTag.join(",")}`);if(200===t.code){let i=t.data.list;this.CharactersCount=t.data.page_count;let a="",s=0;i.forEach(((e,t)=>{s>=6?s=1:s++;let i=e.json?.tag.split(","),r=e.json.Character_author?jsonAiGirlFriend.by+" "+e.json.Character_author:"";a+=`<div class="characters_item" data-indexId="${e.id}" data-id="${e.role_id}">\n          <div class="headPortrait">\n            <img src="${e.head_portrait[0]?.url}" alt="" class="avatar">\n            <div class="share_icon">\n              <img src="/dist/img/aiFriend/btn_more_normal.svg" />\n            </div>\n            <div class="head_shareBox">\n            ${1==e.is_self?`<div class="editInbox" >\n                <div class="icon"></div>${jsonAiGirlFriend.edit}\n              </div>`:""}\n              <div class="shareInbox">\n                <div class="icon"></div>${jsonAiGirlFriend.Share}\n              </div>\n            </div>\n            <div class="chat_info">\n              <img src="/dist/img/aiFriend/icon_chat.svg" alt="">\n              <span>${formatNumber(e.msg_num)}</span>\n            </div>\n          </div>\n          <div class="character_info">\n            <div class="character_name">\n              <div class="name">${e.name}</div>\n              ${r?`<div class="author">${r}</div>`:""}\n            </div>\n            <div class="infoBox">\n              <div class="info_l">\n                <div class="like_icon ${1===e.is_like?"active":""}" data-likes="${e.like_num}"></div>\n                <span class="num">${formatNumber(e.like_num)}</span>\n                <div class="like_num">${e.like_num>1?jsonAiGirlFriend.likes:jsonAiGirlFriend.like}</div>\n               </div>\n              <div class="info_r">\n                <button class="chatNow">${jsonAiGirlFriend.chatNow}</button>\n              </div>\n            </div>\n          </div>\n          <div class="brief_hover"></div>\n          <div class="brief">\n            <div class="brief_top">\n              <img class="brief_avatar" src="${e.head_portrait[0]?.url}"/>\n              <div class="tagBox">\n                <div class="brief_tag" style="display:${i.length>1&&i[i.length-2]?"block":"none"}">${jsonAiGirlFriend.setting_tag[i[i.length-2]]||i[i.length-2]}</div>\n                <div class="brief_tag" style="display:${i.length>0&&i[i.length-1]?"block":"none"}">${jsonAiGirlFriend.setting_tag[i[i.length-1]]||i[i.length-1]}</div>\n              </div>\n            </div>\n            <div class="brief_name">${e.json.Character_name}</div>\n            ${r?`<div class="brief_author">${r}</div>`:""}\n            <div class="brief_created">${e.json.Created}</div>\n            <div class="brief_des">${e.json.Character_des}</div>\n          </div>\n        </div>`})),e?(this.charactersList=i,$(".characters").html(a)):(this.charactersList=[...this.charactersList,...i],$(".characters").append(a))}this.num--,this.isShowCharacterLoading(!1)}catch(e){this.num--,this.isShowCharacterLoading(!1),console.log(e,"error Failed to initialize all characters")}}async GetMyCharacters(e=!0){if(this.reSetMyCharacters(this.resetMy))try{this.numMy++;if(!await this.isShowMyCharacterLoading(!0,!e))return;e?this.MyCharactersPage=0:this.MyCharactersPage++;const t=await fetchGet(`chat/user/get-role-list?type=my_characters&page=${this.MyCharactersPage}&tag=${this.mcTag.join(",")}&role_type=${this.primary.toLowerCase()}`);if(200===t.code){let i=t.data.list;this.MyCharactersCount=t.data.page_count;let a="",s=0;const r=$(".edit:not(.recent)").hasClass("active");i.forEach(((e,t)=>{s>=6?s=1:s++;let i=e.json?.tag.split(","),n=e.json.Character_author?jsonAiGirlFriend.by+" "+e.json.Character_author:"";a+=`<div class="myCharacters_item" data-indexId="${e.id}" data-id="${e.role_id}" data-status="${e.status}">\n                        <div class="headPortrait">\n                          <img src="${e.head_portrait[0]?.url}" alt="" class="avatar" />\n                          <div class="share_icon" style="display: ${r?"none":"flex"};">\n                            <img src="/dist/img/aiFriend/btn_more_normal.svg" />\n                          </div> \n                          <div class="lock_icon" style="display:${2==e.type?"block":"none"}"></div>\n                          <div class="head_shareBox">\n                            <div class="editInbox">\n                              <div class="icon"></div>${jsonAiGirlFriend.edit}\n                            </div>\n                            ${1==e.status&&2!=e.type?`<div class="shareInbox" style="display:">\n                              <div class="icon"></div>${jsonAiGirlFriend.Share}\n                            </div>`:""}\n                          </div>\n                          <div class="deleteChat ${r?"active":""}">\n                            <img src="/dist/img/aiFriend/btn_close_big_normal.svg" alt="" class="" />\n                          </div>\n                        </div>\n                        \n                        <div class="character_info">\n                          <div class="character_name">\n                            <div class="name">${e.name}</div>\n                            ${n?`<div class="author">${n}</div>`:""}\n                          </div>\n                          <div class="infoBox">\n                            <div class="info_l">\n                              <div class="like_icon ${1===e.is_like?"active":""}"" data-likes="${e.like_num}" style="display:${4!=e.status?"block":"none"}"></div>\n                                    </div>\n                            <div class="info_r">\n                            ${4!=e.status?`<button class="chatNow">${jsonAiGirlFriend.chatNow}</button>`:`<button class="editDraft"><div class="icon"></div>${jsonAiGirlFriend.edit}</button>`}\n                            </div>\n                          </div>\n                        </div>\n                        <div class="brief_hover"></div>\n                        <div class="brief">\n                          <div class="brief_top">\n                            <img class="brief_avatar" src="${e.head_portrait[0]?.url}"/>\n                            <div class="tagBox">\n                              <div class="brief_tag" style="display:${i.length>1&&i[i.length-2]?"block":"none"}">${jsonAiGirlFriend.setting_tag[i[i.length-2]]||i[i.length-2]}</div>\n                                    <div class="brief_tag" style="display:${i.length>0&&i[i.length-1]?"block":"none"}">${jsonAiGirlFriend.setting_tag[i[i.length-1]]||i[i.length-1]}</div>\n                          </div>\n                        </div>\n                        <div class="brief_name">${e.json.Character_name}</div>\n                        ${n?`<div class="brief_author">${n}</div>`:""}\n                        <div class="brief_created">${e.json.Created}</div>\n                        <div class="brief_des">${e.json.Character_des}</div>\n                      </div>\n                      </div>`})),e?(this.mycharactersList=i,$(".myCharacters").html(a)):(this.mycharactersList=[...this.mycharactersList,...i],$(".myCharacters").append(a)),this.numMy--,this.isShowMyCharacterLoading(!1)}}catch(e){this.numMy--,this.isShowMyCharacterLoading(!1),console.log(e,"error Failed to initialize my chat partner")}else this.resetMy=!0}async GetRecentChatting(){try{const e=await fetchGet("chat/user/get-role-list?type=recent_chatting");if(200===e.code){let t=e.data.list;if(t.length>0){const e=$(".edit.recent").hasClass("active");$(".Recent_hr").css("display","flex"),$(".RecentChatting").css("display","flex"),this.recentCharacters=t;let i="";t.forEach(((t,a)=>{i+=`<div class="Recent_item" data-index="${a}" data-id="${t.chat_id}">\n                          <img src="${t.head_portrait[0]?.url}" alt="" class="recent_head_port"/>\n                          <div class="name">${t.name}</div>\n                          <div class="deleteChat recent ${e?"active":""}" style="display: ${e?"flex":"none"};">\n                            <img src="/dist/img/aiFriend/btn_close_normal.svg" alt="" class="" />\n                          </div>\n                        </div>`})),$(".RecentChattingBox").html(i),setTimeout((()=>{this.composeRecent()}),200)}else $(".Recent_hr").hide(),$(".RecentChatting").hide(),$(".RecentChattingBox").html(""),$(".edit.recent").removeClass("active").text(jsonAiGirlFriend.edit)}}catch(e){console.log(e,"error Failed to initialize recentCharacters")}}async GetClassify(e){if(e.length>0){this.classifys=e;let t=`<div class="classify_item active" data-tag=''>${jsonAiGirlFriend.AllCharacters}</div>`,i="";e.forEach((e=>{const a=jsonAiGirlFriend.setting_tag[e]||e;t+=`<div class="classify_item" data-tag='${e}'>${a}</div>`,i+=`<div class="check_item">\n                                <input type="checkbox" value="${e}" class="createMc_radio" />\n                                <label for="${e}">${a}</label>\n                              </div>`})),$(".classify_box_container").append(t),$(".createMc_checkbox").html(i),setTimeout((()=>{this.composeClassify($(".SegmentBox")),this.composeClassify($(".myCharactersBox"))}),200)}}async GetSetting(){$(".voicePoolBox_loading").show();try{const e=await fetchGet("chat/user/get-setting");if(200===e.code){let t=e.data.voice;if(this.GetClassify(e.data.tag),t.length>0){this.voiceArr=t,this.voice_json=t[0],this.voicePool_json=t[0],$("#voicePool_type").attr("src",t[0].ai_url_2);let e="",i="";t.forEach(((t,a)=>{const s=jsonAiGirlFriend.setting_voice[t.name]||t;e+=`<div class="voice_item" data-name='${t.name}'>\n                          <div class="icon"></div>${s.name}\n                        </div>`,i+=`<div class="voicePool_item ${0==a?"active":""}">\n                                <div class="pool_avatar">\n                                  <img src="${t.image_url}" alt="">\n                                </div>\n                                <div class="pool_des">\n                                  <div>${s.name_desc}</div>\n                               </div>\n                                <div class="pool_voice" data-name='${t.name}'>\n                                  <div class="icon"></div>${s.name}\n                                </div>\n                              </div>`})),$(".voice_box").html(e),$(".voicePool_box").html(i),$(".voiceBtnCreate").show(),$(".voicePoolBox_loading").hide()}}}catch(e){console.log(e,"error Failed to initialize voice")}}async GetIfications(e=!0){if(e&&(this.informaPage=0,$(".inform_list").html("")),this.isLoadingInform||""===this.informaPage||!getCookie("access_token"))return;this.isLoadingInform=!0;let t=!1;try{const i=await fetchGet(`chat/notifications/list?page=${this.informaPage}`);if(200===i.code){let a=i.data.list;if(a.length>0){this.informaPage=""!==i.data.page?i.data.page:"";let s="";a.forEach(((e,i)=>{let a=1==e.status,r=e.head_portrait?e.head_portrait:defaultHeadImg;a&&(t=!0),s+=`<div class="inform_item ${a?"unlook":""}">\n                            <div class="inform_avatar">\n                              <img src="${r}" alt="">\n                            </div>\n                            <div class="inform_info_box">\n                              <div class="inform_info_name">${e.user_name}</div>\n                              <div class="inform_info_text">${e.title}</div>\n                              <div class="inform_info_time">${checkTimestamp(e.created_at)}</div>\n                            </div>\n                            <div class="inform_chat">\n                              <img src="${e.image}" alt="">\n                            </div>\n                          </div>`})),e?$(".inform_list").html(s):$(".inform_list").append(s),t?($("#header_inform").addClass("unlook"),this.unlook=!0):(this.unlook=!1,$("#header_inform").removeClass("unlook")),$(".noInform").hide(),$(".inform_list").show()}else $(".noInform").css("display","block"),$(".inform_list").hide();informTimer=setTimeout((()=>{this.GetIfications()}),12e4)}this.isLoadingInform=!1}catch(e){this.isLoadingInform=!1,console.log(e,"error Failed to initialize voice")}}async clearIfication(){this.unlook&&await fetchPost("chat/notifications/clear"),this.GetIfications()}async GetSettingInfo(e){for(;tryTimes<=3;){try{let t=await fetchPost("ai/tool/get-task",{id:e});if(200===t.code){if(0===t.data.status){const e=t.data.additional_data;return this.mc_Dialogue=e.example_chat,this.mc_Greeting=e.greeting,this.mc_Persona=e.persona,this.mc_Scenario=e.scenario,$(".createMC_persona").val(this.mc_Persona).get(0).dispatchEvent(evt),$(".createMC_Greeting").val(this.mc_Greeting).get(0).dispatchEvent(evt),$(".createMC_Scenario").val(this.mc_Scenario).get(0).dispatchEvent(evt),$(".createMC_Dialogue").val(this.mc_Dialogue).get(0).dispatchEvent(evt),void(this.editMcType="edit")}}else{if(!(tryTimes<=3))return void $Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"});console.log("try repeat1 -",tryTimes),tryTimes++,await new Promise((e=>setTimeout(e,2e3)))}}catch(e){return console.log(e,"error"),tryTimes<=3?(console.log("try repeat2 -",tryTimes),tryTimes++,void await new Promise((e=>setTimeout(e,2e3)))):void $Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"})}await new Promise((e=>setTimeout(e,2e3)))}}async addTaskGetSettingInfo(){try{const e=await fetchPost("ai/ai-tool/add-task",{action:"aichat_role_generate",param:{type:2,name:this.mc_Name,description:this.mc_Desc,lang:questLanguage}});if(tryTimes=0,200!=e.code)return void $Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"});await this.GetSettingInfo(e.data.task_id)}catch(e){$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"}),console.log(e,"error get-task")}}async GetRoleInfo(e,t=2,i=0){try{const a=await fetchGet(`chat/user/get-role-info?id=${e}&is_my_characters=${t}&my_characters_id=${i}`);if(200===a.code){let e=a.data;this.my_characters_id=e.my_characters_id,this.mc_Avatar=e.head_portrait[0].url,this.mc_Name=e.name,this.mc_Desc=e.json.Character_des,this.mc_Background=e.head_portrait_background[0]?.url,this.mc_Persona=e.persona,this.mc_Gender=e.json.gender,this.is_draft=4==e.status,this.mc_visibility=1==e.type?jsonAiGirlFriend.classifySelect.Public:jsonAiGirlFriend.classifySelect.Private,this.mc_Categories=e.json.tag.length>0?e.json.tag.split(","):[],this.mc_Greeting=e.role_content.greeting.toString(),this.mc_Scenario=e.role_content["scene description"],this.mc_Dialogue=e.role_content.context,this.head_portrait=e.head_portrait,this.head_portrait_background=e.head_portrait_background,this.mc_roleId=e.role_id,this.voice_json=e.voice_json?e.voice_json:this.voiceArr[0],$("#createMC_background_img").attr("src",e.head_portrait_background[0]?.url),$("#createMC_avatar_img").attr("src",e.head_portrait[0]?.url),$(".whiteMeOut").val(this.mc_Desc).get(0).dispatchEvent(evt),$(".createMC_name").val(this.mc_Name).get(0).dispatchEvent(evt),$(".createMC_gender").val(this.mc_Gender).get(0).dispatchEvent(evt),$(".createMC_persona").val(this.mc_Persona).get(0).dispatchEvent(evt),$(".createMC_Greeting").val(this.mc_Greeting).get(0).dispatchEvent(evt),$(".createMC_Scenario").val(this.mc_Scenario).get(0).dispatchEvent(evt),$(".createMC_Dialogue").val(this.mc_Dialogue).get(0).dispatchEvent(evt),this.oldRoleInfo={role_id:this.mc_roleId,name:this.mc_Name,type:this.mc_visibility,is_draft:this.is_draft,tag:this.mc_Categories.join(","),description:this.mc_Desc,persona:this.mc_Persona,scene:this.mc_Scenario,greeting:this.mc_Greeting,context:this.mc_Dialogue,head_portrait:JSON.stringify(this.head_portrait),head_portrait_background:JSON.stringify(this.head_portrait_background)}}}catch(e){console.log(e,"error get role info")}}async GetAiDesc(e=()=>{}){try{const t=await fetchGet("chat/user/get-setting?type=role");if(200===t.code){let i=t.data;const a=randomchoice(i);$(".whiteMe").val(a().description),e?.()}}catch(e){console.log(e,"error get role info")}}async roleEdit(e=()=>{},t=()=>{}){try{let i;this.mc_visibility==jsonAiGirlFriend.classifySelect.Public?(i=1,gtag("event","public_aigirlfriend_edit")):(i=2,gtag("event","private_aigirlfriend_edit"));let a=this.is_draft?1:2,s=this.head_portrait,r=this.head_portrait_background;delete s.url,delete r.url;const n={role_id:this.mc_roleId,my_characters_id:this.my_characters_id,name:this.mc_Name.trim(),type:i,is_draft:a,persona:this.mc_Persona.trim(),gender:this.mc_Gender.trim(),tag:this.mc_Categories.join(","),description:this.mc_Desc.trim(),scene:this.mc_Scenario.trim(),greeting:this.mc_Greeting.trim(),context:this.mc_Dialogue.trim(),head_portrait:JSON.stringify(s),head_portrait_background:JSON.stringify(r),voice_json:JSON.stringify(this.voice_json)},c=await fetchPost("chat/user/role-edit",n,{},!1);if(401==c.code){gtag("event","alert_aigirlfriend_loginwinedit");let e=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),e.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:()=>{gtag("event","notnow_aigirlfriend_loginwindit"),e.close(),this.clearInput(),this.closeCD()},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}});t?.()}else 200===c.code?e?.():(this.is_draft?$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.draftSaveError,type:"error"}):$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.publishError,type:"error"}),t?.())}catch(e){console.log(t,"error"),this.is_draft?$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.draftSaveError,type:"error"}):$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.publishError,type:"error"}),t?.(),console.log(e," create or edit role error")}}addRecentChatting(e){console.log(e,"addRecentChatting");const t=e.chat_id,i=this.recentCharacters.findIndex((e=>e.chat_id==t)),a=$(".edit.recent").hasClass("active");let s="";-1!=i?($(".RecentChattingBox").children().eq(i).insertBefore($(".RecentChattingBox").children().eq(0)),$(".Recent_item").eq(0).find(".recent_head_port").attr("src",e.head_portrait[0]?.url),$(".Recent_item").eq(0).find(".name").text(e.name),this.recentCharacters.splice(i,1)):(s=`<div class="Recent_item" data-id="${e.chat_id}">\n        <img src="${e.head_portrait[0]?.url}" alt="" class='recent_head_port'/>\n        <div class="name">${e.name}</div>\n        <div class="deleteChat recent ${a?"active":""}" style="display: ${a?"flex":"none"};">\n          <img src="/dist/img/aiFriend/btn_close_normal.svg" alt="" class="" />\n        </div>\n      </div>`,$(".RecentChattingBox").prepend(s)),this.recentCharacters.unshift(e),$(".Recent_hr").css("display","flex"),$(".RecentChatting").css("display","flex"),setTimeout((()=>{this.composeRecent()}),500)}clickFn(){let e=this;const t=$("#voice_type"),i=$("#voicePool_type");function a(){gtag("event","alert_aigirlfriend_loginwinedit");const t=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),t.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:()=>{gtag("event","notnow_aigirlfriend_loginwindit"),t.close(),e.closeCD()},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}})}t.on("ended",(function(){$(".voice_item.active .icon").removeClass("active")})),t.on("play",(function(){$(".voice_item.active .icon").addClass("active")})),t.on("pause",(function(){$(".voice_item.active .icon").removeClass("active")})),i.on("ended",(function(){$(".pool_voice.active .icon").removeClass("active")})),i.on("play",(function(){$(".pool_voice.active .icon").addClass("active")})),i.on("pause",(function(){$(".pool_voice.active .icon").removeClass("active")})),$(".heart").click((function(){$(".Characters_hr")[0].scrollIntoView({behavior:"instant",block:"start",inline:"end"}),$(this).hasClass("active")?e.isLike=!1:(e.isLike=!0,gtag("event","like_aigirlfriend_hfilter")),$(this).toggleClass("active"),e.initCharacters()})),$(".Segment_item").click((function(){$(".Segment_item").removeClass("active"),$("body")[0].scrollIntoView({behavior:"instant",inline:"nearest"}),$(this).addClass("active"),$(".myCharactersBox,.voicePoolBox_banner,.SegmentBox,.voicePoolBox").hide(),$(".createBtn").show(),"myCharacters"===$(this).attr("id")?(gtag("event","click_aigirlfriend_mytab"),e.tab="my",$(".myCharactersBox").show(),e.composeClassify($(".myCharactersBox"))):"voicepool"===$(this).attr("id")?(e.tab="voice",$(".voicePoolBox,.voicePoolBox_banner").show(),$(".createBtn").hide()):(gtag("event","click_aigirlfriend_htab"),e.tab="all",$(".SegmentBox").show(),e.composeRecent(),e.composeClassify($(".SegmentBox")))})),$(".edit").click((function(){$(this).hasClass("active")?($(this).removeClass("active"),$(this).text(jsonAiGirlFriend.edit),$(this).hasClass("recent")?($(".Recent_item .deleteChat").removeClass("active").hide(),gtag("event","click_aigirlfriend_hrctedit")):($(".myCharacters_item .deleteChat").removeClass("active").hide(),gtag("event","click_aigirlfriend_mycedit"),$(".myCharacters_item .share_icon").css("display","flex"))):($(this).addClass("active"),$(this).text(jsonAiGirlFriend.Done),$(this).hasClass("recent")?($(".Recent_item .deleteChat").addClass("active").css("display","flex"),gtag("event","click_aigirlfriend_hrctedit")):($(".myCharacters_item .deleteChat").addClass("active").show(),gtag("event","click_aigirlfriend_mycedit"),$(".myCharacters_item .share_icon").hide()))})),$(".createMc").click((function(){e.lastTab=e.tab,e.editMcType="create",$(this).hasClass("createBtn")?gtag("event","click_aigirlfriend_create"):gtag("event","click_aigirlfriend_nodatacreate")})),$(".create_back_box,.mc_btn.discard").click((function(){const t=$(this).hasClass("create_back_box");if("edit"==e.editMcType)if($(this).hasClass("discard")?gtag("event","discard_aigirlfriend_edit"):gtag("event","back_aigirlfriend_edit"),getCookie("access_token")){let i={role_id:e.mc_roleId,name:e.mc_Name,type:e.mc_visibility,is_draft:e.is_draft,tag:e.mc_Categories.join(","),description:e.mc_Desc,scene:e.mc_Scenario,persona:e.mc_Persona,greeting:e.mc_Greeting,context:e.mc_Dialogue,head_portrait:JSON.stringify(e.head_portrait),head_portrait_background:JSON.stringify(e.head_portrait_background)};if(areObjectsEqual(i,e.oldRoleInfo))e.clearInput(),e.closeCD(!t,t);else{const i=$Popup({title:jsonAiGirlFriend.toSaveTitle,content:jsonAiGirlFriend.toSaveDesc,closeBtn:jsonAiGirlFriend.save,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{i.loading.start(),e.is_draft=!0,e.editDraftUpload((()=>{i.close()}),(()=>{i.close()}))},onApply:()=>{i.close(),e.clearInput(),e.closeCD(!t,t)}})}}else{gtag("event","alert_aigirlfriend_loginwinedit");const i=$Popup({title:jsonAiGirlFriend.createMc.bootLoginTitle,content:jsonAiGirlFriend.createMc.bootLoginDesc,closeBtn:jsonAiGirlFriend.login,applyBtn:jsonAiGirlFriend.createMc.NotNow,autoClose:!1,exist:"bootLogin",onClose:()=>{gtag("event","login_aigirlfriend_loginwinedit"),i.close(),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwinedit")}})},onApply:async()=>{gtag("event","notnow_aigirlfriend_loginwindit"),i.close(),e.clearInput(),e.closeCD(!t,t)},topCloseFn:()=>{gtag("event","close_aigirlfriend_loginwinedit")}})}else e.clearInput(),e.closeCD(!t,t)})),$("#createMc").click((async function(){let t=!0;e.mc_Avatar?$(".erorrTip[data-type='avatar']").css("visibility","hidden"):($(".erorrTip[data-type='avatar']").find(".image_error").text(jsonAiGirlFriend.createMc.avatar_not),$(".erorrTip[data-type='avatar']").css("visibility","visible"),t=!1),e.mc_Name&&0!=$(".maxLength[data-input='name'] span").text()?$(".erorrTip[data-type='name']").css("visibility","hidden"):($(".erorrTip[data-type='name']").css("visibility","visible"),t=!1),e.mc_Desc&&0!=$(".maxLength[data-input='description'] span").text()?$(".erorrTip[data-type='description']").css("visibility","hidden"):($(".erorrTip[data-type='description']").css("visibility","visible"),t=!1),t&&(gtag("event","click_aigirlfriend_aicreate"),e.oldRoleInfo={role_id:e.mc_roleId,name:e.mc_Name,type:e.mc_visibility,is_draft:e.is_draft,tag:e.mc_Categories.join(","),description:e.mc_Desc,scene:e.mc_Scenario,greeting:e.mc_Greeting,persona:e.persona,context:e.mc_Dialogue,head_portrait:JSON.stringify(e.head_portrait),head_portrait_background:JSON.stringify(e.head_portrait_background)},$(this).addClass("loading"),$(".createMc_item,.create_back_box").addClass("loading"),await e.addTaskGetSettingInfo(),$(this).removeClass("loading"),$(".createMc_item,.create_back_box").removeClass("loading"))})),$("#editMc").click((async function(){gtag("event","publish_aigirlfriend_edit");let t=!0;if(e.mc_Avatar?$(".erorrTip[data-type='avatar']").css("visibility","hidden"):($(".erorrTip[data-type='avatar']").find(".image_error").text(jsonAiGirlFriend.createMc.avatar_not),$(".erorrTip[data-type='avatar']").css("visibility","visible"),t=!1),e.mc_Name&&0!=$(".maxLength[data-input='name'] span").text()?$(".erorrTip[data-type='name']").css("visibility","hidden"):($(".erorrTip[data-type='name']").css("visibility","visible"),t=!1),e.mc_Persona&&0!=$(".maxLength[data-input='persona'] span").text()?$(".erorrTip[data-type='persona']").css("visibility","hidden"):($(".erorrTip[data-type='persona']").css("visibility","visible"),t=!1),e.mc_Desc&&0!=$(".maxLength[data-input='description'] span").text()?$(".erorrTip[data-type='description']").css("visibility","hidden"):($(".erorrTip[data-type='description']").css("visibility","visible"),t=!1),0==e.mc_Categories.length?($(".erorrTip[data-type='Categories']").css("visibility","visible"),t=!1):$(".erorrTip[data-type='Categories']").css("visibility","hidden"),e.mc_Greeting&&0!=$(".maxLength[data-input='Greeting'] span").text()?$(".erorrTip[data-type='Greeting']").css("visibility","hidden"):($(".erorrTip[data-type='Greeting']").css("visibility","visible"),t=!1),e.mc_Scenario&&0!=$(".maxLength[data-input='Scenario'] span").text()?$(".erorrTip[data-type='Scenario']").css("visibility","hidden"):($(".erorrTip[data-type='Scenario']").css("visibility","visible"),t=!1),!t)return;if(!getCookie("access_token"))return void a();e.is_draft=!1,$(this).addClass("loading");const i=()=>$(this).removeClass("loading");await e.editDraftUpload(i,i,"all")})),$("#draftMc").click((async function(){if(gtag("event","draft_aigirlfriend_edit"),!getCookie("access_token"))return void a();e.is_draft=!0,$(this).addClass("loading");const t=()=>$(this).removeClass("loading");await e.editDraftUpload(t,t,"draft")})),$("#createMC_avatar").on("change",(async function(t){e.isUploadAvatar=!0,e.uploadImage($(".createMyCharacter_Box .avatar"),t,this,"avatar",(()=>{$(this).val("")}))})),$("#createMC_background").on("change",(async function(t){e.isUploadBackground=!0,e.uploadImage($("#background"),t,this,"background",(()=>{$(this).val("")}))})),$("#editUserAvatar").on("change",(async function(t){e.isUploadUserAvatar=!0,e.uploadImage($(".modal.editUser .avatar"),t,this,"editAvatar",(()=>{$(this).val("")}))})),$(".writeMe").click((function(){gtag("event","show_aigirlfriend_aiwrite");let t=$Popup({type:"createMC",title:jsonAiGirlFriend.createMc.writeMe_title,content:$(".whiteMeContent").html(),closeBtn:jsonAiGirlFriend.createMc.Generate,applyBtn:jsonAiGirlFriend.createMc.Apply,autoClose:!1,exist:"exist",onClose:()=>{gtag("event","generate_aigirlfriend_aiwrite"),t.loading.start(),e.GetAiDesc((()=>{t.loading.end()}))},onApply:()=>{gtag("event","apply_aigirlfriend_aiwrite");const i=$(".createMC .whiteMe").val();i.length>0&&(e.mc_Desc=i,t.close())}})})),$(".whiteMe,.whiteMeOut").on("input",(function(){const t=e.inputCharacter($(this),500,"description");$(this).hasClass("whiteMeOut")&&(e.mc_Desc=t)})),$(".createMC_name").on("input",(function(){const t=e.inputCharacter($(this),30,"name");e.mc_Name=t})),$(".createMC_gender").on("input",(function(){const t=e.inputCharacter($(this),30,"gender");e.mc_Gender=t})),$(".createMC_persona").on("input",(function(){const t=e.inputCharacter($(this),500,"persona");e.mc_Persona=t})),$(".createMC_Greeting").on("input",(function(){const t=e.inputCharacter($(this),330,"Greeting");e.mc_Greeting=t})),$(".createMC_Scenario").on("input",(function(){const t=e.inputCharacter($(this),500,"Scenario");e.mc_Scenario=t})),$(".createMC_Dialogue").on("input",(function(){const t=e.inputCharacter($(this),700,"Dialogue");e.mc_Dialogue=t})),$(".header_editUser").click((()=>{gtag("event","editprofile_aigirlfriend_header"),$(".signout").hide(),e.clearUserData();let t=$Popup({type:"editUser",title:jsonAiGirlFriend.editUser.title,content:$(".editUserInfo").html(),closeBtn:jsonAiGirlFriend.editUser.save,applyBtn:jsonAiGirlFriend.editUser.cancel,autoClose:!1,exist:"editUser",onClose:()=>{let i=!0;e.editUser_Avatar?$(".erorrTip[data-type='editUserAvatar']").css("visibility","hidden"):($(".erorrTip[data-type='editUserAvatar']").find(".image_error").text(jsonAiGirlFriend.createMc.avatar_not),$(".erorrTip[data-type='editUserAvatar']").css("visibility","visible"),i=!1),e.editUser_firstName?$(".erorrTip[data-type='editUser_firstName']").css("visibility","hidden"):($(".erorrTip[data-type='editUser_firstName']").css("visibility","visible"),i=!1),e.editUser_lastName?$(".erorrTip[data-type='editUser_lastName']").css("visibility","hidden"):($(".erorrTip[data-type='editUser_lastName']").css("visibility","visible"),i=!1),i&&(t.loading.start(),$(".modal .createMc_item").addClass("loading"),e.userInfoUpdate((()=>{$(".modal .createMc_item").removeClass("loading"),t.loading.end(),t.close(),e.clearUserData(),updateUserData()}),(()=>{t.loading.end()})))},onApply:async()=>{t.close(),e.clearUserData()}});e.getUserData(),e.clickUserEvent()})),$(".voiceBtnCreate").click((()=>{e.lastTab=e.tab,gtag("event","click_aigirlfriend_voicecreate"),e.clearInput(),e.voice_json={...e.voicePool_json},e.editMcType="create",i[0].pause()})),$("body").on("mouseup",(async function(a){const s=$(a.target),r=0!=s.parents(".characters_item").length||s.hasClass("characters_item"),n=0!=s.parents(".myCharacters_item").length||s.hasClass("myCharacters_item");let c;if(r){let t=s.parents(".characters_item").attr("data-indexid");c=e.charactersList.findIndex((e=>parseInt(e.id)==parseInt(t)))}if(n){let t=s.parents(".myCharacters_item").attr("data-indexid"),i=e.mycharactersList.findIndex((e=>parseInt(e.id)==parseInt(t)));c=i>=0?i:c}if(0!=s.parents(".chatSelect").length||s.hasClass("chatSelect")||$(".chatSelect").removeClass("active").children(".select_list").slideUp(),0==s.parents(".head_shareBox").length&&$(".head_shareBox").hide(),s.hasClass("like_icon")){const t=s.parents(".characters_item").data("id")||s.parents(".myCharacters_item").data("id"),i=s.parents(".myCharacters_item").find(".deleteChat");if(0!=i.length&&i.hasClass("active"))return;if(0!=s.parents(".characters_item").length){let t=s.data("likes");s.hasClass("active")?(t>0?t--:t=0,s.siblings(".num").text(formatNumber(t)),s.siblings(".like_num").text(t>1?jsonAiGirlFriend.likes:jsonAiGirlFriend.like),s.data("likes",t),e.charactersList[c].is_like=2):(t++,s.siblings(".num").text(formatNumber(t)),s.siblings(".like_num").text(t>1?jsonAiGirlFriend.likes:jsonAiGirlFriend.like),s.data("likes",t),gtag("event","click_aigirlfriend_hlikebtn"),e.charactersList[c].is_like=1)}else s.hasClass("active")?e.mycharactersList[c].is_like=2:(gtag("event","click_aigirlfriend_myclikebtn"),e.mycharactersList[c].is_like=1);return s.toggleClass("active"),void e.changeLike(t)}if(0==s.parents(".share_icon").length)if(s.hasClass("shareInbox")){if(r){gtag("event","click_aigirlfriend_hshare");const t=e.charactersList[c];e.showShare(t.role_id,t.head_portrait[0].value)}else{gtag("event","click_aigirlfriend_mycshare");const t=e.mycharactersList[c];e.showShare(t.role_id,t.head_portrait[0].value)}$(".head_shareBox").hide()}else if(s.hasClass("editInbox"))if(e.lastTab=e.tab,e.editMcType="edit",$("body")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),0!=s.parents(".characters_item").length){gtag("event","click_aigirlfriend_hedit");const t=e.charactersList[c];await e.GetRoleInfo(t.role_id,1,t.my_chat_id)}else{gtag("event","click_aigirlfriend_mycchatedit");const t=e.mycharactersList[c];await e.GetRoleInfo(t.role_id,1,t.my_characters_id)}else if(s.hasClass("classify_item")){$(".description")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"end"});const t=0!=s.parents(".SegmentBox").length,i=s.data("tag");if(ttsBlank(i))t?(e.homeTag=[],gtag("event","htag_aigirlfriend_allcharacters"),$(".SegmentBox .classify_item").removeClass("active"),$(".SegmentBox .classify_item").eq(0).addClass("active")):(e.mcTag=[],gtag("event","mytag_aigirlfriend_allcharacters"),$(".myCharactersBox .classify_item").removeClass("active"),$(".myCharactersBox .classify_item").eq(0).addClass("active"));else{if(t){$(".SegmentBox .classify_item").eq(0).removeClass("active");let t=e.homeTag.findIndex((e=>e===i));if(-1!==t)e.homeTag.splice(t,1);else{e.homeTag.push(i);let t=s.attr("data-tag");t=t.replace(/\s+/g,"").toLowerCase(),gtag("event",`htag_aigirlfriend_${t}`)}const a=e.homeTag;e.homeTag=a,0==e.homeTag.length&&$(".SegmentBox .classify_item").eq(0).addClass("active")}else{$(".myCharactersBox .classify_item").eq(0).removeClass("active");let t=e.mcTag.findIndex((e=>e===i));if(-1!==t)e.mcTag.splice(t,1);else{e.mcTag.push(i);let t=s.attr("data-tag");t=t.replace(/\s+/g,"").toLowerCase(),gtag("event",`mytag_aigirlfriend_${t}`)}const a=e.mcTag;e.mcTag=a,0==e.mcTag.length&&$(".myCharactersBox .classify_item").eq(0).addClass("active")}s.toggleClass("active")}}else if(s.hasClass("createMc_radio"))setTimeout((()=>{if(s.is(":checked"))e.mc_Categories.push(s.attr("value"));else{const t=s.attr("value"),i=e.mc_Categories.findIndex((e=>e==t));e.mc_Categories.splice(i,1)}const t=e.mc_Categories;e.mc_Categories=t;let i="";i=(e.mc_Categories.length>1?jsonAiGirlFriend.createMc.Categories_tips:jsonAiGirlFriend.createMc.Categories_tip).replace("%ss",e.mc_Categories.length),$(".checkNum").text(i)}),5);else if(0!=s.parents(".deleteChat").length){let t;if(s.parents(".deleteChat").hasClass("recent")){gtag("event","click_aigirlfriend_hrctdelete");const i=s.parents(".Recent_item").attr("data-id");t=$Popup({title:jsonAiGirlFriend.deleteRecentTitle,content:jsonAiGirlFriend.deleteRecentText,closeBtn:jsonAiGirlFriend.Delete,otherBtns:`<button class="cannel">${jsonAiGirlFriend.Cancel}</button>`,autoClose:!1,exist:"deletePop",onClose:()=>{gtag("event","del_aigirlfriend_hrctdelete"),t.loading.start(),e.deleteChat(i,(async()=>{await e.GetRecentChatting(),t.close()}))}}),$(".modal .cannel").click((()=>{gtag("event","cancel_aigirlfriend_hrctdelete"),t.close()}))}else{gtag("event","click_aigirlfriend_mycdelete");const i=e.mycharactersList[c].my_characters_id;t=$Popup({title:jsonAiGirlFriend.deleteMyChatTitle,content:jsonAiGirlFriend.deleteMyChatText,closeBtn:jsonAiGirlFriend.Delete,otherBtns:`<button class="cannel">${jsonAiGirlFriend.Cancel}</button>`,autoClose:!1,exist:"deletePop",onClose:()=>{gtag("event","del_aigirlfriend_mycdelete"),t.loading.start(),e.deleteMyChat(i,(async()=>{await e.GetMyCharacters(),await e.GetRecentChatting(),t.close()}))}}),$(".modal .cannel").click((()=>{gtag("event","cancel_aigirlfriend_mycdelete"),t.close()}))}}else{if(0!=s.parents(".characters_item").length)return s.hasClass("chatNow")?gtag("event","click_aigirlfriend_hchatbtn"):gtag("event","click_aigirlfriend_hcard"),void aiChatting.init(e.charactersList[c]);if(0!=s.parents(".myCharacters_item").length){if(s.hasClass("chatNow")?gtag("event","click_aigirlfriend_mycchatbtn"):gtag("event","click_aigirlfriend_myccard"),s.parents(".myCharacters_item").find(".deleteChat").hasClass("active"))return;if(4!=s.parents(".myCharacters_item").attr("data-status"))aiChatting.init(e.mycharactersList[c]);else{gtag("event","click_aigirlfriend_myccardedit"),e.lastTab=e.tab,e.editMcType="edit";let t=e.mycharactersList[c];await e.GetRoleInfo(t.role_id,1,t.my_characters_id)}return}if(0!=s.parents(".Recent_item").length){if(s.parents(".Recent_item").find(".deleteChat").hasClass("active"))return;gtag("event","click_aigirlfriend_hrctcard");const t=s.parents(".Recent_item").attr("data-id"),i=e.recentCharacters.findIndex((e=>e.chat_id==t));return void aiChatting.init(e.recentCharacters[i])}if(0!=s.parents(".voicePool_item").length||s.hasClass("voicePool_item")){e.voiceOpen="pool_voice";let i=0!=s.parents(".voicePool_item").length?s.parents(".voicePool_item"):s;$(".voicePool_item").removeClass;let a=i.find(".pool_voice");const r=$("#voicePool_type")[0],n=a.attr("data-name");switch(n){case"Sexy(Male)":gtag("event","click_aigirlfriend_voicesexy2");break;case"Youth(Male)":gtag("event","click_aigirlfriend_voiceyouth2");break;case"Bass(Male)":gtag("event","click_aigirlfriend_voicebass2");break;default:gtag("event",`click_aigirlfriend_voice${n.toLowerCase()}`)}if(a.hasClass("active"))return void(r.paused?r.play():r.pause());const c=e.voiceArr.findIndex((e=>e.name==n));e.voicePool_json=e.voiceArr[c];const o=e.voiceArr[c].ai_url_2;$(".voicePool_item,.pool_voice").removeClass("active"),$(".pool_voice .icon").removeClass("active"),i.addClass("active"),a.addClass("active"),r.pause(),r.setAttribute("src",o),r.currentTime=0,t[0].pause(),setTimeout((()=>{r.play()}),30)}else if(0!=s.parents(".voice_item").length||s.hasClass("voice_item")){e.voiceOpen="voice_item";let t=0!=s.parents(".voice_item").length?s.parents(".voice_item"):s;const a=$("#voice_type")[0];if(t.hasClass("active"))return void(a.paused?a.play():a.pause());const r=t.attr("data-name"),n=e.voiceArr.findIndex((e=>e.name==r));e.voice_json=e.voiceArr[n],i[0].pause(),setTimeout((()=>{a.play()}),30)}else if(0!=s.parents(".addImage").length||s.hasClass("addImage")){let e=0!=s.parents(".addImage").length?s.parents(".addImage"):s;0!=e.parents(".avatar").length?0!=e.parents(".editUser").length?$("#editUserAvatar").click():$("#createMC_avatar").click():0!=e.parents(".background").length&&$("#createMC_background").click()}else if(s.hasClass("select_list_item")){const t=s.data("sort_time"),i=s.data("sort"),a=s.data("type"),r=s.data("primary"),n=s.data("age");if(0!=s.parents("#select_sort_time").length&&(e.sort_time=t),0!=s.parents("#select_sort").length&&(e.sort=i,"top"==i?$(".select_time").css("display","flex"):$(".select_time").hide()),0!=s.parents(".editUserAge").length)switch(e.editUserAge=n,s.parents(".select_list").siblings(".select_content").attr("data-age",n),n){case"1-10":gtag("event","click_aigirlfriend_agerange1");break;case"10-15":gtag("event","click_aigirlfriend_agerange2");break;case"15-20":gtag("event","click_aigirlfriend_agerange3");break;case"20-25":gtag("event","click_aigirlfriend_agerange4");break;case"25-30":gtag("event","click_aigirlfriend_agerange5");break;case"30-40":gtag("event","click_aigirlfriend_agerange6");break;case"40-50":gtag("event","click_aigirlfriend_agerange7");break;case"50+":gtag("event","click_aigirlfriend_agerange8")}if(ttsBlank(a)||(e.mc_visibility=a),0!=s.parents(".classify").length)switch(e.composeClassify($(".myCharactersBox")),e.primary=r,r){case"":gtag("event","all_aigirlfriend_filter");break;case jsonAiGirlFriend.classifySelect.Public:gtag("event","public_aigirlfriend_filter");break;case jsonAiGirlFriend.classifySelect.Private:gtag("event","private_aigirlfriend_filter");break;case jsonAiGirlFriend.classifySelect.Draft:gtag("event","draft_aigirlfriend_filter")}if("sort"===Object.keys(s.data())[0]&&0!=s.parents(".character_select").length)switch(getCookie("access_token")?setCookie("aiGirlSort",i):setCookie("aiGirlSort",""),!0){case"top"==i:gtag("event","top_aigirlfriend_hfilter");break;case"hot"==i:gtag("event","hot_aigirlfriend_hfilter")}else switch(!0){case"day"==t:gtag("event","top_aigirlfriend_hdayfilter");break;case"week"==t:gtag("event","top_aigirlfriend_hweekfilter");break;case"month"==t:gtag("event","top_aigirlfriend_hmonthfilter");break;case"year"==t:gtag("event","top_aigirlfriend_hyearfilter");break;case""==t:gtag("event","top_aigirlfriend_halltimefilter")}s.addClass("active"),s.siblings(".select_list_item").removeClass("active"),s.parents(".select_list").siblings(".select_content").text(s.text()),(i||t)&&(0==s.parents(".createMyCharacter_Box ").length&&$(".description")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"end"}),e.initCharacters()),s.parents(".select_list").slideUp(),s.parents(".chatSelect").removeClass("active")}else if(0!=s.parents(".chatSelect").length||s.hasClass("chatSelect")){let e=0!=s.parents(".chatSelect").length?s.parents(".chatSelect"):s;e.hasClass("active")?(e.children(".select_list").slideUp(),e.removeClass("active")):(e.children(".select_list").slideDown(),e.addClass("active"),e.siblings(".chatSelect").children(".select_list").slideUp())}else s.hasClass("delete_image")&&(0!=s.parents(".background").length?e.mc_Background="":0==s.parents(".editUser").length?e.mc_Avatar="":e.editUser_Avatar="")}else{const e=s.parents(".share_icon").siblings(".head_shareBox");e.hasClass("active")?e.removeClass("active").hide():e.addClass("active").show()}})),$(".view,.viewMore,.back").click((function(){$(".Recent_item,.RecentChattingBox").css("transform","translateX(0px)"),$(this).hasClass("active")?($(".view").text(jsonAiGirlFriend.view),$(this).removeClass("active"),$(".RecentChatting").removeClass("viewAll"),e.composeRecent(),$(".viewMore").removeClass("active")):($(".view").text(jsonAiGirlFriend.viewLess),$(this).addClass("active"),$(".btn_left,.btn_right").hide(),$(".RecentChatting").addClass("viewAll"),$(".back").addClass("active"))}))}async editDraftUpload(e,t,i){$(".createMc_item,.create_back_box").addClass("loading");try{if(this.isUploadAvatar){const e=await uploadImagePromise(this.mc_Avatar);this.head_portrait=[{key:"head_portrait",url:e.res.data.access_url,value:e.res.data.key}]}if(this.isUploadBackground){const e=await uploadImagePromise(this.mc_Background);this.head_portrait_background=[{key:"head_portrait_background",url:e.res.data.access_url,value:e.res.data.key}]}}catch(e){t?.(),$(".createMc_item,.create_back_box").removeClass("loading")}await this.roleEdit((()=>{e?.(),$(".createMc_item,.create_back_box").removeClass("loading"),"all"==i?($(".myCharactersBox .classify_select .select_list_item").removeClass("active"),$(".myCharactersBox .classify_select .select_list_item").eq(0).addClass("active"),$(".myCharactersBox .classify_select .select_content").text(jsonAiGirlFriend.classifySelect.All),this.primary=""):"draft"==i&&($(".myCharactersBox .classify_select .select_list_item").removeClass("active"),$(".myCharactersBox .classify_select .select_list_item").eq(3).addClass("active"),$(".myCharactersBox .classify_select .select_content").text(jsonAiGirlFriend.classifySelect.Draft),this.primary=jsonAiGirlFriend.classifySelect.Draft),$(".classify_box_container .classify_item").removeClass("active"),$(".SegmentBox .classify_item").eq(0).addClass("active"),$(".myCharactersBox .classify_item").eq(0).addClass("active"),this.homeTag=[],this.mcTag=[],this.clearInput(),this.closeCD()}),(()=>{t?.(),$(".createMc_item,.create_back_box").removeClass("loading")}))}async isShowCharacterLoading(e,t=!1){return new Promise((async i=>{if(this.isLoading=e,e&&t)return $(".characters_loading").show(),void i(!0);e&&this.num>0?($(".noFound").hide(),$(".characters").hide(),$(".characters_loading").show(),this.isLoadingTimer&&(clearTimeout(this.isLoadingTimer),this.isLoadingTimer=null,this.num>0&&this.num--),this.isLoadingTimer=setTimeout((()=>{i(!0),clearTimeout(this.isLoadingTimer),this.isLoadingTimer=null}),500)):(0==this.charactersList.length?$(".noFound").show():$(".characters").show(),$(".characters_loading").hide())}))}isShowMyCharacterLoading(e,t=!1){return new Promise((async i=>{if(this.isMyLoading=e,""==this.editMcType)return e&&t?($(".Mycharacters_loading").show(),void i(!0)):void(e&&this.numMy>0?($(".noFoundMc").hide(),$(".myCharacters_Box").hide(),$(".Mycharacters_loading").show(),this.isMyLoadingTimer&&(clearTimeout(this.isMyLoadingTimer),this.isMyLoadingTimer=null,this.numMy>0&&this.numMy--),this.isMyLoadingTimer=setTimeout((()=>{i(!0),clearTimeout(this.isMyLoadingTimer),this.isMyLoadingTimer=null}),500)):(0==this.mycharactersList.length?$(".noFoundMc").show():$(".myCharacters_Box").show(),$(".createBtn").hasClass("active")&&$(".myCharacters_Box,.noFoundMc").hide(),$(".Mycharacters_loading").hide()));$(".Mycharacters_loading").hide()}))}changeLike(e){fetchPost("chat/user/role-like",{role_id:e}).catch((function(e){console.log("role-like",e)}))}deleteChat(e,t){fetchPost("chat/user/del-recent-chatting",{chat_id:e}).then((()=>{t?.()})).catch((function(e){console.log("del-recent-chatting",e)}))}deleteMyChat(e,t){fetchPost("chat/user/del-my-characters",{my_characters_id:e}).then((()=>{t?.()})).catch((function(e){console.log("del-my-characters",e)}))}composeRecent(){const e=$(".RecentChatting").width(),t=$(".Recent_item").width(),i=$(".Recent_item").css("margin-right"),a=$(".RecentChatting"),s=$(".RecentChattingBox");s.css("transform","translateX(0px)");let r=(t+parseFloat(i))*$(".Recent_item").length,n=0,c=3*(t+16);isShowBtnLR(n,-(r-e)),$(".btn_right").click((function(){Math.abs(n-c)>=r-e?n=-(r-e):n-=c,s.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-e))})),$(".btn_left").click((function(){n+c>0?n=0:n+=c,s.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-e))})),r>e&&"pc"!=userModel?($(".viewMore").css("visibility","visible"),$(".back").css("display","")):($(".viewMore").css("visibility","hidden"),$(".back").hide(),a.off())}composeClassify(e){const t=e.find(".classify_item"),i=e.find(".classify_box_container").width(),a=e.find(".classify_btn_left"),s=e.find(".classify_btn_right");t.css("transform","translateX(0px)");let r=0;e.find(".classify_item").each((function(){r+=$(this).outerWidth(!0)}));let n=0,c=300;r>i&&"pc"==userModel&&transformBtn(n,-(r-i),a,s),s.click((function(){Math.abs(n-c)>=r-i?n=-(r-i):n-=c,t.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-i),a,s)})),a.click((function(){n+c>0?n=0:n+=c,t.css("transform",`translateX(${n}px)`),transformBtn(n,-(r-i),a,s)}))}composeBrief(){const e=this;$("body").on("mouseover",(function(t){const i=$(t.target);if("pc"==userModel&&(0!=i.parents(".characters_item").length||i.hasClass("characters_item")||0!=i.parents(".myCharacters_item").length||i.hasClass("myCharacters_item"))){let t,a,s;0!=i.parents(".characters_item").length?(t=i.parents(".characters_item").find(".brief"),a=i.parents(".characters_item"),s=e.charactersList.findIndex((e=>parseInt(e.id)==parseInt(a.attr("data-indexid"))))):0!=i.parents(".myCharacters_item").length?(t=i.parents(".myCharacters_item").find(".brief"),a=i.parents(".myCharacters_item"),s=e.mycharactersList.findIndex((e=>parseInt(e.id)==parseInt(a.attr("data-indexid"))))):(t=i.find(".brief"),a=i),t.removeClass("brief_left");const r=$(".aiFriend").width(),n=a.width();s++;const c=Math.floor(r/n);(Number.isInteger(s/c)?1:s/c%1)>.5&&t.addClass("brief_left")}}))}showShare(e,t){gtag("event","share_aigirlfriend_winshow"),$Popup({title:$(".sharePop .shareTitle").html(),content:$(".sharePop .shareBox").html(),type:"share"});let i=TOOL_API+"chat/user/share?s="+btoa(t+","+window.location.origin+window.location.pathname+"?openShare="+e+","+questLanguage+",vidqu,girlfriend");$('meta[name="twitter:image"]').attr("content",t),$("meta[property='og:image']").attr("content",t),$(".shareIco.x").click((()=>{gtag("event","share_aigirlfriend_tw"),openWindow(`https://twitter.com/intent/tweet?url=${i}?play_source=Twitter&text=${encodeURIComponent(jsonAiGirlFriend.shareText)}`)})),$(".shareIco.facebook").click((()=>{gtag("event","share_aigirlfriend_fb"),openWindow(`https://www.facebook.com/sharer.php?u=${i}?play_source=Facebook&text=${encodeURIComponent(jsonAiGirlFriend.shareText)}`),$("meta[property='og:url']").attr("content",i)})),$(".shareIco.Link").click((()=>{gtag("event","share_aigirlfriend_link"),copyText(window.location.origin+window.location.pathname+"?openShare="+e);try{ToolTip({text:"Copied successfully"})}catch(e){ToolTip({text:"Copied failed"})}}))}eventLoginsuccess(){const e=this;document.querySelector("my-component").addEventListener("loginsuccess",(async function(t){isLogin(!0),await e.initCharacters(),e.GetMyCharacters(),e.GetRecentChatting(),e.GetIfications()})),$(".signoutBtn").on("click",(async function(){await e.initCharacters(),e.GetMyCharacters(),e.GetRecentChatting(),e.GetIfications()}))}inputCharacter(e,t,i){const a=t-1;let s=e.val(),r=0,n=0;"name"==i&&(s=s.replace(/[/*&\\%$#@]/g,""));let c="";for(const e of s)if(c+=e,n++,r=c.trim().length,r>a)break;return r>=t?$(`.maxLength[data-input='${i}']`).addClass("error"):$(`.maxLength[data-input='${i}']`).removeClass("error"),r>a&&(r=t),$(`.maxLength[data-input='${i}'] span`).text(r),e.val(s.substring(0,n)),s.substring(0,n)}async uploadImage(e,t,i,a,s){const r=this;if(!t.target.files||!t.target.files[0])return console.log("there is no file"),void s?.();let n=i.files[0];if(!checkFileType(n))return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.imageNoSupported),e.siblings(".erorrTip").css("visibility","visible"),$(i).val(null),s?.(),!1;if(n?.size>104857600)return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.imageSizeError),e.siblings(".erorrTip").css("visibility","visible"),$(i).val(null),s?.(),!1;let{blog:c}=await resizeImageByFile(n),o=URL.createObjectURL(c);var l=new Image;l.src=o,l.onload=function(){var t=this.naturalHeight,i=this.naturalWidth;if("background"===a){if(t<128||i<128)return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.backGround_Error),e.siblings(".erorrTip").css("visibility","visible"),!1;r.mc_Background=n,$("#createMC_background_img").attr("src",o)}else{if(t<32||i<32)return e.siblings(".erorrTip").find(".image_error").text(jsonAiGirlFriend.avatar_error),e.siblings(".erorrTip").css("visibility","visible"),!1;"avatar"==a?(r.mc_Avatar=n,$("#createMC_avatar_img").attr("src",o)):(r.editUser_Avatar=n,$(".editUser #edit_user_avatar").attr("src",o))}e.siblings(".erorrTip").css("visibility","hidden")},l.error=function(){console.log("Error image loading")},s?.()}clearInput(){this.mc_Avatar="",this.mc_Name="",this.mc_Desc="",this.mc_Gender="",this.mc_Background="",this.mc_Persona="",this.mc_visibility=jsonAiGirlFriend.classifySelect.Public,this.mc_Categories=[],this.mc_Greeting="",this.mc_Scenario="",this.mc_Dialogue="",this.head_portrait=[],this.head_portrait_background=[],this.isUploadAvatar=!1,this.isUploadBackground=!1,this.oldRoleInfo={},this.my_characters_id=0,this.is_draft=!1,this.mc_roleId="",this.voice_json=this.voiceArr[0],$(".maxLength span").text(0),$(".erorrTip").css("visibility","hidden")}async closeCD(e=!0,t=!1){if(this.editMcType="",$(".createBtn").removeClass("active"),this.resetAll=e,this.resetMy=e,t)switch(this.lastTab){case"my":$("#myCharacters").click();break;case"voice":$("#voicepool").click();break;case"all":$("#allMyCharacters").click()}else $("#myCharacters").click();$("body")[0].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),console.log(e,"isReset"),setTimeout((async()=>{await this.GetMyCharacters(),this.initCharacters(),this.GetRecentChatting()}),10)}pageProcess(){const e=this;$(window).off("scroll");const t="all"==this.tab;let i,a;t?(i=this.CharactersPage+1,a=this.CharactersCount):(i=this.MyCharactersPage+1,a=this.MyCharactersCount),i>=a||""!=this.editMcType||$(window).on("scroll",(function(i){let a=$(".hr_pagePorgress").offset().top+parseFloat($(".hr_pagePorgress").css("padding-bottom"));window.scrollY+$(window).height()>=a&&($(".hr_pagePorgress")[0].scrollIntoView({behavior:"instant",inline:"end",block:"end"}),t?(!e.isLoading&&e.initCharacters(!1),e.isLoading=!0):(!e.isMyLoading&&e.GetMyCharacters(!1),e.isMyLoading=!0))}))}async userInfoUpdate(e,t){let i="";if(this.isUploadUserAvatar){const e=this.editUser_Avatar,a=new FormData;a.append("file",e),await fetchPostNormal("file-upload",a,interHost,{}).then((e=>{200!=e.code?(t?.(),$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.errorDesc,type:"error"})):i=e.data.url})).catch((e=>{console.error(e)}))}let a={head_portrait:i||this.editUser_Avatar,first_name:this.editUser_firstName,last_name:this.editUser_lastName,age:this.editUserAge};fetchPostNormal("api/user/set-user-info",a,interHost).then((i=>{200!=i.code?(t?.(),$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.errorDesc,type:"error"})):(console.log(i,"res"),e?.())})).catch((e=>{console.error(e),t?.(),$Popup({title:jsonAiGirlFriend.failedMsg.normalTitle,content:jsonAiGirlFriend.failedMsg.generateError,type:"error"})}))}clearUserData(){$(".erorrTip[data-type='editUser_lastName']").css("visibility","hidden"),$(".erorrTip[data-type='editUserAvatar']").css("visibility","hidden"),$(".erorrTip[data-type='editUser_firstName']").css("visibility","hidden"),this.editUser_Avatar="",this.editUserAge=0,this.editUser_firstName="",this.editUser_lastName="",this.isUploadUserAvatar=!1}getUserData(){fetchPostNormal("api/user/get-profile",{},interHost).then((e=>{if(200==e.code){$(".editUser_email").val(e.data.email),$(".editUser #edit_user_avatar").attr("src",e.data.head_portrait),$(".editUser_lastName").val(e.data.last_name),this.editUser_Avatar=e.data.head_portrait,this.editUser_lastName=e.data.last_name;let t=e.data.first_name+e.data.last_name;ttsBlank(t)?this.editUser_firstName=e.data.email.split("@")[0]:this.editUser_firstName=e.data.first_name,$(".editUser_firstName").val(this.editUser_firstName),this.editUserAge=e.data.age}})).catch((()=>{console.error("get user data error")}))}clickUserEvent(){const e=this;$(".editUser_firstName,.editUser_lastName").off(),$(".editUser_firstName").on("input",(function(){const t=e.inputCharacter($(this),30,"editUser_firstName");e.editUser_firstName=t})),$(".editUser_lastName").on("input",(function(){const t=e.inputCharacter($(this),30,"editUser_lastName");e.editUser_lastName=t}))}isShowNewTag(){getCookie("isShowVoicePoolNew")||setCookie("isShowVoicePoolNew",new Date);const e=getCookie("isShowVoicePoolNew");(new Date-new Date(e))/864e5<=7&&$("#voicepool").addClass("new")}}function refreshData(e){let t=null;return function(i=!1){return i&&(t=null),!t&&(t=setTimeout((()=>{t=null}),e),!0)}}function ToolTip(e){const{text:t="",type:i="",showtime:a=""}=e;$("body").append(`\n    <bottom-message\n      text="${t}"\n      type="${i}"\n      showtime="${a}"\n      >\n    </bottom-message>`)}function isShowBtnLR(e,t){const i=$(".RecentChatting").width(),a=$(".Recent_item").width(),s=$(".Recent_item").css("margin-right");(a+parseFloat(s))*$(".Recent_item").length>i&&"pc"==userModel?($(".view").show(),$(".view").hasClass("active")?$(".btn_left,.btn_right").hide():transformBtn(e,t)):$(".btn_left,.btn_right,.view").hide()}function transformBtn(e,t,i=$(".btn_left"),a=$(".btn_right")){0==e?i.hide():i.css("display","flex"),e==t?a.hide():a.css("display","flex")}function copyText(e){const t=e.trim(),i=document.createElement("input");i.value=t,document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i)}function openWindow(e){winRef&&!winRef.closed?winRef.location.href=e:window.open(e)}function formatNumber(e){if(e<1e3)return`${e}`;if(e<1e6){const t=e/1e3;if(Number.isInteger(t))return`${t.toFixed(0)}K`;{const e=t.toFixed(1);return e.endsWith(".0")?`${t.toFixed(0)}K`:`${e}K`}}{const t=e/1e6;if(Number.isInteger(t))return`${t.toFixed(0)}M`;{const e=t.toFixed(1);return e.endsWith(".0")?`${t.toFixed(0)}M`:`${e}M`}}}function clearGetIfications(){window.clearTimeout(informTimer),clearTimeout(informTimer),informTimer=null}function checkTimestamp(e){e*=1e3;const t=(new Date).getTime()-e;if(t<36e5)return"a few minutes ago";if(t<864e5){const e=Math.floor(t/36e5);return t%36e5<18e5?e+" hour ago":e+1+" hour ago"}{const t=new Date(e),i=t.getFullYear(),a=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");return i===(new Date).getFullYear()?`${a}/${s}`:`${i}/${a}/${s}`}}checkFileType=(e,t)=>{var i=e.type;let a=e.name.split(".");var s=a[a.length-1].toLowerCase();return!(!["image/jpeg","image/png","image/webp","application/octet-stream"].includes(i)||!["jpeg","png","webp","jpg"].includes(s))},$(document).ready((function(){console.log(`%cCurrent version: V${currentVersion}`,"color: red;font-size: 24px;font-weight: bold;text-decoration: underline;"),window.aiChatting=new AiGirlfriendTalking,window.aiGirlFriend=new AiGirlFriend,aiChatting.bindEvent();let e=getUrlVal("openShare");(async()=>{await aiGirlFriend.init(),e&&aiChatting.getAiInfo(e,2,""),(getCookie("access_token")?getCookie("access_token"):"")||gtag("event","open_aigirlfriend_page"),window.addEventListener("resize",(function(){aiGirlFriend.composeRecent()}))})()}));