let SOCKET,defaultUserAvatar="/dist/img/aiFriend/icon_avatar.svg";const gfChattingLan=jsonData.aiGirlFriendChat,gfChattingJsLan=jsonData.aiGirlFriendChat.javascript;class PromiseWait{constructor(){this.promise=new Promise((t=>{this.resolve=t}))}async wait(){return this.promise}async finish(){this.resolve()}}class AiGirlfriendTalkingService{getMessageInfo(t,a){const e=new URLSearchParams({chat_id:t});return a>0&&e.append("page",a.toString()),fetchGet(`chat/user/get-message-info?${e.toString()}`)}getChatServer(t){return fetchPost("chat/user/get-chat-server",t)}getRoleInfo(t,a,e){const i=new URLSearchParams({id:t,is_my_characters:a});return e&&1===a&&i.append("my_characters_id",e),fetchGet(`chat/user/get-role-info?${i.toString()}`)}putLike(t){return fetchPost("chat/user/role-like",{role_id:t})}roleEdit(t){return fetchPost("chat/user/role-edit",t)}getUploadUrl(t){return fetchPost("ai/source/get-upload-url",t)}saveAudio(t,a,e,i){return fetchPost("chat/user/up-message",{id:t,chat_id:a,task_timestamp:e,path:i})}getUploadFileUrl(){return fetchPost("ai/source/temp-upload-url",{file_name:"ai-girlfriend-audio.mp3"})}putUploadUrl(t,a){return fetchPut(t,a)}putLog(t){return fetchPost("chat/public/add-log",t)}getVoiceLimit(){return fetchGet("chat/user/get-voice-limit")}getAccessUrl(t){return fetchPost("ai/source/get-access-url",{key:t,action:"browse"})}delChattingRecords(t,a){return fetchPost("chat/user/del-recent-chatting",t).then((()=>{a?.()})).catch((function(t){console.log("del-recent-chatting",t)}))}}class AiGirlfriendTalking{service=new AiGirlfriendTalkingService;hasAudio=!1;constructor(){this.boxPosition={changeBtnLeft:{chattingContainer:{height:"64vh"},chattingBox:{left:".8rem",right:"auto"},chatBgImg:{right:"0px",left:"auto"},changePhotoBtn:{right:".8rem",left:"auto"}},changeBtnMiddle:{chattingContainer:{height:"340px"},chattingBox:{left:"calc(50% - 38.54vw / 2)",right:"auto"},chatBgImg:{right:"auto",left:"calc(50% - 661px / 2)"},changePhotoBtn:{right:"auto",left:".8rem"}},changeBtnRight:{chattingContainer:{height:"64vh"},chattingBox:{left:"auto",right:".8rem"},chatBgImg:{right:"auto",left:"0"},changePhotoBtn:{right:"auto",left:".8rem"}}},this.updateAudioLimit()}data(){return{modelDOM:$("#AiChat"),userMessage:$("#userInputMsg").value}}async init(t,a){gtag("event",`chat_aigirlfriend_${t.role_id}`),gtag("event","enter_aigirlfriend_chatting");let e=this;this.loginPopup=null,this.isChat=!1,this.socketClose=!1,this.chatPage=-1,this.initHistory=!0,this.isSyncingHistroy=!1,this.isConnectingSocket=!1,this.isOldSeverUrl=!1,this.chatMap=new Map,this.helloTimer=null,this.promiseWaitMap=new Map,this.isChangeData=!1,this.lastSendMsg="",this.aiData={...t},this.aiAvatarImg=t?.head_portrait[0]?.url,this.bgImg=t.head_portrait_background.length>0?t.head_portrait_background[0]?.url:t.head_portrait[0]?.url,this.backImg=`url("${t.head_portrait_background[0]?.url||this.bgImg}")`,this.uploadAvatarChange=!0,this.uploadbg=t.head_portrait_background[0]?.url||!1,getCookie("user_info")&&(this.userData=JSON.parse(getCookie("user_info"))),this.userAvatarImg=this.userData?.head_portrait||defaultUserAvatar,this.connectMsg={user_id:"0"|this.userData?.id,role_id:t.role_id+"",role_name:t.name,chat_id_name:"",chat_id:"",token:getCookie("SsToken")},this.connectMsg.user_id=this.connectMsg.user_id+"",this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,$(".chatting-container").empty();let i="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(i=localStorage.getItem("chattingPosition")),this.changePosition(i),$(".audio_btn.screen").hasClass("active")||"true"==localStorage.getItem("aiChat-screen")?($(".audio_btn.screen").addClass("active"),this.changeScreen(!0)):($(".audio_btn.screen").removeClass("active"),this.changeScreen(!1)),this.mobileInit(),this.data().modelDOM.fadeIn(),$("body").css({overflow:"hidden",position:"fixed"}),this.setLoginTimer(),$(".hidden-box #aiAvatarImg").attr("src",this.aiAvatarImg),$("#myAvatarImg").attr("src",this.userAvatarImg),$(".audio_btn.bg").hasClass("active")||"true"==localStorage.getItem("aiChat-bg")?($(".audio_btn.bg").addClass("active"),this.changeBackground(!0)):($(".audio_btn.bg").removeClass("active"),this.changeBackground(!1));let s=new Image;s.onload=function(){e.ratio=this.width/this.height,e.ratio.toFixed(2)>1?e.boxPosition.changeBtnMiddle.chatBgImg.left=0:e.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";let t="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(t=localStorage.getItem("chattingPosition"));const a=$("#chatBgImg");e.ratio.toFixed(2)>1?a.css({width:"100vw",left:"0px"}):a.css({width:"661px",left:e.boxPosition[t].chatBgImg.left})},s.src=this.bgImg,this.updateCharacter();try{await this.updateCharacterFunc(t.role_id,t.is_my_characters,t.my_characters_id);let e=await this.getChatData("",a);if(!e)return;let i=getUrlVal("headAvatar");if(i){let t=getUrlVal("form");await this.fromUndressFn(t,i)}this.isMyCharacterStatus=this.aiData.is_my_characters,this.aiData.toMyCharacter=!1,this.connectChatting(e.server_url),this.getChatHistory(),$(".chat_loading").hasClass("active")&&this.chatReLoading(!1)}catch(t){console.error("init error",t)}}async updateAudioLimit(){const a=await this.service.getVoiceLimit();a.data?(this.hasAudio=a.data.sum_num>0,$(".ai-gf-info-dialog-wrap .audio-limit-desc").text(t(gfChattingLan.audioLimitDesc,{sum_num:a.data.sum_num}))):console.error("getVoiceLimit error",a)}async getChatHistory(){if(!this.isSyncingHistroy&&this.chatPage&&this.aiData.chat_id&&this.connectMsg.chat_id){this.isSyncingHistroy=!0;try{const t=await this.service.getMessageInfo(this.connectMsg.chat_id,this.chatPage);if(200===t.code&&t.data){this.isChat=!0;const a=t.data.page;let e=t.data.list?.filter((t=>!!t.chat_content.content));if(ttsBlank(e)&&(e=[]),0===e?.length&&this.chatPage)return this.isSyncingHistroy=!1,this.chatPage=a,void await this.getChatHistory();const i=$(".chatting-container"),s=i.scrollTop(),n=i[0].scrollHeight;i.css("overflow-y","hidden");for(let t of e)if("user"===t.chat_content.role){let a=$("#myMessageBox");this.showMessage(a,t.chat_content.content,".my-message-container",!0,t)}else{let a=$("#aiMessageBox");this.showMessage(a,t.chat_content.content,".ai-message-container",!0,t)}if(i.css("overflow-y","auto"),this.initHistory)i.scrollTop(i.prop("scrollHeight"));else{const t=i[0].scrollHeight-n;i.scrollTop(s+t)}if(this.initHistory=!1,this.chatPage=a,e.length<5&&a)this.isSyncingHistroy=!1,await this.getChatHistory();else{if(this.chatMap.size<2)return;const t=this.chatMap.entries(),a=t.next().value,e=t.next().value;if("assistant"==a[1].sendUser&&"user"==e[1].sendUser){$(".ai-message-box").eq(-2).find(".rechat").show();let t={...this.connectMsg,chat_content:e[1].content,request_type:20,chat_action:"",UserSendTime:(new Date).getTime()};this.UserSendTime=t.UserSendTime,this.lastMessage=JSON.stringify(t)}}}}catch(t){console.error("getChatHistory error",t)}finally{this.isSyncingHistroy=!1}}}async getChatData(t="",a=""){const e={chat_id:this.aiData.chat_id,role_id:this.connectMsg.role_id,is_my_characters:this.aiData.is_my_characters,last_server_url:t,is_new:a?1:2};1===this.aiData.is_my_characters&&(e.my_characters_id=this.aiData.my_characters_id);const i=await this.service.getChatServer(e);if(401===i.code)return await this.closeChat(),!1;if(200!==i.code||!i.data)return console.error("getChatData error",i.message),$Popup({type:"error",errorType:"normal"}),!1;const s=i.data;return s.is_old_server_url&&1===s.is_old_server_url&&(this.isOldSeverUrl=!0),this.socketUrl=s.server_url,this.connectMsg.chat_id=s.chat_id,this.aiData.chat_id=s.chat_id,this.connectMsg.chat_id_name=s.chat_id_name,s}AiHello(){const t={...this.connectMsg,request_type:50,chat_last_sep:3234};clearTimeout(this.helloTimer),this.helloTimer=setTimeout((()=>{SOCKET.send(JSON.stringify(t))}),24e4)}async fromUndressFn(t,a){let e=atob(getUrlVal("avatarKey")),i=atob(a),s={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:this.aiData.name,is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des??"",scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait:JSON.stringify([{key:"head_portrait",value:e,is_temp:1}]),head_portrait_background:JSON.stringify(this.aiData.head_portrait_background)};if(this.aiData.head_portrait=[{key:"head_portrait",value:i,url:i}],this.aiAvatarImg=i,this.aiData.status=2,this.updateCharacter(),$(".chatting-share").hide(),this.aiData.is_my_characters=1,this.bgImg="",this.changeBgAvatar(),!t)return;const n=await this.service.roleEdit(s);200===n.code&&(aiGirlFriend.GetRecentChatting(),this.aiData.toMyCharacter=!0,history.pushState(null,null,`/novia-virtual.html?openShare=${getUrlVal("openShare")}&headAvatar=${a}&avatarKey=${btoa(e)}`),this.aiData.my_characters_id=n.data.my_characters_id,this.aiData.role_id=n.data.role_id,this.aiData.is_my_characters=1,this.isChangeData=!0),401!==n.code?await this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id):await this.closeChat()}mobileInit(){if(window.innerWidth<1200){let t;$("#changePhotoBtn").text(jsonData.aiGirlFriendChat.changePhoto),t=1===this.aiData.is_my_characters?"1.4rem":"1.92rem",$(".change-photo-btn").css({left:"auto",right:t})}}updateCharacter(){$(".chatting-count").text(formatNumber(this.aiData.msg_num)),$(".ai-chat-gf-avatar, .ai-gf-info-dialog-avatar").attr("src",this.aiAvatarImg),$(".ai-gf-info-dialog-birthday").text(this.aiData.json.Created),$(".ai-gf-info-dialog-desc").text(this.aiData.json.Character_des),$(".ai-chat-gf-name, .ai-gf-info-dialog-name").text(this.aiData.name),this.toggleShareBtn(1===this.aiData.status&&1===this.aiData.type);const t=this.aiData.json.tag.split(",").filter((t=>""!==t)).map((t=>`<div class="ai-gf-info-dialog-tag">${jsonAiGirlFriend.setting_tag[t]||t}</div>`));$(".ai-gf-info-dialog-tags").html(t.join("")),1===this.aiData.is_like?($(".no-like-icon").hide(),$(".like-icon").show()):($(".no-like-icon").show(),$(".like-icon").hide())}bindEvent(){let t=this;$("#userInputMsg").on("input",(function(){let t=$(this).val().length;window.innerWidth>1200?this.style.height=this.scrollHeight+"px":this.style.height=this.scrollHeight/100+.5+"rem",(0===t||t<37)&&(window.innerWidth>1200?this.style.height="46px":this.style.height=".88rem");const a=$(".send-btn");0===t||/^\s*$/.test($(this).val())?a.addClass("disable"):a.removeClass("disable")})),$("#backIcon, #closeIcon").on("click",(function(){"backIcon"===$(this).attr("id")?gtag("event","back_aigirlfriend_chatting"):gtag("event","close_aigirlfriend_chatting"),t.closeChat("click")})),$(".chatting-container").on("click",".audio-button",(function(a){const e=$(a.currentTarget);gtag("event","click_aigirlfriend_voice"),t.toggleAudioBtn(e,!e.hasClass("active"))})),$("#sendMsg").on("click",(()=>{this.sendMessage(),$("#userInputMsg").trigger("focus")})),$(".ai-chat-box textarea").on("keydown",(t=>{"Enter"===t.key&&(t.preventDefault(),this.sendMessage())})),$("#editIcon").on("click",(()=>{$(".change-position-box").toggle()})),$(document).on("click",(function(a){const e=$(a.target);e.closest("#editIcon").length||e.closest(".change-position-box").length||$(".change-position-box").hide(),e.closest(".right-button-box-m-dropdown").length||e.closest(".right-button-box-m-dropdown-menu").length||t.toggleGFDropdown(!1)})),$(".change-btns-box .change-btn").on("click",(function(){let a=$(this).attr("id");gtag("event",{changeBtnLeft:"left_aigirlfriend_pos",changeBtnMiddle:"mid_aigirlfriend_pos",changeBtnRight:"right_aigirlfriend_pos"}[a]),t.changePosition(a),$(".change-position-box").hide()})),$("#changePhotoBtn").on("click",(()=>{gtag("event","click_aigirlfriend_changephoto"),this.openChangeHandle()})),$(".chatting-like").on("click",(async function(){t.isChangeData=!0;try{t.toggleLikeBtn();200===(await t.service.putLike(t.aiData.role_id)).code?$(this).closest(".ai-gf-info-dialog").length>0?gtag("event","like_aigirlfriend_view"):1===t.aiData.is_like&&gtag("event","like_aigirlfriend_chatting"):($Popup({type:"error",errorType:"network"}),t.toggleLikeBtn())}catch(a){console.error("like error",a),$Popup({type:"error",errorType:"network"}),t.toggleLikeBtn()}})),$(".discord-box").on("click",(()=>{gtag("event","discord_aigirlfriend_chatting")})),$(".chatting-share").on("click",(t=>{$(t.target).closest(".ai-gf-info-dialog").length>0?gtag("event","share_aigirlfriend_view"):(gtag("event","share_aigirlfriend_chatting"),$(".chatting-setting").removeClass("active")),aiGirlFriend.showShare(this.aiData.role_id,this.aiData.head_portrait[0].value)})),$(".ai-chat-gf-view").on("click",(()=>{this.toggleGFInfoDialog(!0,".ai-gf-info-dialog")})),$(".ai-gf-info-dialog-close, .ai-gf-info-dialog-bg").on("click",(()=>{this.toggleGFInfoDialog(!1)})),$(".right-button-box-m-dropdown").on("click",(()=>{const t=$(".right-button-box-m-dropdown-menu").is(":visible");this.toggleGFDropdown(!t)})),$("#chattingContainer").on("scroll",(function(){0===$(this).scrollTop()&&t.getChatHistory()})),$(".chatting-newChat").click((async function(){t.isSyncingHistroy||(gtag("event","newchat_aigirlfriend_chatting"),await t.closeChat(!1,"new"),t.aiData.chat_id=void 0,t.connectMsg=null,t.init(t.aiData,"new"))})),$(".chatting-restart").click((function(){if(t.isSyncingHistroy)return;gtag("event","restartchat_aigirlfriend_chatting");let a=$Popup({title:jsonData.aiGirlFriendChat.restartTitle,content:jsonData.aiGirlFriendChat.restartText,closeBtn:jsonData.aiGirlFriendChat.resetChat,applyBtn:jsonAiGirlFriend.Cancel,autoClose:!1,exist:"bootLogin",onClose:()=>{a.loading.start(),aiGirlFriend.deleteChat(t.aiData.chat_id,(async()=>{a.close(),await t.closeChat(!1,"restart"),await aiGirlFriend.GetRecentChatting(),delete t.aiData.chat_id,t.init(t.aiData,"restart")}))},onApply:()=>{a.close()},topCloseFn:()=>{a.close()}})})),$(".audio_btn").click((function(){$(this).toggleClass("active"),$(this).hasClass("screen")?(gtag("event","fullscreen_aigirlfriend_chatting"),$(this).hasClass("active")?(localStorage.setItem("aiChat-screen",!0),t.changeScreen(!0)):(localStorage.setItem("aiChat-screen",!1),t.changeScreen(!1))):$(this).hasClass("bg")&&(gtag("event","hidebackground_aigirlfriend_chatting"),$(this).hasClass("active")?(localStorage.setItem("aiChat-bg",!0),t.changeBackground(!0)):(localStorage.setItem("aiChat-bg",!1),t.changeBackground(!1)))})),$("body").on("mouseup",(async function(a){const e=$(a.target),i=$(".chat-btn-setting")[0].contains(a.target);if((e.hasClass("chat-btn-setting")||e.hasClass("chat-btn-icon"))&&gtag("event","chatsettings_aigirlfriend_chatting"),$(".audio_btn")[0].contains(a.target)||$(".audio_btn")[1].contains(a.target)||(i?$(".chat-btn-setting").toggleClass("active"):$(".chat-btn-setting").removeClass("active")),$(".setting_box").hide(),e.hasClass("msgSetting")){gtag("event","click_aigirlfriend_msgsettings");let t=e.hasClass("my")?"my":"ai";$(".ai-message-box,.my-message-box").css("z-index",""),e.parents(`.${t}-message-box`).css("z-index",1),e.children(".setting_box").show()}else if(e.hasClass("setting_copy")){e.parents(".setting_box").hide();let t="assistant"==e.parents(".chatOperation").data("sender")?"ai":"my";e.parents(`.${t}-message-box`).css("z-index","");const a=e.parents(`.${t}-message-box`).find(".chat_msg");copyText(a.text())}else if(e.hasClass("setting_delete")){let a=e.parents(".chatOperation");if(!a.data("ischecktime"))return;let i="assistant"==a.data("sender")?"ai":"my",s={chat_id:t.aiData.chat_id,role:a.data("sender"),task_timestamp:a.data("timestamp")};t.service.delChattingRecords(s),e.parents(`.${i}-message-box`).remove()}else $(".ai-message-box,.my-message-box").css("z-index",""),$(".ai-message-box,.my-message-box").find(".setting_box").hide();if(e.hasClass("rechat")){gtag("event","click_aigirlfriend_rechat");let a=e.parents(".chatOperation");if(!a.data("ischecktime"))return;let i="assistant"==a.data("sender")?"ai":"my",s=a.data("timestamp"),n={chat_id:t.aiData.chat_id,role:"assistant",task_timestamp:s},o={chat_id:t.aiData.chat_id,role:"user",task_timestamp:s};e.parents(`.${i}-message-box`).remove(),t.setChatLoading(!0),await t.service.delChattingRecords(n),await t.service.delChattingRecords(o),SOCKET?SOCKET.readyState===WebSocket.OPEN?SOCKET.send(t.lastMessage):SOCKET.readyState===WebSocket.CLOSED?(t.disconnectMessage=t.lastMessage,t.connectChatting(t.socketUrl)):t.disconnectMessage=t.lastMessage:t.disconnectMessage=t.lastMessage;$(`.chatOperation[data-timestamp="${s}"]`).attr("data-timestamp",t.UserSendTime)}}))}changePosition(t){this.currentPosition=t,getCookie("user_info")?localStorage.setItem("chattingPosition",t):localStorage.removeItem("chattingPosition"),$("#"+t).addClass("change-active").siblings().removeClass("change-active");let a=this.boxPosition;for(let e in a[t]){let i=`#${e}`;for(let s in a[t][e])"chattingContainer"==e?this.chatHeight=a[t][e][s]:$(i).css(s,a[t][e][s])}let e=$(".chatting-container");e.scrollTop(e.prop("scrollHeight"))}isMobile(){return window.innerWidth<1200}toggleGFInfoDialog(t,a){const e=$(".ai-gf-info-dialog-wrap");if(e.children("div").not(".ai-gf-info-dialog-bg").hide(),a&&e.find(a).show(),this.isMobile()?t?e.show(0,(()=>e.addClass("active"))):e.removeClass("active").hide():t?e.fadeIn(160):e.fadeOut(160),t&&".ai-gf-info-dialog"===a)gtag("event","show_aigirlfriend_view")}toggleGFDropdown(t){const a=$(".right-button-box-m-dropdown-menu");this.isMobile()?t?a.slideDown(160):a.slideUp(160):t?a.fadeIn(160):a.fadeOut(160)}toggleShareBtn(t){const a=$(".chatting-share");t?a.show():a.hide()}toggleLikeBtn(){const t=1!==this.aiData.is_like;this.aiData.is_like=t?1:2;const a=$(".like-icon"),e=$(".no-like-icon");t?(a.show(),e.hide()):(a.hide(),e.show())}async closeChat(t,a=""){let e=async()=>{this.toggleGFInfoDialog(!1),$(".change-position-box").hide(),$("body").css({"overflow-y":"auto",position:"static"}),history.pushState(null,null,"/novia-virtual.html"),clearInterval(this.loginTimer),clearInterval(this.heartTimer),clearInterval(this.disconnectTimer),clearTimeout(this.helloTimer),this.clearTimeoutAudioQueue(),this.clearPromiseWait(),this.changePopup=null,this.loginPopup=null;const t=$("#userInputMsg");t.val(""),window.innerWidth>1200?t.css("height","46px"):t.css("height",".88rem");const e=$(".chatting-container");if(e.find("audio").off("play pause ended"),e.empty(),$Popup().closeAll(),a?this.chatReLoading(!0):this.data().modelDOM.fadeOut(),this.socketClose=!0,SOCKET?.close(),this.isChat&&"restart"!=a){let t={...this.aiData};aiGirlFriend.addRecentChatting(t)}aiGirlFriend.resetAll=this.isChangeData,aiGirlFriend.resetMy=this.isChangeData,await aiGirlFriend.initCharacters(!0),aiGirlFriend.GetMyCharacters(!0)};t?this.showLoginPopup((async()=>{await e()})):await e()}lastMessage=null;connectChatting(t,a){if(this.socketClose||!t||this.isConnectingSocket)return;this.isConnectingSocket=!0,SOCKET=new WebSocket(t),SOCKET.binaryType="arraybuffer";let e={...this.connectMsg,chat_last_sep:3234,request_type:this.isOldSeverUrl?11:10,chat_action:"",UserSendTime:(new Date).getTime()};this.UserSendTime=e.UserSendTime,this.isOldSeverUrl=!1;let i={...this.connectMsg,request_type:40};clearInterval(this.heartTimer),this.heartTimer=setInterval((()=>{SOCKET.readyState===WebSocket.OPEN&&SOCKET.send(JSON.stringify(i))}),4e4),SOCKET.onopen=()=>{this.isConnectingSocket=!1,this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5),SOCKET.send(JSON.stringify(e)),this.AiHello(),this.sendAudioQueue.length&&setTimeout((()=>{for(;this.sendAudioQueue.length>0;)SOCKET.send(this.sendAudioQueue.shift())}),1e3),this.disconnectMessage&&setTimeout((()=>{SOCKET.send(this.disconnectMessage),this.disconnectMessage=""}),1e3)},SOCKET.onmessage=async a=>{this.wssResponse=JSON.parse(a.data);if([300,7001,7002].includes(this.wssResponse.status)){let t={...this.connectMsg,error_msg:this.wssResponse?.error_info,versions:currentVersion,time_stamp:this.wssResponse?.time_stamp??"",wss:this.socketUrl,wssResponse:this.wssResponse};this.service.putLog(t)}if(this.wssResponse.next_time||(clearTimeout(this.disconnectTimer),this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5)),300===this.wssResponse.status||500===this.wssResponse.status){SOCKET.close(),this.disconnectMessage=this.lastMessage;let a=await this.getChatData(t);if(!a)return;return void this.connectChatting(a.server_url)}if(6001===this.wssResponse.status)return gtag("event","already_aigirlfriend_win"),void this.closeChat();if(7001===this.wssResponse.status)return console.error("audio error",{time_stamp:this.wssResponse.time_stamp,message:this.wssResponse.error_info}),this.deleteTimeoutAudioQueue(this.wssResponse.time_stamp),void $(`[data-id="${this.wssResponse.time_stamp}"]`).removeClass("active");if(7002===this.wssResponse.status)return console.error("audio service error",{time_stamp:this.wssResponse.time_stamp,message:this.wssResponse.error_info}),this.deleteTimeoutAudioQueue(this.wssResponse.time_stamp),void $(`[data-id="${this.wssResponse.time_stamp}"]`).removeClass("active");if(21===this.wssResponse.status)return void this.assemblyAudioChunk(this.wssResponse);let e=this.wssResponse?.chat_content,i=$("#aiMessageBox");this.showMessage(i,e,".ai-message-container",!1,this.wssResponse)},SOCKET.onerror=t=>{this.isConnectingSocket=!1,console.error("socket error",t)},SOCKET.onclose=async a=>{if(this.isConnectingSocket=!1,!a.wasClean&&!this.socketClose){let a=await this.getChatData(t);if(!a)return;this.connectChatting(a.server_url)}}}lottiePlayerAudioLoading=$("#audio-loading-icon").clone();setChatLoading(t){let a=this,e=$(".chatting-container");t?(e.append(`\n        <div class="ai-message-box item loading">\n          <div class="img-container">\n            <img src="${this.aiAvatarImg}" alt="" id="aiAvatarImg" class="aiAvatarImg" />\n          </div>\n          <div class="ai-message-container loading">\n            <div class="chatting-loading-new">\n              <span class="relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n              <span class="animation-delay-200 relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n              <span class="animation-delay-400 relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n            </div>\n          </div>\n        </div>\n      `),this.chatLoadingTime=0,this.loadingChatTimer=setInterval((()=>{$(".chatting-loading").css("background-position-x",a.chatLoadingTime+"px"),a.chatLoadingTime=a.chatLoadingTime+8}),200)):(clearInterval(this.loadingChatTimer),this.loadingChatTimer=null,this.chatLoadingTime=0,$(".ai-message-box.item.loading").remove())}chatReLoading(t){t?$(".chat_loading").addClass("active"):$(".chat_loading").removeClass("active")}setRmoveRecords(t){if(!t||ttsBlank(t.UserSendTime))return;const a=$(`.chatOperation[data-timestamp="${t.UserSendTime}"]`);0!=a.length&&(a.attr("data-timestamp",t.time_stamp??t.task_timestamp),a.attr("data-isCheckTime",!0))}async showMessage(t,a,e,i,s,n){if(!a)return;let o,r=t.clone().removeAttr("id");if(o=h(a)?a.replace(/\*(.*?)\*/g,'<p style="margin:0">($1)</p>'):a.replace(/\*(.*?)\*/g,"<p>($1)</p>"),".ai-message-container"===e){const t=s.time_stamp??s.task_timestamp;this.chatMap.set(t,{content:a,timestamp:t,sendUser:"assistant",page:this.chatPage>-1&&i?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:s.chat_content.path??""}),this.lottiePlayerAudioLoading.removeAttr("id"),$(".rechat").hide(),o=`<div class="chatOperation" data-timestamp='${t}' data-sender='assistant' data-isCheckTime='true'>\n                    <div class="chatName">${this.aiData.name}</div>\n                    <div class="chatTools">\n                      <div class="rechat" style="display:${i?"none":"block"}"></div>\n                      <div class="msgSetting ai">\n                        <div class="setting_box">\n                          <div class="setting_copy">\n                            <img src="/dist/img/ai-chatting/icon_copy_black.svg"/>\n                            ${jsonData.aiGirlFriendChat.copy}\n                          </div>\n                          <div class="setting_delete">\n                            <img src="/dist/img/ai-chatting/icon_del.svg"/>\n                            ${jsonData.aiGirlFriendChat.delete}\n                          </div>\n                        </div>\n                      </div>\n                      ${!h(a)&&this.hasAudio,""}\n                    </div>\n                  </div>\n                  <div class="chat_msg">\n                  ${o}\n                  </div>\n                  `}else{const t=n??s.time_stamp??s.task_timestamp;this.chatMap.set("user"+t,{content:a,timestamp:t,sendUser:"user",page:this.chatPage>-1&&i?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:s?.chat_content?.path??""});let e=jsonData.aiGirlFriendChat.User;if(getCookie("access_token")){const t=JSON.parse(getCookie("user_info"));e=t.first_name+" "+t.last_name,e=" "===e?t.email.split("@")[0]:e}o=`<div class="chatOperation" data-timestamp='${t}' data-isCheckTime='${i}' data-sender='user'>\n                    <div class="chatName">${e}</div>\n                    <div class="chatTools">\n                      <div class="msgSetting my">\n                        <div class="setting_box">\n                          <div class="setting_copy">\n                            <img src="/dist/img/ai-chatting/icon_copy_black.svg"/>\n                            ${jsonData.aiGirlFriendChat.copy}\n                          </div>\n                          <div class="setting_delete">\n                            <img src="/dist/img/ai-chatting/icon_del.svg"/>\n                            ${jsonData.aiGirlFriendChat.delete}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="chat_msg">\n                  ${o}\n                  </div>\n                  `}r.find(e).html(o);let c=$(".chatting-container");if(this.setChatLoading(!1),i?c.prepend(r):(c.append(r),".my-message-container"===e&&this.setChatLoading(!0),c.scrollTop(c.prop("scrollHeight"))),this.setRmoveRecords(s),".ai-message-container"===e){const t=r.find(e).find("audio"),a=t.parent(".audio-button");t.length&&(t.on("play",(()=>{a.addClass("active")})),t.on("pause",(()=>{a.removeClass("active")})),t.on("ended",(()=>{a.removeClass("active")})))}function h(t){return/^\*[^*]+\*$/.test(t)}}sendMessage(){gtag("event","click_aigirlfriend_send");const t=$("#userInputMsg");let a=t.val();if(!a||/^\s*$/.test(a))return!1;a=a.replace(/[(（](.*?)[)）]/g,"*$1*");let e,i=(new Date).getTime(),s={...this.connectMsg,chat_content:a,request_type:20,chat_action:"",UserSendTime:i};this.UserSendTime=s.UserSendTime;try{let t=$("#myMessageBox");this.showMessage(t,a,".my-message-container",!1,{},i),SOCKET?SOCKET.readyState===WebSocket.OPEN?(this.AiHello(),SOCKET.send(JSON.stringify(s))):SOCKET.readyState===WebSocket.CLOSED?(this.disconnectMessage=JSON.stringify(s),this.connectChatting(this.socketUrl)):this.disconnectMessage=JSON.stringify(s):this.disconnectMessage=JSON.stringify(s)}catch(t){console.warn(t),this.disconnectMessage=JSON.stringify(s)}e=window.innerWidth<1200?".88rem":"46px",t.css("height",e),this.lastMessage=JSON.stringify(s),t.val(""),$(".send-btn").addClass("disable")}async saveCharacter(){gtag("event","save_aigirlfriend_changephoto");const t=$("#characterNameInput");function a(t){return t instanceof Blob}t.prop("disabled",!0);let e,i={changeAvatar:"aiAvatarImg",changeBg:"bgImg"},s={changeAvatar:"head_portrait",changeBg:"head_portrait_background"};const n=t.val()+"";let o={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:n.trim(),is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des,scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait_background:this.uploadbg?JSON.stringify(this.aiData.head_portrait_background):"[]"};try{let n;this.changePopup.loading.start();for(let t in this.uploadBlob)a(this.uploadBlob[t])&&(await this.service.getUploadUrl({file_name:`${t}.png`}).then((a=>{e=a.data.upload_url,n=a.data.key,this[i[t]]=a.data.access_url,"bgImg"===i[t]?(this.aiData.head_portrait_background=[],this.aiData.head_portrait_background.push({key:"head_portrait_background",url:a.data.access_url,value:n})):this.aiData.changeAvatarUrl=a.data.access_url})).catch((t=>{$Popup({type:"error",errorType:"network"})})),await this.service.putUploadUrl(e,this.uploadBlob[t]).then((a=>{200===a&&(o[s[t]]=JSON.stringify([{key:s[t],value:n}]))})));if(void 0!==o.head_portrait_background||this.aiData.head_portrait_background[0]?.url||(o.head_portrait_background="[]"),void 0===o.head_portrait&&(o.head_portrait=JSON.stringify(this.aiData.head_portrait)),getUrlVal("avatarKey")){let t=atob(getUrlVal("headAvatar")),a=atob(getUrlVal("avatarKey")),e=JSON.parse(o.head_portrait);e[0].value===t&&(e[0].value=a,e[0].is_temp=1,delete e[0].url,o.head_portrait=JSON.stringify(e))}const r=await this.service.roleEdit(o);if(401===r.code)return void this.closeChat();if(200!==r.code)return $Popup({type:"error",errorType:"normal"}),t.prop("disabled",!1),void this.changePopup.loading.end();this.isChangeData=!0,this.aiData.name=o.name,this.aiData.head_portrait=JSON.parse(o.head_portrait),this.aiData.head_portrait[0].url=this.aiData.changeAvatarUrl,this.aiData.is_my_characters=1,2===this.isMyCharacterStatus&&(this.aiData.toMyCharacter=!0),this.aiData.my_characters_id=r.data.my_characters_id,this.aiData.role_id=r.data.role_id,this.aiData.status=2,"[]"===o.head_portrait_background&&(this.bgImg="",this.aiData.head_portrait_background=[]);let c=$(".chatting-container");c.scrollTop(c.prop("scrollHeight")-c.height()-10),this.changePopup.close(),this.aiData.head_portrait[0].url||(this.aiData.head_portrait[0].url=this.aiAvatarImg),this.updateCharacter(),t.prop("disabled",!1),this.changePopup.loading.end(),this.changePopup=null,this.aiData.name=o.name,this.changeBgAvatar(),await this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id)}catch(t){$Popup({type:"error",errorType:"network"}),this.changePopup.loading.end(),this.changePopup=null}}async assemblyAudioChunk(t){const a=this.chatMap.get(t.time_stamp),e="audio/mpeg";if(this.deleteTimeoutAudioQueue(t.time_stamp),a.audioChunk[t.curr_id-1]=function(t,a){const e=atob(t),i=new Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);const s=new Uint8Array(i);return new Blob([s],{type:a})}(t.file_data,e),t.curr_id===t.max_len){const i=$(`[data-id="${t.time_stamp}"]`);let s="",n=null;try{n=new Blob(Array.from(a.audioChunk),{type:e}),s=URL.createObjectURL(n),a.audioUrl=s,i.find("audio").attr("src",s);this.promiseWaitMap.get(t.time_stamp)&&this.deletePromiseWait(t.time_stamp)}catch(t){console.error("assembly audio error",t),a.audioChunk=[],i.removeClass("active loading")}try{await this.saveAudio(a.page,this.connectMsg.chat_id,t.time_stamp,n)}catch(t){console.error("save audio error",t)}}}async saveAudio(t,a,e,i){const s=await this.service.getUploadFileUrl(),n=s.data.upload_url,o=s.data.key;return await this.service.putUploadUrl(n,i),this.service.saveAudio(t,a,e,o)}sendAudioQueue=[];sendAudioMessage(t){const a=JSON.stringify(t);if(!SOCKET)return this.connectChatting(this.socketUrl),void this.sendAudioQueue.push(a);SOCKET.readyState===WebSocket.OPEN?SOCKET.send(a):(this.connectChatting(this.socketUrl),this.sendAudioQueue.push(a))}getHistoryAudioQueueSet=new Set;async getHistoryAudio(t,a){this.getHistoryAudioQueueSet.add(t);const e=await this.service.getAccessUrl(a),i=e.data.static_url||e.data.url,s=$(`[data-id="${t}"]`).find("audio");s.attr("data-path","loaded"),s.attr("src",i),this.getHistoryAudioQueueSet.delete(t)}timeoutAudioQueueMap=new Map;setTimeoutAudioQueue(t){this.timeoutAudioQueueMap.has(t)&&clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.set(t,setTimeout((()=>{this.timeoutAudioQueueMap.delete(t),this.deletePromiseWait(t),$(`[data-id="${t}"]`).removeClass("loading"),console.error("generate audio timeout, timestamp:",t)}),3e4))}deleteTimeoutAudioQueue(t){this.timeoutAudioQueueMap.has(t)&&(clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.delete(t))}clearTimeoutAudioQueue(){for(let[t,a]of this.timeoutAudioQueueMap)clearTimeout(a);this.timeoutAudioQueueMap.clear()}deletePromiseWait(t){const a=this.promiseWaitMap.get(t);a&&(a.finish(),this.promiseWaitMap.delete(t))}clearPromiseWait(){for(let[t,a]of this.promiseWaitMap)a.finish();this.promiseWaitMap.clear()}lastAudioId=void 0;async toggleAudioBtn(t,a){const e=()=>{const a=$(".audio-button").not(t);a.removeClass("active"),a.find("audio").each(((t,a)=>{""!==$(a).attr("src")&&(a.pause(),a.currentTime=0)}))};e();const i=t.find("audio"),s=i.get(0),n=i.attr("src"),o=i.attr("data-path"),r=t.attr("data-id"),c=this.chatMap.get(r);if(a){if(this.lastAudioId=r,t.hasClass("loading"))return;if(""===n&&""===o){t.addClass("loading");try{if(this.timeoutAudioQueueMap.has(r))return;const a=await this.service.getVoiceLimit();if(200!==a.code)return console.error("getVoiceLimit error:",a),void t.removeClass("loading");const{is_use:n}=a.data;if(1!==n)return gtag("event","limit_aigirlfriend_voice"),this.toggleGFInfoDialog(!0,".ai-gf-audio-limit-dialog"),void t.removeClass("loading");const o=c.content,h={request_type:21,chat_content:o.replace(/\*.*?\*/g,"").trim(),time_stamp:r,chat_id:this.connectMsg.chat_id,token:getCookie("SsToken")};this.sendAudioMessage(h),this.setTimeoutAudioQueue(r);const g=new PromiseWait;return this.promiseWaitMap.set(r,g),await g.wait(),""===i.attr("src")?void t.removeClass("loading"):void(t.hasClass("loading")&&(t.removeClass("loading"),this.lastAudioId===r&&(e(),s.play().catch((a=>{t.removeClass("active"),console.error("audio play error by ws:",a)})))))}catch(a){return console.error("toggleAudioBtn error:",a),void t.removeClass("loading")}finally{this.deletePromiseWait(r)}}if(""===n&&"loading"===o){if(t.addClass("loading"),this.getHistoryAudioQueueSet.has(r))return;return await this.getHistoryAudio(r,c.audioPath),t.removeClass("loading"),void(this.lastAudioId===r&&(e(),s.play().catch((a=>{t.removeClass("active"),console.error("audio play error by history:",a)}))))}n&&s.play().catch((a=>{i.attr("data-path",""),i.attr("src",""),this.toggleAudioBtn(t,!0)}))}else t.removeClass("active"),""!==n&&s.pause()}setLoginTimer(){this.loginTimer&&clearTimeout(this.loginTimer),this.loginTimer=setTimeout((()=>{this.showLoginPopup()}),3e5)}showLoginPopup(t=function(){}){$("#userInputMsg").trigger("blur"),getCookie("access_token")||this.loginPopup?t():(gtag("event","alert_aigirlfriend_loginwin"),this.loginPopup=$Popup({title:gfChattingJsLan.loginTitle,content:gfChattingJsLan.loginContent,closeBtn:gfChattingJsLan.loginBtn,otherBtns:gfChattingJsLan.loginOtherBtn,exist:"chatLoginPopup",addBorderRadius:!0,onClose:()=>{this.loginPopup=null,this.setLoginTimer(),gtag("evet","login_aigirlfriend_loginwin"),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwin"),chatLogin()}})},topCloseFn:()=>{this.setLoginTimer(),gtag("evet","close_aigirlfriend_loginwin"),this.loginPopup=null}}),this.loginPopup.modal.find(".login-popup-close-btn").on("click",(()=>{gtag("evet","notnow_aigirlfriend_loginwin"),this.loginPopup.close(),this.loginPopup=null,this.setLoginTimer(),t()})))}changeBgAvatar(){let t=this;$(".aiAvatarImg").each((function(){$(this).attr("src",t.aiAvatarImg)})),$(".ai-name").each((function(){$(this).text(t.aiData.name)}));let a=new Image;a.onload=function(){t.bgImg||t.aiAvatarImg;t.ratio=this.width/this.height,t.ratio.toFixed(2)>1?t.boxPosition.changeBtnMiddle.chatBgImg.left=0:t.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";const a=$("#chatBgImg");t.ratio.toFixed(2)>1?a.css({width:"100vw",left:"0px"}):a.css({width:"661px",left:t.boxPosition[t.currentPosition||"changeBtnMiddle"].chatBgImg.left}),$(".audio_btn.bg").hasClass("active")?t.changeBackground(!0):t.changeBackground(!1)},a.src=t.bgImg||t.aiAvatarImg}hideShowImgBox(t,a){let e={avatarImgBox:{id:"#avatarText",iconId:"#avatarIcon",imgUrlObj:"uploadAvatar",blob:"changeAvatar",showFn:()=>{gtag("event","upload_aigirlfriend_avatar"),this.uploadAvatarChange=!0,$("#characterNameInput").val().length>0&&this.changePopup.enableCloseBtn()},hideFn:()=>{this.uploadAvatarChange=!1,this.changePopup.disableCloseBtn(),gtag("event","del_aigirlfriend_avatar")}},bgImgBox:{id:"#bgText",iconId:"#bgIcon",imgUrlObj:"uploadBg",blob:"changeBg",showFn:()=>{gtag("event","upload_aigirlfriend_bg"),this.uploadbg=!0},hideFn:()=>{this.uploadbg=!1}}},i="#"+t;({hide:()=>{$(i).hide(),$(e[t].id).text(gfChattingJsLan.changePopBtnSpanSet),$(e[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_small.png"),this[e[t].imgUrlObj]=!1,this.uploadBlob[e[t].blob]={},e[t].hideFn()},show:()=>{$(i).show(),$(e[t].id).text(gfChattingJsLan.changePopBtnSpanAddNew),this[e[t].imgUrlObj]=!0,$(e[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_normal.png"),e[t].showFn()}})[a]()}openChangeHandle(){let t,a=this;this.uploadStatus=!1,this.changePopup=$Popup({title:gfChattingJsLan.changePopTitle,content:`<div class="change-photo-box">\n          <div class="change-avatar-box">\n             <div>${gfChattingJsLan.changePopName}</div>\n             <div class="name-input-box">\n             <input type="text" id="characterNameInput" maxlength="100">\n           </div>\n            <div>${gfChattingJsLan.changePopAvatar}</div>\n            <div class="avatar-box">\n              <div class="avatar-img changeAvatarImg" id="avatarImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeAvatarIcon" class="close-icon" bindId="avatarImgBox" alt="close button" />\n\n                <img src="" alt="" id="changeAvatarImg" class="changeAvatarImg" />\n              </div>\n              <div class="replace-img-btn" id="changeAvatarId" fn="changeAvatar">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="avatarIcon" class="img-icon" />\n                  <div class="change-btn-text" id="avatarTextBox">${gfChattingJsLan.changePopBtn}</div>\n                </div>\n              </div>             \n            </div>\n            \n              <div class="avatar-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="avatarTip">${gfChattingJsLan.changePopSupport}</span>\n              </div>\n\n            <div class="change-bg-title">${gfChattingJsLan.changePopBgDesc}</div>\n            <div class="change-bg-sub">${gfChattingJsLan.changePopRecommend}</div>\n            <div class="avatar-box">\n              <div class="avatar-img" id="bgImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeBgIcon" class="close-icon" bindId="bgImgBox" alt="close icon"/>\n                <img src="" alt="" id="changeBgImg" class="changeBgImg" />\n              </div>\n              <div class="replace-img-btn" id="changeBgId" fn="changeBg">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="bgIcon" class="img-icon" />\n                  <div  class="change-btn-text" id="bgTextBox">${gfChattingJsLan.changePopBgBtn}</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="bg-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="bgTip">${gfChattingJsLan.changePopBgSupport}</span>\n           </div>\n\n            <input type="file" name="file" id="fileInput" style="display: none"   accept="image/jpeg, image/png, image/webp">\n          </div>\n        </div>`,closeBtn:gfChattingJsLan.changePopCloseBtn,otherBtns:gfChattingJsLan.changePopOtherBtn,autoClose:!1,topCloseFn:function(){this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,gtag("event","close_aigirlfriend_changephoto")},onClose:()=>{this.uploadStatus?this.saveCharacter():this.changePopup.close()},exist:"change"}),$("#changeOtherBtn").off("click").on("click",(()=>{a.uploadBlob={changeAvatar:{},changeBg:{}},gtag("event","discard_aigirlfriend_changephoto"),a.uploadStatus=!1,a.changePopup.close()}));const e=$("#characterNameInput");e.val(this.aiData.name),e.off("input").on("input",(function(){let t=$(this).val(),e=/[/*&\\%$#@]/g;e.test(t)&&$(this).val(t.replace(e,"")),t=$(this).val();let i=t.length;i>50&&($(this).val(t.substring(0,50)),i=50),a.uploadStatus=!0,0===i?a.changePopup.closeButton.disable():a.uploadAvatarChange&&a.changePopup.closeButton.enable()})),this.aiAvatarImg?$("#changeAvatarImg").attr("src",this.aiAvatarImg):a.hideShowImgBox("avatarImgBox","hide");const i=$("#changeBgImg");this.aiData.head_portrait_background.length&&this.bgImg?i.attr("src",this.bgImg):a.hideShowImgBox("bgImgBox","hide"),i.attr("src",this.bgImg),$("#closeAvatarIcon,#closeBgIcon").off("click").on("click",(function(){a.uploadStatus=!0;let t=$(this).attr("bindId");"bgImgBox"===t&&gtag("event","del_aigirlfriend_bg"),a.hideShowImgBox(t,"hide")})),$(".replace-img-btn").off("click").on("click",(function(){t=$(this).attr("fn"),$("#fileInput").trigger("click")})),$("#fileInput").off("change").on("change",(async function(){let e;const i={changeAvatar:{text:"#avatarTip",box:".avatar-tip-box"},changeBg:{text:"#bgTip",box:".bg-tip-box"}},s={changeAvatar:{icon:"#avatarIcon",text:"#avatarTextBox"},changeBg:{icon:"#bgIcon",text:"#bgTextBox"}};let n=s[t].icon,o=s[t].text,r=i[t].box,c=i[t].text;const h={changeAvatar:i=>{const s=new Image;s.onload=function(){const e=this.naturalHeight,s=this.naturalWidth;e<32||s<32?($("#avatarTip").text(gfChattingJsLan.changePopAvatarError),$(".avatar-tip-box").css("visibility","visible")):(a.uploadStatus=!0,$(".changeAvatarImg").attr("src",i),a.hideShowImgBox(g[t],"show"))},s.src=URL.createObjectURL(e),$(r).css("visibility","hidden")},changeBg:i=>{const s=new Image;s.onload=function(){const e=this.naturalHeight,s=this.naturalWidth;e<128||s<128?($("#bgTip").text(gfChattingJsLan.changePopBgError),$(".bg-tip-box").css("visibility","visible")):(a.uploadStatus=!0,a.bgImg=i,$(".changeBgImg").attr("src",a.bgImg),a.hideShowImgBox(g[t],"show"))},s.src=URL.createObjectURL(e),$(r).css("visibility","hidden")}};let g={changeAvatar:"avatarImgBox",changeBg:"bgImgBox"},l=this.files[0];const d=l.name.split(".").pop().toLowerCase();if(!/^(image\/(jpg|jpeg|png|webp))$/.test(l.type)||!/^jpg|jpeg|png|webp$/.test(d))return $(c).text(gfChattingJsLan.changePopSupport),$(r).css("visibility","visible"),$(this).val(null),!1;if(l?.size>104857600)return $(c).text(gfChattingJsLan.changePopMaxError),$(r).css("visibility","visible"),$(this).val(null),!1;$(n).attr("src","/dist/img/ai-chatting/icon_loading.svg"),$(n).addClass("popup-loading"),$(o).html(gfChattingJsLan.changePopUploading);let{blog:u}=await resizeImageByFile(l);if(u){let i=URL.createObjectURL(u);a.uploadBlob[t]=u,e=u,h[t](i)}else $(c).text(gfChattingJsLan.changePopSupport),$(r).css("visibility","visible");$(this).val(null),(()=>{$(n).removeClass("popup-loading"),$(n).attr("src","dist/img/ai-chatting/btn_add_normal.png");let a={changeAvatar:gfChattingJsLan.changePopBtn,changeBg:gfChattingJsLan.changePopBgBtn};$(o).html(a[t])})()}))}async getAiDetails(t,a,e){try{const i=await this.service.getRoleInfo(t,a,e);if(200===i.code)return i.data;$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),console.error("get-role-info",i.data.message)}catch(t){$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}}async getAiInfo(t,a,e){try{const i=await this.getAiDetails(t,a,e);i?this.init(i):$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}catch(t){$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}}async updateCharacterFunc(t,a,e){const i=["chat_id"];try{const s=await this.getAiDetails(t,a,e);for(const t in s)!s.hasOwnProperty(t)||this.aiData[t]&&i.includes(t)||(this.aiData[t]=s[t]);this.updateCharacter()}catch(t){console.error("update character error:",t)}}changeScreen(t){t?("pc"==userModel?($("#changeBtnMiddle").click(),$("#chattingContainer").css("height","80vh")):$("#chattingContainer").css("height","70vh"),$("#editIcon").hide(),$(".chatting-container").addClass("fullscreen")):($("#editIcon").show(),$(".chatting-container").removeClass("fullscreen"),$("#chattingContainer").css("height",this.chatHeight),$("#chattingContainer").scrollTop($("#chattingContainer").prop("scrollHeight")))}changeBackground(t){if(t)$("#AiChat,#chatBgImg").css({"background-image":"none","background-color":"#151820"});else{let t=this.bgImg||this.aiAvatarImg;$("#AiChat,#chatBgImg").css({"background-image":`url("${t}")`,"background-color":"transparent"})}}}function t(t,a={}){if(!t)return"";if(0===Object.keys(a).length)return t;for(const e in a)t=t.replace(new RegExp(`{{${e}}}`,"g"),a[e]);return t}function getUrlVal(t){const a=window.location.href;if(!a.includes("?"))return!1;const e=a.split("?")[1].split("&"),i={};return e.forEach((function(t){const a=t.split("="),e=decodeURIComponent(a[0]);i[e]=decodeURIComponent(a[1])})),i[t]}"placeholder"in document.createElement("input")||$("input[placeholder],textarea[placeholder]").each((function(){const t=$(this),a=t.attr("placeholder");""===t.val()&&t.val(a).addClass("placeholder"),t.focus((function(){t.val()===a&&t.val("").removeClass("placeholder")})).blur((function(){""===t.val()&&t.val(a).addClass("placeholder")})).closest("form").submit((function(){t.val()===a&&t.val("")}))}));