"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=a){var n,i,r,o,s=[],c=!0,l=!1;try{if(r=(a=a.call(t)).next,0===e){if(Object(a)!==a)return;c=!1}else for(;!(c=(n=r.call(a)).done)&&(s.push(n.value),s.length!==e);c=!0);}catch(t){l=!0,i=t}finally{try{if(!c&&null!=a.return&&(o=a.return(),Object(o)!==o))return}finally{if(l)throw i}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){a&&(t=a);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,s=!1;return{s:function(){a=a.call(t)},n:function(){var t=a.next();return o=t.done,t},e:function(t){s=!0,r=t},f:function(){try{o||null==a.return||a.return()}finally{if(s)throw r}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var a={}.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach((function(e){_defineProperty(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function _defineProperty(t,e,a){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function(){return e};var t,e={},a=Object.prototype,n=a.hasOwnProperty,i=Object.defineProperty||function(t,e,a){t[e]=a.value},r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",s=r.asyncIterator||"@@asyncIterator",c=r.toStringTag||"@@toStringTag";function l(t,e,a){return Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,a){return t[e]=a}}function u(t,e,a,n){var r=e&&e.prototype instanceof m?e:m,o=Object.create(r.prototype),s=new A(n||[]);return i(o,"_invoke",{value:S(t,a,s)}),o}function h(t,e,a){try{return{type:"normal",arg:t.call(e,a)}}catch(t){return{type:"throw",arg:t}}}e.wrap=u;var g="suspendedStart",d="suspendedYield",p="executing",f="completed",v={};function m(){}function _(){}function y(){}var b={};l(b,o,(function(){return this}));var k=Object.getPrototypeOf,x=k&&k(k(B([])));x&&x!==a&&n.call(x,o)&&(b=x);var C=y.prototype=m.prototype=Object.create(b);function w(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function $(t,e){function a(i,r,o,s){var c=h(t[i],t,r);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==_typeof(u)&&n.call(u,"__await")?e.resolve(u.__await).then((function(t){a("next",t,o,s)}),(function(t){a("throw",t,o,s)})):e.resolve(u).then((function(t){l.value=t,o(l)}),(function(t){return a("throw",t,o,s)}))}s(c.arg)}var r;i(this,"_invoke",{value:function(t,n){function i(){return new e((function(e,i){a(t,n,e,i)}))}return r=r?r.then(i,i):i()}})}function S(e,a,n){var i=g;return function(r,o){if(i===p)throw Error("Generator is already running");if(i===f){if("throw"===r)throw o;return{value:t,done:!0}}for(n.method=r,n.arg=o;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===g)throw i=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=p;var l=h(e,a,n);if("normal"===l.type){if(i=n.done?f:d,l.arg===v)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(i=f,n.method="throw",n.arg=l.arg)}}}function T(e,a){var n=a.method,i=e.iterator[n];if(i===t)return a.delegate=null,"throw"===n&&e.iterator.return&&(a.method="return",a.arg=t,T(e,a),"throw"===a.method)||"return"!==n&&(a.method="throw",a.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var r=h(i,e.iterator,a.arg);if("throw"===r.type)return a.method="throw",a.arg=r.arg,a.delegate=null,v;var o=r.arg;return o?o.done?(a[e.resultName]=o.value,a.next=e.nextLoc,"return"!==a.method&&(a.method="next",a.arg=t),a.delegate=null,v):o:(a.method="throw",a.arg=new TypeError("iterator result is not an object"),a.delegate=null,v)}function I(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function P(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function A(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(I,this),this.reset(!0)}function B(e){if(e||""===e){var a=e[o];if(a)return a.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,r=function a(){for(;++i<e.length;)if(n.call(e,i))return a.value=e[i],a.done=!1,a;return a.value=t,a.done=!0,a};return r.next=r}}throw new TypeError(_typeof(e)+" is not iterable")}return _.prototype=y,i(C,"constructor",{value:y,configurable:!0}),i(y,"constructor",{value:_,configurable:!0}),_.displayName=l(y,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===_||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,y):(t.__proto__=y,l(t,c,"GeneratorFunction")),t.prototype=Object.create(C),t},e.awrap=function(t){return{__await:t}},w($.prototype),l($.prototype,s,(function(){return this})),e.AsyncIterator=$,e.async=function(t,a,n,i,r){void 0===r&&(r=Promise);var o=new $(u(t,a,n,i),r);return e.isGeneratorFunction(a)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},w(C),l(C,c,"Generator"),l(C,o,(function(){return this})),l(C,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),a=[];for(var n in e)a.push(n);return a.reverse(),function t(){for(;a.length;){var n=a.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=B,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(P),!e)for(var a in this)"t"===a.charAt(0)&&n.call(this,a)&&!isNaN(+a.slice(1))&&(this[a]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var a=this;function i(n,i){return s.type="throw",s.arg=e,a.next=n,i&&(a.method="next",a.arg=t),!!i}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),l=n.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(t,e){for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var r=i;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=e,r?(this.method="next",this.next=r.finallyLoc,v):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var a=this.tryEntries[e];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),P(a),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var a=this.tryEntries[e];if(a.tryLoc===t){var n=a.completion;if("throw"===n.type){var i=n.arg;P(a)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,a,n){return this.delegate={iterator:B(e),resultName:a,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function asyncGeneratorStep(t,e,a,n,i,r,o){try{var s=t[r](o),c=s.value}catch(t){return void a(t)}s.done?e(c):Promise.resolve(c).then(n,i)}function _asyncToGenerator(t){return function(){var e=this,a=arguments;return new Promise((function(n,i){var r=t.apply(e,a);function o(t){asyncGeneratorStep(r,n,i,o,s,"next",t)}function s(t){asyncGeneratorStep(r,n,i,o,s,"throw",t)}o(void 0)}))}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var n=a.call(t,e||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}var SOCKET,defaultUserAvatar="/dist/img/aiFriend/icon_avatar.svg",gfChattingLan=jsonData.aiGirlFriendChat,gfChattingJsLan=jsonData.aiGirlFriendChat.javascript,PromiseWait=function(){return _createClass((function t(){var e=this;_classCallCheck(this,t),this.promise=new Promise((function(t){e.resolve=t}))}),[{key:"wait",value:(e=_asyncToGenerator(_regeneratorRuntime().mark((function t(){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.promise);case 1:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"finish",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function t(){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.resolve();case 1:case"end":return t.stop()}}),t,this)}))),function(){return t.apply(this,arguments)})}]);var t,e}(),AiGirlfriendTalkingService=function(){return _createClass((function t(){_classCallCheck(this,t)}),[{key:"getMessageInfo",value:function(t,e){var a=new URLSearchParams({chat_id:t});return e>0&&a.append("page",e.toString()),fetchGet("chat/user/get-message-info?".concat(a.toString()))}},{key:"getChatServer",value:function(t){return fetchPost("chat/user/get-chat-server",t)}},{key:"getRoleInfo",value:function(t,e,a){var n=new URLSearchParams({id:t,is_my_characters:e});return a&&1===e&&n.append("my_characters_id",a),fetchGet("chat/user/get-role-info?".concat(n.toString()))}},{key:"putLike",value:function(t){return fetchPost("chat/user/role-like",{role_id:t})}},{key:"roleEdit",value:function(t){return fetchPost("chat/user/role-edit",t)}},{key:"getUploadUrl",value:function(t){return fetchPost("ai/source/get-upload-url",t)}},{key:"saveAudio",value:function(t,e,a,n){return fetchPost("chat/user/up-message",{id:t,chat_id:e,task_timestamp:a,path:n})}},{key:"getUploadFileUrl",value:function(){return fetchPost("ai/source/temp-upload-url",{file_name:"ai-girlfriend-audio.mp3"})}},{key:"putUploadUrl",value:function(t,e){return fetchPut(t,e)}},{key:"putLog",value:function(t){return fetchPost("chat/public/add-log",t)}},{key:"getVoiceLimit",value:function(){return fetchGet("chat/user/get-voice-limit")}},{key:"getAccessUrl",value:function(t){return fetchPost("ai/source/get-access-url",{key:t,action:"browse"})}},{key:"delChattingRecords",value:function(t,e){return fetchPost("chat/user/del-recent-chatting",t).then((function(){null==e||e()})).catch((function(t){console.log("del-recent-chatting",t)}))}}])}(),AiGirlfriendTalking=function(){return _createClass((function t(){_classCallCheck(this,t),_defineProperty(this,"service",new AiGirlfriendTalkingService),_defineProperty(this,"hasAudio",!1),_defineProperty(this,"lastMessage",null),_defineProperty(this,"lottiePlayerAudioLoading",$("#audio-loading-icon").clone()),_defineProperty(this,"sendAudioQueue",[]),_defineProperty(this,"getHistoryAudioQueueSet",new Set),_defineProperty(this,"timeoutAudioQueueMap",new Map),_defineProperty(this,"lastAudioId",void 0),this.boxPosition={changeBtnLeft:{chattingContainer:{height:"64vh"},chattingBox:{left:".8rem",right:"auto"},chatBgImg:{right:"0px",left:"auto"},changePhotoBtn:{right:".8rem",left:"auto"}},changeBtnMiddle:{chattingContainer:{height:"340px"},chattingBox:{left:"calc(50% - 38.54vw / 2)",right:"auto"},chatBgImg:{right:"auto",left:"calc(50% - 661px / 2)"},changePhotoBtn:{right:"auto",left:".8rem"}},changeBtnRight:{chattingContainer:{height:"64vh"},chattingBox:{left:"auto",right:".8rem"},chatBgImg:{right:"auto",left:"0"},changePhotoBtn:{right:"auto",left:".8rem"}}},this.updateAudioLimit()}),[{key:"data",value:function(){return{modelDOM:$("#AiChat"),userMessage:$("#userInputMsg").value}}},{key:"init",value:(f=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a){var n,i,r,o,s,c,l,u,h,g,d,p,f;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return gtag("event","chat_aigirlfriend_".concat(e.role_id)),gtag("event","enter_aigirlfriend_chatting"),u=this,this.loginPopup=null,this.isChat=!1,this.socketClose=!1,this.chatPage=-1,this.initHistory=!0,this.isSyncingHistroy=!1,this.isConnectingSocket=!1,this.isOldSeverUrl=!1,this.chatMap=new Map,this.helloTimer=null,this.promiseWaitMap=new Map,this.isChangeData=!1,this.lastSendMsg="",this.aiData=_objectSpread({},e),this.aiAvatarImg=null==e||null===(n=e.head_portrait[0])||void 0===n?void 0:n.url,this.bgImg=e.head_portrait_background.length>0?null===(i=e.head_portrait_background[0])||void 0===i?void 0:i.url:null===(r=e.head_portrait[0])||void 0===r?void 0:r.url,this.backImg='url("'.concat((null===(o=e.head_portrait_background[0])||void 0===o?void 0:o.url)||this.bgImg,'")'),this.uploadAvatarChange=!0,this.uploadbg=(null===(s=e.head_portrait_background[0])||void 0===s?void 0:s.url)||!1,getCookie("user_info")&&(this.userData=JSON.parse(getCookie("user_info"))),this.userAvatarImg=(null===(c=this.userData)||void 0===c?void 0:c.head_portrait)||defaultUserAvatar,this.connectMsg={user_id:"0"|(null===(l=this.userData)||void 0===l?void 0:l.id),role_id:e.role_id+"",role_name:e.name,chat_id_name:"",chat_id:"",token:getCookie("SsToken")},this.connectMsg.user_id=this.connectMsg.user_id+"",this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,$(".chatting-container").empty(),h="changeBtnMiddle",localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(h=localStorage.getItem("chattingPosition")),this.changePosition(h),$(".audio_btn.screen").hasClass("active")||"true"==localStorage.getItem("aiChat-screen")?($(".audio_btn.screen").addClass("active"),this.changeScreen(!0)):($(".audio_btn.screen").removeClass("active"),this.changeScreen(!1)),this.mobileInit(),this.data().modelDOM.fadeIn(),$("body").css({overflow:"hidden",position:"fixed"}),this.setLoginTimer(),$(".hidden-box #aiAvatarImg").attr("src",this.aiAvatarImg),$("#myAvatarImg").attr("src",this.userAvatarImg),$(".audio_btn.bg").hasClass("active")||"true"==localStorage.getItem("aiChat-bg")?($(".audio_btn.bg").addClass("active"),this.changeBackground(!0)):($(".audio_btn.bg").removeClass("active"),this.changeBackground(!1)),(g=new Image).onload=function(){u.ratio=this.width/this.height,u.ratio.toFixed(2)>1?u.boxPosition.changeBtnMiddle.chatBgImg.left=0:u.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";var t="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(t=localStorage.getItem("chattingPosition"));var e=$("#chatBgImg");u.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:u.boxPosition[t].chatBgImg.left})},g.src=this.bgImg,this.updateCharacter(),t.prev=44,t.next=47,this.updateCharacterFunc(e.role_id,e.is_my_characters,e.my_characters_id);case 47:return t.next=49,this.getChatData("",a);case 49:if(d=t.sent){t.next=52;break}return t.abrupt("return");case 52:if(!(p=getUrlVal("headAvatar"))){t.next=57;break}return f=getUrlVal("form"),t.next=57,this.fromUndressFn(f,p);case 57:this.isMyCharacterStatus=this.aiData.is_my_characters,this.aiData.toMyCharacter=!1,this.connectChatting(d.server_url),this.getChatHistory(),$(".chat_loading").hasClass("active")&&this.chatReLoading(!1),t.next=67;break;case 64:t.prev=64,t.t0=t.catch(44),console.error("init error",t.t0);case 67:case"end":return t.stop()}}),t,this,[[44,64]])}))),function(t,e){return f.apply(this,arguments)})},{key:"updateAudioLimit",value:(p=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.service.getVoiceLimit();case 2:(a=e.sent).data?(this.hasAudio=a.data.sum_num>0,$(".ai-gf-info-dialog-wrap .audio-limit-desc").text(t(gfChattingLan.audioLimitDesc,{sum_num:a.data.sum_num}))):console.error("getVoiceLimit error",a);case 4:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getChatHistory",value:(d=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a,n,i,r,o,s,c,l,u,h,g,d,p,f,v,m,_,y;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.isSyncingHistroy&&this.chatPage){t.next=2;break}return t.abrupt("return");case 2:if(this.aiData.chat_id&&this.connectMsg.chat_id){t.next=4;break}return t.abrupt("return");case 4:return this.isSyncingHistroy=!0,t.prev=5,t.next=8,this.service.getMessageInfo(this.connectMsg.chat_id,this.chatPage);case 8:if(200!==(e=t.sent).code||!e.data){t.next=42;break}if(this.isChat=!0,i=e.data.page,r=null===(a=e.data.list)||void 0===a?void 0:a.filter((function(t){return!!t.chat_content.content})),ttsBlank(r)&&(r=[]),0!==(null===(n=r)||void 0===n?void 0:n.length)||!this.chatPage){t.next=20;break}return this.isSyncingHistroy=!1,this.chatPage=i,t.next=19,this.getChatHistory();case 19:return t.abrupt("return");case 20:o=$(".chatting-container"),s=o.scrollTop(),c=o[0].scrollHeight,o.css("overflow-y","hidden"),l=_createForOfIteratorHelper(r);try{for(l.s();!(u=l.n()).done;)"user"===(h=u.value).chat_content.role?(g=$("#myMessageBox"),this.showMessage(g,h.chat_content.content,".my-message-container",!0,h)):(d=$("#aiMessageBox"),this.showMessage(d,h.chat_content.content,".ai-message-container",!0,h))}catch(t){l.e(t)}finally{l.f()}if(o.css("overflow-y","auto"),this.initHistory?o.scrollTop(o.prop("scrollHeight")):(p=o[0].scrollHeight,f=p-c,o.scrollTop(s+f)),this.initHistory=!1,this.chatPage=i,!(r.length<5&&i)){t.next=36;break}return this.isSyncingHistroy=!1,t.next=34,this.getChatHistory();case 34:t.next=42;break;case 36:if(!(this.chatMap.size<2)){t.next=38;break}return t.abrupt("return");case 38:v=this.chatMap.entries(),m=v.next().value,_=v.next().value,"assistant"==m[1].sendUser&&"user"==_[1].sendUser&&($(".ai-message-box").eq(-2).find(".rechat").show(),y=_objectSpread(_objectSpread({},this.connectMsg),{},{chat_content:_[1].content,request_type:20,chat_action:"",UserSendTime:(new Date).getTime()}),this.UserSendTime=y.UserSendTime,this.lastMessage=JSON.stringify(y));case 42:t.next=47;break;case 44:t.prev=44,t.t0=t.catch(5),console.error("getChatHistory error",t.t0);case 47:return t.prev=47,this.isSyncingHistroy=!1,t.finish(47);case 50:case"end":return t.stop()}}),t,this,[[5,44,47,50]])}))),function(){return d.apply(this,arguments)})},{key:"getChatData",value:(g=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a,n,i,r,o=arguments;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=o.length>0&&void 0!==o[0]?o[0]:"",a=o.length>1&&void 0!==o[1]?o[1]:"",n={chat_id:this.aiData.chat_id,role_id:this.connectMsg.role_id,is_my_characters:this.aiData.is_my_characters,last_server_url:e,is_new:a?1:2},1===this.aiData.is_my_characters&&(n.my_characters_id=this.aiData.my_characters_id),t.next=6,this.service.getChatServer(n);case 6:if(401!==(i=t.sent).code){t.next=11;break}return t.next=10,this.closeChat();case 10:return t.abrupt("return",!1);case 11:if(200===i.code&&i.data){t.next=15;break}return console.error("getChatData error",i.message),$Popup({type:"error",errorType:"normal"}),t.abrupt("return",!1);case 15:return(r=i.data).is_old_server_url&&1===r.is_old_server_url&&(this.isOldSeverUrl=!0),this.socketUrl=r.server_url,this.connectMsg.chat_id=r.chat_id,this.aiData.chat_id=r.chat_id,this.connectMsg.chat_id_name=r.chat_id_name,t.abrupt("return",r);case 22:case"end":return t.stop()}}),t,this)}))),function(){return g.apply(this,arguments)})},{key:"AiHello",value:function(){var t=_objectSpread(_objectSpread({},this.connectMsg),{},{request_type:50,chat_last_sep:3234});clearTimeout(this.helloTimer),this.helloTimer=setTimeout((function(){SOCKET.send(JSON.stringify(t))}),24e4)}},{key:"fromUndressFn",value:(h=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a){var n,i,r,o,s,c,l,u;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=atob(getUrlVal("avatarKey")),c=atob(a),l={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:this.aiData.name,is_draft:2,tag:null!==(n=this.aiData.json.tag)&&void 0!==n?n:"",persona:null!==(i=this.aiData.persona)&&void 0!==i?i:"",gender:null!==(r=this.aiData.json.gender)&&void 0!==r?r:"",description:null!==(o=this.aiData.json.Character_des)&&void 0!==o?o:"",scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait:JSON.stringify([{key:"head_portrait",value:s,is_temp:1}]),head_portrait_background:JSON.stringify(this.aiData.head_portrait_background)},this.aiData.head_portrait=[{key:"head_portrait",value:c,url:c}],this.aiAvatarImg=c,this.aiData.status=2,this.updateCharacter(),$(".chatting-share").hide(),this.aiData.is_my_characters=1,this.bgImg="",this.changeBgAvatar(),e){t.next=13;break}return t.abrupt("return");case 13:return t.next=15,this.service.roleEdit(l);case 15:if(200===(u=t.sent).code&&(aiGirlFriend.GetRecentChatting(),this.aiData.toMyCharacter=!0,history.pushState(null,null,"/novia-virtual.html?openShare=".concat(getUrlVal("openShare"),"&headAvatar=").concat(a,"&avatarKey=").concat(btoa(s))),this.aiData.my_characters_id=u.data.my_characters_id,this.aiData.role_id=u.data.role_id,this.aiData.is_my_characters=1,this.isChangeData=!0),401!==u.code){t.next=21;break}return t.next=20,this.closeChat();case 20:return t.abrupt("return");case 21:return t.next=23,this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id);case 23:case"end":return t.stop()}}),t,this)}))),function(t,e){return h.apply(this,arguments)})},{key:"mobileInit",value:function(){var t;window.innerWidth<1200&&($("#changePhotoBtn").text(jsonData.aiGirlFriendChat.changePhoto),t=1===this.aiData.is_my_characters?"1.4rem":"1.92rem",$(".change-photo-btn").css({left:"auto",right:t}))}},{key:"updateCharacter",value:function(){$(".chatting-count").text(formatNumber(this.aiData.msg_num)),$(".ai-chat-gf-avatar, .ai-gf-info-dialog-avatar").attr("src",this.aiAvatarImg),$(".ai-gf-info-dialog-birthday").text(this.aiData.json.Created),$(".ai-gf-info-dialog-desc").text(this.aiData.json.Character_des),$(".ai-chat-gf-name, .ai-gf-info-dialog-name").text(this.aiData.name),this.toggleShareBtn(1===this.aiData.status&&1===this.aiData.type);var t=this.aiData.json.tag.split(",").filter((function(t){return""!==t})).map((function(t){var e=jsonAiGirlFriend.setting_tag[t]||t;return'<div class="ai-gf-info-dialog-tag">'.concat(e,"</div>")}));$(".ai-gf-info-dialog-tags").html(t.join("")),1===this.aiData.is_like?($(".no-like-icon").hide(),$(".like-icon").show()):($(".no-like-icon").show(),$(".like-icon").hide())}},{key:"bindEvent",value:function(){var t=this,e=this;$("#userInputMsg").on("input",(function(){var t=$(this).val().length;window.innerWidth>1200?this.style.height=this.scrollHeight+"px":this.style.height=this.scrollHeight/100+.5+"rem",(0===t||t<37)&&(window.innerWidth>1200?this.style.height="46px":this.style.height=".88rem");var e=$(".send-btn");0===t||/^\s*$/.test($(this).val())?e.addClass("disable"):e.removeClass("disable")})),$("#backIcon, #closeIcon").on("click",(function(){"backIcon"===$(this).attr("id")?gtag("event","back_aigirlfriend_chatting"):gtag("event","close_aigirlfriend_chatting"),e.closeChat("click")})),$(".chatting-container").on("click",".audio-button",(function(t){var a=$(t.currentTarget);gtag("event","click_aigirlfriend_voice"),e.toggleAudioBtn(a,!a.hasClass("active"))})),$("#sendMsg").on("click",(function(){t.sendMessage(),$("#userInputMsg").trigger("focus")})),$(".ai-chat-box textarea").on("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),t.sendMessage())})),$("#editIcon").on("click",(function(){$(".change-position-box").toggle()})),$(document).on("click",(function(t){var a=$(t.target);a.closest("#editIcon").length||a.closest(".change-position-box").length||$(".change-position-box").hide(),a.closest(".right-button-box-m-dropdown").length||a.closest(".right-button-box-m-dropdown-menu").length||e.toggleGFDropdown(!1)})),$(".change-btns-box .change-btn").on("click",(function(){var t=$(this).attr("id");gtag("event",{changeBtnLeft:"left_aigirlfriend_pos",changeBtnMiddle:"mid_aigirlfriend_pos",changeBtnRight:"right_aigirlfriend_pos"}[t]),e.changePosition(t),$(".change-position-box").hide()})),$("#changePhotoBtn").on("click",(function(){gtag("event","click_aigirlfriend_changephoto"),t.openChangeHandle()})),$(".chatting-like").on("click",_asyncToGenerator(_regeneratorRuntime().mark((function t(){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.isChangeData=!0,t.prev=1,e.toggleLikeBtn(),t.next=5,e.service.putLike(e.aiData.role_id);case 5:200===t.sent.code?$(this).closest(".ai-gf-info-dialog").length>0?gtag("event","like_aigirlfriend_view"):1===e.aiData.is_like&&gtag("event","like_aigirlfriend_chatting"):($Popup({type:"error",errorType:"network"}),e.toggleLikeBtn()),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),console.error("like error",t.t0),$Popup({type:"error",errorType:"network"}),e.toggleLikeBtn();case 14:case"end":return t.stop()}}),t,this,[[1,9]])})))),$(".discord-box").on("click",(function(){gtag("event","discord_aigirlfriend_chatting")})),$(".chatting-share").on("click",(function(e){$(e.target).closest(".ai-gf-info-dialog").length>0?gtag("event","share_aigirlfriend_view"):(gtag("event","share_aigirlfriend_chatting"),$(".chatting-setting").removeClass("active")),aiGirlFriend.showShare(t.aiData.role_id,t.aiData.head_portrait[0].value)})),$(".ai-chat-gf-view").on("click",(function(){t.toggleGFInfoDialog(!0,".ai-gf-info-dialog")})),$(".ai-gf-info-dialog-close, .ai-gf-info-dialog-bg").on("click",(function(){t.toggleGFInfoDialog(!1)})),$(".right-button-box-m-dropdown").on("click",(function(){var e=$(".right-button-box-m-dropdown-menu").is(":visible");t.toggleGFDropdown(!e)})),$("#chattingContainer").on("scroll",(function(){0===$(this).scrollTop()&&e.getChatHistory()})),$(".chatting-newChat").click(_asyncToGenerator(_regeneratorRuntime().mark((function t(){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.isSyncingHistroy){t.next=2;break}return t.abrupt("return");case 2:return gtag("event","newchat_aigirlfriend_chatting"),t.next=5,e.closeChat(!1,"new");case 5:e.aiData.chat_id=void 0,e.connectMsg=null,e.init(e.aiData,"new");case 8:case"end":return t.stop()}}),t)})))),$(".chatting-restart").click((function(){if(!e.isSyncingHistroy){gtag("event","restartchat_aigirlfriend_chatting");var t=$Popup({title:jsonData.aiGirlFriendChat.restartTitle,content:jsonData.aiGirlFriendChat.restartText,closeBtn:jsonData.aiGirlFriendChat.resetChat,applyBtn:jsonAiGirlFriend.Cancel,autoClose:!1,exist:"bootLogin",onClose:function(){t.loading.start(),aiGirlFriend.deleteChat(e.aiData.chat_id,_asyncToGenerator(_regeneratorRuntime().mark((function a(){return _regeneratorRuntime().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return t.close(),a.next=3,e.closeChat(!1,"restart");case 3:return a.next=5,aiGirlFriend.GetRecentChatting();case 5:delete e.aiData.chat_id,e.init(e.aiData,"restart");case 7:case"end":return a.stop()}}),a)}))))},onApply:function(){t.close()},topCloseFn:function(){t.close()}})}})),$(".audio_btn").click((function(){$(this).toggleClass("active"),$(this).hasClass("screen")?(gtag("event","fullscreen_aigirlfriend_chatting"),$(this).hasClass("active")?(localStorage.setItem("aiChat-screen",!0),e.changeScreen(!0)):(localStorage.setItem("aiChat-screen",!1),e.changeScreen(!1))):$(this).hasClass("bg")&&(gtag("event","hidebackground_aigirlfriend_chatting"),$(this).hasClass("active")?(localStorage.setItem("aiChat-bg",!0),e.changeBackground(!0)):(localStorage.setItem("aiChat-bg",!1),e.changeBackground(!1)))})),$("body").on("mouseup",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function t(a){var n,i,r,o,s,c,l,u,h,g,d,p,f,v;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=$(a.target),i=$(".chat-btn-setting")[0].contains(a.target),(n.hasClass("chat-btn-setting")||n.hasClass("chat-btn-icon"))&&gtag("event","chatsettings_aigirlfriend_chatting"),$(".audio_btn")[0].contains(a.target)||$(".audio_btn")[1].contains(a.target)||(i?$(".chat-btn-setting").toggleClass("active"):$(".chat-btn-setting").removeClass("active")),$(".setting_box").hide(),!n.hasClass("msgSetting")){t.next=13;break}gtag("event","click_aigirlfriend_msgsettings"),r=n.hasClass("my")?"my":"ai",$(".ai-message-box,.my-message-box").css("z-index",""),n.parents(".".concat(r,"-message-box")).css("z-index",1),n.children(".setting_box").show(),t.next=35;break;case 13:if(!n.hasClass("setting_copy")){t.next=22;break}n.parents(".setting_box").hide(),o=n.parents(".chatOperation"),s="assistant"==o.data("sender")?"ai":"my",n.parents(".".concat(s,"-message-box")).css("z-index",""),c=n.parents(".".concat(s,"-message-box")).find(".chat_msg"),copyText(c.text()),t.next=35;break;case 22:if(!n.hasClass("setting_delete")){t.next=33;break}if(l=n.parents(".chatOperation"),l.data("ischecktime")){t.next=27;break}return t.abrupt("return");case 27:u="assistant"==l.data("sender")?"ai":"my",h={chat_id:e.aiData.chat_id,role:l.data("sender"),task_timestamp:l.data("timestamp")},e.service.delChattingRecords(h),n.parents(".".concat(u,"-message-box")).remove(),t.next=35;break;case 33:$(".ai-message-box,.my-message-box").css("z-index",""),$(".ai-message-box,.my-message-box").find(".setting_box").hide();case 35:if(!n.hasClass("rechat")){t.next=54;break}if(gtag("event","click_aigirlfriend_rechat"),g=n.parents(".chatOperation"),g.data("ischecktime")){t.next=41;break}return t.abrupt("return");case 41:return d="assistant"==g.data("sender")?"ai":"my",p=g.data("timestamp"),f={chat_id:e.aiData.chat_id,role:"assistant",task_timestamp:p},v={chat_id:e.aiData.chat_id,role:"user",task_timestamp:p},n.parents(".".concat(d,"-message-box")).remove(),e.setChatLoading(!0),t.next=49,e.service.delChattingRecords(f);case 49:return t.next=51,e.service.delChattingRecords(v);case 51:SOCKET?SOCKET.readyState===WebSocket.OPEN?SOCKET.send(e.lastMessage):SOCKET.readyState===WebSocket.CLOSED?(e.disconnectMessage=e.lastMessage,e.connectChatting(e.socketUrl)):e.disconnectMessage=e.lastMessage:e.disconnectMessage=e.lastMessage,$('.chatOperation[data-timestamp="'.concat(p,'"]')).attr("data-timestamp",e.UserSendTime);case 54:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"changePosition",value:function(t){this.currentPosition=t,getCookie("user_info")?localStorage.setItem("chattingPosition",t):localStorage.removeItem("chattingPosition"),$("#"+t).addClass("change-active").siblings().removeClass("change-active");var e=this.boxPosition;for(var a in e[t]){var n="#".concat(a);for(var i in e[t][a])"chattingContainer"==a?this.chatHeight=e[t][a][i]:$(n).css(i,e[t][a][i])}var r=$(".chatting-container");r.scrollTop(r.prop("scrollHeight"))}},{key:"isMobile",value:function(){return window.innerWidth<1200}},{key:"toggleGFInfoDialog",value:function(t,e){var a=$(".ai-gf-info-dialog-wrap");if(a.children("div").not(".ai-gf-info-dialog-bg").hide(),e&&a.find(e).show(),this.isMobile()?t?a.show(0,(function(){return a.addClass("active")})):a.removeClass("active").hide():t?a.fadeIn(160):a.fadeOut(160),t&&".ai-gf-info-dialog"===e)gtag("event","show_aigirlfriend_view")}},{key:"toggleGFDropdown",value:function(t){var e=$(".right-button-box-m-dropdown-menu");this.isMobile()?t?e.slideDown(160):e.slideUp(160):t?e.fadeIn(160):e.fadeOut(160)}},{key:"toggleShareBtn",value:function(t){var e=$(".chatting-share");t?e.show():e.hide()}},{key:"toggleLikeBtn",value:function(){var t=1!==this.aiData.is_like;this.aiData.is_like=t?1:2;var e=$(".like-icon"),a=$(".no-like-icon");t?(e.show(),a.hide()):(e.hide(),a.show())}},{key:"closeChat",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function t(e){var a,n,i=this,r=arguments;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=r.length>1&&void 0!==r[1]?r[1]:"",n=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,n,r,o;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i.toggleGFInfoDialog(!1),$(".change-position-box").hide(),$("body").css({"overflow-y":"auto",position:"static"}),history.pushState(null,null,"/novia-virtual.html"),clearInterval(i.loginTimer),clearInterval(i.heartTimer),clearInterval(i.disconnectTimer),clearTimeout(i.helloTimer),i.clearTimeoutAudioQueue(),i.clearPromiseWait(),i.changePopup=null,i.loginPopup=null,(n=$("#userInputMsg")).val(""),window.innerWidth>1200?n.css("height","46px"):n.css("height",".88rem"),(r=$(".chatting-container")).find("audio").off("play pause ended"),r.empty(),$Popup().closeAll(),a?i.chatReLoading(!0):i.data().modelDOM.fadeOut(),i.socketClose=!0,null===(e=SOCKET)||void 0===e||e.close(),i.isChat&&"restart"!=a&&(o=_objectSpread({},i.aiData),aiGirlFriend.addRecentChatting(o)),aiGirlFriend.resetAll=i.isChangeData,aiGirlFriend.resetMy=i.isChangeData,t.next=27,aiGirlFriend.initCharacters(!0);case 27:aiGirlFriend.GetMyCharacters(!0);case 28:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),!e){t.next=6;break}this.showLoginPopup(_asyncToGenerator(_regeneratorRuntime().mark((function t(){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n();case 2:case"end":return t.stop()}}),t)})))),t.next=8;break;case 6:return t.next=8,n();case 8:case"end":return t.stop()}}),t,this)}))),function(t){return u.apply(this,arguments)})},{key:"connectChatting",value:function(t,e){var a=this;if(!this.socketClose&&t&&!this.isConnectingSocket){this.isConnectingSocket=!0,(SOCKET=new WebSocket(t)).binaryType="arraybuffer";var n=_objectSpread(_objectSpread({},this.connectMsg),{},{chat_last_sep:3234,request_type:this.isOldSeverUrl?11:10,chat_action:"",UserSendTime:(new Date).getTime()});this.UserSendTime=n.UserSendTime,this.isOldSeverUrl=!1;var i=_objectSpread(_objectSpread({},this.connectMsg),{},{request_type:40});clearInterval(this.heartTimer),this.heartTimer=setInterval((function(){SOCKET.readyState===WebSocket.OPEN&&SOCKET.send(JSON.stringify(i))}),4e4),SOCKET.onopen=function(){a.isConnectingSocket=!1,a.disconnectTimer=setTimeout((function(){SOCKET.close()}),3e5),SOCKET.send(JSON.stringify(n)),a.AiHello(),a.sendAudioQueue.length&&setTimeout((function(){for(;a.sendAudioQueue.length>0;)SOCKET.send(a.sendAudioQueue.shift())}),1e3),a.disconnectMessage&&setTimeout((function(){SOCKET.send(a.disconnectMessage),a.disconnectMessage=""}),1e3)},SOCKET.onmessage=function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var i,r,o,s,c,l,u,h;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a.wssResponse=JSON.parse(n.data),[300,7001,7002].includes(a.wssResponse.status)&&(c=_objectSpread(_objectSpread({},a.connectMsg),{},{error_msg:null===(r=a.wssResponse)||void 0===r?void 0:r.error_info,versions:currentVersion,time_stamp:null!==(o=null===(s=a.wssResponse)||void 0===s?void 0:s.time_stamp)&&void 0!==o?o:"",wss:a.socketUrl,wssResponse:a.wssResponse}),a.service.putLog(c)),a.wssResponse.next_time||(clearTimeout(a.disconnectTimer),a.disconnectTimer=setTimeout((function(){SOCKET.close()}),3e5)),300!==a.wssResponse.status&&500!==a.wssResponse.status){e.next=14;break}return SOCKET.close(),a.disconnectMessage=a.lastMessage,e.next=9,a.getChatData(t);case 9:if(l=e.sent){e.next=12;break}return e.abrupt("return");case 12:return a.connectChatting(l.server_url),e.abrupt("return");case 14:if(6001!==a.wssResponse.status){e.next=18;break}return gtag("event","already_aigirlfriend_win"),a.closeChat(),e.abrupt("return");case 18:if(7001!==a.wssResponse.status){e.next=23;break}return console.error("audio error",{time_stamp:a.wssResponse.time_stamp,message:a.wssResponse.error_info}),a.deleteTimeoutAudioQueue(a.wssResponse.time_stamp),$('[data-id="'.concat(a.wssResponse.time_stamp,'"]')).removeClass("active"),e.abrupt("return");case 23:if(7002!==a.wssResponse.status){e.next=28;break}return console.error("audio service error",{time_stamp:a.wssResponse.time_stamp,message:a.wssResponse.error_info}),a.deleteTimeoutAudioQueue(a.wssResponse.time_stamp),$('[data-id="'.concat(a.wssResponse.time_stamp,'"]')).removeClass("active"),e.abrupt("return");case 28:if(21!==a.wssResponse.status){e.next=31;break}return a.assemblyAudioChunk(a.wssResponse),e.abrupt("return");case 31:u=null===(i=a.wssResponse)||void 0===i?void 0:i.chat_content,h=$("#aiMessageBox"),a.showMessage(h,u,".ai-message-container",!1,a.wssResponse);case 34:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),SOCKET.onerror=function(t){a.isConnectingSocket=!1,console.error("socket error",t)},SOCKET.onclose=function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a.isConnectingSocket=!1,n.wasClean||a.socketClose){e.next=8;break}return e.next=4,a.getChatData(t);case 4:if(i=e.sent){e.next=7;break}return e.abrupt("return");case 7:a.connectChatting(i.server_url);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}}},{key:"setChatLoading",value:function(t){var e=this,a=$(".chatting-container");t?(a.append('\n        <div class="ai-message-box item loading">\n          <div class="img-container">\n            <img src="'.concat(this.aiAvatarImg,'" alt="" id="aiAvatarImg" class="aiAvatarImg" />\n          </div>\n          <div class="ai-message-container loading">\n            <div class="chatting-loading-new">\n              <span class="relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n              <span class="animation-delay-200 relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n              <span class="animation-delay-400 relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n            </div>\n          </div>\n        </div>\n      ')),this.chatLoadingTime=0,this.loadingChatTimer=setInterval((function(){$(".chatting-loading").css("background-position-x",e.chatLoadingTime+"px"),e.chatLoadingTime=e.chatLoadingTime+8}),200)):(clearInterval(this.loadingChatTimer),this.loadingChatTimer=null,this.chatLoadingTime=0,$(".ai-message-box.item.loading").remove())}},{key:"chatReLoading",value:function(t){t?$(".chat_loading").addClass("active"):$(".chat_loading").removeClass("active")}},{key:"setRmoveRecords",value:function(t){if(t&&!ttsBlank(t.UserSendTime)){var e,a=$('.chatOperation[data-timestamp="'.concat(t.UserSendTime,'"]'));if(0!=a.length)a.attr("data-timestamp",null!==(e=t.time_stamp)&&void 0!==e?e:t.task_timestamp),a.attr("data-isCheckTime",!0)}}},{key:"showMessage",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a,n,i,r,o){var s,c,l,u,h,g,d,p,f,v,m,_,y,b,k;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(k=function(t){return/^\*[^*]+\*$/.test(t)},a){t.next=3;break}return t.abrupt("return");case 3:s=e.clone().removeAttr("id"),c=k(a)?a.replace(/\*(.*?)\*/g,'<p style="margin:0">($1)</p>'):a.replace(/\*(.*?)\*/g,"<p>($1)</p>"),".ai-message-container"===n?(h=null!==(l=r.time_stamp)&&void 0!==l?l:r.task_timestamp,this.chatMap.set(h,{content:a,timestamp:h,sendUser:"assistant",page:this.chatPage>-1&&i?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:null!==(u=r.chat_content.path)&&void 0!==u?u:""}),this.lottiePlayerAudioLoading.removeAttr("id"),$(".rechat").hide(),c='<div class="chatOperation" data-timestamp=\''.concat(h,"' data-sender='assistant' data-isCheckTime='true'>\n                    <div class=\"chatName\">").concat(this.aiData.name,'</div>\n                    <div class="chatTools">\n                      <div class="rechat" style="display:').concat(i?"none":"block",'"></div>\n                      <div class="msgSetting ai">\n                        <div class="setting_box">\n                          <div class="setting_copy">\n                            <img src="/dist/img/ai-chatting/icon_copy_black.svg"/>\n                            ').concat(jsonData.aiGirlFriendChat.copy,'\n                          </div>\n                          <div class="setting_delete">\n                            <img src="/dist/img/ai-chatting/icon_del.svg"/>\n                            ').concat(jsonData.aiGirlFriendChat.delete,"\n                          </div>\n                        </div>\n                      </div>\n                      ").concat((!k(a)&&this.hasAudio,""),'\n                    </div>\n                  </div>\n                  <div class="chat_msg">\n                  ').concat(c,"\n                  </div>\n                  ")):(f=null!==(g=null!=o?o:r.time_stamp)&&void 0!==g?g:r.task_timestamp,this.chatMap.set("user"+f,{content:a,timestamp:f,sendUser:"user",page:this.chatPage>-1&&i?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:null!==(d=null==r||null===(p=r.chat_content)||void 0===p?void 0:p.path)&&void 0!==d?d:""}),v=jsonData.aiGirlFriendChat.User,getCookie("access_token")&&(m=JSON.parse(getCookie("user_info")),v=" "==(v=m.first_name+" "+m.last_name)?m.email.split("@")[0]:v),c='<div class="chatOperation" data-timestamp=\''.concat(f,"' data-isCheckTime='").concat(i,"' data-sender='user'>\n                    <div class=\"chatName\">").concat(v,'</div>\n                    <div class="chatTools">\n                      <div class="msgSetting my">\n                        <div class="setting_box">\n                          <div class="setting_copy">\n                            <img src="/dist/img/ai-chatting/icon_copy_black.svg"/>\n                            ').concat(jsonData.aiGirlFriendChat.copy,'\n                          </div>\n                          <div class="setting_delete">\n                            <img src="/dist/img/ai-chatting/icon_del.svg"/>\n                            ').concat(jsonData.aiGirlFriendChat.delete,'\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="chat_msg">\n                  ').concat(c,"\n                  </div>\n                  ")),s.find(n).html(c),_=$(".chatting-container"),this.setChatLoading(!1),i?_.prepend(s):(_.append(s),".my-message-container"===n&&this.setChatLoading(!0),_.scrollTop(_.prop("scrollHeight"))),this.setRmoveRecords(r),".ai-message-container"===n&&(y=s.find(n).find("audio"),b=y.parent(".audio-button"),y.length&&(y.on("play",(function(){b.addClass("active")})),y.on("pause",(function(){b.removeClass("active")})),y.on("ended",(function(){b.removeClass("active")}))));case 12:case"end":return t.stop()}}),t,this)}))),function(t,e,a,n,i,r){return l.apply(this,arguments)})},{key:"sendMessage",value:function(){gtag("event","click_aigirlfriend_send");var t=$("#userInputMsg"),e=t.val();if(!e||/^\s*$/.test(e))return!1;e=e.replace(/[(（](.*?)[)）]/g,"*$1*");var a,n=(new Date).getTime(),i=_objectSpread(_objectSpread({},this.connectMsg),{},{chat_content:e,request_type:20,chat_action:"",UserSendTime:n});this.UserSendTime=i.UserSendTime;try{var r=$("#myMessageBox");this.showMessage(r,e,".my-message-container",!1,{},n),SOCKET?SOCKET.readyState===WebSocket.OPEN?(this.AiHello(),SOCKET.send(JSON.stringify(i))):SOCKET.readyState===WebSocket.CLOSED?(this.disconnectMessage=JSON.stringify(i),this.connectChatting(this.socketUrl)):this.disconnectMessage=JSON.stringify(i):this.disconnectMessage=JSON.stringify(i)}catch(t){console.warn(t),this.disconnectMessage=JSON.stringify(i)}a=window.innerWidth<1200?".88rem":"46px",t.css("height",a),this.lastMessage=JSON.stringify(i),t.val(""),$(".send-btn").addClass("disable")}},{key:"saveCharacter",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,a,n,i,r,o,s,c,l,u,h,g,d,p,f,v,m,_,y,b=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=function(t){return t instanceof Blob},gtag("event","save_aigirlfriend_changephoto"),(i=$("#characterNameInput")).prop("disabled",!0),o={changeAvatar:"aiAvatarImg",changeBg:"bgImg"},s={changeAvatar:"head_portrait",changeBg:"head_portrait_background"},l=i.val()+"",u={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:l.trim(),is_draft:2,tag:null!==(e=this.aiData.json.tag)&&void 0!==e?e:"",persona:null!==(a=this.aiData.persona)&&void 0!==a?a:"",gender:null!==(n=this.aiData.json.gender)&&void 0!==n?n:"",description:this.aiData.json.Character_des,scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait_background:this.uploadbg?JSON.stringify(this.aiData.head_portrait_background):"[]"},t.prev=8,this.changePopup.loading.start(),d=_regeneratorRuntime().mark((function t(e){return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!r(b.uploadBlob[e])){t.next=5;break}return t.next=3,b.service.getUploadUrl({file_name:"".concat(e,".png")}).then((function(t){c=t.data.upload_url,g=t.data.key,b[o[e]]=t.data.access_url,"bgImg"===o[e]?(b.aiData.head_portrait_background=[],b.aiData.head_portrait_background.push({key:"head_portrait_background",url:t.data.access_url,value:g})):b.aiData.changeAvatarUrl=t.data.access_url})).catch((function(t){$Popup({type:"error",errorType:"network"})}));case 3:return t.next=5,b.service.putUploadUrl(c,b.uploadBlob[e]).then((function(t){200===t&&(u[s[e]]=JSON.stringify([{key:s[e],value:g}]))}));case 5:case"end":return t.stop()}}),t)})),t.t0=_regeneratorRuntime().keys(this.uploadBlob);case 12:if((t.t1=t.t0()).done){t.next=17;break}return p=t.t1.value,t.delegateYield(d(p),"t2",15);case 15:t.next=12;break;case 17:return void 0!==u.head_portrait_background||null!==(h=this.aiData.head_portrait_background[0])&&void 0!==h&&h.url||(u.head_portrait_background="[]"),void 0===u.head_portrait&&(u.head_portrait=JSON.stringify(this.aiData.head_portrait)),getUrlVal("avatarKey")&&(f=atob(getUrlVal("headAvatar")),v=atob(getUrlVal("avatarKey")),(m=JSON.parse(u.head_portrait))[0].value===f&&(m[0].value=v,m[0].is_temp=1,delete m[0].url,u.head_portrait=JSON.stringify(m))),t.next=22,this.service.roleEdit(u);case 22:if(401!==(_=t.sent).code){t.next=26;break}return this.closeChat(),t.abrupt("return");case 26:if(200===_.code){t.next=31;break}return $Popup({type:"error",errorType:"normal"}),i.prop("disabled",!1),this.changePopup.loading.end(),t.abrupt("return");case 31:return this.isChangeData=!0,this.aiData.name=u.name,this.aiData.head_portrait=JSON.parse(u.head_portrait),this.aiData.head_portrait[0].url=this.aiData.changeAvatarUrl,this.aiData.is_my_characters=1,2===this.isMyCharacterStatus&&(this.aiData.toMyCharacter=!0),this.aiData.my_characters_id=_.data.my_characters_id,this.aiData.role_id=_.data.role_id,this.aiData.status=2,"[]"===u.head_portrait_background&&(this.bgImg="",this.aiData.head_portrait_background=[]),(y=$(".chatting-container")).scrollTop(y.prop("scrollHeight")-y.height()-10),this.changePopup.close(),this.aiData.head_portrait[0].url||(this.aiData.head_portrait[0].url=this.aiAvatarImg),this.updateCharacter(),i.prop("disabled",!1),this.changePopup.loading.end(),this.changePopup=null,this.aiData.name=u.name,this.changeBgAvatar(),t.next=53,this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id);case 53:t.next=60;break;case 55:t.prev=55,t.t3=t.catch(8),$Popup({type:"error",errorType:"network"}),this.changePopup.loading.end(),this.changePopup=null;case 60:case"end":return t.stop()}}),t,this,[[8,55]])}))),function(){return c.apply(this,arguments)})},{key:"assemblyAudioChunk",value:(s=_asyncToGenerator(_regeneratorRuntime().mark((function t(e){var a,n,i,r,o,s;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=function(t,e){for(var a=atob(t),n=new Array(a.length),i=0;i<a.length;i++)n[i]=a.charCodeAt(i);var r=new Uint8Array(n);return new Blob([r],{type:e})},a=this.chatMap.get(e.time_stamp),n="audio/mpeg",this.deleteTimeoutAudioQueue(e.time_stamp),a.audioChunk[e.curr_id-1]=s(e.file_data,n),e.curr_id!==e.max_len){t.next=18;break}i=$('[data-id="'.concat(e.time_stamp,'"]')),r="",o=null;try{o=new Blob(Array.from(a.audioChunk),{type:n}),r=URL.createObjectURL(o),a.audioUrl=r,i.find("audio").attr("src",r),this.promiseWaitMap.get(e.time_stamp)&&this.deletePromiseWait(e.time_stamp)}catch(t){console.error("assembly audio error",t),a.audioChunk=[],i.removeClass("active loading")}return t.prev=10,t.next=13,this.saveAudio(a.page,this.connectMsg.chat_id,e.time_stamp,o);case 13:t.next=18;break;case 15:t.prev=15,t.t0=t.catch(10),console.error("save audio error",t.t0);case 18:case"end":return t.stop()}}),t,this,[[10,15]])}))),function(t){return s.apply(this,arguments)})},{key:"saveAudio",value:(o=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a,n,i){var r,o,s;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.service.getUploadFileUrl();case 2:return r=t.sent,o=r.data.upload_url,s=r.data.key,t.next=7,this.service.putUploadUrl(o,i);case 7:return t.abrupt("return",this.service.saveAudio(e,a,n,s));case 8:case"end":return t.stop()}}),t,this)}))),function(t,e,a,n){return o.apply(this,arguments)})},{key:"sendAudioMessage",value:function(t){var e=JSON.stringify(t);if(!SOCKET)return this.connectChatting(this.socketUrl),void this.sendAudioQueue.push(e);SOCKET.readyState===WebSocket.OPEN?SOCKET.send(e):(this.connectChatting(this.socketUrl),this.sendAudioQueue.push(e))}},{key:"getHistoryAudio",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a){var n,i,r,o;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.getHistoryAudioQueueSet.add(e),t.next=3,this.service.getAccessUrl(a);case 3:n=t.sent,i=n.data.static_url||n.data.url,r=$('[data-id="'.concat(e,'"]')),(o=r.find("audio")).attr("data-path","loaded"),o.attr("src",i),this.getHistoryAudioQueueSet.delete(e);case 10:case"end":return t.stop()}}),t,this)}))),function(t,e){return r.apply(this,arguments)})},{key:"setTimeoutAudioQueue",value:function(t){var e=this;this.timeoutAudioQueueMap.has(t)&&clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.set(t,setTimeout((function(){e.timeoutAudioQueueMap.delete(t),e.deletePromiseWait(t),$('[data-id="'.concat(t,'"]')).removeClass("loading"),console.error("generate audio timeout, timestamp:",t)}),3e4))}},{key:"deleteTimeoutAudioQueue",value:function(t){this.timeoutAudioQueueMap.has(t)&&(clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.delete(t))}},{key:"clearTimeoutAudioQueue",value:function(){var t,e=_createForOfIteratorHelper(this.timeoutAudioQueueMap);try{for(e.s();!(t=e.n()).done;){var a=_slicedToArray(t.value,2),n=(a[0],a[1]);clearTimeout(n)}}catch(t){e.e(t)}finally{e.f()}this.timeoutAudioQueueMap.clear()}},{key:"deletePromiseWait",value:function(t){var e=this.promiseWaitMap.get(t);e&&(e.finish(),this.promiseWaitMap.delete(t))}},{key:"clearPromiseWait",value:function(){var t,e=_createForOfIteratorHelper(this.promiseWaitMap);try{for(e.s();!(t=e.n()).done;){var a=_slicedToArray(t.value,2);a[0];a[1].finish()}}catch(t){e.e(t)}finally{e.f()}this.promiseWaitMap.clear()}},{key:"toggleAudioBtn",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a){var n,i,r,o,s,c,l,u,h,g,d,p,f=this;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((n=function(){var t=$(".audio-button").not(e);t.removeClass("active"),t.find("audio").each((function(t,e){""!==$(e).attr("src")&&(e.pause(),e.currentTime=0)}))})(),i=e.find("audio"),r=i.get(0),o=i.attr("src"),s=i.attr("data-path"),c=e.attr("data-id"),l=this.chatMap.get(c),!a){t.next=66;break}if(this.lastAudioId=c,!e.hasClass("loading")){t.next=12;break}return t.abrupt("return");case 12:if(""!==o||""!==s){t.next=54;break}if(e.addClass("loading"),t.prev=14,!this.timeoutAudioQueueMap.has(c)){t.next=17;break}return t.abrupt("return");case 17:return t.next=19,this.service.getVoiceLimit();case 19:if(200===(u=t.sent).code){t.next=24;break}return console.error("getVoiceLimit error:",u),e.removeClass("loading"),t.abrupt("return");case 24:if(1===u.data.is_use){t.next=30;break}return gtag("event","limit_aigirlfriend_voice"),this.toggleGFInfoDialog(!0,".ai-gf-audio-limit-dialog"),e.removeClass("loading"),t.abrupt("return");case 30:return h=l.content,g=h.replace(/\*.*?\*/g,""),d={request_type:21,chat_content:g.trim(),time_stamp:c,chat_id:this.connectMsg.chat_id,token:getCookie("SsToken")},this.sendAudioMessage(d),this.setTimeoutAudioQueue(c),p=new PromiseWait,this.promiseWaitMap.set(c,p),t.next=39,p.wait();case 39:if(""!==i.attr("src")){t.next=42;break}return e.removeClass("loading"),t.abrupt("return");case 42:return e.hasClass("loading")&&(e.removeClass("loading"),this.lastAudioId===c&&(n(),r.play().catch((function(t){e.removeClass("active"),console.error("audio play error by ws:",t)})))),t.abrupt("return");case 46:return t.prev=46,t.t0=t.catch(14),console.error("toggleAudioBtn error:",t.t0),e.removeClass("loading"),t.abrupt("return");case 51:return t.prev=51,this.deletePromiseWait(c),t.finish(51);case 54:if(""!==o||"loading"!==s){t.next=63;break}if(e.addClass("loading"),!this.getHistoryAudioQueueSet.has(c)){t.next=58;break}return t.abrupt("return");case 58:return t.next=60,this.getHistoryAudio(c,l.audioPath);case 60:return e.removeClass("loading"),this.lastAudioId===c&&(n(),r.play().catch((function(t){e.removeClass("active"),console.error("audio play error by history:",t)}))),t.abrupt("return");case 63:o&&r.play().catch((function(t){i.attr("data-path",""),i.attr("src",""),f.toggleAudioBtn(e,!0)})),t.next=68;break;case 66:e.removeClass("active"),""!==o&&r.pause();case 68:case"end":return t.stop()}}),t,this,[[14,46,51,54]])}))),function(t,e){return i.apply(this,arguments)})},{key:"setLoginTimer",value:function(){var t=this;this.loginTimer&&clearTimeout(this.loginTimer),this.loginTimer=setTimeout((function(){t.showLoginPopup()}),3e5)}},{key:"showLoginPopup",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};$("#userInputMsg").trigger("blur"),getCookie("access_token")||this.loginPopup?e():(gtag("event","alert_aigirlfriend_loginwin"),this.loginPopup=$Popup({title:gfChattingJsLan.loginTitle,content:gfChattingJsLan.loginContent,closeBtn:gfChattingJsLan.loginBtn,otherBtns:gfChattingJsLan.loginOtherBtn,exist:"chatLoginPopup",addBorderRadius:!0,onClose:function(){t.loginPopup=null,t.setLoginTimer(),gtag("evet","login_aigirlfriend_loginwin"),showLoginWindow({fn:function(){gtag("evet","succ_aigirlfriend_loginwin"),chatLogin()}})},topCloseFn:function(){t.setLoginTimer(),gtag("evet","close_aigirlfriend_loginwin"),t.loginPopup=null}}),this.loginPopup.modal.find(".login-popup-close-btn").on("click",(function(){gtag("evet","notnow_aigirlfriend_loginwin"),t.loginPopup.close(),t.loginPopup=null,t.setLoginTimer(),e()})))}},{key:"changeBgAvatar",value:function(){var t=this;$(".aiAvatarImg").each((function(){$(this).attr("src",t.aiAvatarImg)})),$(".ai-name").each((function(){$(this).text(t.aiData.name)}));var e=new Image;e.onload=function(){t.bgImg||t.aiAvatarImg;t.ratio=this.width/this.height,t.ratio.toFixed(2)>1?t.boxPosition.changeBtnMiddle.chatBgImg.left=0:t.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";var e=$("#chatBgImg");t.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:t.boxPosition[t.currentPosition||"changeBtnMiddle"].chatBgImg.left}),$(".audio_btn.bg").hasClass("active")?t.changeBackground(!0):t.changeBackground(!1)},e.src=t.bgImg||t.aiAvatarImg}},{key:"hideShowImgBox",value:function(t,e){var a=this,n={avatarImgBox:{id:"#avatarText",iconId:"#avatarIcon",imgUrlObj:"uploadAvatar",blob:"changeAvatar",showFn:function(){gtag("event","upload_aigirlfriend_avatar"),a.uploadAvatarChange=!0,$("#characterNameInput").val().length>0&&a.changePopup.enableCloseBtn()},hideFn:function(){a.uploadAvatarChange=!1,a.changePopup.disableCloseBtn(),gtag("event","del_aigirlfriend_avatar")}},bgImgBox:{id:"#bgText",iconId:"#bgIcon",imgUrlObj:"uploadBg",blob:"changeBg",showFn:function(){gtag("event","upload_aigirlfriend_bg"),a.uploadbg=!0},hideFn:function(){a.uploadbg=!1}}},i="#"+t;({hide:function(){$(i).hide(),$(n[t].id).text(gfChattingJsLan.changePopBtnSpanSet),$(n[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_small.png"),a[n[t].imgUrlObj]=!1,a.uploadBlob[n[t].blob]={},n[t].hideFn()},show:function(){$(i).show(),$(n[t].id).text(gfChattingJsLan.changePopBtnSpanAddNew),a[n[t].imgUrlObj]=!0,$(n[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_normal.png"),n[t].showFn()}})[e]()}},{key:"openChangeHandle",value:function(){var t,e=this,a=this;this.uploadStatus=!1,this.changePopup=$Popup({title:gfChattingJsLan.changePopTitle,content:'<div class="change-photo-box">\n          <div class="change-avatar-box">\n             <div>'.concat(gfChattingJsLan.changePopName,'</div>\n             <div class="name-input-box">\n             <input type="text" id="characterNameInput" maxlength="100">\n           </div>\n            <div>').concat(gfChattingJsLan.changePopAvatar,'</div>\n            <div class="avatar-box">\n              <div class="avatar-img changeAvatarImg" id="avatarImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeAvatarIcon" class="close-icon" bindId="avatarImgBox" alt="close button" />\n\n                <img src="" alt="" id="changeAvatarImg" class="changeAvatarImg" />\n              </div>\n              <div class="replace-img-btn" id="changeAvatarId" fn="changeAvatar">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="avatarIcon" class="img-icon" />\n                  <div class="change-btn-text" id="avatarTextBox">').concat(gfChattingJsLan.changePopBtn,'</div>\n                </div>\n              </div>             \n            </div>\n            \n              <div class="avatar-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="avatarTip">').concat(gfChattingJsLan.changePopSupport,'</span>\n              </div>\n\n            <div class="change-bg-title">').concat(gfChattingJsLan.changePopBgDesc,'</div>\n            <div class="change-bg-sub">').concat(gfChattingJsLan.changePopRecommend,'</div>\n            <div class="avatar-box">\n              <div class="avatar-img" id="bgImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeBgIcon" class="close-icon" bindId="bgImgBox" alt="close icon"/>\n                <img src="" alt="" id="changeBgImg" class="changeBgImg" />\n              </div>\n              <div class="replace-img-btn" id="changeBgId" fn="changeBg">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="bgIcon" class="img-icon" />\n                  <div  class="change-btn-text" id="bgTextBox">').concat(gfChattingJsLan.changePopBgBtn,'</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="bg-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="bgTip">').concat(gfChattingJsLan.changePopBgSupport,'</span>\n           </div>\n\n            <input type="file" name="file" id="fileInput" style="display: none"   accept="image/jpeg, image/png, image/webp">\n          </div>\n        </div>'),closeBtn:gfChattingJsLan.changePopCloseBtn,otherBtns:gfChattingJsLan.changePopOtherBtn,autoClose:!1,topCloseFn:function(){this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,gtag("event","close_aigirlfriend_changephoto")},onClose:function(){e.uploadStatus?e.saveCharacter():e.changePopup.close()},exist:"change"}),$("#changeOtherBtn").off("click").on("click",(function(){a.uploadBlob={changeAvatar:{},changeBg:{}},gtag("event","discard_aigirlfriend_changephoto"),a.uploadStatus=!1,a.changePopup.close()}));var n=$("#characterNameInput");n.val(this.aiData.name),n.off("input").on("input",(function(){var t=$(this).val(),e=/[/*&\\%$#@]/g;e.test(t)&&$(this).val(t.replace(e,""));var n=(t=$(this).val()).length;n>50&&($(this).val(t.substring(0,50)),n=50),a.uploadStatus=!0,0===n?a.changePopup.closeButton.disable():a.uploadAvatarChange&&a.changePopup.closeButton.enable()})),this.aiAvatarImg?$("#changeAvatarImg").attr("src",this.aiAvatarImg):a.hideShowImgBox("avatarImgBox","hide");var i=$("#changeBgImg");this.aiData.head_portrait_background.length&&this.bgImg?i.attr("src",this.bgImg):a.hideShowImgBox("bgImgBox","hide"),i.attr("src",this.bgImg),$("#closeAvatarIcon,#closeBgIcon").off("click").on("click",(function(){a.uploadStatus=!0;var t=$(this).attr("bindId");"bgImgBox"===t&&gtag("event","del_aigirlfriend_bg"),a.hideShowImgBox(t,"hide")})),$(".replace-img-btn").off("click").on("click",(function(){t=$(this).attr("fn"),$("#fileInput").trigger("click")})),$("#fileInput").off("change").on("change",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var n,i,r,o,s,c,l,u,h,g,d,p,f,v,m,_;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={changeAvatar:{text:"#avatarTip",box:".avatar-tip-box"},changeBg:{text:"#bgTip",box:".bg-tip-box"}},o=(r={changeAvatar:{icon:"#avatarIcon",text:"#avatarTextBox"},changeBg:{icon:"#bgIcon",text:"#bgTextBox"}})[t].icon,s=r[t].text,c=i[t].box,l=i[t].text,u=function(){$(o).attr("src","/dist/img/ai-chatting/icon_loading.svg"),$(o).addClass("popup-loading"),$(s).html(gfChattingJsLan.changePopUploading)},h=function(){$(o).removeClass("popup-loading"),$(o).attr("src","dist/img/ai-chatting/btn_add_normal.png");var e={changeAvatar:gfChattingJsLan.changePopBtn,changeBg:gfChattingJsLan.changePopBgBtn};$(s).html(e[t])},g={changeAvatar:function(e){var i=new Image;i.onload=function(){var n=this.naturalHeight,i=this.naturalWidth;n<32||i<32?($("#avatarTip").text(gfChattingJsLan.changePopAvatarError),$(".avatar-tip-box").css("visibility","visible")):(a.uploadStatus=!0,$(".changeAvatarImg").attr("src",e),a.hideShowImgBox(d[t],"show"))},i.src=URL.createObjectURL(n),$(c).css("visibility","hidden")},changeBg:function(e){var i=new Image;i.onload=function(){var n=this.naturalHeight,i=this.naturalWidth;n<128||i<128?($("#bgTip").text(gfChattingJsLan.changePopBgError),$(".bg-tip-box").css("visibility","visible")):(a.uploadStatus=!0,a.bgImg=e,$(".changeBgImg").attr("src",a.bgImg),a.hideShowImgBox(d[t],"show"))},i.src=URL.createObjectURL(n),$(c).css("visibility","hidden")}},d={changeAvatar:"avatarImgBox",changeBg:"bgImgBox"},p=this.files[0],f=p.name.split(".").pop().toLowerCase(),/^(image\/(jpg|jpeg|png|webp))$/.test(p.type)&&/^jpg|jpeg|png|webp$/.test(f)){e.next=17;break}return $(l).text(gfChattingJsLan.changePopSupport),$(c).css("visibility","visible"),$(this).val(null),e.abrupt("return",!1);case 17:if(!((null==p?void 0:p.size)>104857600)){e.next=22;break}return $(l).text(gfChattingJsLan.changePopMaxError),$(c).css("visibility","visible"),$(this).val(null),e.abrupt("return",!1);case 22:return u(),e.next=25,resizeImageByFile(p);case 25:v=e.sent,(m=v.blog)?(_=URL.createObjectURL(m),a.uploadBlob[t]=m,n=m,g[t](_)):($(l).text(gfChattingJsLan.changePopSupport),$(c).css("visibility","visible")),$(this).val(null),h();case 30:case"end":return e.stop()}}),e,this)}))))}},{key:"getAiDetails",value:(n=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a,n){var i;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.service.getRoleInfo(e,a,n);case 3:if(200!==(i=t.sent).code){t.next=6;break}return t.abrupt("return",i.data);case 6:$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),console.error("get-role-info",i.data.message),t.next=13;break;case 10:t.prev=10,t.t0=t.catch(0),$Popup({type:"error",errorType:"normal",addBorderRadius:!0});case 13:case"end":return t.stop()}}),t,this,[[0,10]])}))),function(t,e,a){return n.apply(this,arguments)})},{key:"getAiInfo",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a,n){var i;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.getAiDetails(e,a,n);case 3:(i=t.sent)?this.init(i):$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0),$Popup({type:"error",errorType:"normal",addBorderRadius:!0});case 10:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(t,e,n){return a.apply(this,arguments)})},{key:"updateCharacterFunc",value:(e=_asyncToGenerator(_regeneratorRuntime().mark((function t(e,a,n){var i,r,o;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=["chat_id"],t.prev=1,t.next=4,this.getAiDetails(e,a,n);case 4:for(o in r=t.sent)!r.hasOwnProperty(o)||this.aiData[o]&&i.includes(o)||(this.aiData[o]=r[o]);this.updateCharacter(),t.next=12;break;case 9:t.prev=9,t.t0=t.catch(1),console.error("update character error:",t.t0);case 12:case"end":return t.stop()}}),t,this,[[1,9]])}))),function(t,a,n){return e.apply(this,arguments)})},{key:"changeScreen",value:function(t){t?("pc"==userModel?($("#changeBtnMiddle").click(),$("#chattingContainer").css("height","80vh")):$("#chattingContainer").css("height","70vh"),$("#editIcon").hide(),$(".chatting-container").addClass("fullscreen")):($("#editIcon").show(),$(".chatting-container").removeClass("fullscreen"),$("#chattingContainer").css("height",this.chatHeight),$("#chattingContainer").scrollTop($("#chattingContainer").prop("scrollHeight")))}},{key:"changeBackground",value:function(t){if(t)$("#AiChat,#chatBgImg").css({"background-image":"none","background-color":"#151820"});else{var e=this.bgImg||this.aiAvatarImg;$("#AiChat,#chatBgImg").css({"background-image":'url("'.concat(e,'")'),"background-color":"transparent"})}}}]);var e,a,n,i,r,o,s,c,l,u,h,g,d,p,f}();function t(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return"";if(0===Object.keys(e).length)return t;for(var a in e)t=t.replace(new RegExp("{{".concat(a,"}}"),"g"),e[a]);return t}function getUrlVal(t){var e=window.location.href;if(!e.includes("?"))return!1;var a=e.split("?")[1].split("&"),n={};return a.forEach((function(t){var e=t.split("="),a=decodeURIComponent(e[0]);n[a]=decodeURIComponent(e[1])})),n[t]}"placeholder"in document.createElement("input")||$("input[placeholder],textarea[placeholder]").each((function(){var t=$(this),e=t.attr("placeholder");""===t.val()&&t.val(e).addClass("placeholder"),t.focus((function(){t.val()===e&&t.val("").removeClass("placeholder")})).blur((function(){""===t.val()&&t.val(e).addClass("placeholder")})).closest("form").submit((function(){t.val()===e&&t.val("")}))}));