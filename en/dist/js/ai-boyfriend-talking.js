let SOCKET,defaultUserAvatar="/dist/img/aiFriend/icon_avatar.svg";const gfChattingLan=jsonData.aiGirlFriendChat,gfChattingJsLan=jsonData.aiGirlFriendChat.javascript;class PromiseWait{constructor(){this.promise=new Promise((t=>{this.resolve=t}))}async wait(){return this.promise}async finish(){this.resolve()}}class AiGirlfriendTalkingService{getMessageInfo(t,a){const e=new URLSearchParams({chat_id:t});return a>0&&e.append("page",a.toString()),fetchGet(`chat/user/get-message-info?${e.toString()}`)}getChatServer(t){return fetchPost("chat/user/get-chat-server",t)}getRoleInfo(t,a,e){const i=new URLSearchParams({id:t,is_my_characters:a});return e&&1===a&&i.append("my_characters_id",e),fetchGet(`chat/user/get-role-info?${i.toString()}`)}putLike(t){return fetchPost("chat/user/role-like",{role_id:t})}roleEdit(t){return fetchPost("chat/user/role-edit",t)}getUploadUrl(t){return fetchPost("ai/source/get-upload-url",t)}saveAudio(t,a,e,i){return fetchPost("chat/user/up-message",{id:t,chat_id:a,task_timestamp:e,path:i})}getUploadFileUrl(){return fetchPost("ai/source/temp-upload-url",{file_name:"ai-girlfriend-audio.mp3"})}putUploadUrl(t,a){return fetchPut(t,a)}putLog(t){return fetchPost("chat/public/add-log",t)}getVoiceLimit(){return fetchGet("chat/user/get-voice-limit")}getAccessUrl(t){return fetchPost("ai/source/get-access-url",{key:t,action:"browse"})}}class AiGirlfriendTalking{service=new AiGirlfriendTalkingService;hasAudio=!1;constructor(){this.boxPosition={changeBtnLeft:{chattingContainer:{height:"64vh"},chattingBox:{left:".8rem",right:"auto"},chatBgImg:{right:"0px",left:"auto"},changePhotoBtn:{right:".8rem",left:"auto"}},changeBtnMiddle:{chattingContainer:{height:"340px"},chattingBox:{left:"calc(50% - 38.54vw / 2)",right:"auto"},chatBgImg:{right:"auto",left:"calc(50% - 661px / 2)"},changePhotoBtn:{right:"auto",left:".8rem"}},changeBtnRight:{chattingContainer:{height:"64vh"},chattingBox:{left:"auto",right:".8rem"},chatBgImg:{right:"auto",left:"0"},changePhotoBtn:{right:"auto",left:".8rem"}}},this.updateAudioLimit()}data(){return{modelDOM:$("#AiChat"),userMessage:$("#userInputMsg").value}}async init(t){gtag("event",`chat_aiboyfriend_${t.role_id}`),gtag("event","enter_aiboyfriend_chatting");let a=this;this.loginPopup=null,this.isChat=!1,this.socketClose=!1,this.chatPage=-1,this.initHistory=!0,this.isSyncingHistroy=!1,this.isOldSeverUrl=!1,this.chatMap=new Map,this.helloTimer=null,this.promiseWaitMap=new Map,this.aiData=t,this.aiAvatarImg=t?.head_portrait[0]?.url,this.bgImg=t.head_portrait_background.length>0?t.head_portrait_background[0]?.url:t.head_portrait[0]?.url,this.backImg=`url("${t.head_portrait_background[0]?.url||this.bgImg}")`,this.uploadAvatarChange=!0,this.uploadbg=t.head_portrait_background[0]?.url||!1,getCookie("user_info")&&(this.userData=JSON.parse(getCookie("user_info"))),this.userAvatarImg=this.userData?.head_portrait||defaultUserAvatar,this.connectMsg={user_id:"0"|this.userData?.id,role_id:t.role_id+"",role_name:t.name,chat_id_name:"",chat_id:"",token:getCookie("SsToken")},this.connectMsg.user_id=this.connectMsg.user_id+"",this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,$(".chatting-container").empty();let e="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(e=localStorage.getItem("chattingPosition")),this.changePosition(e),this.mobileInit(),this.data().modelDOM.fadeIn(),$("body").css({overflow:"hidden",position:"fixed"}),this.setLoginTimer(),$(".hidden-box #aiAvatarImg").attr("src",this.aiAvatarImg),$("#myAvatarImg").attr("src",this.userAvatarImg),$(".chat-bg-img, .ai-chat-box").css("background-image",this.backImg);let i=new Image;i.onload=function(){a.ratio=this.width/this.height,a.ratio.toFixed(2)>1?a.boxPosition.changeBtnMiddle.chatBgImg.left=0:a.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";let t="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(t=localStorage.getItem("chattingPosition"));const e=$("#chatBgImg");a.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:a.boxPosition[t].chatBgImg.left})},i.src=this.bgImg,this.updateCharacter();try{await this.updateCharacterFunc(t.role_id,t.is_my_characters,t.my_characters_id);let a=await this.getChatData(),e=getUrlVal("headAvatar");if(e){let t=getUrlVal("form");await this.fromUndressFn(t,e)}this.isMyCharacterStatus=this.aiData.is_my_characters,this.aiData.toMyCharacter=!1,this.connectChatting(a.server_url),this.getChatHistory()}catch(t){console.error("init error",t)}}async updateAudioLimit(){const a=await this.service.getVoiceLimit();a.data?(this.hasAudio=a.data.sum_num>0,$(".ai-gf-info-dialog-wrap .audio-limit-desc").text(t(gfChattingLan.audioLimitDesc,{sum_num:a.data.sum_num}))):console.error("getVoiceLimit error",a)}async getChatHistory(){if(!this.isSyncingHistroy&&this.chatPage){this.isSyncingHistroy=!0;try{const t=await this.service.getMessageInfo(this.connectMsg.chat_id,this.chatPage);if(200===t.code&&t.data){this.isChat=!0;const a=t.data.page,e=t.data.list.filter((t=>!!t.chat_content.content));if(0===e.length&&this.chatPage)return this.isSyncingHistroy=!1,this.chatPage=a,void await this.getChatHistory();const i=$(".chatting-container"),s=i.scrollTop(),o=i[0].scrollHeight;i.css("overflow-y","hidden");for(let t of e)if("user"===t.chat_content.role){let a=$("#myMessageBox");this.showMessage(a,t.chat_content.content,".my-message-container",!1,!0)}else{let a=$("#aiMessageBox");this.showMessage(a,t.chat_content.content,".ai-message-container",!0,!0,t)}if(i.css("overflow-y","auto"),this.initHistory)i.scrollTop(i.prop("scrollHeight"));else{const t=i[0].scrollHeight-o;i.scrollTop(s+t)}this.initHistory=!1,this.chatPage=a,e.length<5&&a&&(this.isSyncingHistroy=!1,await this.getChatHistory())}}catch(t){console.error("getChatHistory error",t)}finally{this.isSyncingHistroy=!1}}}async getChatData(t=""){const a={chat_id:this.aiData.chat_id,role_id:this.connectMsg.role_id,is_my_characters:this.aiData.is_my_characters,last_server_url:t};1===this.aiData.is_my_characters&&(a.my_characters_id=this.aiData.my_characters_id);const e=await this.service.getChatServer(a);if(401===e.code)return await this.closeChat(),!1;if(200!==e.code)return console.error("getChatData error",e.message),$Popup({type:"error",errorType:"normal"}),!1;const i=e.data;return 1===i.is_old_server_url&&(this.isOldSeverUrl=!0),this.socketUrl=i.server_url,this.connectMsg.chat_id=i.chat_id,this.aiData.chat_id=i.chat_id,this.connectMsg.chat_id_name=i.chat_id_name,i}AiHello(){const t={...this.connectMsg,request_type:50,chat_last_sep:240};clearTimeout(this.helloTimer),this.helloTimer=setTimeout((()=>{SOCKET.send(JSON.stringify(t))}),24e4)}async fromUndressFn(t,a){let e=atob(getUrlVal("avatarKey")),i=atob(a),s={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:this.aiData.name,is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des??"",scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait:JSON.stringify([{key:"head_portrait",value:e,is_temp:1}]),head_portrait_background:JSON.stringify(this.aiData.head_portrait_background)};if(this.aiData.head_portrait=[{key:"head_portrait",value:i,url:i}],this.aiAvatarImg=i,this.aiData.status=2,this.updateCharacter(),$(".chatting-share").hide(),this.aiData.is_my_characters=1,this.bgImg="",this.changeBgAvatar(),!t)return;const o=await this.service.roleEdit(s);200===o.code&&(aiGirlFriend.GetRecentChatting(),this.aiData.toMyCharacter=!0,history.pushState(null,null,`/ai-boyfriend.html?openShare=${getUrlVal("openShare")}&headAvatar=${a}&avatarKey=${btoa(e)}`),this.aiData.my_characters_id=o.data.my_characters_id,this.aiData.role_id=o.data.role_id,this.aiData.is_my_characters=1),401!==o.code?await this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id):await this.closeChat()}mobileInit(){if(window.innerWidth<1200){let t;$("#changePhotoBtn").text("Change Photo"),t=1===this.aiData.is_my_characters?"1.4rem":"1.92rem",$(".change-photo-btn").css({left:"auto",right:t})}}updateCharacter(){$(".chatting-count").text(formatNumber(this.aiData.msg_num)),$(".ai-chat-gf-avatar, .ai-gf-info-dialog-avatar").attr("src",this.aiAvatarImg),$(".ai-gf-info-dialog-birthday").text(this.aiData.json.Created),$(".ai-gf-info-dialog-desc").text(this.aiData.json.Character_des),$(".ai-chat-gf-name, .ai-gf-info-dialog-name").text(this.aiData.name),this.toggleShareBtn(1===this.aiData.status&&1===this.aiData.type);const t=this.aiData.json.tag.split(",").filter((t=>""!==t)).map((t=>`<div class="ai-gf-info-dialog-tag">${t}</div>`));$(".ai-gf-info-dialog-tags").html(t.join("")),1===this.aiData.is_like?($(".no-like-icon").hide(),$(".like-icon").show()):($(".no-like-icon").show(),$(".like-icon").hide())}bindEvent(){let t=this;$("#userInputMsg").on("input",(function(){let t=$(this).val().length;window.innerWidth>1200?this.style.height=this.scrollHeight+"px":this.style.height=this.scrollHeight/100+.5+"rem",(0===t||t<37)&&(window.innerWidth>1200?this.style.height="46px":this.style.height=".88rem");const a=$(".send-btn");0===t||/^\s*$/.test($(this).val())?a.addClass("disable"):a.removeClass("disable")})),$("#backIcon, #closeIcon").on("click",(function(){"backIcon"===$(this).attr("id")?gtag("event","back_aiboyfriend_chatting"):gtag("event","close_aiboyfriend_chatting"),t.closeChat("click")})),$(".chatting-container").on("click",".audio-button",(function(a){const e=$(a.currentTarget);gtag("event","click_aiboyfriend_voice"),t.toggleAudioBtn(e,!e.hasClass("active"))})),$("#sendMsg").on("click",(()=>{this.sendMessage(),$("#userInputMsg").trigger("focus")})),$(".ai-chat-box textarea").on("keydown",(t=>{"Enter"===t.key&&(t.preventDefault(),this.sendMessage())})),$("#editIcon").on("click",(()=>{$(".change-position-box").toggle()})),$(document).on("click",(function(a){const e=$(a.target);e.closest("#editIcon").length||e.closest(".change-position-box").length||$(".change-position-box").hide(),e.closest(".right-button-box-m-dropdown").length||e.closest(".right-button-box-m-dropdown-menu").length||t.toggleGFDropdown(!1)})),$(".change-btns-box .change-btn").on("click",(function(){let a=$(this).attr("id");gtag("event",{changeBtnLeft:"left_aiboyfriend_pos",changeBtnMiddle:"mid_aiboyfriend_pos",changeBtnRight:"right_aiboyfriend_pos"}[a]),t.changePosition(a),$(".change-position-box").hide()})),$("#changePhotoBtn").on("click",(()=>{gtag("event","click_aiboyfriend_changephoto"),this.openChangeHandle()})),$(".chatting-like").on("click",(async function(){try{t.toggleLikeBtn();200===(await t.service.putLike(t.aiData.role_id)).code?$(this).closest(".ai-gf-info-dialog").length>0?gtag("event","like_aiboyfriend_view"):1===t.aiData.is_like&&gtag("event","like_aiboyfriend_chatting"):($Popup({type:"error",errorType:"network"}),t.toggleLikeBtn())}catch(a){console.error("like error",a),$Popup({type:"error",errorType:"network"}),t.toggleLikeBtn()}})),$(".discord-box").on("click",(()=>{gtag("event","discord_aiboyfriend_chatting")})),$(".chatting-share").on("click",(t=>{$(t.target).closest(".ai-gf-info-dialog").length>0?gtag("event","share_aiboyfriend_view"):gtag("event","share_aiboyfriend_chatting"),aiGirlFriend.showShare(this.aiData.role_id,this.aiData.head_portrait[0].value)})),$(".ai-chat-gf-view").on("click",(()=>{this.toggleGFInfoDialog(!0,".ai-gf-info-dialog")})),$(".ai-gf-info-dialog-close, .ai-gf-info-dialog-bg").on("click",(()=>{this.toggleGFInfoDialog(!1)})),$(".right-button-box-m-dropdown").on("click",(()=>{const t=$(".right-button-box-m-dropdown-menu").is(":visible");this.toggleGFDropdown(!t)})),$("#chattingContainer").on("scroll",(function(){0===$(this).scrollTop()&&t.getChatHistory()}))}changePosition(t){this.currentPosition=t,getCookie("user_info")?localStorage.setItem("chattingPosition",t):localStorage.removeItem("chattingPosition"),$("#"+t).addClass("change-active").siblings().removeClass("change-active");let a=this.boxPosition;for(let e in a[t]){let i=`#${e}`;for(let s in a[t][e])$(i).css(s,a[t][e][s])}let e=$(".chatting-container");e.scrollTop(e.prop("scrollHeight"))}isMobile(){return window.innerWidth<1200}toggleGFInfoDialog(t,a){const e=$(".ai-gf-info-dialog-wrap");if(e.children("div").not(".ai-gf-info-dialog-bg").hide(),a&&e.find(a).show(),this.isMobile()?t?e.show(0,(()=>e.addClass("active"))):e.removeClass("active").hide():t?e.fadeIn(160):e.fadeOut(160),t&&".ai-gf-info-dialog"===a)gtag("event","show_aiboyfriend_view")}toggleGFDropdown(t){const a=$(".right-button-box-m-dropdown-menu");this.isMobile()?t?a.slideDown(160):a.slideUp(160):t?a.fadeIn(160):a.fadeOut(160)}toggleShareBtn(t){const a=$(".chatting-share");t?a.show():a.hide()}toggleLikeBtn(){const t=1!==this.aiData.is_like;this.aiData.is_like=t?1:2;const a=$(".like-icon"),e=$(".no-like-icon");t?(a.show(),e.hide()):(a.hide(),e.show())}async closeChat(t){let a=async()=>{this.toggleGFInfoDialog(!1),$(".change-position-box").hide(),$("body").css({"overflow-y":"auto",position:"static"}),history.pushState(null,null,"/ai-boyfriend.html"),clearInterval(this.loginTimer),clearInterval(this.heartTimer),clearInterval(this.disconnectTimer),clearTimeout(this.helloTimer),this.clearTimeoutAudioQueue(),this.clearPromiseWait(),this.changePopup=null,this.loginPopup=null;const t=$("#userInputMsg");t.val(""),window.innerWidth>1200?t.css("height","46px"):t.css("height",".88rem");const a=$(".chatting-container");a.find("audio").off("play pause ended"),a.empty(),$Popup().closeAll(),this.data().modelDOM.fadeOut(),this.socketClose=!0,SOCKET?.close(),this.isChat&&aiGirlFriend.addRecentChatting(this.aiData),await aiGirlFriend.initCharacters(),aiGirlFriend.GetMyCharacters()};t?this.showLoginPopup((async()=>{await a()})):await a()}lastMessage=null;connectChatting(t){if(this.socketClose||!t)return;SOCKET=new WebSocket(t),SOCKET.binaryType="arraybuffer";let a={...this.connectMsg,chat_last_sep:3234,request_type:this.isOldSeverUrl?11:10,chat_action:""};this.isOldSeverUrl=!1;let e={...this.connectMsg,request_type:40};clearInterval(this.heartTimer),this.heartTimer=setInterval((()=>{SOCKET.readyState===WebSocket.OPEN&&SOCKET.send(JSON.stringify(e))}),4e4),SOCKET.onopen=()=>{for(this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5),SOCKET.send(JSON.stringify(a)),this.AiHello();this.sendAudioQueue.length>0;)SOCKET.send(this.sendAudioQueue.shift());this.disconnectMessage&&setTimeout((()=>{SOCKET.send(this.disconnectMessage),this.disconnectMessage=""}),1e3)},SOCKET.onmessage=async a=>{this.wssResponse=JSON.parse(a.data);if([300,7001,7002].includes(this.wssResponse.status)){let t={...this.connectMsg,error_msg:this.wssResponse?.error_info,versions:currentVersion,time_stamp:this.wssResponse?.time_stamp??"",wss:this.socketUrl,wssResponse:this.wssResponse};this.service.putLog(t)}if(this.wssResponse.next_time||(clearTimeout(this.disconnectTimer),this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5)),300===this.wssResponse.status){SOCKET.close(),this.disconnectMessage=this.lastMessage;let a=await this.getChatData(t);return void this.connectChatting(a.server_url)}if(6001===this.wssResponse.status)return gtag("event","already_aiboyfriend_win"),void this.closeChat();if(7001===this.wssResponse.status)return console.error("audio error",{time_stamp:this.wssResponse.time_stamp,message:this.wssResponse.error_info}),this.deleteTimeoutAudioQueue(this.wssResponse.time_stamp),void $(`[data-id="${this.wssResponse.time_stamp}"]`).removeClass("active");if(7002===this.wssResponse.status)return console.error("audio service error",{time_stamp:this.wssResponse.time_stamp,message:this.wssResponse.error_info}),this.deleteTimeoutAudioQueue(this.wssResponse.time_stamp),void $(`[data-id="${this.wssResponse.time_stamp}"]`).removeClass("active");if(21===this.wssResponse.status)return void this.assemblyAudioChunk(this.wssResponse);let e=this.wssResponse?.chat_content,i=$("#aiMessageBox");this.showMessage(i,e,".ai-message-container",!1,!1,this.wssResponse)},SOCKET.onerror=t=>{console.error("socket error",t)},SOCKET.onclose=async a=>{if(!a.wasClean&&!this.socketClose){let a=await this.getChatData(t);this.connectChatting(a.server_url)}}}lottiePlayerAudioLoading=$("#audio-loading-icon").clone();async showMessage(t,a,e,i,s,o){if(!a)return;let n,r=t.clone().removeAttr("id");if(n=h(a)?a.replace(/\*(.*?)\*/g,'<p style="margin:0">($1)</p>'):a.replace(/\*(.*?)\*/g,"<p>($1)</p>"),".ai-message-container"===e){const t=o.time_stamp??o.task_timestamp;this.chatMap.set(t,{content:a,page:this.chatPage>-1&&s?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:o.chat_content.path??""}),this.lottiePlayerAudioLoading.removeAttr("id");const e=`\n              <div class="audio-button" data-id="${t}">\n                <div class="audio-play-icon"></div>\n                ${this.lottiePlayerAudioLoading[0].outerHTML}\n                <audio src="" data-path="${o.chat_content.path?"loading":""}"></audio>\n              </div>\n            `;n=`\n                <div class="ai-name">${this.aiData.name}</div>\n                ${!h(a)&&this.hasAudio?e:""}\n                ${n}\n                `}r.find(e).html(n);let c=$(".chatting-container");if(s?c.prepend(r):(c.append(r),c.scrollTop(c.prop("scrollHeight"))),".ai-message-container"===e&&!i){r.find(e).html('<div class="chatting-loading"></div>');let t=0;const a=setInterval((()=>{$(".chatting-loading").css("background-position-x",t+"px"),t+=8}),200);await new Promise((t=>setTimeout(t,800))),r.find(e).html(n),c.scrollTop(c.prop("scrollHeight")),clearInterval(a),t=0}if(".ai-message-container"===e){const t=r.find(e).find("audio"),a=t.parent(".audio-button");t.length&&(t.on("play",(()=>{a.addClass("active")})),t.on("pause",(()=>{a.removeClass("active")})),t.on("ended",(()=>{a.removeClass("active")})))}function h(t){return/^\*[^*]+\*$/.test(t)}}sendMessage(){gtag("event","click_aiboyfriend_send");const t=$("#userInputMsg");let a=t.val();if(!a||/^\s*$/.test(a))return!1;a=a.replace(/[(（](.*?)[)）]/g,"*$1*");let e,i={...this.connectMsg,chat_content:a,request_type:20,chat_action:""};try{let t=$("#myMessageBox");this.showMessage(t,a,".my-message-container"),SOCKET?SOCKET.readyState===WebSocket.OPEN?(this.AiHello(),SOCKET.send(JSON.stringify(i))):SOCKET.readyState===WebSocket.CLOSED?(this.disconnectMessage=JSON.stringify(i),this.connectChatting(this.socketUrl)):this.disconnectMessage=JSON.stringify(i):this.disconnectMessage=JSON.stringify(i)}catch(t){console.warn(t),this.disconnectMessage=JSON.stringify(i)}e=window.innerWidth<1200?".88rem":"46px",t.css("height",e),this.lastMessage=JSON.stringify(i),t.val(""),$(".send-btn").addClass("disable")}async saveCharacter(){gtag("event","save_aiboyfriend_changephoto");const t=$("#characterNameInput");function a(t){return t instanceof Blob}t.prop("disabled",!0);let e,i={changeAvatar:"aiAvatarImg",changeBg:"bgImg"},s={changeAvatar:"head_portrait",changeBg:"head_portrait_background"};const o=t.val()+"";let n={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:o.trim(),is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des,scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait_background:this.uploadbg?JSON.stringify(this.aiData.head_portrait_background):"[]"};try{let o;this.changePopup.loading.start();for(let t in this.uploadBlob)a(this.uploadBlob[t])&&(await this.service.getUploadUrl({file_name:`${t}.png`}).then((a=>{e=a.data.upload_url,o=a.data.key,this[i[t]]=a.data.access_url,"bgImg"===i[t]?(this.aiData.head_portrait_background=[],this.aiData.head_portrait_background.push({key:"head_portrait_background",url:a.data.access_url,value:o})):this.aiData.changeAvatarUrl=a.data.access_url})).catch((t=>{$Popup({type:"error",errorType:"network"})})),await this.service.putUploadUrl(e,this.uploadBlob[t]).then((a=>{200===a&&(n[s[t]]=JSON.stringify([{key:s[t],value:o}]))})));if(void 0!==n.head_portrait_background||this.aiData.head_portrait_background[0]?.url||(n.head_portrait_background="[]"),void 0===n.head_portrait&&(n.head_portrait=JSON.stringify(this.aiData.head_portrait)),getUrlVal("avatarKey")){let t=atob(getUrlVal("headAvatar")),a=atob(getUrlVal("avatarKey")),e=JSON.parse(n.head_portrait);e[0].value===t&&(e[0].value=a,e[0].is_temp=1,delete e[0].url,n.head_portrait=JSON.stringify(e))}const r=await this.service.roleEdit(n);if(401===r.code)return void this.closeChat();if(200!==r.code)return $Popup({type:"error",errorType:"normal"}),t.prop("disabled",!1),void this.changePopup.loading.end();this.aiData.name=n.name,this.aiData.head_portrait=JSON.parse(n.head_portrait),this.aiData.head_portrait[0].url=this.aiData.changeAvatarUrl,this.aiData.is_my_characters=1,2===this.isMyCharacterStatus&&(this.aiData.toMyCharacter=!0),this.aiData.my_characters_id=r.data.my_characters_id,this.aiData.role_id=r.data.role_id,this.aiData.status=2,"[]"===n.head_portrait_background&&(this.bgImg="",this.aiData.head_portrait_background=[]);let c=$(".chatting-container");c.scrollTop(c.prop("scrollHeight")-c.height()-10),this.changePopup.close(),this.aiData.head_portrait[0].url||(this.aiData.head_portrait[0].url=this.aiAvatarImg),this.updateCharacter(),t.prop("disabled",!1),this.changePopup.loading.end(),this.changePopup=null,this.aiData.name=n.name,this.changeBgAvatar(),await this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id)}catch(t){$Popup({type:"error",errorType:"network"}),this.changePopup.loading.end(),this.changePopup=null}}async assemblyAudioChunk(t){const a=this.chatMap.get(t.time_stamp),e="audio/mpeg";if(this.deleteTimeoutAudioQueue(t.time_stamp),a.audioChunk[t.curr_id-1]=function(t,a){const e=atob(t),i=new Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);const s=new Uint8Array(i);return new Blob([s],{type:a})}(t.file_data,e),t.curr_id===t.max_len){const i=$(".audio-button.active");let s="",o=null;try{o=new Blob(Array.from(a.audioChunk),{type:e}),s=URL.createObjectURL(o),a.audioUrl=s,$(`[data-id="${t.time_stamp}"]`).find("audio").attr("src",s);this.promiseWaitMap.get(t.time_stamp)&&this.deletePromiseWait(t.time_stamp)}catch(e){console.error("assembly audio error",e),a.audioChunk=[],i.attr("data-id")===t.time_stamp&&i.removeClass("active")}try{await this.saveAudio(a.page,this.connectMsg.chat_id,t.time_stamp,o)}catch(t){console.error("save audio error",t)}}}async saveAudio(t,a,e,i){const s=await this.service.getUploadFileUrl(),o=s.data.upload_url,n=s.data.key;return await this.service.putUploadUrl(o,i),this.service.saveAudio(t,a,e,n)}sendAudioQueue=[];sendAudioMessage(t){SOCKET&&SOCKET.readyState===WebSocket.OPEN?SOCKET.send(JSON.stringify(t)):this.sendAudioQueue.push(t)}getHistoryAudioQueueSet=new Set;async getHistoryAudio(t,a){this.getHistoryAudioQueueSet.add(t);const e=await this.service.getAccessUrl(a),i=e.data.static_url||e.data.url,s=$(`[data-id="${t}"]`).find("audio");s.attr("data-path","loaded"),s.attr("src",i),this.getHistoryAudioQueueSet.delete(t)}timeoutAudioQueueMap=new Map;setTimeoutAudioQueue(t){this.timeoutAudioQueueMap.has(t)&&clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.set(t,setTimeout((()=>{this.timeoutAudioQueueMap.delete(t),this.deletePromiseWait(t),$(`[data-id="${t}"]`).removeClass("active"),console.error("generate audio timeout, timestamp:",t)}),3e4))}deleteTimeoutAudioQueue(t){this.timeoutAudioQueueMap.has(t)&&(clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.delete(t))}clearTimeoutAudioQueue(){for(let[t,a]of this.timeoutAudioQueueMap)clearTimeout(a);this.timeoutAudioQueueMap.clear()}deletePromiseWait(t){const a=this.promiseWaitMap.get(t);a&&(a.finish(),this.promiseWaitMap.delete(t))}clearPromiseWait(){for(let[t,a]of this.promiseWaitMap)a.finish();this.promiseWaitMap.clear()}async toggleAudioBtn(t,a){const e=$(".audio-button").not(t);e.removeClass("active"),e.find("audio").each(((t,a)=>{""!==$(a).attr("src")&&(a.pause(),a.currentTime=0)}));const i=t.find("audio"),s=i.get(0),o=i.attr("src"),n=i.attr("data-path"),r=t.attr("data-id"),c=this.chatMap.get(r);if(a){if(t.addClass("active"),""===o&&""===n)try{if(this.timeoutAudioQueueMap.has(r))return;const a=await this.service.getVoiceLimit();if(200!==a.code)return console.error("getVoiceLimit error:",a),void t.removeClass("active");const{is_use:e}=a.data;if(1!==e)return gtag("event","limit_aiboyfriend_voice"),this.toggleGFInfoDialog(!0,".ai-gf-audio-limit-dialog"),void t.removeClass("active");const o=c.content,n={request_type:21,chat_content:o.replace(/\*.*?\*/g,"").trim(),time_stamp:r,chat_id:this.connectMsg.chat_id,token:getCookie("SsToken")};this.sendAudioMessage(n),this.setTimeoutAudioQueue(r);const h=new PromiseWait;return this.promiseWaitMap.set(r,h),await h.wait(),""===i.attr("src")?void t.removeClass("active"):void(t.hasClass("active")&&s.play().catch((a=>{t.removeClass("active"),console.error("audio play error by ws:",a)})))}catch(a){return console.error("toggleAudioBtn error:",a),void t.removeClass("active")}finally{this.deletePromiseWait(r)}if(""===o&&"loading"===n){if(this.getHistoryAudioQueueSet.has(r))return;return await this.getHistoryAudio(r,c.audioPath),void(t.hasClass("active")&&s.play().catch((a=>{t.removeClass("active"),console.error("audio play error by history:",a)})))}o&&s.play().catch((a=>{i.attr("data-path",""),i.attr("src",""),this.toggleAudioBtn(t,!0)}))}else t.removeClass("active"),""!==o&&s.pause()}setLoginTimer(){this.loginTimer&&clearTimeout(this.loginTimer),this.loginTimer=setTimeout((()=>{this.showLoginPopup()}),3e5)}showLoginPopup(t=function(){}){$("#userInputMsg").trigger("blur"),getCookie("access_token")||this.loginPopup?t():(gtag("event","alert_aiboyfriend_loginwin"),this.loginPopup=$Popup({title:gfChattingJsLan.loginTitle,content:gfChattingJsLan.loginContent,closeBtn:gfChattingJsLan.loginBtn,otherBtns:gfChattingJsLan.loginOtherBtn,exist:"chatLoginPopup",addBorderRadius:!0,onClose:()=>{this.loginPopup=null,this.setLoginTimer(),gtag("evet","login_aiboyfriend_loginwin"),showLoginWindow({fn:()=>{gtag("evet","succ_aiboyfriend_loginwin"),chatLogin()}})},topCloseFn:()=>{this.setLoginTimer(),gtag("evet","close_aiboyfriend_loginwin"),this.loginPopup=null}}),this.loginPopup.modal.find(".login-popup-close-btn").on("click",(()=>{gtag("evet","notnow_aiboyfriend_loginwin"),this.setLoginTimer(),this.loginPopup.close(),this.loginPopup=null,t()})))}changeBgAvatar(){let t=this;$(".aiAvatarImg").each((function(){$(this).attr("src",t.aiAvatarImg)})),$(".ai-name").each((function(){$(this).text(t.aiData.name)}));let a=new Image;a.onload=function(){let a=t.bgImg||t.aiAvatarImg;t.ratio=this.width/this.height,t.ratio.toFixed(2)>1?t.boxPosition.changeBtnMiddle.chatBgImg.left=0:t.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";const e=$("#chatBgImg");t.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:t.boxPosition[t.currentPosition||"changeBtnMiddle"].chatBgImg.left}),$(".chat-bg-img, .ai-chat-box").css("background-image",`url("${a}")`)},a.src=this.bgImg||t.aiAvatarImg}hideShowImgBox(t,a){let e={avatarImgBox:{id:"#avatarText",iconId:"#avatarIcon",imgUrlObj:"uploadAvatar",blob:"changeAvatar",showFn:()=>{gtag("event","upload_aiboyfriend_avatar"),this.uploadAvatarChange=!0,$("#characterNameInput").val().length>0&&this.changePopup.enableCloseBtn()},hideFn:()=>{this.uploadAvatarChange=!1,this.changePopup.disableCloseBtn(),gtag("event","del_aiboyfriend_avatar")}},bgImgBox:{id:"#bgText",iconId:"#bgIcon",imgUrlObj:"uploadBg",blob:"changeBg",showFn:()=>{gtag("event","upload_aiboyfriend_bg"),this.uploadbg=!0},hideFn:()=>{this.uploadbg=!1}}},i="#"+t;({hide:()=>{$(i).hide(),$(e[t].id).text(gfChattingJsLan.changePopBtnSpanSet),$(e[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_small.png"),this[e[t].imgUrlObj]=!1,this.uploadBlob[e[t].blob]={},e[t].hideFn()},show:()=>{$(i).show(),$(e[t].id).text(gfChattingJsLan.changePopBtnSpanAddNew),this[e[t].imgUrlObj]=!0,$(e[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_normal.png"),e[t].showFn()}})[a]()}openChangeHandle(){let t,a=this;this.uploadStatus=!1,this.changePopup=$Popup({title:gfChattingJsLan.changePopTitle,content:`<div class="change-photo-box">\n          <div class="change-avatar-box">\n             <div>${gfChattingJsLan.changePopName}</div>\n             <div class="name-input-box">\n             <input type="text" id="characterNameInput" maxlength="100">\n           </div>\n            <div>${gfChattingJsLan.changePopAvatar}</div>\n            <div class="avatar-box">\n              <div class="avatar-img changeAvatarImg" id="avatarImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeAvatarIcon" class="close-icon" bindId="avatarImgBox" alt="close button" />\n\n                <img src="" alt="" id="changeAvatarImg" class="changeAvatarImg" />\n              </div>\n              <div class="replace-img-btn" id="changeAvatarId" fn="changeAvatar">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="avatarIcon" class="img-icon" />\n                  <div class="change-btn-text" id="avatarTextBox">${gfChattingJsLan.changePopBtn}</div>\n                </div>\n              </div>             \n            </div>\n            \n              <div class="avatar-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="avatarTip">${gfChattingJsLan.changePopSupport}</span>\n              </div>\n\n            <div class="change-bg-title">${gfChattingJsLan.changePopBgDesc}</div>\n            <div class="change-bg-sub">${gfChattingJsLan.changePopRecommend}</div>\n            <div class="avatar-box">\n              <div class="avatar-img" id="bgImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeBgIcon" class="close-icon" bindId="bgImgBox" alt="close icon"/>\n                <img src="" alt="" id="changeBgImg" class="changeBgImg" />\n              </div>\n              <div class="replace-img-btn" id="changeBgId" fn="changeBg">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="bgIcon" class="img-icon" />\n                  <div  class="change-btn-text" id="bgTextBox">${gfChattingJsLan.changePopBgBtn}</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="bg-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="bgTip">${gfChattingJsLan.changePopBgSupport}</span>\n           </div>\n\n            <input type="file" name="file" id="fileInput" style="display: none"   accept="image/jpeg, image/png, image/webp">\n          </div>\n        </div>`,closeBtn:gfChattingJsLan.changePopCloseBtn,otherBtns:gfChattingJsLan.changePopOtherBtn,autoClose:!1,topCloseFn:function(){this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,gtag("event","close_aiboyfriend_changephoto")},onClose:()=>{this.uploadStatus?this.saveCharacter():this.changePopup.close()},exist:"change"}),$("#changeOtherBtn").off("click").on("click",(()=>{a.uploadBlob={changeAvatar:{},changeBg:{}},gtag("event","discard_aiboyfriend_changephoto"),a.uploadStatus=!1,a.changePopup.close()}));const e=$("#characterNameInput");e.val(this.aiData.name),e.off("input").on("input",(function(){let t=$(this).val(),e=/[/*&\\%$#@]/g;e.test(t)&&$(this).val(t.replace(e,"")),t=$(this).val();let i=t.length;i>50&&($(this).val(t.substring(0,50)),i=50),a.uploadStatus=!0,0===i?a.changePopup.closeButton.disable():a.uploadAvatarChange&&a.changePopup.closeButton.enable()})),this.aiAvatarImg?$("#changeAvatarImg").attr("src",this.aiAvatarImg):a.hideShowImgBox("avatarImgBox","hide");const i=$("#changeBgImg");this.aiData.head_portrait_background.length&&this.bgImg?i.attr("src",this.bgImg):a.hideShowImgBox("bgImgBox","hide"),i.attr("src",this.bgImg),$("#closeAvatarIcon,#closeBgIcon").off("click").on("click",(function(){a.uploadStatus=!0;let t=$(this).attr("bindId");"bgImgBox"===t&&gtag("event","del_aiboyfriend_bg"),a.hideShowImgBox(t,"hide")})),$(".replace-img-btn").off("click").on("click",(function(){t=$(this).attr("fn"),$("#fileInput").trigger("click")})),$("#fileInput").off("change").on("change",(async function(){let e;const i={changeAvatar:{text:"#avatarTip",box:".avatar-tip-box"},changeBg:{text:"#bgTip",box:".bg-tip-box"}},s={changeAvatar:{icon:"#avatarIcon",text:"#avatarTextBox"},changeBg:{icon:"#bgIcon",text:"#bgTextBox"}};let o=s[t].icon,n=s[t].text,r=i[t].box,c=i[t].text;const h={changeAvatar:i=>{const s=new Image;s.onload=function(){const e=this.naturalHeight,s=this.naturalWidth;e<32||s<32?($("#avatarTip").text(gfChattingJsLan.changePopAvatarError),$(".avatar-tip-box").css("visibility","visible")):(a.uploadStatus=!0,$(".changeAvatarImg").attr("src",i),a.hideShowImgBox(g[t],"show"))},s.src=URL.createObjectURL(e),$(r).css("visibility","hidden")},changeBg:i=>{const s=new Image;s.onload=function(){const e=this.naturalHeight,s=this.naturalWidth;e<128||s<128?($("#bgTip").text(gfChattingJsLan.changePopBgError),$(".bg-tip-box").css("visibility","visible")):(a.uploadStatus=!0,a.bgImg=i,$(".changeBgImg").attr("src",a.bgImg),a.hideShowImgBox(g[t],"show"))},s.src=URL.createObjectURL(e),$(r).css("visibility","hidden")}};let g={changeAvatar:"avatarImgBox",changeBg:"bgImgBox"},l=this.files[0];const d=l.name.split(".").pop().toLowerCase();if(!/^(image\/(jpg|jpeg|png|webp))$/.test(l.type)||!/^jpg|jpeg|png|webp$/.test(d))return $(c).text(gfChattingJsLan.changePopSupport),$(r).css("visibility","visible"),$(this).val(null),!1;if(l?.size>104857600)return $(c).text(gfChattingJsLan.changePopMaxError),$(r).css("visibility","visible"),$(this).val(null),!1;$(o).attr("src","/dist/img/ai-chatting/icon_loading.svg"),$(o).addClass("popup-loading"),$(n).html(gfChattingJsLan.changePopUploading);let{blog:u}=await resizeImageByFile(l);if(u){let i=URL.createObjectURL(u);a.uploadBlob[t]=u,e=u,h[t](i)}else $(c).text(gfChattingJsLan.changePopSupport),$(r).css("visibility","visible");$(this).val(null),(()=>{$(o).removeClass("popup-loading"),$(o).attr("src","dist/img/ai-chatting/btn_add_normal.png");let a={changeAvatar:gfChattingJsLan.changePopBtn,changeBg:gfChattingJsLan.changePopBgBtn};$(n).html(a[t])})()}))}async getAiDetails(t,a,e){try{const i=await this.service.getRoleInfo(t,a,e);if(200===i.code)return i.data;$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),console.error("get-role-info",i.data.message)}catch(t){$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}}async getAiInfo(t,a,e){try{const i=await this.getAiDetails(t,a,e);i?this.init(i):$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}catch(t){$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}}async updateCharacterFunc(t,a,e){const i=["chat_id"];try{const s=await this.getAiDetails(t,a,e);for(const t in s)!s.hasOwnProperty(t)||this.aiData[t]&&i.includes(t)||(this.aiData[t]=s[t]);this.updateCharacter()}catch(t){console.error("update character error:",t)}}}function t(t,a={}){if(!t)return"";if(0===Object.keys(a).length)return t;for(const e in a)t=t.replace(new RegExp(`{{${e}}}`,"g"),a[e]);return t}function getUrlVal(t){const a=window.location.href;if(!a.includes("?"))return!1;const e=a.split("?")[1].split("&"),i={};return e.forEach((function(t){const a=t.split("="),e=decodeURIComponent(a[0]);i[e]=decodeURIComponent(a[1])})),i[t]}"placeholder"in document.createElement("input")||$("input[placeholder],textarea[placeholder]").each((function(){const t=$(this),a=t.attr("placeholder");""===t.val()&&t.val(a).addClass("placeholder"),t.focus((function(){t.val()===a&&t.val("").removeClass("placeholder")})).blur((function(){""===t.val()&&t.val(a).addClass("placeholder")})).closest("form").submit((function(){t.val()===a&&t.val("")}))}));