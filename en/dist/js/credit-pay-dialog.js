var userinfo=getCookie("user_info")?JSON.parse(getCookie("user_info")):"",curToken=getCookie("access_token")||"";function getReq(e,t={}){return fetch(e,{method:"GET",headers:{...getHeaders(),...t}}).then((e=>e.json()))}function postReq(e,t,o={}){return fetch(e,{method:"POST",headers:{...getHeaders(),...o},body:JSON.stringify(t)}).then((e=>e.json()))}function getHeaders(){const e={"Content-Type":"application/json","Request-App":"ai","Request-Origin":"web","Request-Language":"ja"==getPreferredLanguage()?"jp":getPreferredLanguage()};return curToken&&(e.Authorization="Bearer "+curToken),e}async function sendPayDataOneTime(e={},t="/api/stripe-pay/pay"){const o=`${TOOL_API}api/order/stripe-generate`;return(await fetch(o,{method:"POST",headers:getHeaders(),body:JSON.stringify(e)})).json()}async function sendPayDataCreate(e={},t="/stripe-pay-create"){const o=`${TOOL_API}api/order/stripe-generate`;return(await fetch(o,{method:"POST",headers:getHeaders(),body:JSON.stringify(e)})).json()}function getKey(){return new Promise(((e,t)=>{postReq(`${TOOL_API}api/stripe-pay/set`).then((t=>{let o="";if(200===t.code){o=(t.data||"").data||""}e(o)})).catch((e=>{t(e)}))}))}function showCarModal(e){gtag("event","show_creditpricing_cart"),closeCar(),$(".dialog_pay_mask").addClass("show"),$(".coupon_box").removeClass("paying"),$(".m_paypal_content").removeClass("paying"),$(".paypal_content").removeClass("paying");const t=document.body.clientWidth<=1200,o=t?document.getElementById("mob_submit"):document.getElementById("submit");o.classList.remove("loading"),o.classList.remove("disabled");let a="";if("car"==e?a="showpay":"success"==e?a="showsuc":"err"==e&&(a="showerr"),a){$(t?".dialog_pay_mob":".dialog_pay.pc_modal").addClass(a)}}function closeCar(){paymentElement&&paymentElement.clear&&paymentElement.clear(),$(".dialog_pay_mask").removeClass("show"),$(".dialog_pay.pc_modal").removeClass("showpay showsuc showerr"),$(".dialog_pay_mob").removeClass("showpay showsuc showerr"),$(".coupon_box").removeClass("active"),$(".total_price").removeClass("active"),$(".coupon_price").html(""),$("#input_code").val(""),$(".coupon_err").hide(),$(".remove_btn").hide(),$(".apply_btn").html(`${payText.apply_btn}`),$(".dialog_pay_mob .coupon_box").removeClass("active"),$(".dialog_pay_mob .total_price").removeClass("active"),$(".dialog_pay_mob .coupon_price").html(""),$(".dialog_pay_mob #input_code").val(""),$(".dialog_pay_mob .coupon_err").hide(),$(".dialog_pay_mob .remove_btn").hide(),$(".dialog_pay_mob .apply_btn").html(`${payText.apply_btn}`),$(".paypal_content").show(),$(".m_paypal_content").show(),coupon_sale=null,coupon_id=null,promotion_code=null}function coupon(e,t){postReq(`${interHost}/api/stripe-pay/coupon`,{code:e,product_id:t.id}).then((o=>{if(200!==o.code)return $(".coupon_err").show(),$(".dialog_pay_mob .coupon_err").show(),$(".paypal_content").show(),void $(".m_paypal_content").show();const a=o.data.salesPrice.toFixed(2);coupon_sale=a,coupon_id=o.data.coupon_id,promotion_code=e,$(".coupon_price").html(`${t.symbol}${formatterFix2.format(a)}`),$(".total_price").addClass("active"),$(".apply_btn").html(`${payText.apply_btn_active}`),$(".dialog_pay_mob .coupon_price").html(`${t.symbol}${formatterFix2.format(a)}`),$(".dialog_pay_mob .total_price").addClass("active"),$(".dialog_pay_mob .apply_btn").html(`${payText.apply_btn_active}`),$(".paypal_content").hide(),$(".m_paypal_content").hide()})).catch((e=>{$(".coupon_err").show(),$(".dialog_pay_mob .coupon_err").show()}))}function formatCurrentDate(e){const t=new Date;t.setMonth(t.getMonth()+e);return new Intl.DateTimeFormat(localeArea[getPreferredLanguage()],{year:"numeric",month:"long",day:"numeric"}).format(t)}function changeCarInfo(e,t){$("#pc_car .title_text").html(`${payText.title1}`),$("#mob_car .title_text").html(`${payText.title1}`),$("#pc_car .product_info_des").html(payText.info_des1),$("#mob_car .product_info_des").html(payText.info_des1),$("#suc_info").html(payText.suc_des1),$("#m_suc_info").html(payText.suc_des1),1==e.num?($("#pc_car .product_name .name").html(`${payText.plan1.replace("%s",formatter.format(e.credit_num))}`),$("#mob_car .product_name .name").html(`${payText.plan1.replace("%s",formatter.format(e.credit_num))}`),$("#suc_product_info").html(`${payText.plan1.replace("%s",formatter.format(e.credit_num))}`),$(".dialog_pay_mob #suc_product_info").html(`${payText.plan1.replace("%s",formatter.format(e.credit_num))}`),$("#pc_car #sub_date").html(`${payText.month}`),$("#mob_car #sub_date").html(`${payText.month}`)):6==e.num?($("#pc_car .product_name .name").html(`${payText.plan2.replace("%s",formatter.format(e.credit_num))}`),$("#mob_car .product_name .name").html(`${payText.plan2.replace("%s",formatter.format(e.credit_num))}`),$("#suc_product_info").html(`${payText.plan2.replace("%s",formatter.format(e.credit_num))}`),$(".dialog_pay_mob #suc_product_info").html(`${payText.plan2.replace("%s",formatter.format(e.credit_num))}`),$("#pc_car #sub_date").html(`${payText.sixm}`),$("#mob_car #sub_date").html(`${payText.sixm}`)):12==e.num&&($("#pc_car .product_name .name").html(`${payText.plan3.replace("%s",formatter.format(e.credit_num))}`),$("#mob_car .product_name .name").html(`${payText.plan3.replace("%s",formatter.format(e.credit_num))}`),$("#suc_product_info").html(`${payText.plan3.replace("%s",formatter.format(e.credit_num))}`),$(".dialog_pay_mob #suc_product_info").html(`${payText.plan3.replace("%s",formatter.format(e.credit_num))}`),$("#pc_car #sub_date").html(`${payText.year}`),$("#mob_car #sub_date").html(`${payText.year}`)),e.save?($("#pc_car .product_name .price").html(`${e.symbol}${formatterFix2.format(e.save)}`),$("#pc_car .subtotal .price").html(`${e.symbol}${formatterFix2.format(e.save)}`),$("#mob_car .product_name .price").html(`${e.symbol}${formatterFix2.format(e.save)}`),$("#mob_car .subtotal .price").html(`${e.symbol}${formatterFix2.format(e.save)}`)):($("#pc_car .product_name .price").html(`${e.symbol}${formatterFix2.format(e.price)}`),$("#pc_car .subtotal .price").html(`${e.symbol}${formatterFix2.format(e.price)}`),$("#mob_car .product_name .price").html(`${e.symbol}${formatterFix2.format(e.price)}`),$("#mob_car .subtotal .price").html(`${e.symbol}${formatterFix2.format(e.price)}`)),0!=e.discount?($("#pc_car .discount").show(),$("#pc_car .discount .off").html(`${payText.off.replace("%s",e.discount)}`),$("#pc_car .discount .price").html(`-${e.symbol}${formatterFix2.format(e.discount_price)}`),$("#mob_car .discount").show(),$("#mob_car .discount .off").html(`${payText.off.replace("%s",e.discount)}`),$("#mob_car .discount .price").html(`-${e.symbol}${formatterFix2.format(e.discount_price)}`)):($("#pc_car .discount").hide(),$("#mob_car .discount").hide()),$("#pc_car  #combo_total_price").html(`${e.symbol}${formatterFix2.format(e.price)}`),$("#pc_car #cur_date").html(`${formatCurrentDate(e.num)}`),$("#pc_car #next_price").html(`${e.symbol}${formatterFix2.format(e.price)}`),$("#mob_car  #combo_total_price").html(`${e.symbol}${formatterFix2.format(e.price)}`),$("#mob_car #cur_date").html(`${formatCurrentDate(e.num)}`),$("#mob_car #next_price").html(`${e.symbol}${formatterFix2.format(e.price)}`),"credit"===t&&($("#suc_info").html(payText.suc_des3),$(".dialog_pay_mob #suc_info").html(payText.suc_des3),$("#pc_car .title_text").html(payText.title2),$("#pc_car .product_name .name").html(`${formatter.format(e.credit_num)} ${payText.credits}`),$("#mob_car .title_text").html(payText.title2),$("#mob_car .product_name .name").html(`${formatter.format(e.credit_num)} ${payText.credits}`),$("#suc_product_info").html(`${formatter.format(e.credit_num)} ${payText.credits}`),$(".dialog_pay_mob #suc_product_info").html(`${formatter.format(e.credit_num)} ${payText.credits}`),$("#pc_car .product_info_des").html(payText.info_des2),$("#mob_car .product_info_des").html(payText.info_des2)),$("#suc_user_email").html(`${userinfo.email}`),$("#suc_product_credit").html(`${formatter.format(e.credit_num)}`),$(".dialog_pay_mob #suc_user_email").html(`${userinfo.email}`),$(".dialog_pay_mob #suc_product_credit").html(`${formatter.format(e.credit_num)}`),document.querySelector(".apply_btn").onclick=()=>{const t=$("#input_code").val().trim();t?coupon(t,e):$(".coupon_err").show()},document.querySelector(".dialog_pay_mob .apply_btn").onclick=()=>{const t=$(".dialog_pay_mob #input_code").val().trim();t?coupon(t,e):$(".dialog_pay_mob .coupon_err").show()},formEvent(e,t),elements.update({amount:Math.ceil(100*e.price)}),showCarModal("car")}function userCoupon(e,t,o){const a={};a.productType="credit"===e?"ai-credits-disposable":"ai-credits-subscription",postReq(`${interHost}/api/user/user-sign-coupon`,a).then((e=>{if(200===e.code){const{data:a}=e;a&&a.coupon&&(o.addClass("active"),t.val(a.coupon),promotion_code=a.coupon)}}))}function renderFaildTip(){let e=`\n    <div class="failed_mask"></div>\n    <div class="tip_failed">\n      <div class="container">\n        <div class="tip_close_icon"></div>\n        <div class="tip_content">\n          <div class="failed_icon"></div>\n          <div class="failed_text">\n            <div class="failed_title">${payText.tip_fail}</div>\n            <div class="failed_des">${payText.tip_fail_des}</div>\n          </div>\n        </div>\n        <div class="tip_btn">\n          <div class="ok_btn">${payText.btn_ok}</div>\n        </div>\n      </div>\n    </div>\n  `;$(".tip_failed_box").html(e),$(".ok_btn, .tip_close_icon").on("click",(function(){window.location.reload()}))}let elements,stripe,emailAddress,paymentElement,coupon_sale,coupon_id,promotion_code;async function initPay(e){const t=await getKey();stripe=Stripe(t);const o={ja:"ja",de:"de",en:"en",es:"es",fr:"fr",it:"it",pt:"pt"};let a;if(document.body.clientWidth<=1200){a={mode:"payment",paymentMethodTypes:["card"],amount:Math.ceil(100*e.price),currency:e.currency.toLowerCase(),setup_future_usage:"off_session",locale:o[getPreferredLanguage()],fonts:[{cssSrc:"https://fonts.googleapis.com/css2?family=Lexend:wght@300&display=swap"}],appearance:{variables:{borderRadius:"3px",fontSizeBase:"0.7rem",colorText:"#A19CB5",fontSmooth:"always",spacingGridRow:"25px",fontFamily:"Lexend",colorDanger:"#FD3050",transition:"none"},rules:{".Input--invalid, .Input:focus":{boxShadow:"none"},".Input::placeholder":{color:"#A19CB5",fontSize:"0.8rem",fontFamily:"Lexend"},".Input":{boxShadow:"none",paddingTop:"1.5rem",paddingBottom:"1.5rem",color:"#000000",fontFamily:"Lexend",transition:"none",fontWeight:"bold"},".Label":{textTransform:"Capitalize"},".Error":{color:"#FD3050"}}}},elements=stripe.elements(a),emailAddress=userinfo.email||"";const t=elements.create("linkAuthentication",{defaultValues:{email:emailAddress}});t.mount(".dialog_pay_mob #link-authentication-element"),t.on("change",(e=>{t.update({defaultValues:{email:emailAddress}})})),paymentElement=elements.create("payment",{layout:{type:"tabs",defaultCollapsed:!1}}),paymentElement.mount(".dialog_pay_mob #payment-element")}else{a={mode:"payment",paymentMethodTypes:["card"],amount:Math.ceil(100*e.price),currency:e.currency.toLowerCase(),setup_future_usage:"off_session",locale:o[getPreferredLanguage()],fonts:[{cssSrc:"https://fonts.googleapis.com/css2?family=Lexend:wght@300&display=swap"}],appearance:{variables:{borderRadius:"3px",fontSizeBase:"0.8rem",colorText:"#A19CB5",fontSmooth:"always",spacingGridRow:"25px",fontFamily:"Lexend",colorDanger:"#FD3050",transition:"none"},rules:{".Input--invalid, .Input:focus":{boxShadow:"none"},".Input::placeholder":{color:"#A19CB5",fontSize:"0.8rem",fontFamily:"Lexend"},".Input":{boxShadow:"none",paddingTop:"0.89rem",paddingBottom:"0.89rem",color:"#000000",fontFamily:"Roboto",transition:"none",fontWeight:"bold",fontSize:"14px"},".Label":{textTransform:"Capitalize",color:"#1B1E37",opacity:"0.6",fontSize:"12px",fontFamily:"Sora",fontWeight:"400"},".Error":{color:"#FD3050",fontSize:"12px",fontFamily:"Roboto",fontWeight:"400"}}}},elements=stripe.elements(a),emailAddress=userinfo.email||"";const t=elements.create("linkAuthentication",{defaultValues:{email:emailAddress}});t.mount("#link-authentication-element"),t.on("change",(e=>{t.update({defaultValues:{email:emailAddress}})})),paymentElement=elements.create("payment",{layout:{type:"tabs",defaultCollapsed:!1}}),paymentElement.mount("#payment-element")}}function formEvent(e,t){let o=document.getElementById("payment-form"),a=document.getElementById("submit");document.body.clientWidth<=1200&&(o=document.getElementById("mob_payment-form"),a=document.getElementById("mob_submit"));const n=(e,t="")=>{a.classList.remove("loading"),a.classList.remove("disabled"),"input"!==t&&showCarModal("err")};a.onclick=async o=>{o.preventDefault(),gtag("event","buy_creditpricing_cart");const{error:r}=await elements.submit();if(r)return void n(0,"input");a.classList.add("disabled"),a.classList.add("loading"),$(".coupon_box").addClass("paying"),$(".m_paypal_content").addClass("paying"),$(".paypal_content").addClass("paying");let i,c=null,p=getCookie("aff")?JSON.parse(getCookie("aff")):"";if(t){try{const e=await postReq(`${TOOL_API}api/user/info`);if(200!==e.code)return a.classList.remove("loading"),void renderFaildTip();if(1!=e.data.is_credit_subscription)return a.classList.remove("loading"),void renderFaildTip()}catch(s){return a.classList.remove("loading"),void renderFaildTip()}try{const t=await sendPayDataOneTime({item:e.id,product:"ai-credits-disposable",st:getCookie("st")||"",insur:getCookie("insur")||"",aff:p,page:getCookie("page")||"crdonetime",coupon_price:coupon_sale||"",coupon_id:coupon_id||"",promotion_code:promotion_code||""});({clientSecret:c,order_no:i}=t),t.data?.client_secret&&(c=t.data?.client_secret)}catch(s){c=null}}else try{const t=await sendPayDataCreate({item:e.id,product:"ai-credits-subscription",st:getCookie("st")||"",insur:getCookie("insur")||"",aff:p,page:getCookie("page")||"crdsub",origin:"web",coupon_price:coupon_sale||"",coupon_id:coupon_id||"",promotion_code:promotion_code||""});({clientSecret:c,order_no:i}=t.data),t.data?.client_secret&&(c=t.data?.client_secret)}catch(s){c=null}if(!c)return void n();const l=await stripe.confirmPayment({elements:elements,clientSecret:c,confirmParams:{return_url:`${location.origin}/paysuccessful`,receipt_email:emailAddress},redirect:"if_required"}),{error:s}=l;if(s)n();else{let t="",o="",a="",n="";e.price,e.currency,e.id;p&&(t=p.a_aid,o=p.chan,a=p.data1,n=p.data2);showCarModal("success")}}}async function postAff(e){let t=0;for(;;){try{const o=await postReq(`${interHost}/api/stripe-pay/go-aff`,e);if(200===o?.code)return;if(t++,t>=5)return}catch(e){if(t++,t>=5)return}await new Promise((e=>setTimeout(e,1e3)))}}function createScript(e){}function initPaypal(e,t){}$((function(){showCreditBox(),$("#failed_pay, #success_pay, .dialog_pay_mob #failed_pay, .dialog_pay_mob #success_pay").on("click",(function(){"failed_pay"===this.id?showCarModal("car"):(closeCar(),window.location.reload())})),$(".close_icon, .dialog_pay_mob .close_icon").on("click",(function(){($(".dialog_pay").hasClass("showsuc")||$(".dialog_pay_mob").hasClass("showsuc"))&&window.location.reload(),closeCar()})),$(".coupon_btn, .dialog_pay_mob .coupon_btn").on("click",(function(){document.body.clientWidth<=1200?$(".dialog_pay_mob .coupon_box").hasClass("active")?($(".dialog_pay_mob .coupon_box").removeClass("active"),$(".dialog_pay_mob .coupon_err").hide()):$(".dialog_pay_mob .coupon_box").addClass("active"):$(".coupon_box").hasClass("active")?($(".coupon_box").removeClass("active"),$(".coupon_err").hide()):$(".coupon_box").addClass("active")})),$(".remove_btn, .dialog_pay_mob .remove_btn").on("click",(function(){$(".total_price").removeClass("active"),$(".coupon_price").html(""),$("#input_code").val(""),$(".coupon_err").hide(),$(".remove_btn").hide(),$(".apply_btn").html(payText.apply_btn),$(".paypal_content").show(),$(".m_paypal_content").show(),$(".dialog_pay_mob .total_price").removeClass("active"),$(".dialog_pay_mob .coupon_price").html(""),$(".dialog_pay_mob #input_code").val(""),$(".dialog_pay_mob .coupon_err").hide(),$(".dialog_pay_mob .remove_btn").hide(),$(".dialog_pay_mob .apply_btn").html(payText.apply_btn),coupon_sale=null,coupon_id=null,promotion_code=null})),$("#input_code, .dialog_pay_mob #input_code").on("input",(function(){document.body.clientWidth<=1200?($(".dialog_pay_mob #input_code").val()?$(".dialog_pay_mob .remove_btn").show():$(".dialog_pay_mob .remove_btn").hide(),$(".dialog_pay_mob .coupon_err").hide(),$(".dialog_pay_mob .total_price").removeClass("active"),$(".dialog_pay_mob .apply_btn").html(payText.apply_btn),$(".m_paypal_content").show()):($("#input_code").val()?$(".remove_btn").show():$(".remove_btn").hide(),$(".coupon_err").hide(),$(".total_price").removeClass("active"),$(".apply_btn").html(payText.apply_btn),$(".paypal_content").show()),coupon_sale=null,coupon_id=null,promotion_code=null}))}));