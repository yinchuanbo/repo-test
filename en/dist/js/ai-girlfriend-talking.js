let SOCKET,defaultUserAvatar="/dist/img/aiFriend/icon_avatar.svg";const gfChattingLan=jsonData.aiGirlFriendChat,gfChattingJsLan=jsonData.aiGirlFriendChat.javascript;class PromiseWait{constructor(){this.promise=new Promise((t=>{this.resolve=t}))}async wait(){return this.promise}async finish(){this.resolve()}}class chatTooltip{$el=null;content=void 0;static initScroll=!1;constructor(t,e){this.$el=$(t),this.$el.length&&(this.content=e,this.init(),chatTooltip.initScrollEvent())}init(){const t=$('<div class="chat__tooltip"></div>');t.html(this.content),this.$el.on("mouseenter touchstart",(()=>{$("body").append(t);const e=this.$el.get(0).getBoundingClientRect(),a=t.outerWidth(),i=t.outerHeight();let s=e.left+e.width/2-a/2,n=e.bottom+8;const o=s+a-window.innerWidth;o>0&&(s-=o),s<0&&(s=19);const r=n+i-window.innerHeight;r>0&&(n-=r),t.css({transform:`translate(${s}px, ${n}px)`}),t.stop().fadeIn(100)})),this.$el.on("mouseleave",(()=>{t.stop().fadeOut(100,(()=>t.remove()))}))}static initScrollEvent(){this.initScroll||(this.initScroll=!0,$(window).on("scroll",(()=>{requestAnimationFrame((()=>{const t=$(".plan__tooltip");t.length&&t.fadeOut(100,(()=>t.remove()))}))})))}}class AiGirlfriendTalkingService{getMessageInfo(t,e){const a=new URLSearchParams({chat_id:t});return e>0&&a.append("page",e.toString()),fetchGet(`chat/user/get-message-info?${a.toString()}`)}getChatServer(t){return fetchPost("chat/user/get-chat-server",t)}getRoleInfo(t,e,a){const i=new URLSearchParams({id:t,is_my_characters:e});return a&&1===e&&i.append("my_characters_id",a),fetchGet(`chat/user/get-role-info?${i.toString()}`)}putLike(t){return fetchPost("chat/user/role-like",{role_id:t})}roleEdit(t){return fetchPost("chat/user/role-edit",t)}getUploadUrl(t){return fetchPost("ai/source/get-upload-url",t)}saveAudio(t,e,a,i){return fetchPost("chat/user/up-message",{id:t,chat_id:e,task_timestamp:a,path:i})}getUploadFileUrl(){return fetchPost("ai/source/temp-upload-url",{file_name:"ai-girlfriend-audio.mp3"})}putUploadUrl(t,e){return fetchPut(t,e)}putLog(t){return fetchPost("chat/public/add-log",t)}getVoiceLimit(){return fetchGet("chat/user/get-voice-limit")}getAccessUrl(t){return fetchPost("ai/source/get-access-url",{key:t,action:"browse"})}delChattingRecords(t,e){return fetchPost("chat/user/del-recent-chatting",t).then((()=>{e?.()})).catch((function(t){console.log("del-recent-chatting",t)}))}getIdAllChat(t,e){const a=new URLSearchParams;return a.append("role_id",t),a.append("page_size","10"),a.append("page",e.toString()),fetchGet(`chat/message/list?${a}`)}getPersonaList(t){const e=new URLSearchParams;return e.append("chat_id",t),fetchGet(`chat/user-sesid/persona-list?${e}`)}addPersona(t,e){return fetchPost("chat/user-sesid/persona-add",{title:t,about:e})}editPersona(t,e){const a={id:t.id,title:t.title,about:t.about,is_default:t.is_default};return e&&(a.chat_id=e),fetchPost("chat/user-sesid/persona-edit",a)}delPersona(t){return fetchPost("chat/user-sesid/persona-del",{id:t})}getUserSetting(){return fetchGet("chat/user-sesid/seting-get").then((t=>200===t.code&&t.data?t.data:null)).catch((t=>(console.error("getUserSetting error",t),null)))}setUserSetting(t){return fetchPost("chat/user-sesid/seting-edit",{seting:JSON.stringify(t)})}}class AiGirlfriendTalking{service=new AiGirlfriendTalkingService;hasAudio=!1;userConfig=this.userDefaultConfig();constructor(){this.boxPosition={changeBtnLeft:{chattingContainer:{height:"64vh"},chattingBox:{left:".8rem",right:"auto"},chatBgImg:{right:"0px",left:"auto"},changePhotoBtn:{right:".8rem",left:"auto"}},changeBtnMiddle:{chattingContainer:{height:"340px"},chattingBox:{left:"calc(50% - 38.54vw / 2)",right:"auto"},chatBgImg:{right:"auto",left:"calc(50% - 661px / 2)"},changePhotoBtn:{right:"auto",left:".8rem"}},changeBtnRight:{chattingContainer:{height:"64vh"},chattingBox:{left:"auto",right:".8rem"},chatBgImg:{right:"auto",left:"0"},changePhotoBtn:{right:"auto",left:".8rem"}}},this.updateAudioLimit(),this.getUserConfig()}userDefaultConfig(){return{fullScreen:!1,hideBackground:!1,streaming:!1,chat_id_persona_show:[]}}async getUserConfig(){try{const t=await this.service.getUserSetting()??this.userDefaultConfig();this.userConfig=Object.assign(this.userDefaultConfig(),t)}catch(t){console.error("getUserSetting error",t)}}async setUserConfig(){try{await this.service.setUserSetting(this.userConfig)}catch(t){console.error("setUserSetting error",t)}}data(){return{modelDOM:$("#AiChat"),userMessage:$("#userInputMsg").value}}setSessionData(){sessionStorage.setItem("repeatData",JSON.stringify({path:"chat",data:this.aiData}))}clearSessionData(){sessionStorage.removeItem("repeatData")}async init(t,e){gtag("event",`chat_aigirlfriend_${t.role_id}`),gtag("event","enter_aigirlfriend_chatting");let a=this;this.loginPopup=null,this.isChat=!1,this.socketClose=!1,this.chatPage=-1,this.initHistory=!0,this.isSyncingHistroy=!1,this.isConnectingSocket=!1,this.isOldSeverUrl=!1,this.chatMap=new Map,this.helloTimer=null,this.promiseWaitMap=new Map,this.isChangeData=!1,this.lastSendMsg="",this.aiData={...t},this.aiAvatarImg=t?.head_portrait[0]?.url,this.bgImg=t.head_portrait_background.length>0?t.head_portrait_background[0]?.url:t.head_portrait[0]?.url,this.backImg=`url("${t.head_portrait_background[0]?.url||this.bgImg}")`,this.uploadAvatarChange=!0,this.uploadbg=t.head_portrait_background[0]?.url||!1,getCookie("user_info")&&(this.userData=JSON.parse(getCookie("user_info"))),this.userAvatarImg=this.userData?.head_portrait||defaultUserAvatar,this.connectMsg={user_id:"0"|this.userData?.id,role_id:t.role_id+"",role_name:t.name,chat_id_name:"",chat_id:"",token:getCookie("SsToken"),language:"en"},this.connectMsg.user_id=this.connectMsg.user_id+"",this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,this.isUserScrolling=!1,this.replyKey=void 0,this.replyTimer=null,$(".chatting-container").empty();let i="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(i=localStorage.getItem("chattingPosition")),this.changePosition(i),this.userConfig.fullScreen?($(".audio_btn.screen").addClass("active"),this.changeScreen(!0)):($(".audio_btn.screen").removeClass("active"),this.changeScreen(!1)),this.userConfig.streaming?$(".audio_btn.streaming").addClass("active"):$(".audio_btn.streaming").removeClass("active"),this.userConfig.hideBackground?($(".audio_btn.bg").addClass("active"),this.changeBackground(!0)):($(".audio_btn.bg").removeClass("active"),this.changeBackground(!1)),this.mobileInit(),this.data().modelDOM.fadeIn(),$("body").css({overflow:"hidden",position:"fixed"}),this.setLoginTimer(),$(".hidden-box #aiAvatarImg").attr("src",this.aiAvatarImg),$("#myAvatarImg").attr("src",this.userAvatarImg);let s=new Image;s.onload=function(){a.ratio=this.width/this.height,a.ratio.toFixed(2)>1?a.boxPosition.changeBtnMiddle.chatBgImg.left=0:a.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";let t="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(t=localStorage.getItem("chattingPosition"));const e=$("#chatBgImg");a.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:a.boxPosition[t].chatBgImg.left})},s.src=this.bgImg,this.updateCharacter();try{await this.updateCharacterFunc(t.role_id,t.is_my_characters,t.my_characters_id);let a=await this.getChatData("",e);if(!a)return;let i=getUrlVal("headAvatar");if(i){let t=getUrlVal("form");await this.fromUndressFn(t,i)}this.isMyCharacterStatus=this.aiData.is_my_characters,this.aiData.toMyCharacter=!1,this.connectChatting(a.server_url),this.getChatHistory(),$(".chat_loading").hasClass("active")&&this.chatReLoading(!1)}catch(t){console.error("init error",t)}finally{this.setSessionData()}}async updateAudioLimit(){const e=await this.service.getVoiceLimit();e.data?(this.hasAudio=e.data.sum_num>0,$(".ai-gf-info-dialog-wrap .audio-limit-desc").text(t(gfChattingLan.audioLimitDesc,{sum_num:e.data.sum_num})),"T3"==e.data.area&&$("#voicepool,.createMc_item.voice").toggle()):console.error("getVoiceLimit error",e)}async getChatHistory(){if(!this.isSyncingHistroy&&this.chatPage&&this.aiData.chat_id&&this.connectMsg.chat_id){this.isSyncingHistroy=!0;try{const t=await this.service.getMessageInfo(this.connectMsg.chat_id,this.chatPage);if(200===t.code&&t.data){this.isChat=!0,history.replaceState(null,"","/ai-girlfriend.html?chat");const e=t.data.page;let a=t.data.list?.filter((t=>!!t.chat_content.content));if(ttsBlank(a)&&(a=[]),0===a?.length&&this.chatPage)return this.isSyncingHistroy=!1,this.chatPage=e,void await this.getChatHistory();const i=$(".chatting-container"),s=i.scrollTop(),n=i[0].scrollHeight;i.css("overflow-y","hidden");for(let t of a)if("string"==typeof t.chat_content.content)if("user"===t.chat_content.role){let e=$("#myMessageBox");this.showMessage(e,t.chat_content.content,".my-message-container",!0,t)}else{let e=$("#aiMessageBox");this.showMessage(e,t.chat_content.content,".ai-message-container",!0,t)}if(i.css("overflow-y","auto"),this.initHistory)i.scrollTop(i.prop("scrollHeight"));else{const t=i[0].scrollHeight-n;i.scrollTop(s+t)}if(this.initHistory=!1,this.chatPage=e,a.length<5&&e)this.isSyncingHistroy=!1,await this.getChatHistory();else{if(this.chatMap.size<2)return;const t=this.chatMap.entries(),e=t.next().value,a=t.next().value;if("assistant"==e[1].sendUser&&"user"==a[1].sendUser){$(".ai-message-box").eq(-2).find(".rechat").show();let t={...this.connectMsg,chat_content:a[1].content,request_type:20,chat_action:"",UserSendTime:(new Date).getTime()};this.UserSendTime=t.UserSendTime,this.lastMessage=JSON.stringify(t)}}}}catch(t){console.error("getChatHistory error",t)}finally{this.isSyncingHistroy=!1}}}async getChatData(t="",e=""){const a={chat_id:this.aiData.chat_id,role_id:this.connectMsg.role_id,is_my_characters:this.aiData.is_my_characters,last_server_url:t,is_new:e?1:2};1===this.aiData.is_my_characters&&(a.my_characters_id=this.aiData.my_characters_id);const i=await this.service.getChatServer(a);if(401===i.code)return await this.closeChat(),!1;if(null==i.data)return $Popup({title:jsonData.aiGirlFriend.errorTitle,content:jsonData.aiGirlFriendChat.notChatServer,exist:"serverError"}),!1;if(200!==i.code||!i.data)return console.error("getChatData error",i.message),$Popup({type:"error",errorType:"normal"}),!1;const s=i.data;return s.is_old_server_url&&1===s.is_old_server_url&&(this.isOldSeverUrl=!0),this.socketUrl=s.server_url,this.connectMsg.chat_id=s.chat_id,this.aiData.chat_id=s.chat_id,this.connectMsg.chat_id_name=s.chat_id_name,this.setSessionData(),s}AiHello(){const t={...this.connectMsg,request_type:50,chat_last_sep:3234};clearTimeout(this.helloTimer),this.helloTimer=setTimeout((()=>{SOCKET.send(JSON.stringify(t))}),24e4)}async fromUndressFn(t,e){let a=atob(getUrlVal("avatarKey")),i=atob(e),s={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:this.aiData.name,is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des??"",scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait:JSON.stringify([{key:"head_portrait",value:a,is_temp:1}]),head_portrait_background:JSON.stringify(this.aiData.head_portrait_background)};if(this.aiData.head_portrait=[{key:"head_portrait",value:i,url:i}],this.aiAvatarImg=i,this.aiData.status=2,this.updateCharacter(),$(".chatting-share").hide(),this.aiData.is_my_characters=1,this.bgImg="",this.changeBgAvatar(),!t)return;const n=await this.service.roleEdit(s);200===n.code&&(aiGirlFriend.GetRecentChatting(),this.aiData.toMyCharacter=!0,history.pushState(null,null,`/ai-girlfriend.html?openShare=${getUrlVal("openShare")}&headAvatar=${e}&avatarKey=${btoa(a)}`),this.aiData.my_characters_id=n.data.my_characters_id,this.aiData.role_id=n.data.role_id,this.aiData.is_my_characters=1,this.isChangeData=!0),401!==n.code?(await this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id),this.setSessionData()):await this.closeChat()}mobileInit(){if(window.innerWidth<1200){let t;$("#changePhotoBtn").text("Change Photo"),t=1===this.aiData.is_my_characters?"1.4rem":"1.92rem",$(".change-photo-btn").css({left:"auto",right:t})}}updateCharacter(){$(".chatting-count").text(formatNumber(this.aiData.msg_num)),$(".ai-chat-gf-avatar, .ai-gf-info-dialog-avatar").attr("src",this.aiAvatarImg),$(".ai-gf-info-dialog-birthday").text(this.aiData.json.Created),$(".ai-gf-info-dialog-desc").text(this.aiData.json.Character_des),$(".ai-chat-gf-name, .ai-gf-info-dialog-name").text(this.aiData.name),this.toggleShareBtn(1===this.aiData.status&&1===this.aiData.type);const t=this.aiData.json.tag.split(",").filter((t=>""!==t)).map((t=>`<div class="ai-gf-info-dialog-tag">${t}</div>`));$(".ai-gf-info-dialog-tags").html(t.join("")),1===this.aiData.is_like?($(".no-like-icon").hide(),$(".like-icon").show()):($(".no-like-icon").show(),$(".like-icon").hide())}bindEvent(){let t=this;$("#userInputMsg").on("input",(function(){let t=$(this).val().length;window.innerWidth>1200?this.style.height=this.scrollHeight+"px":this.style.height=this.scrollHeight/100+.5+"rem",(0===t||t<37)&&(window.innerWidth>1200?this.style.height="46px":this.style.height=".88rem");const e=$(".send-btn");0===t||/^\s*$/.test($(this).val())?e.addClass("disable"):e.removeClass("disable")})),$("#backIcon, #closeIcon").on("click",(function(){"backIcon"===$(this).attr("id")?gtag("event","back_aigirlfriend_chatting"):gtag("event","close_aigirlfriend_chatting"),t.closeChat("click")})),$(".chatting-container").on("click",".audio-button",(function(e){const a=$(e.currentTarget);gtag("event","click_aigirlfriend_voice"),t.toggleAudioBtn(a,!a.hasClass("active"))})),$("#sendMsg").on("click",(()=>{this.sendMessage(),$("#userInputMsg").trigger("focus")})),$(".ai-chat-box textarea").on("keydown",(t=>{"Enter"===t.key&&(t.preventDefault(),this.sendMessage())})),$("#editIcon").on("click",(()=>{$(".change-position-box").toggle()})),$(document).on("click",(function(e){const a=$(e.target);a.closest("#editIcon").length||a.closest(".change-position-box").length||$(".change-position-box").hide(),a.closest(".right-button-box-m-dropdown").length||a.closest(".right-button-box-m-dropdown-menu").length||t.toggleGFDropdown(!1),0===a.closest(".ai-gf-persona-more").length&&$(".ai-gf-persona-pop").fadeOut(160)})),$(".change-btns-box .change-btn").on("click",(function(){let e=$(this).attr("id");gtag("event",{changeBtnLeft:"left_aigirlfriend_pos",changeBtnMiddle:"mid_aigirlfriend_pos",changeBtnRight:"right_aigirlfriend_pos"}[e]),t.changePosition(e),$(".change-position-box").hide()})),$("#changePhotoBtn").on("click",(()=>{gtag("event","click_aigirlfriend_changephoto"),this.openChangeHandle()})),$(".chatting-like").on("click",(async function(){t.isChangeData=!0;try{t.toggleLikeBtn();200===(await t.service.putLike(t.aiData.role_id)).code?$(this).closest(".ai-gf-info-dialog").length>0?gtag("event","like_aigirlfriend_view"):1===t.aiData.is_like&&gtag("event","like_aigirlfriend_chatting"):($Popup({type:"error",errorType:"network"}),t.toggleLikeBtn())}catch(e){console.error("like error",e),$Popup({type:"error",errorType:"network"}),t.toggleLikeBtn()}})),$(".discord-box").on("click",(()=>{gtag("event","discord_aigirlfriend_chatting")})),$(".chatting-share").on("click",(t=>{$(t.target).closest(".ai-gf-info-dialog").length>0?gtag("event","share_aigirlfriend_view"):(gtag("event","share_aigirlfriend_chatting"),$(".chatting-setting").removeClass("active")),aiGirlFriend.showShare(this.aiData.role_id,this.aiData.head_portrait[0].value)})),$(".ai-chat-gf-view").on("click",(()=>{this.toggleGFInfoDialog(!0,".ai-gf-info-dialog")})),$(".chatting-all").on("click",(()=>{gtag("event","allchat_aigirlfriend_chatting"),this.toggleGFInfoDialog(!0,".ai-gf-all-dialog"),this.clearRoleIdAllChats(),this.updateRoleIdAllChats()})),$(".ai-gf-info-dialog-close, .ai-gf-info-dialog-bg").on("click",(()=>{$(".ai-gf-info-dialog-wrap").find(".ai-gf-persona-dialog").is(":visible")?this.openSavePopup(!0):this.toggleGFInfoDialog(!1)})),$(".right-button-box-m-dropdown").on("click",(()=>{const t=$(".right-button-box-m-dropdown-menu").is(":visible");this.toggleGFDropdown(!t)}));const e=$("#chattingContainer");e.on("scroll",(t=>{0===$(t.currentTarget).scrollTop()&&this.getChatHistory()})),e.on("wheel touchmove",(t=>{t.stopPropagation(),this.isUserScrolling=!0})),$(".chatting-newChat").click((async function(){t.isSyncingHistroy||(gtag("event","newchat_aigirlfriend_chatting"),await t.closeChat(!1,"new"),t.aiData.chat_id=void 0,t.connectMsg=null,t.init(t.aiData,"new"))})),$(".chatting-restart").click((function(){if(t.isSyncingHistroy)return;gtag("event","restartchat_aigirlfriend_chatting");let e=$Popup({title:jsonData.aiGirlFriendChat.restartTitle,content:jsonData.aiGirlFriendChat.restartText,closeBtn:jsonData.aiGirlFriendChat.resetChat,applyBtn:jsonAiGirlFriend.Cancel,autoClose:!1,exist:"bootLogin",onClose:()=>{e.loading.start(),aiGirlFriend.deleteChat(t.aiData.chat_id,(async()=>{e.close(),await t.closeChat(!1,"restart"),await aiGirlFriend.GetRecentChatting(),delete t.aiData.chat_id,t.init(t.aiData,"restart")}))},onApply:()=>{e.close()},topCloseFn:()=>{e.close()}})})),$(".audio_btn").click((function(){$(this).toggleClass("active"),$(this).hasClass("screen")?(gtag("event","fullscreen_aigirlfriend_chatting"),$(this).hasClass("active")?(t.userConfig.fullScreen=!0,t.changeScreen(!0)):(t.userConfig.fullScreen=!1,t.changeScreen(!1))):$(this).hasClass("bg")?(gtag("event","hidebackground_aigirlfriend_chatting"),$(this).hasClass("active")?(t.userConfig.hideBackground=!0,t.changeBackground(!0)):(t.userConfig.hideBackground=!1,t.changeBackground(!1))):$(this).hasClass("streaming")&&(gtag("event","enablestreaming_aigirlfriend_chatting"),t.userConfig.streaming=!!$(this).hasClass("active")),t.debounceUserConfig()})),$("body").on("mouseup",(async function(e){const a=$(e.target),i=$(".chat-btn-setting")[0].contains(e.target);(a.hasClass("chat-btn-setting")||a.hasClass("chat-btn-icon"))&&gtag("event","chatsettings_aigirlfriend_chatting");const s=$(".audio_btn");if(s[0].contains(e.target)||s[1].contains(e.target)||s[2].contains(e.target)||(i?$(".chat-btn-setting").toggleClass("active"):$(".chat-btn-setting").removeClass("active")),$(".setting_box").hide(),a.hasClass("msgSetting")){gtag("event","click_aigirlfriend_msgsettings");let t=a.hasClass("my")?"my":"ai";$(".ai-message-box,.my-message-box").css("z-index",""),a.parents(`.${t}-message-box`).css("z-index",1),a.children(".setting_box").show()}else if(a.hasClass("setting_copy")){a.parents(".setting_box").hide();let t="assistant"==a.parents(".chatOperation").data("sender")?"ai":"my";a.parents(`.${t}-message-box`).css("z-index","");const e=a.parents(`.${t}-message-box`).find(".chat_msg");copyText(e.text())}else if(a.hasClass("setting_delete")){let e=a.parents(".chatOperation");if(!e.data("ischecktime"))return;let i="assistant"==e.data("sender")?"ai":"my",s={chat_id:t.aiData.chat_id,role:e.data("sender"),task_timestamp:e.data("timestamp")};t.service.delChattingRecords(s),a.parents(`.${i}-message-box`).remove()}else $(".ai-message-box,.my-message-box").css("z-index",""),$(".ai-message-box,.my-message-box").find(".setting_box").hide();if(a.hasClass("rechat")){gtag("event","click_aigirlfriend_rechat");let e=a.parents(".chatOperation");if(!e.data("ischecktime"))return;let i="assistant"==e.data("sender")?"ai":"my",s=e.data("timestamp"),n={chat_id:t.aiData.chat_id,role:"assistant",task_timestamp:s},o={chat_id:t.aiData.chat_id,role:"user",task_timestamp:s};a.parents(`.${i}-message-box`).remove(),t.setChatLoading(!0),await t.service.delChattingRecords(n),await t.service.delChattingRecords(o),SOCKET?SOCKET.readyState===WebSocket.OPEN?SOCKET.send(t.lastMessage):SOCKET.readyState===WebSocket.CLOSED?(t.disconnectMessage=t.lastMessage,t.connectChatting(t.socketUrl)):t.disconnectMessage=t.lastMessage:t.disconnectMessage=t.lastMessage;$(`.chatOperation[data-timestamp="${s}"]`).attr("data-timestamp",t.UserSendTime)}})),this.bindAiReplyEvent(),this.bindUserPersonaEvent(),this.bindRoleIdAllChatsEvent()}debounceUserConfig=debounce((()=>{this.setUserConfig()}),600);clearReplyList(){this.replyKey=void 0,clearTimeout(this.replyTimer),$(".ai-reply-wrapper").removeClass("show loading"),$(".ai-reply-list").empty()}setReplyTimer(){const t=$(".ai-reply-wrapper");t.addClass("loading"),clearTimeout(this.replyTimer),this.replyTimer=setTimeout((()=>{this.replyKey=void 0,t.removeClass("loading")}),6e4)}bindAiReplyEvent(){const t=$(".ai-reply-wrapper");$(".ai-reply-btn > img").on("click",(()=>{gtag("event","click_aigirlfriend_aireply"),0===$(".ai-reply-list li").length&&this.refreshAiReply(),t.addClass("show")})),$(".ai-reply-close").on("click",(()=>{this.clearReplyList()})),$(".ai-reply-title > img").on("click",(()=>{this.refreshAiReply()})),$(".ai-reply-list").on("click","li",(t=>{const e=$(t.currentTarget);e.siblings().removeClass("checked"),e.addClass("checked");const a=e.find("p").text();$("#userInputMsg").val(a).trigger("input").trigger("focus")}))}refreshAiReply(){if(this.replyKey)return;let t=(new Date).getTime(),e={...this.connectMsg,chat_content:"1",request_type:60,chat_action:"",UserSendTime:t};this.replyKey=t,this.setReplyTimer(),this.sendOtherMessage(e)}_personaList=[];get personaList(){return this._personaList}set personaList(t){this._personaList=t,this.renderPersonaList(t)}getCopyPersonaList(){return this.personaList.map((t=>({...t})))}async getPersonaList(t){if(t)try{const e=await this.service.getPersonaList(t);200===e.code?this.personaList=e.data?.reverse()??[]:console.error("getPersonaList error",e.message)}catch(t){console.error("getPersonaList error",t)}}renderPersonaList(t){const e=$(".add-new-persona");if(t.length>=3?e.addClass("disabled"):e.removeClass("disabled"),0===t.length)return;let a="";t.forEach((e=>{const i=e.title!==gfChattingLan.newPersonaTitle?escapeHtml(e.title):e.title,s=e.about?escapeHtml(e.about):"";a+=`\n        <div class="ai-gf-persona-item" data-id="${e.id??""}">\n          <div class="ai-gf-persona-radio"></div>\n          <div class="ai-gf-persona-name-wrapper">\n            <div class="ai-gf-persona-name">${i}</div>\n            ${s?`<div class="ai-gf-persona-desc">${s}</div>`:""}\n          </div>\n          ${t.length>1||!e.id.includes("new")?`\n          <div class="ai-gf-persona-more">\n            <img src="/dist/img/ai-chatting/btn_more.svg" alt="">\n            <div class="ai-gf-persona-pop">\n              ${e.id.includes("new")?"":`\n               <div class="ai-gf-persona-pop-item default">\n                <img src="/dist/img/ai-chatting/icon_user.svg" alt="" class="item_icon" />\n                <span>${gfChattingLan.default}</span>\n              </div>`}\n              <div class="ai-gf-persona-pop-item del">\n                <img src="/dist/img/ai-chatting/icon_del.svg" alt="" class="item_icon" />\n                <span>${gfChattingLan.delete}</span>\n              </div>\n            </div>\n          </div>`:""}\n          <img class="ai-gf-persona-set" src="/dist/img/ai-chatting/icon_arrow_pink.svg" alt="">\n        </div>\n        `})),$(".ai-gf-persona-list").html(a);const i=t.findIndex((t=>1===t.chat_is_default)),s=t.findIndex((t=>1===t.is_default));$(".ai-gf-persona-item").eq(-1!==i?i:-1!==s?s:0).trigger("click")}clearPersona(){this.personaList=[],$(".ai-gf-persona-list").empty(),$(".ai-gf-persona-edit-title").text(gfChattingLan.newPersona),$(".ai-gf-persona-input").val(""),$(".ai-gf-persona-list-wrapper").addClass("active"),$(".ai-gf-persona-edit").removeClass("active"),$(".ai-gf-persona-save").addClass("disabled")}openSavePopup(t=!1){const e=$(".ai-gf-persona-save"),a=$("input.ai-gf-persona-input"),i=()=>{const t=$("textarea.ai-gf-persona-input");a.val(""),t.val(""),a.trigger("input"),t.trigger("input"),$(".ai-gf-persona-list-wrapper").addClass("active"),$(".ai-gf-persona-edit").removeClass("active")};if(e.hasClass("disabled"))return t&&this.toggleGFInfoDialog(!1),void i();const s=`\n      <div style="font-family: 'Roboto',serif;font-size: 14px;color: rgba(255,253,245,1)">${gfChattingLan.personaSaveContent}</div>\n      <div style="font-family: 'Roboto',serif;font-size: 14px;color: rgba(255,253,245,0.6)">${gfChattingLan.persona}: ${escapeHtml(a.val().trim())}</div>\n    `,n=`\n    <div class='login-popup-close-btn'>${gfChattingLan.dontSave}</div>\n    `,o=$Popup({title:gfChattingLan.confirmSave,content:s,closeBtn:gfChattingLan.save,otherBtns:n,exist:"personaPopup",addBorderRadius:!0,autoClose:!1,onClose:()=>{o.loading.start(),e.trigger("click");const a=setInterval((()=>{e.hasClass("loading")||(o.loading.end(),o.close(),t&&this.toggleGFInfoDialog(!1),i(),clearInterval(a))}),500)}});o.modal.find(".login-popup-close-btn").on("click",(()=>{o.close(),t&&this.toggleGFInfoDialog(!1),i()}))}bindUserPersonaEvent(){new chatTooltip(".persona-tips",gfChattingLan.personaTip),new chatTooltip(".about-yourself-tips",gfChattingLan.tellAboutYourselfTip);const t=$(".ai-gf-persona-dialog"),e=$(".ai-gf-persona-list-wrapper"),a=$(".ai-gf-persona-edit"),i=$(".ai-gf-persona-switch-btn"),s=$(".add-new-persona"),n=$(".ai-gf-persona-apply"),o=$(".ai-gf-persona-save"),r=$(".ai-gf-persona-list"),l=$("textarea.ai-gf-persona-input"),c=$("input.ai-gf-persona-input");let h=!1;const g=e=>{h=e,e?(t.addClass("syncing"),o.addClass("disabled"),n.addClass("disabled")):t.removeClass("syncing")},d=t=>{if(!t.includes("new"))try{this.service.delPersona(t)}catch(t){console.error("delPersona error")}const e=this.getCopyPersonaList().filter((e=>e.id!==t));this.personaList=e,0===e.length&&s.trigger("click")},p=t=>{if(t.includes("new"))return;let e=null;this.personaList=this.getCopyPersonaList().map((a=>(a.id===t?(e=a,a.is_default=1):a.is_default=2,a)));try{this.service.editPersona(e)}catch(t){console.error("setDefault error")}},u=t=>{const e=t.includes("new");let a=null;this.personaList.forEach((e=>{e.id===t?(e.chat_is_default=1,a=e):e.chat_is_default=2})),a&&($(".ai-gf-persona-edit-title").text(e?gfChattingLan.newPersona:a.title),$("input.ai-gf-persona-input").val(e?"":a.title),$("textarea.ai-gf-persona-input").val(e?"":a.about),l.trigger("input"),c.trigger("input"))};let m=1;s.on("click",(t=>{this.personaList.length>=3||(this.personaList=[...this.getCopyPersonaList(),{id:"new-"+m,title:gfChattingLan.newPersonaTitle,about:"",is_default:2}],m++)})),$(".chatting-persona").on("click",(async()=>{new Set(this.userConfig.chat_id_persona_show).has(this.aiData.chat_id)?(i.addClass("active"),n.removeClass("disabled")):(i.removeClass("active"),n.addClass("disabled"));try{if(this.toggleGFInfoDialog(!0,".ai-gf-persona-dialog"),gtag("event","userpersona_aigirlfriend_chatting"),0!==this.personaList.length)return;await this.getPersonaList(this.aiData.chat_id),0===this.personaList.length&&s.trigger("click")}catch(t){$Popup({type:"error",errorType:"network"}),console.error("getPersonaList error",t)}})),r.on("click",".ai-gf-persona-item",(t=>{const e=$(t.currentTarget),a=e.data("id");e.addClass("active").siblings().removeClass("active");new Set(this.userConfig.chat_id_persona_show).has(this.aiData.chat_id)&&(a.includes("new")?n.addClass("disabled"):n.removeClass("disabled")),u(a)})),r.on("click",".ai-gf-persona-more",(t=>{t.stopPropagation()})),r.on("click",".ai-gf-persona-more > img",(t=>{t.stopPropagation();const e=$(t.currentTarget).closest(".ai-gf-persona-item").find(".ai-gf-persona-pop");$(".ai-gf-persona-pop").not(e).fadeOut(160),e.fadeToggle(160)})),r.on("click",".ai-gf-persona-set",(t=>{e.removeClass("active"),a.addClass("active")})),r.on("click",".ai-gf-persona-pop-item",(t=>{t.stopPropagation();const e=$(t.currentTarget),a=e.hasClass("default")?"default":"del",i=e.closest(".ai-gf-persona-item").data("id");switch(a){case"default":p(i);break;case"del":d(i)}})),$(".ai-gf-persona-edit-back").on("click",(()=>{this.openSavePopup()}));const f=$(".ai-gf-persona-count");let v=!1;l.on("compositionstart",(function(){v=!0})),l.on("compositionend",(function(){v=!1,$(this).trigger("input")})),l.on("input change",(()=>{if(v)return;const t=1024,e=this.personaList.find((t=>$(".ai-gf-persona-item.active").data("id")===t.id)).about;let a=l.val().replace(/^\s+$/g,"");l.val(a),a.length>=t?(l.val(a.slice(0,t)),f.addClass("error")):f.removeClass("error"),a=l.val(),a.length&&c.val().trim()&&a!==e?o.removeClass("disabled"):o.addClass("disabled"),f.text(`${a.length}/1024`)})),c.on("input change",(()=>{let t=c.val().trim();const e=this.personaList.find((t=>$(".ai-gf-persona-item.active").data("id")===t.id)).title;t.length&&l.val().trim()&&t!==e?o.removeClass("disabled"):o.addClass("disabled")})),o.on("click",(async()=>{if(h)return;g(!0),o.addClass("loading");const t=c.val().trim(),e=l.val().trim(),a=$(".ai-gf-persona-item.active"),i=a.data("id"),s=i.includes("new"),n=a.index();try{const a=s?await this.service.addPersona(t,e):await this.service.editPersona({id:i,title:t,about:e,is_default:this.personaList.find((t=>t.id===i)).is_default});if(200!==a.code)return void $Popup({type:"error",errorType:"network"});const o=a.data;if(s){const t=o[0],e=this.getCopyPersonaList();e[n]=t,this.personaList=e}else this.personaList=this.getCopyPersonaList().map((a=>(a.id===i&&(a.title=t,a.about=e),a)));$(".ai-gf-persona-item").eq(n).trigger("click")}catch(t){$Popup({type:"error",errorType:"network"}),console.error("savePersona error",t)}finally{g(!1),o.removeClass("loading")}})),n.on("click",(async()=>{if(h)return;g(!0),n.addClass("loading");const t=this.personaList.find((t=>1===t.chat_is_default));try{if(t&&!t.id.includes("new")){const e=await this.service.editPersona({...t,is_default:"1"},this.connectMsg.chat_id);if(200!==e.code)return $Popup({type:"error",errorType:"network"}),void console.error("applyPersona error",e.message);this.toggleGFInfoDialog(!1)}}catch(t){$Popup({type:"error",errorType:"network"}),console.error("applyPersona error",t)}finally{g(!1),n.removeClass("loading")}})),i.on("click",(()=>{const t=new Set(this.userConfig.chat_id_persona_show);t.has(this.aiData.chat_id)?(t.delete(this.aiData.chat_id),i.removeClass("active"),n.addClass("disabled")):(t.add(this.aiData.chat_id),i.addClass("active"),n.removeClass("disabled")),$(".ai-gf-persona-item.active").attr("data-id").includes("new")&&n.addClass("disabled"),this.userConfig.chat_id_persona_show=Array.from(t),this.debounceUserConfig()}))}changePosition(t){this.currentPosition=t,getCookie("user_info")?localStorage.setItem("chattingPosition",t):localStorage.removeItem("chattingPosition"),$("#"+t).addClass("change-active").siblings().removeClass("change-active");let e=this.boxPosition;for(let a in e[t]){let i=`#${a}`;for(let s in e[t][a])"chattingContainer"==a?this.chatHeight=e[t][a][s]:$(i).css(s,e[t][a][s])}let a=$(".chatting-container");a.scrollTop(a.prop("scrollHeight"))}isMobile(){return window.innerWidth<1200}toggleGFInfoDialog(t,e){const a=$(".ai-gf-info-dialog-wrap");if(a.children("div").not(".ai-gf-info-dialog-bg").hide(),e&&a.find(e).show(),this.isMobile()?t?a.show(0,(()=>a.addClass("active"))):a.removeClass("active").hide():t?a.fadeIn(160):a.fadeOut(160),t&&".ai-gf-info-dialog"===e)gtag("event","show_aigirlfriend_view")}toggleGFDropdown(t){const e=$(".right-button-box-m-dropdown-menu");this.isMobile()?t?e.slideDown(160):e.slideUp(160):t?e.fadeIn(160):e.fadeOut(160)}toggleShareBtn(t){const e=$(".chatting-share");t?e.show():e.hide()}toggleLikeBtn(){const t=1!==this.aiData.is_like;this.aiData.is_like=t?1:2;const e=$(".like-icon"),a=$(".no-like-icon");t?(e.show(),a.hide()):(e.hide(),a.show()),this.setSessionData()}roleIdAllChatsPage=0;roleIdTotalPage=0;isLoadingRoleIdAllChats=!1;bindRoleIdAllChatsEvent(){const t=$(".ai-gf-all-list");t.on("scroll",(t=>{if(this.roleIdAllChatsPage>=this.roleIdTotalPage&&0!==this.roleIdAllChatsPage)return;const e=$(t.currentTarget);e.scrollTop()+e.innerHeight()>=e[0].scrollHeight&&this.updateRoleIdAllChats()})),t.on("click",".ai-gf-all-item-del",(e=>{const a=$(e.currentTarget).closest(".ai-gf-all-item"),i=a.attr("data-id"),s=$Popup({title:jsonAiGirlFriend.deleteRecentTitle,content:jsonAiGirlFriend.deleteRecentText,closeBtn:jsonAiGirlFriend.Delete,otherBtns:`<button class="cannel">${jsonAiGirlFriend.Cancel}</button>`,autoClose:!1,exist:"deletePop",onClose:()=>{s.loading.start(),aiGirlFriend.deleteChat(i,(async()=>{try{i===this.aiData.chat_id&&this.closeChat(),await aiGirlFriend.GetRecentChatting(),a.remove(),s.close(),0===t.find(".ai-gf-all-item").length&&t.empty()}catch(t){console.error("deleteChat error",t)}}))}});s.modal.find(".cannel").on("click",(()=>{s.close()}))}))}clearRoleIdAllChats(){$(".ai-gf-all-list").empty(),this.roleIdAllChatsPage=0,this.roleIdTotalPage=0,this.isLoadingRoleIdAllChats=!1}async updateRoleIdAllChats(){const t=$(".ai-gf-all-title"),e=$(".ai-gf-all-list");t.text(`${gfChattingLan.allChatsWith} "${this.aiData.name}"`);try{if(this.isLoadingRoleIdAllChats)return;if(this.roleIdAllChatsPage>=this.roleIdTotalPage&&0!==this.roleIdAllChatsPage)return;this.isLoadingRoleIdAllChats=!0;const t=await this.service.getIdAllChat(this.aiData.role_id,this.roleIdAllChatsPage);if(200!==t.code||!t.data)return void console.error("updateRoleIdAllChats error",t.message);const a=t.data.list;if(0===a.length&&!this.roleIdAllChatsPage)return void e.empty();this.roleIdAllChatsPage=t.data.page,this.roleIdTotalPage=t.data.page_count;let i="";a.forEach((t=>{const e=function(t){if(!t)return"+";const e=new Date(MSK2UTC(t)),a=((new Date).getTime()-e.getTime())/1e3,i=e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"}),s=navigator.language||navigator.languages[0];if(a<3600){const t=Math.floor(a/60);return`${t} ${gfChattingLan[t>1?"minutesAgo":"minuteAgo"]}+${i}`}if(a<86400){const t=Math.floor(a/3600);return`${t} ${gfChattingLan[t>1?"hoursAgo":"hourAgo"]}+${i}`}if(a<604800){const t=Math.floor(a/86400);return`${t} ${gfChattingLan[t>1?"daysAgo":"dayAgo"]}+${i}`}if(s.startsWith("en"))return`${e.getDate()} ${e.toLocaleString("en-US",{month:"long"})}, ${e.getFullYear()}+${i}`;return`${e.toLocaleDateString(void 0,{day:"numeric",month:"long",year:"numeric"})}+${i}`}(t.message.task_timestamp).split("+"),a=Array.isArray(t.message)?"":t.message.chat_content.content.replace(/\*(.*?)\*/g,"");i+=`\n          <li class="ai-gf-all-item" data-id="${t.chat_id}">\n            <img class="ai-gf-all-item-avatar" src="${t.head_portrait[0].url}" alt="avatar">\n            <svg class="ai-gf-all-item-del" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14" viewBox="0 0 14 14">\n              <defs>\n                <clipPath>\n                  <rect id="Rectangle_32155" data-name="Rectangle 32155" width="14" height="14" transform="translate(1396 423)" fill="#fff" stroke="#707070" stroke-width="1"/>\n                </clipPath>\n              </defs>\n              <g id="btn_del_hover" transform="translate(-1396 -423)">\n                <path id="Path_2030" data-name="Path 2030" d="M7,1123h4m-8,2H15m-1.333,0-.468,7.013a4.889,4.889,0,0,1-.332,1.98,2,2,0,0,1-.866.807,4.876,4.876,0,0,1-1.995.2H7.994A4.876,4.876,0,0,1,6,1134.8a2,2,0,0,1-.866-.807,4.889,4.889,0,0,1-.332-1.98L4.333,1125m3.333,3v3.333M10.333,1128v3.333" transform="translate(1394 -699)" fill="none" stroke="#eef3ff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>\n              </g>\n            </svg>\n\n            <div class="ai-gf-all-item-info">\n              <div class="ai-gf-all-item-time">${e[0]}</div>\n              <div class="ai-gf-all-item-time">${e[1]}</div>\n              <div class="ai-gf-all-item-msg">${a}</div>\n            </div>\n          </li>\n        `})),e.append(i)}catch(t){console.error("updateAllChat error",t)}finally{this.isLoadingRoleIdAllChats=!1}}async closeChat(t,e=""){let a=async()=>{this.toggleGFInfoDialog(!1),$(".change-position-box").hide(),$("body").css({"overflow-y":"auto",position:"static"}),history.pushState(null,null,"/ai-girlfriend.html"),clearInterval(this.loginTimer),clearInterval(this.heartTimer),clearInterval(this.disconnectTimer),clearTimeout(this.helloTimer),this.clearTimeoutAudioQueue(),this.clearPromiseWait(),this.clearRoleIdAllChats(),this.clearReplyList(),this.clearPersona(),this.clearSessionData(),this.changePopup=null,this.loginPopup=null;const t=$("#userInputMsg");t.val(""),window.innerWidth>1200?t.css("height","46px"):t.css("height",".88rem");const a=$(".chatting-container");if(a.find("audio").off("play pause ended"),a.empty(),$Popup().closeAll(),e?this.chatReLoading(!0):this.data().modelDOM.fadeOut(),this.socketClose=!0,SOCKET?.close(),this.isChat&&"restart"!=e){let t={...this.aiData};aiGirlFriend.addRecentChatting(t)}this.isChat=!1;let i="home";"my"==aiGirlFriend.tab?i="my-characters":"voice"==aiGirlFriend.tab&&(i="voice-pool"),history.replaceState(null,"",`/ai-girlfriend.html?${i}`),aiGirlFriend.resetAll=this.isChangeData,aiGirlFriend.resetMy=this.isChangeData,await aiGirlFriend.initCharacters(!0),aiGirlFriend.GetMyCharacters(!0)};t?this.showLoginPopup((async()=>{await a()})):await a()}lastMessage=null;connectChatting(t,e){if(this.socketClose||!t||this.isConnectingSocket)return;this.isConnectingSocket=!0;let a=!1;SOCKET=new WebSocket(t),SOCKET.binaryType="arraybuffer";let i={...this.connectMsg,chat_last_sep:3234,request_type:this.isOldSeverUrl?11:10,chat_action:"",UserSendTime:(new Date).getTime()};this.UserSendTime=i.UserSendTime,this.isOldSeverUrl=!1;let s={...this.connectMsg,request_type:40};clearInterval(this.heartTimer),this.heartTimer=setInterval((()=>{SOCKET.readyState===WebSocket.OPEN&&SOCKET.send(JSON.stringify(s))}),4e4),SOCKET.onopen=()=>{this.isConnectingSocket=!1,this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5),SOCKET.send(JSON.stringify(i))},SOCKET.onmessage=async e=>{this.wssResponse=JSON.parse(e.data),a||(a=!0,this.AiHello(),this.sendOtherQueue.length&&setTimeout((()=>{for(;this.sendOtherQueue.length>0;){const t=JSON.parse(this.sendOtherQueue.shift());SOCKET.send(JSON.stringify(Object.assign(t,this.connectMsg)))}}),1e3),this.disconnectMessage&&setTimeout((()=>{const t=JSON.parse(this.disconnectMessage);SOCKET.send(JSON.stringify(Object.assign(t,this.connectMsg))),this.disconnectMessage=""}),1e3));if([300,7001,7002].includes(this.wssResponse.status)){let t={...this.connectMsg,error_msg:this.wssResponse?.error_info,versions:currentVersion,time_stamp:this.wssResponse?.time_stamp??"",wss:this.socketUrl,wssResponse:this.wssResponse};this.service.putLog(t)}if(this.wssResponse.next_time||(clearTimeout(this.disconnectTimer),this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5)),300===this.wssResponse.status||500===this.wssResponse.status){SOCKET.close(),this.disconnectMessage=this.lastMessage;let e=await this.getChatData(t);if(!e)return;return void this.connectChatting(e.server_url)}if(6001===this.wssResponse.status)return gtag("event","already_aigirlfriend_win"),void this.closeChat();if(7001===this.wssResponse.status)return console.error("audio error",{time_stamp:this.wssResponse.time_stamp,message:this.wssResponse.error_info}),this.deleteTimeoutAudioQueue(this.wssResponse.time_stamp),void $(`[data-id="${this.wssResponse.time_stamp}"]`).removeClass("active");if(7002===this.wssResponse.status)return console.error("audio service error",{time_stamp:this.wssResponse.time_stamp,message:this.wssResponse.error_info}),this.deleteTimeoutAudioQueue(this.wssResponse.time_stamp),void $(`[data-id="${this.wssResponse.time_stamp}"]`).removeClass("active");if(21===this.wssResponse.status)return void this.assemblyAudioChunk(this.wssResponse);if(200===this.wssResponse.status&&this.replyKey&&this.wssResponse.UserSendTime===this.replyKey){const t=$(".ai-reply-wrapper"),e=this.wssResponse.chat_content.filter(Boolean);if(e.length){const t=$(".ai-reply-list");t.empty();let a="";e.forEach((t=>{a+=`\n               <li>\n                 <p>${t}</p>\n                 <div class="ai-reply-checkbox"></div>\n               </li>`})),t.html(a)}return t.removeClass("loading"),clearTimeout(this.replyTimer),void(this.replyKey=void 0)}let i=this.wssResponse?.chat_content,s=$("#aiMessageBox");this.showMessage(s,i,".ai-message-container",!1,this.wssResponse)},SOCKET.onerror=t=>{this.isConnectingSocket=!1,console.error("socket error",t)},SOCKET.onclose=async e=>{if(this.isConnectingSocket=!1,!e.wasClean&&!this.socketClose){let e=await this.getChatData(t);if(!e)return;this.connectChatting(e.server_url)}}}lottiePlayerAudioLoading=$("#audio-loading-icon").clone();setChatLoading(t){let e=this,a=$(".chatting-container");t?(a.append(`\n        <div class="ai-message-box item loading">\n          <div class="img-container">\n            <img src="${this.aiAvatarImg}" alt="" id="aiAvatarImg" class="aiAvatarImg" />\n          </div>\n          <div class="ai-message-container loading">\n            <div class="chatting-loading-new">\n              <span class="relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n              <span class="animation-delay-200 relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n              <span class="animation-delay-400 relative wh-8 w-2 animate-typing rounded-full bg-typing bouncing-element"></span>\n            </div>\n          </div>\n        </div>\n      `),this.chatLoadingTime=0,this.loadingChatTimer=setInterval((()=>{$(".chatting-loading").css("background-position-x",e.chatLoadingTime+"px"),e.chatLoadingTime=e.chatLoadingTime+8}),200)):(clearInterval(this.loadingChatTimer),this.loadingChatTimer=null,this.chatLoadingTime=0,$(".ai-message-box.item.loading").remove())}chatReLoading(t){t?$(".chat_loading").addClass("active"):$(".chat_loading").removeClass("active")}setRmoveRecords(t){if(!t||ttsBlank(t.UserSendTime))return;const e=$(`.chatOperation[data-timestamp="${t.UserSendTime}"]`);0!=e.length&&(e.attr("data-timestamp",t.time_stamp??t.task_timestamp),e.attr("data-isCheckTime",!0))}async showMessage(t,e,a,i,s,n){if(!e)return;let o,r,l=t.clone().removeAttr("id"),c=$(".chatting-container");if(o=h(e)?e.replace(/\*(.*?)\*/g,'<p style="margin:0">$1</p>'):e.replace(/\*(.*?)\*/g,"<p>$1</p>"),".ai-message-container"===a){const t=s.time_stamp??s.task_timestamp;this.chatMap.set(t,{content:e,timestamp:t,sendUser:"assistant",page:this.chatPage>-1&&i?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:s.chat_content.path??""}),this.lottiePlayerAudioLoading.removeAttr("id"),$(".rechat").hide(),r=`<div class="chatOperation" data-timestamp='${t}' data-sender='assistant' data-isCheckTime='true'>\n                    <div class="chatName">${this.aiData.name}</div>\n                    <div class="chatTools">\n                      <div class="rechat" style="display:${i?"none":"block"}"></div>\n                      <div class="msgSetting ai">\n                        <div class="setting_box">\n                          <div class="setting_copy">\n                            <img src="/dist/img/ai-chatting/icon_copy_black.svg"/>\n                            ${jsonData.aiGirlFriendChat.copy}\n                          </div>\n                          <div class="setting_delete">\n                            <img src="/dist/img/ai-chatting/icon_del.svg"/>\n                            ${jsonData.aiGirlFriendChat.delete}\n                          </div>\n                        </div>\n                      </div>\n                      ${!h(e)&&this.hasAudio?`<div class="audio-button" data-id="${t}">\n                        <div class="audio-play-icon"></div>\n                          <img src="/dist/img/ai-chatting/icon_loading.svg" class="audio-loading-icon"/>\n                        <lottie-player style="display: none" src="/dist/img/ai-chatting/audio-loading.json"\n                          background="transparent" speed="1" loop autoplay>\n                        </lottie-player>\n                        <audio src="" data-path="${s.chat_content.path?"loading":""}"></audio>\n                      </div>`:""}\n                    </div>\n                  </div>\n                  <div class="chat_msg"></div>\n                  `,l.find(a).html(r);const n=l.find(a).find(".chat_msg");if(this.userConfig.streaming&&!i){const t=/(<\/?p[^>]*>)/g,e=o.split(t).filter(Boolean);let a=!1,i=null,s=0;this.isUserScrolling=!1;const r=()=>{this.isUserScrolling||c.scrollTop($(".chatting-container")[0].scrollHeight)},l=(t,e)=>{e<=t.length?setTimeout((()=>{a&&i?i.text(t.substring(0,e)):n.html(`${n.html()}${t.charAt(e-1)}`),r(),l(t,e+1)}),16):h()},h=()=>{if(s<e.length){const o=e[s++];t.test(o)?(a=!a,a&&(i=$(o+"</p>").appendTo(n)),h()):l(o,0)}};h()}else n.html(o)}else{const t=n??s.time_stamp??s.task_timestamp;this.chatMap.set("user"+t,{content:e,timestamp:t,sendUser:"user",page:this.chatPage>-1&&i?this.chatPage:"",audioChunk:[],audioUrl:"",audioPath:s?.chat_content?.path??""});let c=jsonData.aiGirlFriendChat.User;if(getCookie("access_token")){const t=JSON.parse(getCookie("user_info"));c=t.first_name+" "+t.last_name,c=" "===c?t.email.split("@")[0]:c}r=`<div class="chatOperation" data-timestamp='${t}' data-isCheckTime='${i}' data-sender='user'>\n                    <div class="chatName">${c}</div>\n                    <div class="chatTools">\n                      <div class="msgSetting my">\n                        <div class="setting_box">\n                          <div class="setting_copy">\n                            <img src="/dist/img/ai-chatting/icon_copy_black.svg"/>\n                            ${jsonData.aiGirlFriendChat.copy}\n                          </div>\n                          <div class="setting_delete">\n                            <img src="/dist/img/ai-chatting/icon_del.svg"/>\n                            ${jsonData.aiGirlFriendChat.delete}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="chat_msg">\n                  ${o}\n                  </div>\n                  `,l.find(a).html(r)}if(this.setChatLoading(!1),i?c.prepend(l):(c.append(l),".my-message-container"===a&&this.setChatLoading(!0),c.scrollTop(c.prop("scrollHeight"))),this.setRmoveRecords(s),".ai-message-container"===a){const t=l.find(a).find("audio"),e=t.parent(".audio-button");t.length&&(t.on("play",(()=>{e.addClass("active")})),t.on("pause",(()=>{e.removeClass("active")})),t.on("ended",(()=>{e.removeClass("active")})))}function h(t){return/^\*[^*]+\*$/.test(t)}}sendMessage(){gtag("event","click_aigirlfriend_send"),this.clearReplyList();const t=$("#userInputMsg");let e=t.val();if(!e||/^\s*$/.test(e))return!1;e=e.replace(/[(（](.*?)[)）]/g,"*$1*");let a,i=(new Date).getTime(),s={...this.connectMsg,chat_content:e,request_type:20,chat_action:"",UserSendTime:i};this.UserSendTime=s.UserSendTime;try{let t=$("#myMessageBox");this.showMessage(t,e,".my-message-container",!1,{},i),SOCKET?SOCKET.readyState===WebSocket.OPEN?(this.AiHello(),SOCKET.send(JSON.stringify(s))):SOCKET.readyState===WebSocket.CLOSED?(this.disconnectMessage=JSON.stringify(s),this.connectChatting(this.socketUrl)):this.disconnectMessage=JSON.stringify(s):this.disconnectMessage=JSON.stringify(s)}catch(t){console.warn(t),this.disconnectMessage=JSON.stringify(s)}a=window.innerWidth<1200?".88rem":"46px",t.css("height",a),this.lastMessage=JSON.stringify(s),t.val(""),$(".send-btn").addClass("disable")}async saveCharacter(){gtag("event","save_aigirlfriend_changephoto");const t=$("#characterNameInput");function e(t){return t instanceof Blob}t.prop("disabled",!0);let a,i={changeAvatar:"aiAvatarImg",changeBg:"bgImg"},s={changeAvatar:"head_portrait",changeBg:"head_portrait_background"};const n=t.val()+"";let o={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:n.trim(),is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des,scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait_background:this.uploadbg?JSON.stringify(this.aiData.head_portrait_background):"[]"};try{let n;this.changePopup.loading.start();for(let t in this.uploadBlob)e(this.uploadBlob[t])&&(await this.service.getUploadUrl({file_name:`${t}.png`}).then((e=>{a=e.data.upload_url,n=e.data.key,this[i[t]]=e.data.access_url,"bgImg"===i[t]?(this.aiData.head_portrait_background=[],this.aiData.head_portrait_background.push({key:"head_portrait_background",url:e.data.access_url,value:n})):this.aiData.changeAvatarUrl=e.data.access_url})).catch((t=>{$Popup({type:"error",errorType:"network"})})),await this.service.putUploadUrl(a,this.uploadBlob[t]).then((e=>{200===e&&(o[s[t]]=JSON.stringify([{key:s[t],value:n}]))})));if(void 0!==o.head_portrait_background||this.aiData.head_portrait_background[0]?.url||(o.head_portrait_background="[]"),void 0===o.head_portrait&&(o.head_portrait=JSON.stringify(this.aiData.head_portrait)),getUrlVal("avatarKey")){let t=atob(getUrlVal("headAvatar")),e=atob(getUrlVal("avatarKey")),a=JSON.parse(o.head_portrait);a[0].value===t&&(a[0].value=e,a[0].is_temp=1,delete a[0].url,o.head_portrait=JSON.stringify(a))}const r=await this.service.roleEdit(o);if(401===r.code)return void this.closeChat();if(200!==r.code)return $Popup({type:"error",errorType:"normal"}),t.prop("disabled",!1),void this.changePopup.loading.end();this.isChangeData=!0,this.aiData.name=o.name,this.aiData.head_portrait=JSON.parse(o.head_portrait),this.aiData.head_portrait[0].url=this.aiData.changeAvatarUrl,this.aiData.is_my_characters=1,2===this.isMyCharacterStatus&&(this.aiData.toMyCharacter=!0),this.aiData.my_characters_id=r.data.my_characters_id,this.aiData.role_id=r.data.role_id,this.aiData.status=2,"[]"===o.head_portrait_background&&(this.bgImg="",this.aiData.head_portrait_background=[]);let l=$(".chatting-container");l.scrollTop(l.prop("scrollHeight")-l.height()-10),this.changePopup.close(),this.aiData.head_portrait[0].url||(this.aiData.head_portrait[0].url=this.aiAvatarImg),this.updateCharacter(),t.prop("disabled",!1),this.changePopup.loading.end(),this.changePopup=null,this.aiData.name=o.name,this.changeBgAvatar(),await this.updateCharacterFunc(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id)}catch(t){$Popup({type:"error",errorType:"network"}),this.changePopup.loading.end(),this.changePopup=null}finally{this.setSessionData()}}async assemblyAudioChunk(t){const e=this.chatMap.get(t.time_stamp),a="audio/mpeg";if(this.deleteTimeoutAudioQueue(t.time_stamp),e.audioChunk[t.curr_id-1]=function(t,e){const a=atob(t),i=new Array(a.length);for(let t=0;t<a.length;t++)i[t]=a.charCodeAt(t);const s=new Uint8Array(i);return new Blob([s],{type:e})}(t.file_data,a),t.curr_id===t.max_len){const i=$(`[data-id="${t.time_stamp}"]`);let s="",n=null;try{n=new Blob(Array.from(e.audioChunk),{type:a}),s=URL.createObjectURL(n),e.audioUrl=s,i.find("audio").attr("src",s);this.promiseWaitMap.get(t.time_stamp)&&this.deletePromiseWait(t.time_stamp)}catch(t){console.error("assembly audio error",t),e.audioChunk=[],i.removeClass("active loading")}try{await this.saveAudio(e.page,this.connectMsg.chat_id,t.time_stamp,n)}catch(t){console.error("save audio error",t)}}}async saveAudio(t,e,a,i){const s=await this.service.getUploadFileUrl(),n=s.data.upload_url,o=s.data.key;return await this.service.putUploadUrl(n,i),this.service.saveAudio(t,e,a,o)}sendOtherQueue=[];sendOtherMessage(t){const e=JSON.stringify(t);SOCKET?SOCKET.readyState===WebSocket.OPEN?SOCKET.send(e):(this.connectChatting(this.socketUrl),this.sendOtherQueue.push(e)):this.sendOtherQueue.push(e)}getHistoryAudioQueueSet=new Set;async getHistoryAudio(t,e){this.getHistoryAudioQueueSet.add(t);const a=await this.service.getAccessUrl(e),i=a.data.static_url||a.data.url,s=$(`[data-id="${t}"]`).find("audio");s.attr("data-path","loaded"),s.attr("src",i),this.getHistoryAudioQueueSet.delete(t)}timeoutAudioQueueMap=new Map;setTimeoutAudioQueue(t){this.timeoutAudioQueueMap.has(t)&&clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.set(t,setTimeout((()=>{this.timeoutAudioQueueMap.delete(t),this.deletePromiseWait(t),$(`[data-id="${t}"]`).removeClass("loading"),console.error("generate audio timeout, timestamp:",t)}),3e4))}deleteTimeoutAudioQueue(t){this.timeoutAudioQueueMap.has(t)&&(clearTimeout(this.timeoutAudioQueueMap.get(t)),this.timeoutAudioQueueMap.delete(t))}clearTimeoutAudioQueue(){for(let[t,e]of this.timeoutAudioQueueMap)clearTimeout(e);this.timeoutAudioQueueMap.clear()}deletePromiseWait(t){const e=this.promiseWaitMap.get(t);e&&(e.finish(),this.promiseWaitMap.delete(t))}clearPromiseWait(){for(let[t,e]of this.promiseWaitMap)e.finish();this.promiseWaitMap.clear()}lastAudioId=void 0;async toggleAudioBtn(t,e){const a=()=>{const e=$(".audio-button").not(t);e.removeClass("active"),e.find("audio").each(((t,e)=>{""!==$(e).attr("src")&&(e.pause(),e.currentTime=0)}))};a();const i=t.find("audio"),s=i.get(0),n=i.attr("src"),o=i.attr("data-path"),r=t.attr("data-id"),l=this.chatMap.get(r);if(e){if(this.lastAudioId=r,t.hasClass("loading"))return;if(""===n&&""===o){t.addClass("loading");try{if(this.timeoutAudioQueueMap.has(r))return;const e=await this.service.getVoiceLimit();if(200!==e.code)return console.error("getVoiceLimit error:",e),void t.removeClass("loading");const{is_use:n}=e.data;if(1!==n)return gtag("event","limit_aigirlfriend_voice"),this.toggleGFInfoDialog(!0,".ai-gf-audio-limit-dialog"),void t.removeClass("loading");const o=l.content,c={request_type:21,chat_content:o.replace(/\*.*?\*/g,"").trim(),time_stamp:r,chat_id:this.connectMsg.chat_id,token:getCookie("SsToken")};this.sendOtherMessage(c),this.setTimeoutAudioQueue(r);const h=new PromiseWait;return this.promiseWaitMap.set(r,h),await h.wait(),""===i.attr("src")?void t.removeClass("loading"):void(t.hasClass("loading")&&(t.removeClass("loading"),this.lastAudioId===r&&(a(),s.play().catch((e=>{t.removeClass("active"),console.error("audio play error by ws:",e)})))))}catch(e){return console.error("toggleAudioBtn error:",e),void t.removeClass("loading")}finally{this.deletePromiseWait(r)}}if(""===n&&"loading"===o){if(t.addClass("loading"),this.getHistoryAudioQueueSet.has(r))return;return await this.getHistoryAudio(r,l.audioPath),t.removeClass("loading"),void(this.lastAudioId===r&&(a(),s.play().catch((e=>{t.removeClass("active"),console.error("audio play error by history:",e)}))))}n&&s.play().catch((e=>{i.attr("data-path",""),i.attr("src",""),this.toggleAudioBtn(t,!0)}))}else t.removeClass("active"),""!==n&&s.pause()}setLoginTimer(){this.loginTimer&&clearTimeout(this.loginTimer),this.loginTimer=setTimeout((()=>{this.showLoginPopup()}),3e5)}showLoginPopup(t=function(){}){$("#userInputMsg").trigger("blur"),getCookie("access_token")||this.loginPopup?t():(gtag("event","alert_aigirlfriend_loginwin"),this.loginPopup=$Popup({title:gfChattingJsLan.loginTitle,content:gfChattingJsLan.loginContent,closeBtn:gfChattingJsLan.loginBtn,otherBtns:gfChattingJsLan.loginOtherBtn,exist:"chatLoginPopup",addBorderRadius:!0,onClose:()=>{this.loginPopup=null,this.setLoginTimer(),gtag("evet","login_aigirlfriend_loginwin"),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwin"),chatLogin()}})},topCloseFn:()=>{this.setLoginTimer(),gtag("evet","close_aigirlfriend_loginwin"),this.loginPopup=null}}),this.loginPopup.modal.find(".login-popup-close-btn").on("click",(()=>{gtag("evet","notnow_aigirlfriend_loginwin"),this.loginPopup.close(),this.loginPopup=null,this.setLoginTimer(),t()})))}changeBgAvatar(){let t=this;$(".aiAvatarImg").each((function(){$(this).attr("src",t.aiAvatarImg)})),$(".ai-name").each((function(){$(this).text(t.aiData.name)}));let e=new Image;e.onload=function(){t.bgImg||t.aiAvatarImg;t.ratio=this.width/this.height,t.ratio.toFixed(2)>1?t.boxPosition.changeBtnMiddle.chatBgImg.left=0:t.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";const e=$("#chatBgImg");t.ratio.toFixed(2)>1?e.css({width:"100vw",left:"0px"}):e.css({width:"661px",left:t.boxPosition[t.currentPosition||"changeBtnMiddle"].chatBgImg.left}),$(".audio_btn.bg").hasClass("active")?t.changeBackground(!0):t.changeBackground(!1)},e.src=t.bgImg||t.aiAvatarImg}hideShowImgBox(t,e){let a={avatarImgBox:{id:"#avatarText",iconId:"#avatarIcon",imgUrlObj:"uploadAvatar",blob:"changeAvatar",showFn:()=>{gtag("event","upload_aigirlfriend_avatar"),this.uploadAvatarChange=!0,$("#characterNameInput").val().length>0&&this.changePopup.enableCloseBtn()},hideFn:()=>{this.uploadAvatarChange=!1,this.changePopup.disableCloseBtn(),gtag("event","del_aigirlfriend_avatar")}},bgImgBox:{id:"#bgText",iconId:"#bgIcon",imgUrlObj:"uploadBg",blob:"changeBg",showFn:()=>{gtag("event","upload_aigirlfriend_bg"),this.uploadbg=!0},hideFn:()=>{this.uploadbg=!1}}},i="#"+t;({hide:()=>{$(i).hide(),$(a[t].id).text(gfChattingJsLan.changePopBtnSpanSet),$(a[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_small.png"),this[a[t].imgUrlObj]=!1,this.uploadBlob[a[t].blob]={},a[t].hideFn()},show:()=>{$(i).show(),$(a[t].id).text(gfChattingJsLan.changePopBtnSpanAddNew),this[a[t].imgUrlObj]=!0,$(a[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_normal.png"),a[t].showFn()}})[e]()}openChangeHandle(){let t,e=this;this.uploadStatus=!1,this.changePopup=$Popup({title:gfChattingJsLan.changePopTitle,content:`<div class="change-photo-box">\n          <div class="change-avatar-box">\n             <div>${gfChattingJsLan.changePopName}</div>\n             <div class="name-input-box">\n             <input type="text" id="characterNameInput" maxlength="100">\n           </div>\n            <div>${gfChattingJsLan.changePopAvatar}</div>\n            <div class="avatar-box">\n              <div class="avatar-img changeAvatarImg" id="avatarImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeAvatarIcon" class="close-icon" bindId="avatarImgBox" alt="close button" />\n\n                <img src="" alt="" id="changeAvatarImg" class="changeAvatarImg" />\n              </div>\n              <div class="replace-img-btn" id="changeAvatarId" fn="changeAvatar">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="avatarIcon" class="img-icon" />\n                  <div class="change-btn-text" id="avatarTextBox">${gfChattingJsLan.changePopBtn}</div>\n                </div>\n              </div>             \n            </div>\n            \n              <div class="avatar-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="avatarTip">${gfChattingJsLan.changePopSupport}</span>\n              </div>\n\n            <div class="change-bg-title">${gfChattingJsLan.changePopBgDesc}</div>\n            <div class="change-bg-sub">${gfChattingJsLan.changePopRecommend}</div>\n            <div class="avatar-box">\n              <div class="avatar-img" id="bgImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeBgIcon" class="close-icon" bindId="bgImgBox" alt="close icon"/>\n                <img src="" alt="" id="changeBgImg" class="changeBgImg" />\n              </div>\n              <div class="replace-img-btn" id="changeBgId" fn="changeBg">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="bgIcon" class="img-icon" />\n                  <div  class="change-btn-text" id="bgTextBox">${gfChattingJsLan.changePopBgBtn}</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="bg-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png" alt="tip icon">\n                <span class="tip-text" id="bgTip">${gfChattingJsLan.changePopBgSupport}</span>\n           </div>\n\n            <input type="file" name="file" id="fileInput" style="display: none"   accept="image/jpeg, image/png, image/webp">\n          </div>\n        </div>`,closeBtn:gfChattingJsLan.changePopCloseBtn,otherBtns:gfChattingJsLan.changePopOtherBtn,autoClose:!1,topCloseFn:function(){this.uploadBlob={changeAvatar:{},changeBg:{}},this.uploadStatus=!1,gtag("event","close_aigirlfriend_changephoto")},onClose:()=>{this.uploadStatus?this.saveCharacter():this.changePopup.close()},exist:"change"}),$("#changeOtherBtn").off("click").on("click",(()=>{e.uploadBlob={changeAvatar:{},changeBg:{}},gtag("event","discard_aigirlfriend_changephoto"),e.uploadStatus=!1,e.changePopup.close()}));const a=$("#characterNameInput");a.val(this.aiData.name),a.off("input").on("input",(function(){let t=$(this).val(),a=/[/*&\\%$#@]/g;a.test(t)&&$(this).val(t.replace(a,"")),t=$(this).val();let i=t.length;i>50&&($(this).val(t.substring(0,50)),i=50),e.uploadStatus=!0,0===i?e.changePopup.closeButton.disable():e.uploadAvatarChange&&e.changePopup.closeButton.enable()})),this.aiAvatarImg?$("#changeAvatarImg").attr("src",this.aiAvatarImg):e.hideShowImgBox("avatarImgBox","hide");const i=$("#changeBgImg");this.aiData.head_portrait_background.length&&this.bgImg?i.attr("src",this.bgImg):e.hideShowImgBox("bgImgBox","hide"),i.attr("src",this.bgImg),$("#closeAvatarIcon,#closeBgIcon").off("click").on("click",(function(){e.uploadStatus=!0;let t=$(this).attr("bindId");"bgImgBox"===t&&gtag("event","del_aigirlfriend_bg"),e.hideShowImgBox(t,"hide")})),$(".replace-img-btn").off("click").on("click",(function(){t=$(this).attr("fn"),$("#fileInput").trigger("click")})),$("#fileInput").off("change").on("change",(async function(){let a;const i={changeAvatar:{text:"#avatarTip",box:".avatar-tip-box"},changeBg:{text:"#bgTip",box:".bg-tip-box"}},s={changeAvatar:{icon:"#avatarIcon",text:"#avatarTextBox"},changeBg:{icon:"#bgIcon",text:"#bgTextBox"}};let n=s[t].icon,o=s[t].text,r=i[t].box,l=i[t].text;const c={changeAvatar:i=>{const s=new Image;s.onload=function(){const a=this.naturalHeight,s=this.naturalWidth;a<32||s<32?($("#avatarTip").text(gfChattingJsLan.changePopAvatarError),$(".avatar-tip-box").css("visibility","visible")):(e.uploadStatus=!0,$(".changeAvatarImg").attr("src",i),e.hideShowImgBox(h[t],"show"))},s.src=URL.createObjectURL(a),$(r).css("visibility","hidden")},changeBg:i=>{const s=new Image;s.onload=function(){const a=this.naturalHeight,s=this.naturalWidth;a<128||s<128?($("#bgTip").text(gfChattingJsLan.changePopBgError),$(".bg-tip-box").css("visibility","visible")):(e.uploadStatus=!0,e.bgImg=i,$(".changeBgImg").attr("src",e.bgImg),e.hideShowImgBox(h[t],"show"))},s.src=URL.createObjectURL(a),$(r).css("visibility","hidden")}};let h={changeAvatar:"avatarImgBox",changeBg:"bgImgBox"},g=this.files[0];const d=g.name.split(".").pop().toLowerCase();if(!/^(image\/(jpg|jpeg|png|webp))$/.test(g.type)||!/^jpg|jpeg|png|webp$/.test(d))return $(l).text(gfChattingJsLan.changePopSupport),$(r).css("visibility","visible"),$(this).val(null),!1;if(g?.size>104857600)return $(l).text(gfChattingJsLan.changePopMaxError),$(r).css("visibility","visible"),$(this).val(null),!1;$(n).attr("src","/dist/img/ai-chatting/icon_loading.svg"),$(n).addClass("popup-loading"),$(o).html(gfChattingJsLan.changePopUploading);let{blog:p}=await resizeImageByFile(g);if(p){let i=URL.createObjectURL(p);e.uploadBlob[t]=p,a=p,c[t](i)}else $(l).text(gfChattingJsLan.changePopSupport),$(r).css("visibility","visible");$(this).val(null),(()=>{$(n).removeClass("popup-loading"),$(n).attr("src","dist/img/ai-chatting/btn_add_normal.png");let e={changeAvatar:gfChattingJsLan.changePopBtn,changeBg:gfChattingJsLan.changePopBgBtn};$(o).html(e[t])})()}))}async getAiDetails(t,e,a){try{const i=await this.service.getRoleInfo(t,e,a);if(200===i.code)return i.data;$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),console.error("get-role-info",i.data.message)}catch(t){$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}}async getAiInfo(t,e,a){try{const i=await this.getAiDetails(t,e,a);i?this.init(i):$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}catch(t){$Popup({type:"error",errorType:"normal",addBorderRadius:!0})}}async updateCharacterFunc(t,e,a){const i=["chat_id"];try{const s=await this.getAiDetails(t,e,a);for(const t in s)!s.hasOwnProperty(t)||this.aiData[t]&&i.includes(t)||(this.aiData[t]=s[t]);this.updateCharacter()}catch(t){console.error("update character error:",t)}}changeScreen(t){t?("pc"==userModel?($("#changeBtnMiddle").click(),$("#chattingContainer").css("height","80vh")):$("#chattingContainer").css("height","70vh"),$("#editIcon").hide(),$(".chatting-container").addClass("fullscreen")):($("#editIcon").show(),$(".chatting-container").removeClass("fullscreen"),$("#chattingContainer").css("height",this.chatHeight),$("#chattingContainer").scrollTop($("#chattingContainer").prop("scrollHeight")))}changeBackground(t){if(t)$("#AiChat,#chatBgImg").css({"background-image":"none","background-color":"#151820"});else{let t=this.bgImg||this.aiAvatarImg;$("#AiChat,#chatBgImg").css({"background-image":`url("${t}")`,"background-color":"transparent"})}}}function MSK2UTC(t){if(t.includes("UTC"))return new Date(t.replace("UTC","T")+"Z").getTime();{const e=t.includes("T")?t:t.replace(" ","T")+".000";return new Date(e+"+03:00").getTime()}}function escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function t(t,e={}){if(!t)return"";if(0===Object.keys(e).length)return t;for(const a in e)t=t.replace(new RegExp(`{{${a}}}`,"g"),e[a]);return t}function getUrlVal(t){const e=window.location.href;if(!e.includes("?"))return!1;const a=e.split("?")[1].split("&"),i={};return a.forEach((function(t){const e=t.split("="),a=decodeURIComponent(e[0]);i[a]=decodeURIComponent(e[1])})),i[t]}"placeholder"in document.createElement("input")||$("input[placeholder],textarea[placeholder]").each((function(){const t=$(this),e=t.attr("placeholder");""===t.val()&&t.val(e).addClass("placeholder"),t.focus((function(){t.val()===e&&t.val("").removeClass("placeholder")})).blur((function(){""===t.val()&&t.val(e).addClass("placeholder")})).closest("form").submit((function(){t.val()===e&&t.val("")}))}));