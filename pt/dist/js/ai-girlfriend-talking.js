let SOCKET,defaultUserAvatar="/dist/img/ai-chatting/icon_avatar.png";const gfChattingLan=jsonData.aiGirlFriendChat.javascript;class AiGirlfriendTalking{unChangeKeyList=["chat_id"];constructor(){this.boxPosition={changeBtnLeft:{chattingContainer:{height:"64vh"},chattingBox:{left:".8rem",right:"auto"},chatBgImg:{right:"0px",left:"auto"},changePhotoBtn:{right:".8rem",left:"auto"}},changeBtnMiddle:{chattingContainer:{height:"320px"},chattingBox:{left:"calc(50% - 38.54vw / 2)",right:"auto"},chatBgImg:{right:"auto",left:"calc(50% - 661px / 2)"},changePhotoBtn:{right:"auto",left:".8rem"}},changeBtnRight:{chattingContainer:{height:"64vh"},chattingBox:{left:"auto",right:".8rem"},chatBgImg:{right:"auto",left:"0"},changePhotoBtn:{right:"auto",left:".8rem"}}},this.isChat=!1}data(){return{modelDOM:$("#AiChat"),userMessage:$("#userInputMsg").value}}async getChatHistory(){if(this.isSyncingHistroy||!this.chatPage)return;this.isSyncingHistroy=!0;const t=new URLSearchParams;t.append("chat_id",this.connectMsg.chat_id),this.chatPage&&this.chatPage>0&&t.append("page",this.chatPage+"");const a=t.toString();await fetchGet(`chat/user/get-message-info?${a}`).then((t=>{if(200===t.code&&t.data){this.isChat=!0,this.chatPage=t.data.page;const a=t.data.list.filter((t=>!!t.chat_content.content));if(a.length<5&&this.chatPage&&(this.isSyncingHistroy=!1,this.getChatHistory(),0===a.length))return;const i=$(".chatting-container"),e=i.scrollTop(),n=i[0].scrollHeight;i.css("overflow-y","hidden");for(let t of a)if("user"===t.chat_content.role){let a=$("#myMessageBox");this.showMessage(a,t.chat_content.content,".my-message-container",!1,!0)}else{let a=$("#aiMessageBox");this.showMessage(a,t.chat_content.content,".ai-message-container",!0,!0)}if(i.css("overflow-y","auto"),this.initHistory)i.scrollTop(i.prop("scrollHeight"));else{const t=i[0].scrollHeight-n;i.scrollTop(e+t)}this.initHistory=!1}})).finally((()=>{this.isSyncingHistroy=!1}))}getChatData(t=""){let a=this;return new Promise((i=>{let e={chat_id:this.aiData.chat_id,role_id:this.connectMsg.role_id,is_my_characters:this.aiData.is_my_characters,last_server_url:t};1===this.aiData.is_my_characters&&(e.my_characters_id=this.aiData.my_characters_id),fetchPost("chat/user/get-chat-server",e).then((t=>{if(401===t.code)return a.closeChat(),!1;1===t.data.is_old_server_url&&(a.isOldSeverUrl=!0),this.socketUrl=t.data.server_url,this.connectMsg.chat_id=t.data.chat_id,this.aiData.chat_id=t.data.chat_id,this.connectMsg.chat_id_name=t.data.chat_id_name,200===t.code?i(t.data):($Popup({type:"error",errorType:"normal"}),i())}))}))}AiHello(){if(!this.sendHello)return!1;try{clearInterval(this.helloTimer)}catch{}let t={...this.connectMsg,request_type:50,chat_last_sep:3234};this.helloTimer=setInterval((()=>{SOCKET.send(JSON.stringify(t)),this.sendHello=!1,clearInterval(this.helloTimer)}),24e4)}async changeAvatarFn(){let t=getUrlVal("form"),a=this,i=getUrlVal("headAvatar");if(i){let e=atob(getUrlVal("avatarKey")),n=atob(i),s={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:this.aiData.name,is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des??"",scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait:JSON.stringify([{key:"head_portrait",value:e,is_temp:1}]),head_portrait_background:JSON.stringify(this.aiData.head_portrait_background)};if(this.aiData.head_portrait=[{key:"head_portrait",value:n,url:n}],a.aiAvatarImg=n,this.aiData.status=2,this.updateCharacter(),$(".chatting-share").hide(),a.aiData.is_my_characters=1,a.bgImg="",this.changeBgAvatar(),!t)return!1;const o=await fetchPost("chat/user/role-edit",s);200===o.code&&(aiGirlFriend.GetRecentChatting(),this.aiData.toMyCharacter=!0,history.pushState(null,null,`/ai-girlfriend.html?openShare=${getUrlVal("openShare")}&headAvatar=${i}&avatarKey=${btoa(e)}`),this.aiData.my_characters_id=o.data.my_characters_id,this.aiData.role_id=o.data.role_id,this.aiData.is_my_characters=1),401===o.code&&a.closeChat();const r=await this.getAiDetails(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id);for(const t in r)!r.hasOwnProperty(t)||this.aiData[t]&&this.unChangeKeyList.includes(t)||(this.aiData[t]=r[t]);this.updateCharacter()}}mobileInit(){if(window.innerWidth<1200){let t;$("#changePhotoBtn").text("Change Photo"),t=1===this.aiData.is_my_characters?"1.4rem":"1.92rem",$(".change-photo-btn").css({left:"auto",right:t})}}async init(t){gtag("event",`chat_aigirlfriend_${t.role_id}`),this.errorPopup=$Popup({type:"error",errorType:"network"}),this.errorPopup.close(),this.isChat=!1;let a=this;this.socketClose=!1,this.chatPage=-1,this.initHistory=!0,this.isSyncingHistroy=!1,gtag("event","enter_aigirlfriend_chatting"),this.aiData=t,this.aiAvatarImg=t?.head_portrait[0]?.url,this.bgImg=t.head_portrait_background.length>0?t.head_portrait_background[0]?.url:t.head_portrait[0]?.url,this.backImg=`url("${t.head_portrait_background[0]?.url||this.bgImg}")`,this.uploadAvatarChange=!0,this.uploadbg=t.head_portrait_background[0]?.url||!1,getCookie("user_info")&&(this.userData=JSON.parse(getCookie("user_info"))),this.userAvatarImg=this.userData?.head_portrait||defaultUserAvatar,this.connectMsg={user_id:"0"|this.userData?.id,role_id:t.role_id+"",role_name:t.name,chat_id_name:"",chat_id:"",token:getCookie("SsToken")},this.connectMsg.user_id=this.connectMsg.user_id+"",this.uploadBlob={changeAvatar:{},changeBg:{}},this.sendHello=!0,this.uploadStatus=!1,$(".chatting-container").empty();let i="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(i=localStorage.getItem("chattingPosition")),this.changePosition(i),this.mobileInit(),this.data().modelDOM.fadeIn(),$("body").css({overflow:"hidden",position:"fixed"}),this.loginTimer=setInterval((()=>{this.showLoginPopup()}),3e5),$(".hidden-box #aiAvatarImg").attr("src",this.aiAvatarImg),$("#myAvatarImg").attr("src",this.userAvatarImg),$(".chat-bg-img, .ai-chat-box").css("background-image",this.backImg);let e=new Image;e.onload=function(){a.ratio=this.width/this.height,a.ratio.toFixed(2)>1?a.boxPosition.changeBtnMiddle.chatBgImg.left=0:a.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";let t="changeBtnMiddle";localStorage.getItem("user_info")&&localStorage.getItem("chattingPosition")&&(t=localStorage.getItem("chattingPosition"));const i=$("#chatBgImg");a.ratio.toFixed(2)>1?i.css({width:"100vw",left:"0px"}):i.css({width:"661px",left:a.boxPosition[t].chatBgImg.left})},e.src=this.bgImg,this.updateCharacter();let n=await this.getAiDetails(t.role_id,t.is_my_characters,t.my_characters_id);for(const t in n)!n.hasOwnProperty(t)||this.aiData[t]&&this.unChangeKeyList.includes(t)||(this.aiData[t]=n[t]);this.updateCharacter(),1===n.is_like?($(".no-like-icon").hide(),$(".like-icon").show()):($(".no-like-icon").show(),$(".like-icon").hide());let s=await this.getChatData();await this.changeAvatarFn(),this.getChatHistory(),this.isMyCharacterStatus=this.aiData.is_my_characters,this.aiData.toMyCharacter=!1,this.connectChatting(s.server_url),this.AiHello()}updateCharacter(){$(".chatting-count").text(formatNumber(this.aiData.msg_num)),$(".ai-chat-gf-avatar, .ai-gf-info-dialog-avatar").attr("src",this.aiAvatarImg),$(".ai-gf-info-dialog-birthday").text(this.aiData.json.Created),$(".ai-gf-info-dialog-desc").text(this.aiData.json.Character_des),$(".ai-chat-gf-name, .ai-gf-info-dialog-name").text(this.aiData.name),this.toggleShareBtn(1===this.aiData.status&&1===this.aiData.type);const t=this.aiData.json.tag.split(",").filter((t=>""!==t)).map((t=>`<div class="ai-gf-info-dialog-tag">${t}</div>`));$(".ai-gf-info-dialog-tags").html(t.join(""))}bindEvent(){let t=this;$("#userInputMsg").off("input").on("input",(function(){let t=$(this).val().length;window.innerWidth>1200?this.style.height=this.scrollHeight+"px":this.style.height=this.scrollHeight/100+.5+"rem",(0===t||t<37)&&(window.innerWidth>1200?this.style.height="46px":this.style.height=".88rem");const a=$(".send-btn");0===t||/^\s*$/.test($(this).val())?a.addClass("disable"):a.removeClass("disable")})),$("#backIcon, #closeIcon").off("click").on("click",(function(){"backIcon"===$(this).attr("id")?gtag("event","back_aigirlfriend_chatting"):gtag("event","close_aigirlfriend_chatting"),t.closeChat("click")})),$("#sendMsg").off("click").on("click",(()=>{this.sendMessage(),$("#userInputMsg").trigger("focus")})),$(".ai-chat-box textarea").off("keydown").on("keydown",(t=>{"Enter"===t.key&&(t.preventDefault(),this.sendMessage())})),$("#editIcon").off("click").on("click",(()=>{$(".change-position-box").toggle()})),$(document).on("click",(function(a){const i=$(a.target);i.closest("#editIcon").length||i.closest(".change-position-box").length||$(".change-position-box").hide(),i.closest(".right-button-box-m-dropdown").length||i.closest(".right-button-box-m-dropdown-menu").length||t.toggleGFDropdown(!1)})),$(".change-btns-box .change-btn").off("click").on("click",(function(){let a=$(this).attr("id");gtag("event",{changeBtnLeft:"left_aigirlfriend_pos",changeBtnMiddle:"mid_aigirlfriend_pos",changeBtnRight:"right_aigirlfriend_pos"}[a]),t.changePosition(a),$(".change-position-box").hide()})),$("#changePhotoBtn").off("click").on("click",(()=>{gtag("event","click_aigirlfriend_changephoto"),this.openChangeHandle()})),$(".chatting-like").off("click").on("click",(function(){aiGirlFriend.changeLike(t.aiData.role_id),$(".no-like-icon").toggle(),$(".like-icon").toggle(),$(this).closest(".ai-gf-info-dialog").length>0?gtag("event","like_aigirlfriend_view"):"like-icon"===$(this).find('img[style="display: block;"]').attr("class")&&gtag("event","like_aigirlfriend_chatting"),1===t.aiData.is_like?t.aiData.is_like=2:t.aiData.is_like=1})),$(".discord-box").off("click").on("click",(()=>{gtag("event","discord_aigirlfriend_chatting")})),$(".chatting-share").off("click").on("click",(t=>{$(t.target).closest(".ai-gf-info-dialog").length>0?gtag("event","share_aigirlfriend_view"):gtag("event","share_aigirlfriend_chatting"),aiGirlFriend.showShare(this.aiData.role_id,this.aiData.head_portrait[0].value)})),$(".ai-chat-gf-view").off("click").on("click",(()=>{this.toggleGFInfoDialog(!0)})),$(".ai-gf-info-dialog-close, .ai-gf-info-dialog-bg").off("click").on("click",(()=>{this.toggleGFInfoDialog(!1)})),$(".right-button-box-m-dropdown").off("click").on("click",(()=>{const t=$(".right-button-box-m-dropdown-menu").is(":visible");this.toggleGFDropdown(!t)})),$("#chattingContainer").off("scroll").on("scroll",(function(){0===$(this).scrollTop()&&t.getChatHistory()}))}changePosition(t){this.currentPosition=t,getCookie("user_info")?localStorage.setItem("chattingPosition",t):localStorage.removeItem("chattingPosition"),$("#"+t).addClass("change-active").siblings().removeClass("change-active");let a=this.boxPosition;for(let i in a[t]){let e=`#${i}`;for(let n in a[t][i])$(e).css(n,a[t][i][n])}let i=$(".chatting-container");i.scrollTop(i.prop("scrollHeight"))}isMobile(){return window.innerWidth<1200}toggleGFInfoDialog(t){const a=$(".ai-gf-info-dialog-wrap");this.isMobile()?t?a.show(0,(()=>a.addClass("active"))):a.removeClass("active").hide():t?a.fadeIn(160):a.fadeOut(160),t&&gtag("event","show_aigirlfriend_view")}toggleGFDropdown(t){const a=$(".right-button-box-m-dropdown-menu");this.isMobile()?t?a.slideDown(160):a.slideUp(160):t?a.fadeIn(160):a.fadeOut(160)}toggleShareBtn(t){const a=$(".chatting-share");t?a.show():a.hide()}async closeChat(t){let a=async()=>{this.toggleGFInfoDialog(!1),$(".change-position-box").hide(),$("body").css({"overflow-y":"auto",position:"static"}),history.pushState(null,null,"/ai-girlfriend.html"),clearInterval(this.loginTimer),clearInterval(this.heartTimer),clearInterval(this.helloTimer),clearInterval(this.disconnectTimer);const t=$("#userInputMsg");t.val(""),window.innerWidth>1200?t.css("height","46px"):t.css("height",".88rem"),$(".chatting-container").empty(),$("div.modal").remove(),this.data().modelDOM.fadeOut(),this.socketClose=!0,SOCKET?.close(),this.isChat&&aiGirlFriend.addRecentChatting(this.aiData),await aiGirlFriend.initCharacters(),aiGirlFriend.GetMyCharacters()};t?this.showLoginPopup((async()=>{a()})):a()}lastMessage=null;connectChatting(t){if(this.socketClose)return!1;let a=this;SOCKET=new WebSocket(t);let i={...this.connectMsg,chat_last_sep:3234,request_type:this.isOldSeverUrl?11:10,chat_action:""};this.isOldSeverUrl=!1;let e={...this.connectMsg,request_type:40};this.heartTimer=setInterval((()=>{SOCKET.readyState===WebSocket.OPEN&&SOCKET.send(JSON.stringify(e))}),4e4),SOCKET.onopen=()=>{this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5),SOCKET.send(JSON.stringify(i)),this.disconnectMessage&&setTimeout((()=>{SOCKET.send(this.disconnectMessage),this.disconnectMessage=""}),1e3)},SOCKET.onmessage=async i=>{if(this.wssResponse=JSON.parse(i.data),this.wssResponse.next_time||(clearTimeout(this.disconnectTimer),this.disconnectTimer=setTimeout((()=>{SOCKET.close()}),3e5)),300===this.wssResponse.status){SOCKET.close(),this.disconnectMessage=this.lastMessage;let i=await a.getChatData(t);return a.connectChatting(i?.server_url),!1}if(6001===this.wssResponse.status)return gtag("event","already_aigirlfriend_win"),a.closeChat(),!1;let e=JSON.parse(i.data)?.chat_content,n=$("#aiMessageBox");this.showMessage(n,e,".ai-message-container")},SOCKET.onerror=async function(t){console.error(t,"error")},SOCKET.onclose=async function(i){if(!i.wasClean){let i=await a.getChatData(t);a.connectChatting(i?.server_url)}}}showMessage(t,a,i,e,n){if(!a)return;let s=t.clone().removeAttr("id");a=/^\*[^*]+\*$/.test(a)?a.replace(/\*(.*?)\*/g,'<p style="margin:0">($1)</p>'):a.replace(/\*(.*?)\*/g,"<p>($1)</p>"),".ai-message-container"===i&&(a=`<div class="ai-name">${this.aiData.name}</div>`+a),s.find(i).html(a);let o=$(".chatting-container");if(n?o.prepend(s):(o.append(s),o.scrollTop(o.prop("scrollHeight"))),".ai-message-container"===i&&!e){s.find(i).html('<div class="chatting-loading"></div>');let t=0;const e=setInterval((()=>{$(".chatting-loading").css("background-position-x",t+"px"),t+=8}),200);setTimeout((()=>{s.find(i).html(a),o.scrollTop(o.prop("scrollHeight")),clearInterval(e),t=0}),800)}}sendMessage(){gtag("event","click_aigirlfriend_send"),this.AiHello();const t=$("#userInputMsg");let a=t.val();if(!a||/^\s*$/.test(a))return!1;a=a.replace(/[(（](.*?)[)）]/g,"*$1*");let i,e={...this.connectMsg,chat_content:a,request_type:20,chat_action:""};try{let t=$("#myMessageBox");this.showMessage(t,a,".my-message-container"),SOCKET.readyState===WebSocket.OPEN?SOCKET.send(JSON.stringify(e)):SOCKET.readyState===WebSocket.CLOSED?(this.disconnectMessage=JSON.stringify(e),this.connectChatting(this.socketUrl)):this.disconnectMessage=JSON.stringify(e)}catch(t){console.warn(t),this.disconnectMessage=JSON.stringify(e)}i=window.innerWidth<1200?".88rem":"46px",t.css("height",i),this.lastMessage=JSON.stringify(e),t.val(""),$(".send-btn").addClass("disable")}async saveCharacter(){gtag("event","save_aigirlfriend_changephoto");const t=$("#characterNameInput");function a(t){return t instanceof Blob}t.prop("disabled",!0);let i,e={changeAvatar:"aiAvatarImg",changeBg:"bgImg"},n={changeAvatar:"head_portrait",changeBg:"head_portrait_background"};const s=t.val()+"";let o={role_id:this.aiData.role_id,my_characters_id:1===this.aiData.is_my_characters?this.aiData.my_characters_id:0,name:s.trim(),is_draft:2,tag:this.aiData.json.tag??"",persona:this.aiData.persona??"",gender:this.aiData.json.gender??"",description:this.aiData.json.Character_des,scene:this.aiData.role_content["scene description"],greeting:this.aiData.role_content.greeting,context:this.aiData.role_content.context,chat_id:this.connectMsg.chat_id,head_portrait_background:this.uploadbg?JSON.stringify(this.aiData.head_portrait_background):"[]"};try{let t;this.changePopup.loading.start();for(let s in this.uploadBlob)a(this.uploadBlob[s])&&(await fetchPost("ai/source/get-upload-url",{file_name:`${s}.png`}).then((a=>{i=a.data.upload_url,t=a.data.key,this[e[s]]=a.data.access_url,"bgImg"===e[s]?(this.aiData.head_portrait_background=[],this.aiData.head_portrait_background.push({key:"head_portrait_background",url:a.data.access_url,value:t})):this.aiData.changeAvatarUrl=a.data.access_url})).catch((t=>{$Popup({type:"error",errorType:"network"})})),await fetchPut(i,this.uploadBlob[s]).then((a=>{200===a&&(o[n[s]]=JSON.stringify([{key:n[s],value:t}]))})));if(void 0!==o.head_portrait_background||this.aiData.head_portrait_background[0]?.url||(o.head_portrait_background="[]"),void 0===o.head_portrait&&(o.head_portrait=JSON.stringify(this.aiData.head_portrait)),getUrlVal("avatarKey")){let t=atob(getUrlVal("headAvatar")),a=atob(getUrlVal("avatarKey")),i=JSON.parse(o.head_portrait);i[0].value===t&&(i[0].value=a,i[0].is_temp=1,delete i[0].url,o.head_portrait=JSON.stringify(i))}const s=await fetchPost("chat/user/role-edit",o);if(401===s.code)return void this.closeChat();if(200!==s.code)return $Popup({type:"error",errorType:"normal"}),setTimeout((()=>{$(".error").find("button").text("OK")}),10),$("#characterNameInput").prop("disabled",!1),void this.changePopup.loading.end();this.aiData.name=o.name,this.aiData.head_portrait=JSON.parse(o.head_portrait),this.aiData.head_portrait[0].url=this.aiData.changeAvatarUrl,this.aiData.is_my_characters=1,2===this.isMyCharacterStatus&&(this.aiData.toMyCharacter=!0),this.aiData.my_characters_id=s.data.my_characters_id,this.aiData.role_id=s.data.role_id,this.aiData.status=2,"[]"===o.head_portrait_background&&(this.bgImg="",this.aiData.head_portrait_background=[]);let r=$(".chatting-container");r.scrollTop(r.prop("scrollHeight")-r.height()-10),this.changePopup.close(),this.aiData.head_portrait[0].url||(this.aiData.head_portrait[0].url=this.aiAvatarImg),this.updateCharacter(),$("#characterNameInput").prop("disabled",!1),this.changePopup.loading.end(),this.aiData.name=o.name,this.changeBgAvatar();const c=await this.getAiDetails(this.aiData.role_id,this.aiData.is_my_characters,this.aiData.my_characters_id);for(const t in c)!c.hasOwnProperty(t)||this.aiData[t]&&this.unChangeKeyList.includes(t)||(this.aiData[t]=c[t]);this.updateCharacter()}catch(t){this.errorPopup.show(),setTimeout((()=>{$(".error .closeModal").text("OK")}),10),$(".error .closeModal").off("click").on("click",(()=>{this.errorPopup.close()})),$(".error .title-right").off("click").on("click",(()=>{this.errorPopup.close()})),this.changePopup.loading.end()}}loginPopup=null;showLoginPopup(t=function(){}){if(this.loginPopup)return!1;if($("#userInputMsg").trigger("blur"),getCookie("access_token"))t();else{gtag("event","alert_aigirlfriend_loginwin"),this.loginPopup=$Popup({title:gfChattingLan.loginTitle,content:gfChattingLan.loginContent,closeBtn:gfChattingLan.loginBtn,otherBtns:gfChattingLan.loginOtherBtn,exist:gfChattingLan.loginExist,addBorderRadius:!0,onClose:()=>{this.loginPopup=null,gtag("evet","login_aigirlfriend_loginwin"),showLoginWindow({fn:()=>{gtag("evet","succ_aigirlfriend_loginwin"),chatLogin()}})}});const a=this;$(".login-popup-close-btn,.title-right").off("click").on("click",(function(){"title-right"===$(this).attr("class")?gtag("evet","close_aigirlfriend_loginwin"):gtag("evet","notnow_aigirlfriend_loginwin"),a.loginPopup.close(),a.loginPopup=null,"login-popup-close-btn"===$(this).attr("class")&&t()}))}}changeBgAvatar(){let t=this;$(".aiAvatarImg").each((function(){$(this).attr("src",t.aiAvatarImg)})),$(".ai-name").each((function(){$(this).text(t.aiData.name)}));let a=new Image;a.onload=function(){let a=t.bgImg||t.aiAvatarImg;t.ratio=this.width/this.height,t.ratio.toFixed(2)>1?t.boxPosition.changeBtnMiddle.chatBgImg.left=0:t.boxPosition.changeBtnMiddle.chatBgImg.left="calc(50% - 661px / 2)";const i=$("#chatBgImg");t.ratio.toFixed(2)>1?i.css({width:"100vw",left:"0px"}):i.css({width:"661px",left:t.boxPosition[t.currentPosition||"changeBtnMiddle"].chatBgImg.left}),$(".chat-bg-img, .ai-chat-box").css("background-image",`url("${a}")`)},a.src=this.bgImg||t.aiAvatarImg}hideShowImgBox(t,a){let i={avatarImgBox:{id:"#avatarText",iconId:"#avatarIcon",imgUrlObj:"uploadAvatar",blob:"changeAvatar",showFn:()=>{gtag("event","upload_aigirlfriend_avatar"),this.uploadAvatarChange=!0,$("#characterNameInput").val().length>0&&this.changePopup.enableCloseBtn()},hideFn:()=>{this.uploadAvatarChange=!1,this.changePopup.disableCloseBtn(),gtag("event","del_aigirlfriend_avatar")}},bgImgBox:{id:"#bgText",iconId:"#bgIcon",imgUrlObj:"uploadBg",blob:"changeBg",showFn:()=>{gtag("event","upload_aigirlfriend_bg"),this.uploadbg=!0},hideFn:()=>{this.uploadbg=!1}}},e="#"+t;({hide:()=>{$(e).hide(),$(i[t].id).text(gfChattingLan.changePopBtnSpanSet),$(i[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_small.png"),this[i[t].imgUrlObj]=!1,this.uploadBlob[i[t].blob]={},i[t].hideFn()},show:()=>{$(e).show(),$(i[t].id).text(gfChattingLan.changePopBtnSpanAddNew),this[i[t].imgUrlObj]=!0,$(i[t].iconId).attr("src","/dist/img/ai-chatting/btn_add_normal.png"),i[t].showFn()}})[a]()}openChangeHandle(){let t,a=this;this.uploadStatus=!1,this.changePopup=$Popup({title:gfChattingLan.changePopTitle,content:`<div class="change-photo-box">\n          <div class="change-avatar-box">\n             <div>${gfChattingLan.changePopName}</div>\n             <div class="name-input-box">\n             <input type="text" id="characterNameInput" maxlength="100">\n           </div>\n            <div>${gfChattingLan.changePopAvatar}</div>\n            <div class="avatar-box">\n              <div class="avatar-img changeAvatarImg" id="avatarImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeAvatarIcon" class="close-icon" bindId="avatarImgBox"/>\n\n                <img src="" alt="" id="changeAvatarImg" class="changeAvatarImg" />\n              </div>\n              <div class="replace-img-btn" id="changeAvatarId" fn="changeAvatar">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="avatarIcon" class="img-icon" />\n                  <div class="change-btn-text" id="avatarTextBox">${gfChattingLan.changePopBtn}</div>\n                </div>\n              </div>             \n            </div>\n            \n              <div class="avatar-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png">\n                <span class="tip-text" id="avatarTip">${gfChattingLan.changePopSupport}</span>\n              </div>\n\n            <div class="change-bg-title">${gfChattingLan.changePopBgDesc}</div>\n            <div class="change-bg-sub">${gfChattingLan.changePopRecommend}</div>\n            <div class="avatar-box">\n              <div class="avatar-img" id="bgImgBox">\n                <img src="/dist/img/ai-chatting/btn_close_small.png" id="closeBgIcon" class="close-icon" bindId="bgImgBox"/>\n                <img src="" alt="" id="changeBgImg" class="changeBgImg" />\n              </div>\n              <div class="replace-img-btn" id="changeBgId" fn="changeBg">\n                <div class="replace-btm-container">\n                  <img src="dist/img/ai-chatting/btn_add_normal.png" alt="" id="bgIcon" class="img-icon" />\n                  <div  class="change-btn-text" id="bgTextBox">${gfChattingLan.changePopBgBtn}</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="bg-tip-box">\n                <img src="/dist/img/ai-chatting/icon_tip.png">\n                <span class="tip-text" id="bgTip">${gfChattingLan.changePopBgSupport}</span>\n           </div>\n\n            <input type="file" name="file" id="fileInput" style="display: none"   accept="image/jpeg, image/png, image/webp">\n          </div>\n        </div>`,closeBtn:gfChattingLan.changePopCloseBtn,otherBtns:gfChattingLan.changePopOtherBtn,autoClose:!1,topCloseFn:function(){this.uploadBlob={changeAvatar:{},changeBg:{}},a.uploadStatus=!1,gtag("event","close_aigirlfriend_changephoto")},onClose:()=>{this.uploadStatus?this.saveCharacter():this.changePopup.close()},exist:"change"}),$("#changeOtherBtn").off("click").on("click",(()=>{this.uploadBlob={changeAvatar:{},changeBg:{}},gtag("event","discard_aigirlfriend_changephoto"),a.uploadStatus=!1,this.changePopup.close()})),$("#characterNameInput").val(this.aiData.name),$("#characterNameInput").off("input").on("input",(function(){let t=$(this).val(),i=/[/*&\\%$#@]/g;i.test(t)&&$(this).val(t.replace(i,"")),t=$(this).val();let e=t.length;e>50&&($(this).val(t.substring(0,50)),e=50),a.uploadStatus=!0,0===e?a.changePopup.closeButton.disable():a.uploadAvatarChange&&a.changePopup.closeButton.enable()})),this.aiAvatarImg?$("#changeAvatarImg").attr("src",this.aiAvatarImg):a.hideShowImgBox("avatarImgBox","hide");const i=$("#changeBgImg");this.aiData.head_portrait_background.length&&this.bgImg?i.attr("src",this.bgImg):a.hideShowImgBox("bgImgBox","hide"),i.attr("src",this.bgImg),$("#closeAvatarIcon,#closeBgIcon").off("click").on("click",(function(){a.uploadStatus=!0;let t=$(this).attr("bindId");"bgImgBox"===t&&gtag("event","del_aigirlfriend_bg"),a.hideShowImgBox(t,"hide")})),$(".replace-img-btn").off("click").on("click",(function(){t=$(this).attr("fn"),$("#fileInput").trigger("click")})),$("#fileInput").off("change").on("change",(async function(){let i;const e={changeAvatar:{text:"#avatarTip",box:".avatar-tip-box"},changeBg:{text:"#bgTip",box:".bg-tip-box"}},n={changeAvatar:{icon:"#avatarIcon",text:"#avatarTextBox"},changeBg:{icon:"#bgIcon",text:"#bgTextBox"}};let s=n[t].icon,o=n[t].text,r=e[t].box,c=e[t].text;const h={changeAvatar:e=>{const n=new Image;n.onload=function(){const i=this.naturalHeight,n=this.naturalWidth;i<32||n<32?($("#avatarTip").text(gfChattingLan.changePopAvatarError),$(".avatar-tip-box").css("visibility","visible")):(a.uploadStatus=!0,$(".changeAvatarImg").attr("src",e),a.hideShowImgBox(g[t],"show"))},n.src=URL.createObjectURL(i),$(r).css("visibility","hidden")},changeBg:e=>{const n=new Image;n.onload=function(){const i=this.naturalHeight,n=this.naturalWidth;i<128||n<128?($("#bgTip").text(gfChattingLan.changePopBgError),$(".bg-tip-box").css("visibility","visible")):(a.uploadStatus=!0,a.bgImg=e,$(".changeBgImg").attr("src",a.bgImg),a.hideShowImgBox(g[t],"show"))},n.src=URL.createObjectURL(i),$(r).css("visibility","hidden")}};let g={changeAvatar:"avatarImgBox",changeBg:"bgImgBox"},l=this.files[0];const d=l.name.split(".").pop().toLowerCase();if(!/^(image\/(jpg|jpeg|png|webp))$/.test(l.type)||!/^jpg|jpeg|png|webp$/.test(d))return $(c).text(gfChattingLan.changePopSupport),$(r).css("visibility","visible"),$(this).val(null),!1;if(l?.size>104857600)return $(c).text(gfChattingLan.changePopMaxError),$(r).css("visibility","visible"),$(this).val(null),!1;$(s).attr("src","/dist/img/ai-chatting/icon_loading.svg"),$(s).addClass("popup-loading"),$(o).html(gfChattingLan.changePopUploading);let{blog:p}=await resizeImageByFile(l);if(p){let e=URL.createObjectURL(p);a.uploadBlob[t]=p,i=p,h[t](e)}else $(c).text(gfChattingLan.changePopSupport),$(r).css("visibility","visible");$(this).val(null),(()=>{$(s).removeClass("popup-loading"),$(s).attr("src","dist/img/ai-chatting/btn_add_normal.png");let a={changeAvatar:gfChattingLan.changePopBtn,changeBg:gfChattingLan.changePopBgBtn};$(o).html(a[t])})()}))}async getAiInfo(t,a,i){return new Promise((async(e,n)=>{let s=`chat/user/get-role-info?id=${t}&is_my_characters=${a}`;1===a&&(s+=`&my_characters_id=${i}`),await fetchGet(s).then((t=>{200===t.code?this.init(t.data):$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),200!==t.code&&console.error(t.data.message,"get-role-info"),e()}))}))}getAiDetails(t,a,i){return new Promise((async(e,n)=>{let s=`chat/user/get-role-info?id=${t}&is_my_characters=${a}`;1===a&&(s+=`&my_characters_id=${i}`),await fetchGet(s).then((t=>{200===t.code?e(t.data):$Popup({type:"error",errorType:"normal",addBorderRadius:!0}),200!==t.code&&console.error(t.data.message,"get-role-info")}))}))}}function formatTimestamp(t){return`Created ${new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}`}function getUrlVal(t){const a=window.location.href;if(!a.includes("?"))return!1;const i=a.split("?")[1].split("&"),e={};return i.forEach((function(t){const a=t.split("="),i=decodeURIComponent(a[0]);e[i]=decodeURIComponent(a[1])})),e[t]}"placeholder"in document.createElement("input")||$("input[placeholder],textarea[placeholder]").each((function(){var t=$(this),a=t.attr("placeholder");""===t.val()&&t.val(a).addClass("placeholder"),t.focus((function(){t.val()===a&&t.val("").removeClass("placeholder")})).blur((function(){""===t.val()&&t.val(a).addClass("placeholder")})).closest("form").submit((function(){t.val()===a&&t.val("")}))})),$((function(){}));