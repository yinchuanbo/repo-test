function setTextContentObj(e,t={}){let i=lan.faceSwapPop[e];for(let e in t){const o=new RegExp(`{{${e}}}`,"g");i=i.replace(o,t[e])}return i}let show_priority=0,actTab="tab_photo";var videoPhotoDownloadData=null,video_task_id=null;let isFaceswapinitVideo=!1;class UploadVideo{constructor(e,t){const i=this;this.element=e,this.videoSrc="",this.videoCoverImgSrc="",this.uploadFile=null,this.submit=t,this.data={loading:!1},this.demo_key="",this.demo_coverImg="",this.videoDuration=0,this.videoLoading=!0,this.videoData=new Proxy(this.data,{set:(e,t,o)=>(e[t]=o,"loading"===t&&(o?($("#video_Face_swapper_container .change_video_btn").addClass("disabled"),i.element.find(".stepBox").addClass("loading"),i.element.find(".step_loadingBox").css("display","flex"),console.log("that.submit.submitData.isVideoSubmit",i.submit.submitData.isVideoSubmit),i.submit.submitData.isVideoSubmit||$("#video_Face_swapper_container .spread_box_container").addClass("uploading")):(i.element.find(".stepBox").removeClass("loading").find(".step_V").addClass("active"),i.element.find(".step_loadingBox").hide(),i.element.find(".btn_changer").show(),i.element.find(".icon_video").show(),$("#video_Face_swapper_container .spread_box_container").removeClass("uploading"),null!==i.uploadFile&&i.submit.isSubmit())),!0),get:(e,t)=>e[t]})}initFace(){let e=$(".video_upload_input_step1");this.element.find(".stepBox").on("dragover",(e=>{e.preventDefault(),e.stopPropagation(),this.showDropMask(!0),this.submit.imgContainer.showDropMask(!1)})),this.element.find(".uploader_loading_mask").on("dragleave",(e=>{e.preventDefault(),e.stopPropagation(),this.showDropMask(!1)})),this.element.find(".uploader_loading_mask").on("drop",(e=>{e.preventDefault(),e.stopPropagation(),this.showDropMask(!1),this.submit.imgContainer.showDropMask(!1);let t=e.originalEvent.dataTransfer.files[0];gtag("event","up_faceswap_videostep1"),this.uploadFileRule(t)})),this.element.find(".step_V").on("click",(()=>{gtag("event","up_faceswap_videostep1"),e.click()})),$("#video_Face_swapper_container .stepA .btn_changer").on("click",(()=>{gtag("event","up_faceswap_videostep1"),e.click()})),e.on("change",(()=>{let t=e[0].files[0];this.uploadFileRule(t),setTimeout((()=>{e[0].value=""}),500)}))}showDropMask(e){this.loading||(e?this.element.find(".uploader_loading_mask").show():this.element.find(".uploader_loading_mask").hide())}showUploading(e){console.log("showUploading",e),this.videoData.loading=e}uploadFileRule(e,t){if(this.loading)return;t?.demo_key?(this.demo_coverImg=t.demo_coverImg,this.demo_key=t.demo_key):(this.demo_key="",this.demo_coverImg="");const i=1048576*userRuleConfig.limit;if(e){console.log(e,"file");const t=e.name.split(".").pop().toLowerCase(),o=["m4v","mp4","mov","webm","gif"],a=["video/mp4","video/quicktime","video/webm","image/gif"];this.submit.videoRandom=!1,o.includes(t)||a.includes(e.type)?e.size>i?showMaximumFileSizeV():"image/gif"===e.type?this.uploadGifFile(e):this.uploadVideoRule(e):(this.value="",ToolTip({type:"error",title:textContentObj.Failed,content:setTextContentObj("support_formats_v"),btn:textContentObj.ok}))}}async uploadGifFile(e){const t=this;this.showUploading(!0),this.submit.videoDemo.domeLoadDisabled(!0);const i=new FileReader;i.onload=function(e){setTimeout((()=>{t.videoDuration=userRuleConfig.duration,t.submit.uploadType="gif",t.submit.PreviewVideoTool.setVideoOrGifSrc("gif",e.target.result),$("#video_Face_swapper_container .step_V")[0].src=e.target.result,$(".video_img").addClass("active"),t.showUploading(!1),t.submit.videoDemo.domeLoadDisabled(!1),t.submit.videoDemo.setCheckedDemo("video"),t.submit.PreviewVideoTool.showVideoControls(!1)}),1e3)},i.readAsDataURL(e),this.uploadFile=e}async uploadVideoRule(e){console.log(e);const t=await createObjectURLFun(e);console.log(t);const i=document.getElementById("getLoadedDom_video");i.src=t;const o=this;this.showUploading(!0),this.submit.videoDemo.domeLoadDisabled(!0),i.addEventListener("loadedmetadata",(()=>{const a=i.duration;userRuleConfig.duration,setTimeout((()=>{o.uploadFile=e,o.videoDuration=a,o.setVideoFileSrc(t),o.submit.videoDemo.setCheckedDemo("video"),o.showUploading(!1),o.submit.videoDemo.domeLoadDisabled(!1)}),1e3)}),{once:!0})}setVideoFileSrc(e){const t=this;return new Promise((async(i,o)=>{t.submit.uploadType="video";let a=await t.submit.PreviewVideoTool.setVideoOrGifSrc("video",e);URL.revokeObjectURL(t.videoSrc),t.videoSrc=e,t.videoCoverImgSrc=a,t.element.find(".step_V")[0].src=a,t.element.find(".video_img").addClass("active"),t.submit.PreviewVideoTool.showVideoControls(!1),i()}))}async getConsumeCredit(e){let t=e/(userRuleConfig.duration||10),i=5*Math.ceil(t);if(getCookie("access_token"))if(userRuleConfig.credit)this.submit.showBtnCredits(!0,i);else{200===(await fetchPost("ai/tool/can-face",{action:"video_face_changing",duration:e},TOOL_API)).code?this.submit.showBtnCredits(!1,i):this.submit.showBtnCredits(!0,i)}else this.submit.showBtnCredits(!1,i),e>userRuleConfig.duration+1||this.submit.videoDemo.showMoreVideoDuration(!1)}}class UploadImage{constructor(e,t){const i=this;this.element=e,this.imageSrc="",this.uploadFile=null,this.data={loading:!1},this.submit=t,this.imageLoading=!0,this.photoData=new Proxy(this.data,{set:(e,t,o)=>(e[t]=o,"loading"===t&&(o?($("#video_Face_swapper_container .change_video_btn").addClass("disabled"),i.element.find(".stepBox").addClass("loading"),i.element.find(".step_loadingBox").css("display","flex")):(i.element.find(".step_loadingBox").hide(),i.element.find(".stepBox").removeClass("loading"),null!==i.uploadFile&&($("#video_Face_swapper_container .faceSwapProgress").text(textContentObj.Loading),i.element.find(".stepBox").find(".step_P").addClass("active"),i.element.find(".btn_changer").show(),i.element.find(".step_P")[0].src=i.imageSrc,i.submit.isSubmit()))),!0),get:(e,t)=>e[t]})}initFace(){const e=this;let t=$(".video_upload_input_step2");this.element.on("dragover",(e=>{e.preventDefault(),this.showDropMask(!0)})),this.element.find(".uploader_loading_mask").on("dragleave",(e=>{e.preventDefault(),e.stopPropagation(),this.showDropMask(!1)})),this.element.find(".uploader_loading_mask").on("drop",(t=>{t.preventDefault(),t.stopPropagation(),gtag("event","up_faceswap_videostep2"),this.showDropMask(!1);let i=t.originalEvent.dataTransfer.files[0];e.uploadFileRule(i)})),this.element.find(".step_P").on("click",(e=>{gtag("event","up_faceswap_videostep2"),t.click()})),this.element.find(".btn_changer").on("click",(e=>{gtag("event","up_faceswap_videostep2"),t.click()})),t.on("change",(()=>{let i=t[0].files[0];e.uploadFileRule(i),setTimeout((()=>{t[0].value=""}),500)}))}transtoBlob=({b64data:e,contentType:t="image/png"})=>{t=t||"";let i=1024,o=atob(e.split(",")[1]),a=o.length,n=Math.ceil(a/i),s=new Array(n);for(let e=0;e<n;++e){let t=e*i,n=Math.min(t+i,a),d=new Array(n-t);for(let e=t,i=0;e<n;++i,++e)d[i]=o[e].charCodeAt(0);s[e]=new Uint8Array(d)}return new Blob(s,{type:t})};checkFileType(e){const t=e;for(let e=0;e<t.length;e++){const i=t[e].name.split(".").pop().toLowerCase();if(!["png","jpg","webp","jpeg"].includes(i))return!1}return!0}async uploadFileRule(e){if(this.loading||!e)return;if(!this.checkFileType([e]))return void ToolTip({type:"error",title:textContentObj.Failed,content:setTextContentObj("support_formats_p"),btn:textContentObj.ok});let t=await this.imgMinWidth(e);this.submit.videoDemo.domeLoadDisabled(!0),this.showUploading(!0),this.submit.imageRandom=!1,isFaceswapinitVideo||await initFace();let i=await this.detectionFace(t);if(1!==i.status){let e="";switch(i.status){case 0:e=setTextContentObj("No_face");break;case 2:e=setTextContentObj("Mutiple_face");break;case 3:e=setTextContentObj("face_small")}ToolTip({type:"error",title:textContentObj.Failed,content:e,btn:textContentObj.ok})}else URL.revokeObjectURL(this.imageSrc),this.uploadFile=e,this.imageSrc=t;this.showUploading(!1),this.submit.videoDemo.domeLoadDisabled(!1)}detectionFace(e){return new Promise(((t,i)=>{setTimeout((()=>{let o=new Image;o.src=e,console.log(e),o.onload=function(){try{faceapi.detectAllFaces(o,new faceapi.TinyFaceDetectorOptions({inputSize:416})).then((e=>{console.log(e);let i={};1===e.length?(i.status=1,i.box=e[0].box,t(i)):e.length>1?(i.status=2,t(i)):faceapi.detectAllFaces(o,new faceapi.SsdMobilenetv1Options).then((e=>{console.log(e),1===e.length?(i.status=1,i.box=e[0].box):e.length>1?i.status=2:i.status=0,t(i)}))}))}catch(e){console.log("err",e),i(e)}}}),50)}))}async imgMinWidth(e){const t=await createObjectURLFun(e);return new Promise((e=>{const i=new Image;i.src=t,i.onload=function(){this.width,this.height;e(t)}}))}resizeImageByFile(e){var t=this;return new Promise(((i,o)=>{var a=new FileReader;a.onloadend=()=>{let e=new Image;e.onload=()=>{let o=document.createElement("canvas"),a=o.getContext("2d"),n=Math.max(e.width,e.height);if(n>1080){let t=1080/n;o.width=e.width*t,o.height=e.height*t}else o.width=e.width,o.height=e.height;a.drawImage(e,0,0,o.width,o.height);var s=o.toDataURL(),d=t.transtoBlob({b64data:s,contentType:"image/png"});let l="width";o.width<o.height&&(l="height"),i({blog:d,imgType:l})},e.onerror=()=>{o(new Error("Image load failed"))},e.src=a.result},a.onerror=o,a.readAsDataURL(e)}))}showDropMask(e){this.loading||(e?this.element.find(".uploader_loading_mask").show():this.element.find(".uploader_loading_mask").hide())}showUploading(e){this.photoData.loading=e}showImageChange(e){}}class SubmitFaceSwap{constructor(e){const t=this;this.element=e,this.disabled=!0,this.videoContainer=null,this.imgContainer=null,this.PreviewVideoTool=null,this.clearTimeout=null,this.initGtag=!1,this.initGtag2=!1,this.task_id=null,this.swapCredits=0,this.isShowControl=!1,this.uploadType="",this.videoRandom=!1,this.imageRandom=!1,this.timerLoading=null,this.task_credits=!1,this.data={isVideoSubmit:!1},this.submitData=new Proxy(this.data,{set:(e,i,o)=>("isVideoSubmit"===i&&(o?(setTimeout((()=>{$(".v_preview_playIcon").fadeOut()}),100),t.element.find("#v_swap_face_Now").addClass("submit"),$("#video_Face_swapper_container .spread_box_container").addClass("loading"),$("#video_Face_swapper_container .change_video_btn .submit_text").text(textContentObj.Swapping_setp),t.setLoadingStep(!0),$(".high_quality_append_dom_video").css("pointer-events","none")):("gif"!=t.uploadType&&$(".v_preview_playIcon").fadeIn(),$("#video_Face_swapper_container .change_video_btn .submit_text").text(textContentObj.step3_btn),$("#video_Face_swapper_container .spread_box_container").removeClass("loading"),t.element.find("#v_swap_face_Now").removeClass("submit"),$(".high_quality_append_dom_video").css("pointer-events","auto"))),e[i]=o,!0),get:(e,t)=>e[t]})}async initFace(){this.videoContainer=new UploadVideo($("#video_Face_swapper_container .stepA"),this),this.creditModel=new CreditsMessageModel,this.videoContainer.initFace(),this.imgContainer=new UploadImage($("#video_Face_swapper_container .stepB"),this),this.PreviewVideoTool=new PreviewVideoTool($("#video_Face_swapper_container .spread_box"),this),this.videoDemo=new VideoDemo($("#v_face_swap_Demo"),this),this.PreviewVideoTool.initFace(),this.imgContainer.initFace(),this.showBtnCredits(!1),this.setMaskUnlockPriority(),this.element.find("#v_swap_face_Now").on("click",(async()=>{gtag("event","click_faceswap_videostep3"),this.PreviewVideoTool.video_preview_dom.pause(),this.disabled||(this.faceSwapLoading(!0),this.videoDemo.domeLoadDisabled(!0),this.videoContainer.showUploading(!0),this.imgContainer.showUploading(!0),this.PreviewVideoTool.showControls?this.isShowControl=!0:this.isShowControl=!1,this.PreviewVideoTool.showVideoControls(!1),getCountryConfig().then((()=>{this.submitFun()})).catch((()=>{this.videoContainer.showUploading(!1),this.imgContainer.showUploading(!1),this.faceSwapLoading(!1),this.videoDemo.domeLoadDisabled(!1),this.isShowControl&&this.PreviewVideoTool.showVideoControls(!0)})))}))}async setLoadingStep({step:e,createTask:t}){const i=this;let o=t?.data?.progress,a=t?.data?.status,n=setTextContentObj("loading_text");if(e&&0!==e){if(1==e)return n=setTextContentObj("Preparing_step"),void i.PreviewVideoTool.setLoadingText(n);-1==a&&(n="% "+setTextContentObj("Analyzing_setp")),-2==a&&(n="% "+setTextContentObj("Swapping_step")),i.PreviewVideoTool.setLoadingText(parseInt(o)+n)}else i.PreviewVideoTool.setLoadingText(n)}submitDisabled(e){e?(this.element.find(".video_upload_button").css({opacity:.4,"pointer-events":"none"}),this.element.find(".video_upload_button img").hide(),this.disabled=!0):(this.element.find(".video_upload_button").css({opacity:1,"pointer-events":"auto"}),this.element.find(".video_upload_button img").show(),this.disabled=!1)}async submitFun(){const e=this;let t=await this.uploadFile({videoFile:this.videoContainer.uploadFile,imgFile:this.imgContainer.uploadFile});if(console.log(t),t.bool){1!==window.userRuleConfig.is_subscriber&&this.videoContainer.videoDuration&&this.videoContainer.videoDuration>userRuleConfig.duration+1?this.videoDemo.showMoreVideoDuration(!0):this.videoDemo.showMoreVideoDuration(!1);let e=t.data.additional_data.merge_key.includes(".gif")?"gif":"video",i=await this.PreviewVideoTool.setVideoOrGifSrc(e,t.data.additional_data.merge_url,t.data.additional_data.cover_url);this.task_id=t.data.id;let o=t.data.additional_data.merge_key.split(".");o=o[o.length-1],console.log(111),this.PreviewVideoTool.downloadData={key:t.data.additional_data.merge_key,coverImg:i,type:o,url:t.data.additional_data.merge_url},this.videoContainer.videoCoverImgSrc=t.data.additional_data.cover_url,gtag("event","succ_faceswap_videoswapbtn"),this.PreviewVideoTool.showVideoControls(!0)}else{if("3005"==t?.data?.code)showMaximumV();else if("3008"==t?.data?.code)showNotEnoughCreditsVideo(e.swapCredits);else if(t?.message?.includes("faces=0")||t?.message?.includes("no face")){let t=textContentObj.No_face;e.task_credits&&(t=textContentObj.Credits_failed_no_face),ToolTip({type:"error",title:textContentObj.Failed,content:t,btn:textContentObj.ok})}else if(t?.message?.includes("celebrity")){let t=textContentObj.celebrity;e.task_credits&&(t=textContentObj.Credits_failed_celebrity),ToolTip({type:"error",title:textContentObj.Failed,content:t,btn:textContentObj.ok})}else if(t?.message?.includes("faces=")){let t=textContentObj.Mutiple_face;e.task_credits&&(t=textContentObj.Credits_failed_multi_face),ToolTip({type:"error",title:textContentObj.Failed,content:t,btn:textContentObj.ok})}else{let i=textContentObj.processImage;e.task_credits&&(i=textContentObj.Credits_failed),ToolTip({type:"error",title:textContentObj.Failed,content:i,btn:textContentObj.ok}),console.log(t.message)}this.isShowControl&&this.PreviewVideoTool.showVideoControls(!0)}this.setLoadingStep({step:0}),this.videoContainer.showUploading(!1),this.imgContainer.showUploading(!1),this.videoDemo.domeLoadDisabled(!1),this.faceSwapLoading(!1)}async uploadFile(e){console.log(e,this.videoRandom,this.imageRandom,"uploadFile");let t,i,{videoFile:o,imgFile:a}=e;t=this.videoRandom?o?.video_url.split(".").pop()||"mp4":o?.name.split(".").pop()||"mp4",i=this.imageRandom?a?.pic_url.split(".").pop()||"jpg":a?.name.split(".").pop()||"jpg";const n=this;return n.setLoadingStep({step:1}),new Promise((async(e,s)=>{let d,l,r,c;try{this.videoRandom||(d=await fetchPost("ai/source/temp-upload-url",{file_name:"vidqu_faceswap."+t},TOOL_API)),this.imageRandom||(l=await fetchPost("ai/source/temp-upload-url",{file_name:"vidqu_faceswap."+i},TOOL_API))}catch(t){return console.log("获取上传地址失败",t),void e({bool:!1})}if(this.videoRandom||await this.testUploadFile(d.data.upload_url,o,e),this.imageRandom||await this.testUploadFile(l.data.upload_url,a,e),this.videoRandom||(r=await getFileUrlRequest(d.data.access_url)),this.imageRandom||(r=await getFileUrlRequest(l.data.access_url)),!this.videoRandom||!this.imageRandom){if(!r)return console.log("failed ",l),void e({bool:!1,type:"upload"});console.log("success ",l)}let p=n.videoContainer.videoDuration;try{c=await n.createTaskFun({video_key:n.videoRandom?o.video_key:d.data.key,avatar_key:n.imageRandom?a.pic_key:l.data.key,duration:p,size:(n.videoRandom,o.size)})}catch(t){return console.log("创建任务失败",t),void e({bool:!1,message:t.message,data:t})}e(c)}))}async createTaskFun(e){let{video_key:t,avatar_key:i,demo_key:o,duration:a,size:n}=e;const s=this;return new Promise((async(e,d)=>{let l=await fetchPost("ai/tool/video-face-changing",{video_key:t,avatar_key:i,demo_key:o,duration:a,size:n,watertype:5,is_hd:videocreditSystem?.is_hd},TOOL_API,{"X-TASK-VERSION":"2.0.0"});if(200===l.code){video_task_id=l.data.task_id;let t=await s.intervalGetTask(l.data.task_id);userRuleConfig.credit=l.data.credit,show_priority=0,changeHeaderCredit(userRuleConfig.credit),e(t)}else d(l)}))}setMaskUnlockPriority(){$("#createTaskMaskVideo .v_mask_unlock_priority").on("click",(e=>{gtag("event","click_faceswap_videopriority"),setCookie("st","fsvideocreditpriority")}))}setLoadingMaskTip(e,t={}){const{maskSpan:i,show_wait:o,num:a,second:n}=t;let s=$("#createTaskMaskVideo"),d=$("#video_Face_swapper_container .v_mask_background");if(e){if(1===o){s.find(".v_mask_content2").show();let e=n,t="wait_minutes";n>60?e=Math.ceil(n/60):t="wait_seconds",s.find(".v_mask_content2 .v_mask_span").html(setTextContentObj(a>1?"estimated_wait_times":"estimated_wait_time",{val:a,val2:e,val3:setTextContentObj(t)}))}else s.find(".v_mask_content2").hide();s.show(),d.show()}else s.hide(),d.hide()}isSubmit(){null!==this.videoContainer.uploadFile&&null!==this.imgContainer.uploadFile&&(this.videoContainer.getConsumeCredit(this.videoContainer.videoDuration),this.element.find(".change_video_btn").removeClass("disabled"),this.disabled=!1)}intervalGetTask(e){let t=3;return new Promise((i=>{let o=setInterval((()=>{fetchPost("ai/tool/get-task",{id:e},TOOL_API).then((async e=>{if(200===e.code){if(this.setLoadingStep({step:2,createTask:e}),1===e.data.wait?.show_wait){0==show_priority&&(show_priority++,gtag("event","show_faceswap_videopriority"));let{num:t,second:i}=e.data.wait;this.setLoadingMaskTip(!0,{show_wait:1,num:t,second:i})}else this.setLoadingMaskTip(!1);0===e.data.status&&(videoPhotoDownloadData=await setDownloadData("video_face_changing",e),setCookie("faceSwapTime_swap",Date.now(),2),clearInterval(o),showCreditBannerP(!0),i({bool:!0,data:e.data}))}else this.setLoadingMaskTip(!1),clearInterval(o),i({bool:!1,message:e.message})})).catch((e=>{t--,0===t&&(clearInterval(o),i({bool:!1,message:e}))}))}),3e3)}))}async testUploadFile(e,t,i){try{await fetchPut(e,t,"")}catch(e){return console.log("failed upload file",e),void i({bool:!1,message:"exception_occurred"})}}setInitGtag(e){"tab_video"===e?this.initGtag||(this.initGtag=!0):this.initGtag2||(this.initGtag2=!0)}faceSwapLoading(e){this.submitData.isVideoSubmit=e}showBtnCredits(e,t){this.swapCredits=t,this.task_credits=e,videocreditSystem.showBtnCredits({bool:e,credits:t,appendDom:$("#video_Face_swapper_container .change_video_btn"),type:"video"})}eventLoginsuccess(){const e=this;document.querySelector("my-component").addEventListener("loginsuccess",(function(t){getCountryConfig().then((t=>{userRuleConfig=t,e.videoContainer.uploadFile?e.videoContainer.getConsumeCredit(e.videoContainer.videoDuration):showCreditBannerP(!0),isLogin(!0)}))}))}}class PreviewVideoTool{constructor(e,t){this.element=e,this.submit=t,this.video_preview_dom=this.element.find("#video_preview_dom")[0],this.video_larger_preview_dom=$("#v_preview_larger_video")[0],this.gif_larger_preview_dom=$("#v_preview_larger_gif")[0],this.downloadData=null,this.showControls=!1}initFace(){this.element.find(".zoomIn").on("click",(()=>{this.pauseVideoPreview(),gtag("event","zoomin_faceswap_videores"),this.showPreviewVideo(!0)})),$("#large_modal.video_large .close_large").on("click",(function(){this.showPreviewVideo(!1),this.pauseLargerVideoPreview()})),this.element.find(".download").on("click",(()=>{this.downloadVideo()})),this.element.find(".v_preview_playIcon").fadeOut(),this.element.find(".v_preview_playIcon").on("click",(e=>{this.playerVideoPreview(),e.originalEvent.stopPropagation()})),this.element.find("#video_preview_dom").on("click",(e=>{this.pauseVideoPreview(),e.originalEvent.stopPropagation()})),this.element.find("#video_preview_dom").on("contextmenu",(e=>{e.originalEvent.preventDefault()})),$("#v_preview_larger_video").on("contextmenu",(e=>{e.originalEvent.preventDefault()})),$(".v_preview_larger_playIcon").on("click",(e=>{this.playerLargerVideoPreview(),e.originalEvent.stopPropagation()}));const e=this.element.find(".video_preview_larger .v_preview_waitingIcon");this.video_larger_preview_dom.addEventListener("waiting",(function(){e.fadeIn()})),this.video_larger_preview_dom.addEventListener("playing",(function(){e.fadeOut()})),$("#v_preview_larger_video").on("click",(t=>{this.pauseLargerVideoPreview(),e.fadeOut(),t.originalEvent.stopPropagation()}));const t=$("#shareDialogEl").find(".v_preview_waitingIcon"),i=$("#shareDialogEl").find(".preview-video-box .show-video")[0];i.addEventListener("waiting",(function(){t.fadeIn()})),i.addEventListener("playing",(function(){t.fadeOut()})),i.addEventListener("pause",(function(){t.fadeOut()}));const o=this.element.find(".v_preview_playIcon");this.video_preview_dom.addEventListener("pause",(function(){o.fadeIn()})),this.video_preview_dom.addEventListener("play",(function(){o.fadeOut()})),this.element.find("#createTaskMask .v_mask_unlock_priority").on("click",(e=>{})),this.showVideoControls(!1)}showShareDom(){console.log("showShareDom");this.submit.videoContainer;this.videoSrc="",this.videoCoverImgSrc="",console.log(this.submit.videoContainer),shareFun({url:this.downloadData.url,text:setTextContentObj("share_text_v"),imageKey:this.downloadData.key,title:setTextContentObj("share_title_v"),content:setTextContentObj("share_title_centent")})}setLoadingText(e){this.element.find(".loading_box").find(".faceSwapProgress").text(e)}playerVideoPreview(){this.element.find(".v_preview_playIcon").fadeOut(),this.video_preview_dom.play()}playerLargerVideoPreview(){const e=$(".v_preview_larger_playIcon");e.fadeOut(),this.video_larger_preview_dom.play(),this.video_larger_preview_dom.addEventListener("pause",(function(){e.fadeIn()}),{once:!0})}pauseVideoPreview(){this.video_preview_dom.paused||this.video_preview_dom.pause()}pauseLargerVideoPreview(){this.video_larger_preview_dom.paused||this.video_larger_preview_dom.pause()}setLoading(e){e?(this.element.find(".video_dom_container").css("filter","blur(4px)"),this.element.find(".preview_upload_loading").css("display","flex")):(this.element.find(".video_dom_container").css("filter",""),this.element.find(".preview_upload_loading").css("display","none"))}setVideoOrGifSrc(e,t,i){const o=this;return new Promise(((a,n)=>{if("video"===e){let e=this.element.find(".video_node")[0];const n=i||o.submit.videoContainer.videoCoverImgSrc;n&&(o.element.find(".img_gif_node")[0].src=n,o.element.find(".video_node").css("display","none"),o.element.find(".img_gif_node").css("display","")),e.addEventListener("loadedmetadata",(async function(){setTimeout((async()=>{if(o.element.find(".video_node").css("display",""),o.element.find(".img_gif_node").css("display","none"),i)a(i);else{let t=await getVideoCoverImage(e);o.element.find(".img_gif_node")[0].src=t,a(t)}}),200)}),{once:!0}),e.src=t,e.load(),this.video_larger_preview_dom.src=t,this.video_larger_preview_dom.load(),$(this.gif_larger_preview_dom).hide(),$(this.video_larger_preview_dom).show(),this.element.find(".v_preview_playIcon").fadeIn(),$(".v_preview_larger_playIcon").fadeIn(),i&&a(i)}else"gif"===e&&(this.element.find(".video_node").css("display","none"),this.element.find(".img_gif_node").css("display",""),this.element.find(".img_gif_node")[0].src=t,this.gif_larger_preview_dom.src=t,$(this.gif_larger_preview_dom).show(),$(this.video_larger_preview_dom).hide(),this.element.find(".v_preview_playIcon").fadeOut(),$(".v_preview_larger_playIcon").fadeOut(),this.element.find(".img_gif_node")[0].onload=function(){a()})}))}showVideoControls(e){let t=this.showControls;return this.showControls=e,console.error(1),e?($("#video_Face_swapper_container .spread_box_controls").css("visibility","visible"),$("#video_Face_swapper_container .my_files_tips").css("visibility","visible"),gtag("event","show_vidqmyfiles_videotipsfile")):($("#video_Face_swapper_container .spread_box_controls").css("visibility","hidden"),$("#video_Face_swapper_container .my_files_tips").css("visibility","hidden")),t}showPreviewVideo(e){e?($("#v_preview_larger_video")[0].currentTime=0,$("#large_modal").addClass("video_large").fadeIn(),$("#large_modal.video_large .download").on("click",(async e=>{this.downloadVideo()}))):($("#large_modal").fadeOut().removeClass("video_large"),$("#large_modal .download").off("click"))}async downloadVideo(){if(!getCookie("access_token"))return void showLoginWindow({isReloading:!1,wait:[video_task_id],fn:async(e=null)=>{e&&(videoPhotoDownloadData=e)}});if(!videoPhotoDownloadData)return void(videoPhotoDownloadData=await newDownloadFile(this.submit.task_id));gtag("event","download_faceswap_videores");let{key:e,type:t}=this.downloadData;var i=()=>{ToolTip({type:"success",title:textContentObj.Download_success,content:textContentObj.Download_sucess_text,btn:textContentObj.ok})},o=()=>{ToolTip({type:"error",title:textContentObj.Failed,content:textContentObj.downloadError,btn:textContentObj.ok})},a=()=>{ToolTip({type:"error",title:textContentObj.failedTitle,content:textContentObj.file_download_exist,btn:textContentObj.ok})};await fetchPost("ai/source/get-access-url",{key:e,action:"download",file_name:"Vidqu_faceswap."+t},TOOL_API).then((e=>{ToolTip({type:"progress",content:textContentObj.downloading,progressType:"fetch",url:e.data.url,name:"Vidqu_faceswap."+t,sucessCallback:i,failedCallback:o,NoExistCallback:a})})).catch((e=>{ToolTip({type:"error",title:textContentObj.errorNetworkTitle,content:textContentObj.errorNetwork,btn:textContentObj.ok})}))}}class CreditsMessageModel{showNotEnoughCredits(){ToolTip({type:"error",title:textContentObj.Failed,content:getfsCreditsText("Model_not_credit_span",{val:credits}),btn:textContentObj.ok})}showMaximum(){gtag("event","alert_faceswap_videomaxlimit");let e=getfsCreditsText("Model_Maximum_span",{val:userRuleConfig.v_times},!0);ToolTip({type:"error",title:textContentObj.exceedTitle,content:e,btn:textContentObj.ok})}showMaximumFileSize(){let e=getfsCreditsText("Model_MaximumFile_span",{val:userRuleConfig.limit});ToolTip({type:"error",title:textContentObj.Failed,content:e,btn:textContentObj.ok})}}class TabsChange{constructor(e,t,i){this.element=e,this.tabs=t,this.submit=i,this.actTab="tab_photo"}initFace(){const e=this;e.changeTabs("tab_photo"),this.element.find(".faceSwap_tab").click((function(){let t=$(this).attr("tabName");"tab_multiple"!=t&&e.changeTabs(t)}))}changeTabs(e){this.actTab=e,actTab=e,this.element.find(".faceSwap_tab").removeClass("active");let t=this.element.find(".faceSwap_tab");for(let i=0;i<t.length;i++){let o=t[i];$(o).attr("tabName")===e&&$(o).addClass("active")}this.tabs.tab_all.forEach((e=>{e.hide()})),this.tabs[e].dom.forEach((e=>{e.show()})),"tab_video"===e?("T1"===userRuleConfig.countrycode&&$(".our_pics li[data-type='video'][data-vp='v']").show(),$(".our_pics li[data-type='video'][data-vp='p']").show(),$(".our_pics li[data-type='photo']").hide(),this.submit.setInitGtag("tab_video"),gtag("event","click_faceswap_videotab")):"tab_multiple"===e?gtag("event","click_faceswap_multitab"):($(".our_pics li[data-type='photo']").show(),$(".our_pics li[data-type='video']").hide(),this.submit.setInitGtag("tab_photo"),gtag("event","click_faceswap_phototab"))}}class VideoDemo{constructor(e,t){this.submit=t,this.element=e,this.demoType="video",this.checkedDemo={},this.demoObj={video:{},photo:{}},this.extendDurationEl=$("#video_Face_swapper_container .video_extend_duration"),this.initFace(),this.showMoreVideoDuration(!1)}initFace(){this.extendDurationEl.find(".v_other_button").on("click",(function(){console.log("Extend Video duration")})),this.getVideoOrImgDemo()}setTabs(){"T1"!==userRuleConfig.countrycode&&(this.element.find(".v_demo_photoTab").click(),this.element.find(".v_demo_videoTab").css("display","none"))}setCheckedDemo(e,t){const i=this;return new Promise((async(o,a)=>{if(!t)return i.checkedDemo[e]={},void o();let{key:n,url:s,cover_url:d,f_key:l}=t;"video"===e?(i.checkedDemo.video={key:n,cover_url:d,url:s,f_key:l},i.submit.videoContainer.showUploading(!0),i.submit.videoContainer.videoDuration=15,i.submit.videoContainer.uploadFile=null,await i.submit.videoContainer.setVideoFileSrc(i.checkedDemo.video.url),setTimeout((()=>{i.submit.videoContainer.showUploading(!1),i.submit.PreviewVideoTool.showVideoControls(!1),o()}),2e3)):"photo"===e?(i.checkedDemo.photo={key:n,url:s,f_key:l},i.submit.imgContainer.imageSrc=s,i.submit.imgContainer.uploadFile=null,i.submit.PreviewVideoTool.showVideoControls(!1),o()):(i.checkedDemo={},o())}))}domeLoadDisabled(e){e?($('.our_pics li[data-type="video"]').css({filter:"brightness(0.5)","pointer-events":" none"}),$('.our_pics li[data-type="video"]').css({filter:"brightness(0.5)","pointer-events":" none"})):($('.our_pics li[data-type="video"]').css({filter:"","pointer-events":""}),$('.our_pics li[data-type="video"]').css({filter:"","pointer-events":""}))}changeDemoLoading(e,t){e?$('.our_pics li[data-type="video"]').css({filter:"brightness(0.5)","pointer-events":" none"}):$('.our_pics li[data-type="video"]').css({filter:"","pointer-events":""})}async downloadVideoDemoFile(e){const t=this;return new Promise((async(i,o)=>{let{url:a,f_key:n,cover_url:s}=e;if(t.demoObj.video[n])await t.setCheckedDemo("video",t.demoObj.video[n]),i();else{let e=await srcToFile(a,"video");e&&200===e?.code?(t.demoObj.video[n]={key:e.data.key,url:a,cover_url:s,f_key:n},await t.setCheckedDemo("video",t.demoObj.video[n]),i()):(console.error(e),i())}}))}async downloadPhotoDemoFile(e){const t=this;return new Promise((async(i,o)=>{let{url:a,f_key:n}=e;if(t.demoObj.photo[n])t.setCheckedDemo("photo",t.demoObj.photo[n]);else{let e=await srcToFile(a,"photo");e&&200===e?.code?(t.demoObj.photo[n]={key:e.data.key,url:a,f_key:n},t.setCheckedDemo("photo",t.demoObj.photo[n])):console.error(e)}i()}))}async getVideoOrImgDemo(){const e=this;document.querySelector(".our_pics").addEventListener("click",(function(t){const i=t.target.parentNode;if("video"==i.getAttribute("data-type"))if("p"===i.getAttribute("data-vp")){e.submit.imageRandom=!0,e.submit.PreviewVideoTool.showVideoControls(!1),e.submit.imgContainer.showUploading(!0);let t=i.getAttribute("pic-url"),o=i.getAttribute("pic-key");e.changeDemoLoading(!0,"photo"),e.submit.imgContainer.uploadFile={pic_key:o,pic_url:t},e.submit.imgContainer.imageSrc=t,e.submit.imgContainer.element.find(".step_P")[0].src=t,$(".head_portrait_container").addClass("active"),e.changeDemoLoading(!1,"photo"),gtag("event","clickvid_faceswap_imgtpl"),e.submit.imgContainer.showUploading(!1)}else{e.submit.videoRandom=!0,e.submit.PreviewVideoTool.showVideoControls(!1);let t=i.getAttribute("video-url"),o=i.getAttribute("video-key"),a=i.getAttribute("cover-url"),n=i.getAttribute("video-duration"),s=i.getAttribute("video-size");e.changeDemoLoading(!0,"video"),e.submit.videoContainer.showUploading(!0),e.submit.videoContainer.videoDuration=n,e.submit.videoContainer.uploadFile={cover_url:a,video_key:o,video_url:t,size:s,duration:n},e.submit.PreviewVideoTool.setVideoOrGifSrc("video",t,a),$("#video_Face_swapper_container .step_V")[0].src=a,$(".video_img").addClass("active");let d="video/"+o.split(".")[1];"video/mp4"===d&&"video/webm"===d||(d="video/quicktime"),e.changeDemoLoading(!1,"video"),e.submit.videoContainer.showUploading(!1),gtag("event","clickvid_faceswap_vidtpl")}}))}showMoreVideoDuration(e){e?0==userRuleConfig.credit&&(this.element.hide(),this.extendDurationEl.find(".v_duration_content").html(setTextContentObj("More_duration_span",{val:userRuleConfig.duration})),this.extendDurationEl.show()):(this.element.show(),this.extendDurationEl.hide())}}const initFace=async function(){var e="/dist/js/weights";const t=await faceapi.loadTinyFaceDetectorModel(e);await faceapi.loadSsdMobilenetv1Model(e),isFaceswapinitVideo=!0,console.log("initfacevideo",t)};function showMaximumFileSizeV(){videocreditSystem.showCreditPopup({title:getfsCreditsText("Model_MaximumFile_title"),content:getfsCreditsText(1===userRuleConfig?.is_subscriber?"Model_MaximumFile_span2":"Model_MaximumFile_span",{val:userRuleConfig.limit}),btn:getfsCreditsText(1===userRuleConfig?.is_subscriber?"ok":"Model_Unlock_btn"),btnFn:()=>{userRuleConfig},isnotNeedPay:1===userRuleConfig?.is_subscriber,modalCoins:"filemax"})}function showMaximumV(){gtag("event","alert_faceswap_videomaxlimit"),videocreditSystem.showCreditPopup({title:textContentObj.exceedTitle,content:getfsCreditsText("Model_Maximum_span",{val:userRuleConfig.v_times},!0),btn:getfsCreditsText("Model_Unlock_btn"),btnFn:()=>{gtag("event","click_faceswap_videomaxlimit"),setCookie("st","fsvideomaxlimit")},modalCoins:"timesmax"})}async function getVideoCoverImage(e){return new Promise(((t,i)=>{e.play(),setTimeout((()=>{e.pause()}),100),setTimeout((()=>{try{let i=document.createElement("canvas");i.width=e.videoWidth,i.height=e.videoHeight,i.getContext("2d").drawImage(e,0,0,i.width,i.height);let o=i.toDataURL("image/jpeg");t(o)}catch(e){console.log("获取第一帧失败"),t("")}}),500)}))}async function srcToFile(e,t,i){let o="video"===t?[".m4v",".mp4",".mov",".webm"]:[".jpg",".png",".webp",".jpeg"],a=o.filter((e=>i.includes(e)));console.log(o,i,a);let n=a[0].split(".")[1],s="video"===t?"video/"+n:"image/"+n;return"video"!==t||"video/mp4"===s&&"video/webm"===s||(s="video/quicktime"),new Promise((async(t,i)=>{let o=await videoSrcConvertToBlob(e,s),a=await blobUrlToFile(o,{filename:"vidqu_faceswap",type:s});console.log(a),t(a)}))}async function srcToFile2(e,t){let i="video"===t?"video/mp4":"image/jpg";return new Promise((async(t,o)=>{let a=await videoSrcConvertToBlob(e,i),n=await blobUrlToFile(a,{filename:"test",type:i}),s=await fetchPost("ai/source/temp-upload-url",{file_name:"vidqu_faceswap"},TOOL_API);if(s.data?.upload_url){let e=s.data.upload_url;try{await fetchPut(e,n,""),t(s)}catch(e){console.log(e),t(null)}}else console.log(s),t(null)}))}function videoSrcConvertToBlob(e,t="video/mp4"){return new Promise(((i,o)=>{let a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="blob",a.onload=function(e){if(200==this.status){let e=new Blob([this.response],{type:t}),o=URL.createObjectURL(e);i(o)}},a.send()}))}function blobUrlToFile(e,t){return new Promise(((i,o)=>{let{filename:a,type:n}=t;fetch(e).then((e=>e.blob())).then((e=>{let t=new File([e],a,{type:n});i(t),console.log("File object:",t)})).catch((e=>{console.error("Error:",e)}))}))}function shareFun(e){let t=document.querySelector("#shareDialogEl");t.changeTips({title:e.title,content:e.content}),t.showShare({url:e.url,action:"videofacechangingshare",imageKey:e.imageKey,text:e.text,title:e.title})}function getCountryConfig(){return new Promise(((e,t)=>{fetchPost("ai/tool/videoface-user",{},TOOL_API).then((i=>{200===i.code?(userRuleConfig=i.data,initCreditsComponents(),"tab_video"===actTab&&window.faceSwapTab.changeTabs(actTab),changeHeaderCredit(i.data.credit),e(i.data)):(console.error("Error getCountryConfig",i),ToolTip({type:"error",title:textContentObj.Failed,content:textContentObj.processImage,btn:textContentObj.ok}),t())})).catch((e=>{console.error(e),ToolTip({type:"error",title:textContentObj.errorNetworkTitle,content:textContentObj.errorNetwork,btn:textContentObj.ok}),t()}))}))}function getParameterByName(e){e=e.replace(/[\[\]]/g,"\\$&");const t=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(window.location.search);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}function video_swap_init(){let e={tab_all:[$("#photo_Face_swapper_container"),$("#video_Face_swapper_container")],tab_photo:{dom:[$("#photo_Face_swapper_container")]},tab_video:{dom:[$("#video_Face_swapper_container")]}},t=new SubmitFaceSwap($("#video_Face_swapper_container .step_C"));window.aiFaceVideo=t,t.initFace(),t.eventLoginsuccess();let i=new TabsChange($(".faceSwap_tabBox"),e,t);return i.initFace(),getCountryConfig(),"videofaceSwap"===getParameterByName("openTab")&&i.changeTabs("tab_video"),i}function setCookie(e,t,i){var o=new Date;o.setDate(o.getDate()+i);var a=location.hostname.includes(".vidqu.ai")?".vidqu.ai":location.hostname,n=encodeURIComponent(t)+(null==i?"":";expires="+o.toUTCString())+";path=/;domain="+a;document.cookie=e+"="+n}function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function createObjectURLFun(e){return URL.createObjectURL(e)}function createFileUrl(e){e.type;return new Promise(((t,i)=>{const o=new FileReader;o.onload=function(e){const i=e.target.result;t(i)},o.readAsDataURL(e)}))}function getFileUrlRequest(e){return new Promise(((t,i)=>{var o=new XMLHttpRequest;o.open("GET",e,!0),o.send(),o.addEventListener("readystatechange",(function(e){if(2==o.readyState){let e=o.getResponseHeader("Content-Length");t(!!(e&&e/1024>1)),o.abort()}}),!1)}))}function showNotEnoughCreditsVideo(e=1){gtag("event","alert_faceswap_videonocredit"),videocreditSystem.showCreditPopup({title:getfsCreditsText("Model_not_credits_title"),content:getfsCreditsText("Model_not_credit_span",{val:e},!0),btn:getfsCreditsText("Model_not_credits_btn"),btnFn:()=>{gtag("event","click_faceswap_videonocredit"),setCookie("st","fsvideonocredit")},modalCoins:"notenough"})}$(window).ready((function(){window.faceSwapTab=video_swap_init(),$("#video_Face_swapper_container .my_files_tips .myfiles_check_Now_btn").on("click",(()=>{gtag("event","click_vidqmyfiles_videotipsfile"),getCookie("access_token")?window.open("/my-files.html"):showLoginWindow({isReloading:!1,wait:[video_task_id],fn:async(e=null)=>{e&&(videoPhotoDownloadData=e),window.open("/my-files.html")}})}))}));